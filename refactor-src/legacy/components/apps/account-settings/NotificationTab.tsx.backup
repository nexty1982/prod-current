import React, { useState } from 'react';
import {
  Card,
  CardContent,
  Typography,
  FormControlLabel,
  Switch,
  Box,
  Button,
  Divider,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Alert,
  Stack,
  Chip,
  TextField,
  Grid
} from '@mui/material';
import Grid2 from '@mui/material/Grid2';
// TODO: Fix date picker dependencies
// import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
// import { AdapterDateFns } from '@mui/x-date-pickers/AdapterDateFns';
// import { TimePicker } from '@mui/x-date-pickers/TimePicker';
import {
  IconMail,
  IconBell,
  IconDeviceMobile,
  IconMessage,
  IconUsers,
  IconCalendar,
  IconNews,
  IconSettings
} from '@tabler/icons-react';

const NotificationTab = ({ 
  notificationSettings, 
  onNotificationUpdate 
}) => {
  const [settings, setSettings] = useState({
    // Email Notifications
    email_enabled: notificationSettings?.email_enabled ?? true,
    email_messages: notificationSettings?.email_messages ?? true,
    email_friend_requests: notificationSettings?.email_friend_requests ?? true,
    email_posts: notificationSettings?.email_posts ?? false,
    email_events: notificationSettings?.email_events ?? true,
    email_reminders: notificationSettings?.email_reminders ?? true,
    email_newsletters: notificationSettings?.email_newsletters ?? false,
    
    // SMS Notifications  
    sms_enabled: notificationSettings?.sms_enabled ?? false,
    sms_messages: notificationSettings?.sms_messages ?? false,
    sms_events: notificationSettings?.sms_events ?? false,
    sms_reminders: notificationSettings?.sms_reminders ?? false,
    
    // Push Notifications
    push_enabled: notificationSettings?.push_enabled ?? true,
    push_messages: notificationSettings?.push_messages ?? true,
    push_friend_requests: notificationSettings?.push_friend_requests ?? true,
    push_posts: notificationSettings?.push_posts ?? false,
    push_events: notificationSettings?.push_events ?? true,
    
    // In-App Notifications
    in_app_enabled: notificationSettings?.in_app_enabled ?? true,
    in_app_messages: notificationSettings?.in_app_messages ?? true,
    in_app_friend_requests: notificationSettings?.in_app_friend_requests ?? true,
    in_app_posts: notificationSettings?.in_app_posts ?? true,
    in_app_events: notificationSettings?.in_app_events ?? true,
    
    // Frequency Settings
    frequency: notificationSettings?.frequency || 'daily',
    quiet_hours_start: notificationSettings?.quiet_hours_start || '22:00:00',
    quiet_hours_end: notificationSettings?.quiet_hours_end || '08:00:00',
    timezone: notificationSettings?.timezone || 'UTC'
  });

  const [updateMessage, setUpdateMessage] = useState('');
  const [updateError, setUpdateError] = useState('');

  const handleSettingChange = (key, value) => {
    setSettings(prev => ({ ...prev, [key]: value }));
  };

  const handleSave = async () => {
    try {
      setUpdateError('');
      await onNotificationUpdate(settings);
      setUpdateMessage('Notification preferences updated successfully');
      setTimeout(() => setUpdateMessage(''), 3000);
    } catch (error) {
      setUpdateError('Failed to update notification preferences');
    }
  };

  const NotificationSection = ({ title, icon, children }) => (
    <Card sx={{ mb: 3 }}>
      <CardContent>
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 2 }}>
          {icon}
          <Typography variant="h6">
            {title}
          </Typography>
        </Box>
        {children}
      </CardContent>
    </Card>
  );

  return (
    <LocalizationProvider dateAdapter={AdapterDateFns}>
      <Box>
        {updateMessage && (
          <Alert severity="success" sx={{ mb: 2 }}>
            {updateMessage}
          </Alert>
        )}
        {updateError && (
          <Alert severity="error" sx={{ mb: 2 }}>
            {updateError}
          </Alert>
        )}

        {/* Email Notifications */}
        <NotificationSection
          title="Email Notifications"
          icon={<IconMail size={24} />}
        >
          <FormControlLabel
            control={
              <Switch
                checked={settings.email_enabled}
                onChange={(e) => handleSettingChange('email_enabled', e.target.checked)}
              />
            }
            label="Enable email notifications"
            sx={{ mb: 2 }}
          />
          
          {settings.email_enabled && (
            <Stack spacing={2} sx={{ mt: 2 }}>
              <FormControlLabel
                control={
                  <Switch
                    checked={settings.email_messages}
                    onChange={(e) => handleSettingChange('email_messages', e.target.checked)}
                  />
                }
                label="New messages"
              />
              <FormControlLabel
                  control={
                    <Switch
                      checked={settings.email_friend_requests}
                      onChange={(e) => handleSettingChange('email_friend_requests', e.target.checked)}
                    />
                  }
                  label="Friend requests"
                />
              <FormControlLabel
                control={
                  <Switch
                    checked={settings.email_posts}
                    onChange={(e) => handleSettingChange('email_posts', e.target.checked)}
                  />
                }
                label="New posts from friends"
              />
              <FormControlLabel
                control={
                  <Switch
                    checked={settings.email_events}
                    onChange={(e) => handleSettingChange('email_events', e.target.checked)}
                  />
                }
                label="Church events"
              />
              <FormControlLabel
                control={
                  <Switch
                    checked={settings.email_reminders}
                    onChange={(e) => handleSettingChange('email_reminders', e.target.checked)}
                  />
                }
                label="Event reminders"
              />
              <FormControlLabel
                control={
                  <Switch
                    checked={settings.email_newsletters}
                    onChange={(e) => handleSettingChange('email_newsletters', e.target.checked)}
                  />
                }
                label="Newsletters"
              />
            </Stack>
          )}
        </NotificationSection>

        {/* Push Notifications */}
        <NotificationSection
          title="Push Notifications"
          icon={<IconBell size={24} />}
        >
          <FormControlLabel
            control={
              <Switch
                checked={settings.push_enabled}
                onChange={(e) => handleSettingChange('push_enabled', e.target.checked)}
              />
            }
            label="Enable push notifications"
            sx={{ mb: 2 }}
          />
          
          {settings.push_enabled && (
            <Grid container spacing={2}>
              <Grid item xs={12} sm={6}>
                <FormControlLabel
                  control={
                    <Switch
                      checked={settings.push_messages}
                      onChange={(e) => handleSettingChange('push_messages', e.target.checked)}
                    />
                  }
                  label="New messages"
                />
              </Grid>
              <Grid item xs={12} sm={6}>
                <FormControlLabel
                  control={
                    <Switch
                      checked={settings.push_friend_requests}
                      onChange={(e) => handleSettingChange('push_friend_requests', e.target.checked)}
                    />
                  }
                  label="Friend requests"
                />
              </Grid>
              <Grid item xs={12} sm={6}>
                <FormControlLabel
                  control={
                    <Switch
                      checked={settings.push_posts}
                      onChange={(e) => handleSettingChange('push_posts', e.target.checked)}
                    />
                  }
                  label="New posts from friends"
                />
              </Grid>
              <Grid item xs={12} sm={6}>
                <FormControlLabel
                  control={
                    <Switch
                      checked={settings.push_events}
                      onChange={(e) => handleSettingChange('push_events', e.target.checked)}
                    />
                  }
                  label="Church events"
                />
              </Grid>
            </Grid>
          )}
        </NotificationSection>

        {/* SMS Notifications */}
        <NotificationSection
          title="SMS Notifications"
          icon={<IconDeviceMobile size={24} />}
        >
          <FormControlLabel
            control={
              <Switch
                checked={settings.sms_enabled}
                onChange={(e) => handleSettingChange('sms_enabled', e.target.checked)}
              />
            }
            label="Enable SMS notifications"
            sx={{ mb: 2 }}
          />
          
          {settings.sms_enabled && (
            <Grid container spacing={2}>
              <Grid item xs={12} sm={6}>
                <FormControlLabel
                  control={
                    <Switch
                      checked={settings.sms_messages}
                      onChange={(e) => handleSettingChange('sms_messages', e.target.checked)}
                    />
                  }
                  label="Important messages"
                />
              </Grid>
              <Grid item xs={12} sm={6}>
                <FormControlLabel
                  control={
                    <Switch
                      checked={settings.sms_events}
                      onChange={(e) => handleSettingChange('sms_events', e.target.checked)}
                    />
                  }
                  label="Church events"
                />
              </Grid>
              <Grid item xs={12} sm={6}>
                <FormControlLabel
                  control={
                    <Switch
                      checked={settings.sms_reminders}
                      onChange={(e) => handleSettingChange('sms_reminders', e.target.checked)}
                    />
                  }
                  label="Event reminders"
                />
              </Grid>
            </Grid>
          )}
        </NotificationSection>

        {/* In-App Notifications */}
        <NotificationSection
          title="In-App Notifications"
          icon={<IconMessage size={24} />}
        >
          <FormControlLabel
            control={
              <Switch
                checked={settings.in_app_enabled}
                onChange={(e) => handleSettingChange('in_app_enabled', e.target.checked)}
              />
            }
            label="Enable in-app notifications"
            sx={{ mb: 2 }}
          />
          
          {settings.in_app_enabled && (
            <Grid container spacing={2}>
              <Grid item xs={12} sm={6}>
                <FormControlLabel
                  control={
                    <Switch
                      checked={settings.in_app_messages}
                      onChange={(e) => handleSettingChange('in_app_messages', e.target.checked)}
                    />
                  }
                  label="New messages"
                />
              </Grid>
              <Grid item xs={12} sm={6}>
                <FormControlLabel
                  control={
                    <Switch
                      checked={settings.in_app_friend_requests}
                      onChange={(e) => handleSettingChange('in_app_friend_requests', e.target.checked)}
                    />
                  }
                  label="Friend requests"
                />
              </Grid>
              <Grid item xs={12} sm={6}>
                <FormControlLabel
                  control={
                    <Switch
                      checked={settings.in_app_posts}
                      onChange={(e) => handleSettingChange('in_app_posts', e.target.checked)}
                    />
                  }
                  label="New posts from friends"
                />
              </Grid>
              <Grid item xs={12} sm={6}>
                <FormControlLabel
                  control={
                    <Switch
                      checked={settings.in_app_events}
                      onChange={(e) => handleSettingChange('in_app_events', e.target.checked)}
                    />
                  }
                  label="Church events"
                />
              </Grid>
            </Grid>
          )}
        </NotificationSection>

        {/* Notification Schedule */}
        <NotificationSection
          title="Notification Schedule"
          icon={<IconSettings size={24} />}
        >
          <Grid container spacing={3}>
            <Grid item xs={12} sm={4}>
              <FormControl fullWidth>
                <InputLabel>Frequency</InputLabel>
                <Select
                  value={settings.frequency}
                  label="Frequency"
                  onChange={(e) => handleSettingChange('frequency', e.target.value)}
                >
                  <MenuItem value="immediate">Immediate</MenuItem>
                  <MenuItem value="daily">Daily Digest</MenuItem>
                  <MenuItem value="weekly">Weekly Summary</MenuItem>
                </Select>
              </FormControl>
            </Grid>
            
            <Grid item xs={12} sm={4}>
              <TextField
                fullWidth
                label="Quiet Hours Start"
                type="time"
                value={settings.quiet_hours_start?.slice(0, 5) || '22:00'}
                onChange={(e) => handleSettingChange('quiet_hours_start', e.target.value + ':00')}
                InputLabelProps={{ shrink: true }}
              />
            </Grid>
            
            <Grid item xs={12} sm={4}>
              <TextField
                fullWidth
                label="Quiet Hours End"
                type="time"
                value={settings.quiet_hours_end?.slice(0, 5) || '08:00'}
                onChange={(e) => handleSettingChange('quiet_hours_end', e.target.value + ':00')}
                InputLabelProps={{ shrink: true }}
              />
            </Grid>
          </Grid>
          
          <Typography variant="body2" color="text.secondary" sx={{ mt: 2 }}>
            During quiet hours, you'll only receive critical notifications
          </Typography>
        </NotificationSection>

        {/* Notification Categories */}
        <Card>
          <CardContent>
            <Typography variant="h6" gutterBottom>
              Quick Settings
            </Typography>
            <Stack direction="row" spacing={1} flexWrap="wrap">
              <Chip
                icon={<IconMessage />}
                label="All Messages"
                variant={settings.email_messages && settings.push_messages && settings.in_app_messages ? "filled" : "outlined"}
                onClick={() => {
                  const allEnabled = settings.email_messages && settings.push_messages && settings.in_app_messages;
                  handleSettingChange('email_messages', !allEnabled);
                  handleSettingChange('push_messages', !allEnabled);
                  handleSettingChange('in_app_messages', !allEnabled);
                }}
                clickable
                sx={{ mb: 1 }}
              />
              <Chip
                icon={<IconUsers />}
                label="Social Updates"
                variant={settings.email_friend_requests && settings.push_friend_requests ? "filled" : "outlined"}
                onClick={() => {
                  const allEnabled = settings.email_friend_requests && settings.push_friend_requests;
                  handleSettingChange('email_friend_requests', !allEnabled);
                  handleSettingChange('push_friend_requests', !allEnabled);
                  handleSettingChange('in_app_friend_requests', !allEnabled);
                }}
                clickable
                sx={{ mb: 1 }}
              />
              <Chip
                icon={<IconCalendar />}
                label="Church Events"
                variant={settings.email_events && settings.push_events ? "filled" : "outlined"}
                onClick={() => {
                  const allEnabled = settings.email_events && settings.push_events;
                  handleSettingChange('email_events', !allEnabled);
                  handleSettingChange('push_events', !allEnabled);
                  handleSettingChange('in_app_events', !allEnabled);
                }}
                clickable
                sx={{ mb: 1 }}
              />
            </Stack>
          </CardContent>
        </Card>

        {/* Save Button */}
        <Box sx={{ mt: 3, textAlign: 'center' }}>
          <Button
            variant="contained"
            size="large"
            onClick={handleSave}
            sx={{ minWidth: 200 }}
          >
            Save Notification Preferences
          </Button>
        </Box>
      </Box>
    </LocalizationProvider>
  );
};

export default NotificationTab;
