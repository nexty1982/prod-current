GOAL
Stabilize OrthodoxMetrics backend + records dropdown options by fixing:
1) ER_NO_SUCH_TABLE: orthodoxmetrics_db.baptism_records missing (and any similar record tables).
2) “Record request without church context” warnings (church_id context propagation).
3) “Centralized config not available, using process.env fallback” warnings (restore centralized config path/usage).
4) “[SafeRequire] Module not found: ../utils/writeSacramentHistory” fallback (restore module and wire it correctly).
5) “Gallery directory does not exist …/front-end/public/images/gallery” warning (ensure directory creation is correct and not noisy).

HARD REQUIREMENTS
- Backend-first, correct long-term fixes. No frontend-only band-aids unless truly necessary.
- First: identify and document current setup BEFORE changes. Produce a short “Current State” section with file paths, relevant env vars, db names, and discovered schemas.
- Backend server is always on port 3001.
- Changes must be production-grade: add validations, explicit errors, and tests/smoke checks.
- If a mismatch exists between “global” tables (orthodoxmetrics_db.*) and per-church schemas (om_church_46 etc), implement a single consistent resolution strategy and document it.
- Do not silently swallow errors; return actionable 4xx/5xx with clear JSON and server logs.
- Keep changes minimal but complete; remove noisy warnings once fixed.

PHASE 1 — DISCOVERY (DO NOT MODIFY CODE YET)
1) Search for the dropdown options handler hitting:
   GET /api/baptism-records/dropdown-options/clergy?table=baptism_records
   Locate the exact route file(s) and controller function(s). Confirm where it builds SQL:
   SELECT DISTINCT clergy AS value FROM baptism_records ...
   Provide file path + line numbers.
2) Determine how church context is supposed to be provided:
   - Is church_id expected from JWT claims, session, header, querystring, or route params?
   - Locate middleware that sets req.church, req.church_id, req.tenant, or similar.
   - Identify why requests are missing church context.
3) Determine DB topology:
   - Inspect server/config/db.js and any “centralized config” module.
   - Confirm whether the code expects tables inside orthodoxmetrics_db (global) OR per-church schema (om_church_<id>).
   - Run a DB inspection script (add one if missing) to print:
     a) list of schemas matching om_church_%
     b) whether orthodoxmetrics_db.baptism_records exists
     c) for a sample church (46), whether om_church_46.baptism_records exists
4) Determine what “writeSacramentHistory” is:
   - Search for references to writeSacramentHistory usage (imports).
   - Identify where it used to live, or a similar file in repo history.
   - Confirm desired behavior (logging history to a table? files?).
5) Confirm the gallery path:
   - Find the code that checks/creates /front-end/public/images/gallery.
   - Decide whether this should be created at boot, on upload, or via deployment step.
   - Reduce warning noise if it’s expected.

PHASE 1 OUTPUT
Return a concise report:
- Routes/files involved (with line numbers).
- How church context is currently determined and why it’s missing.
- Actual DB reality (which schemas/tables exist).
- What the correct intended table location should be (global vs per-church).
- What’s missing for centralized config + writeSacramentHistory.
No changes yet.

PHASE 2 — IMPLEMENTATION (MAKE CHANGES)
Implement the most correct fix based on discovery:

A) Fix ER_NO_SUCH_TABLE properly
- If records tables are meant to be per-church (likely), then:
  1) Require church context for dropdown-options endpoint.
  2) Dynamically target the correct schema: om_church_<church_id>.baptism_records (and sanitize/whitelist church_id).
  3) Remove reliance on query param “table=baptism_records” for table selection OR strictly whitelist allowed table names per record type.
  4) Return 400 if church context missing; do not attempt global query.
- If records tables are intended to be global (orthodoxmetrics_db), then:
  1) Add/restore migrations to create baptism_records and any required indexes/columns.
  2) Ensure seed/tenant fields exist (church_id column, etc).
  3) Update queries to filter by church_id if applicable.

B) Fix “Record request without church context”
- Ensure middleware extracts church_id reliably.
- Decide single source of truth:
  - Prefer JWT/session claim (e.g., user’s active church) with optional explicit override via querystring only for super_admin.
- Add a small helper: requireChurchContext(req) that throws a typed error leading to 400 JSON:
  { error: "Missing church context", hint: "...", required: ["church_id"] }
- Update all records endpoints that require church context to use the helper (at least baptism dropdown-options, ideally all record routes).

C) Restore centralized config
- Identify the centralized config module path the logs refer to.
- If missing, recreate it with stable exports and load order that works in dist/ builds.
- Ensure dist builds include it (tsconfig/build pipeline).
- Remove the repetitive “Centralized config not available” warnings once restored; keep a single warning only if truly optional.

D) Restore writeSacramentHistory
- Recreate ../utils/writeSacramentHistory with the required function signature.
- Wire it into the routes/controllers where it’s imported.
- If it writes to DB, ensure it targets the correct schema/table and fails safely (do not crash the server; log and continue if history write fails, but do not “stub silently”).
- Add minimal unit/integration coverage or at least a smoke test script.

E) Gallery directory warning
- Make directory creation deterministic:
  - Create on server startup OR in the upload route before write, using fs.mkdir({recursive:true}).
- Downgrade log to INFO only once, or remove if directory is created successfully.

PHASE 3 — VERIFICATION
Add a “smoke check” script runnable from repo root that:
- Calls the dropdown-options endpoint with and without church context.
- Confirms proper 400 on missing context.
- Confirms proper 200 and a non-empty/empty array response when context is provided (depending on data).
- Confirms no ER_NO_SUCH_TABLE is thrown.
- Confirms centralized config is loaded without warnings.
- Confirms writeSacramentHistory module resolves.
- Confirms gallery directory existence.

Deliverables:
1) Code changes with file paths and line numbers.
2) Any SQL migration scripts if needed.
3) The smoke check script and exact commands to run.
4) A short “What changed / Why this is correct” summary.

IMPORTANT GUARDRAILS
- Sanitize schema/table selection: NO raw string concatenation without whitelisting.
- Do not break existing prod data.
- Keep logging structured and minimal.
- Do not change unrelated UI styling in this task.

START NOW
Begin with Phase 1 discovery and show findings, then proceed through Phase 2 and Phase 3.
