var ee=Object.defineProperty,te=Object.defineProperties;var ne=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var ae=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var U=(s,l,c)=>l in s?ee(s,l,{enumerable:!0,configurable:!0,writable:!0,value:c}):s[l]=c,m=(s,l)=>{for(var c in l||(l={}))ae.call(l,c)&&U(s,c,l[c]);if(R)for(var c of R(l))se.call(l,c)&&U(s,c,l[c]);return s},p=(s,l)=>te(s,ne(l));var F=(s,l,c)=>new Promise((B,D)=>{var b=h=>{try{C(c.next(h))}catch(f){D(f)}},N=h=>{try{C(c.throw(h))}catch(f){D(f)}},C=h=>h.done?B(h.value):Promise.resolve(h.value).then(b,N);C((c=c.apply(s,l)).next())});import{aK as ie,l as re,j as e,B as x,C as J,S as G,e as O,aL as le,d as j,$ as oe,U as W,Q as P,D as k,O as g,f as o,R as ce,T as ue,I as de}from"./index-CQJq875H.js";import{B as xe}from"./Breadcrumb-DPJpPJYg.js";import{P as he}from"./PageContainer-Dcom98rz.js";import{r as I}from"./vendor-DgfDxsY7.js";import{u as me,I as pe}from"./index-NY0yo0eN.js";import{L as je,A as ge}from"./AdapterDateFns-DxOZ-j8f.js";import{I as ve}from"./IconDeviceFloppy-Bx9X-YRH.js";import{D as H}from"./DatePicker-BjSt7Gpc.js";import{I as _e}from"./IconPlus-WkeJvWvg.js";import{T as fe,a as Ie,b as ye,c as M,d as be}from"./TableRow-DCPT_a5G.js";import{T as u}from"./TableCell-MgPOxDnu.js";import{I as Ce}from"./IconTrash-CiHBPOoG.js";import{B as Se}from"./BlankCard-DdczsrIb.js";import"./Breadcrumbs-CV3hf9fU.js";import"./Link-QuBZyEDj.js";import"./Helmet-DNWYwtrp.js";import"./index-BvdvJza9.js";import"./useThemeProps-Bi4Dqx2d.js";import"./InputAdornment-CNS_vxXH.js";import"./index-DbGRKVM3.js";import"./ListItem-C0K_HsLZ.js";import"./listItemButtonClasses-B2JwQewU.js";import"./index-CCbV6T5K.js";import"./index-B8Cm0CAq.js";import"./typeof-QjJsDpFa.js";import"./index-B9SIr0Qh.js";import"./index-DmKFFksY.js";import"./index-B8a_guEX.js";import"./index-Bl18lNLp.js";import"./toPropertyKey-BRA8pAMC.js";const De=()=>{const{id:s}=ie(),l=re(),{getInvoiceById:c,updateInvoice:B,createInvoice:D}=me(),[b,N]=I.useState(null),[C,h]=I.useState(!0),[f,z]=I.useState(!1),[$,w]=I.useState(null),[i,_]=I.useState({church_id:null,issue_date:new Date,due_date:new Date,currency:"USD",language:"en",internal_notes:"",status:"draft"}),[v,T]=I.useState([]),A=!!(s&&s!=="new");I.useEffect(()=>{A?Q():(h(!1),q())},[s]);const Q=()=>F(void 0,null,function*(){try{h(!0),w(null);const t=yield c(Number(s));if(t){N(t),_({church_id:t.church_id,issue_date:new Date(t.issue_date),due_date:new Date(t.due_date),currency:t.currency,language:t.language,internal_notes:t.internal_notes||"",status:t.status});const r=(t.items||[]).map(n=>{var a,d,S,E;return p(m({},n),{name:typeof n.name_multilang=="string"?JSON.parse(n.name_multilang)[t.language]||JSON.parse(n.name_multilang).en||"":((a=n.name_multilang)==null?void 0:a[t.language])||((d=n.name_multilang)==null?void 0:d.en)||"",description:typeof n.description_multilang=="string"?JSON.parse(n.description_multilang)[t.language]||JSON.parse(n.description_multilang).en||"":((S=n.description_multilang)==null?void 0:S[t.language])||((E=n.description_multilang)==null?void 0:E.en)||""})});T(r)}}catch(t){w("Failed to load invoice"),console.error("Error fetching invoice:",t)}finally{h(!1)}}),q=()=>{const t={id:Date.now(),invoice_id:Number(s)||0,item_code:"",name:"",description:"",category:"service",quantity:1,unit_type:"each",unit_price:0,discount_percent:0,discount_amount:0,line_total:0,tax_rate:0,tax_amount:0,sort_order:v.length,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};T([...v,t])},K=t=>{T(v.filter((r,n)=>n!==t))},y=(t,r,n)=>{const a=[...v];if(a[t]=p(m({},a[t]),{[r]:n}),["quantity","unit_price","discount_percent","discount_amount"].includes(r)){const d=a[t],S=d.quantity*d.unit_price,E=d.discount_percent>0?S*(d.discount_percent/100):d.discount_amount;a[t].line_total=S-E}T(a)},L=()=>{const t=v.reduce((a,d)=>a+d.line_total,0),r=v.reduce((a,d)=>a+d.tax_amount,0),n=t+r;return{subtotal:t,taxAmount:r,total:n}},V=()=>F(void 0,null,function*(){try{z(!0),w(null);const{total:t,taxAmount:r}=L(),n=p(m({},i),{issue_date:i.issue_date.toISOString().split("T")[0],due_date:i.due_date.toISOString().split("T")[0],total_amount:t,tax_amount:r,items:v.map(a=>({item_code:a.item_code,name_multilang:JSON.stringify({[i.language]:a.name}),description_multilang:JSON.stringify({[i.language]:a.description}),category:a.category,quantity:a.quantity,unit_type:a.unit_type,unit_price:a.unit_price,discount_percent:a.discount_percent,discount_amount:a.discount_amount,line_total:a.line_total,tax_rate:a.tax_rate,tax_amount:a.tax_amount,sort_order:a.sort_order}))});if(A)yield B(Number(s),n);else{const a=yield D(n);if(a){l(`/apps/invoice/detail/${a.id}`);return}}l(`/apps/invoice/detail/${s}`)}catch(t){w("Failed to save invoice"),console.error("Error saving invoice:",t)}finally{z(!1)}}),{subtotal:X,taxAmount:Y,total:Z}=L();return C?e.jsx(x,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(J,{})}):e.jsx(je,{dateAdapter:ge,children:e.jsxs(x,{children:[e.jsxs(G,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(x,{children:[e.jsx(O,{startIcon:e.jsx(le,{}),onClick:()=>l("/apps/invoice/list"),sx:{mb:1},children:"Back to Invoices"}),e.jsx(j,{variant:"h4",children:A?`Edit Invoice ${b==null?void 0:b.invoice_number}`:"Create New Invoice"})]}),e.jsx(O,{variant:"contained",startIcon:f?e.jsx(J,{size:20}):e.jsx(ve,{}),onClick:V,disabled:f||v.length===0,children:f?"Saving...":"Save Invoice"})]}),$&&e.jsx(oe,{severity:"error",sx:{mb:3},children:$}),e.jsxs(x,{sx:{display:"flex",gap:3,mb:3,flexDirection:{xs:"column",md:"row"}},children:[e.jsx(x,{sx:{flex:1},children:e.jsx(W,{children:e.jsxs(P,{children:[e.jsx(j,{variant:"h6",gutterBottom:!0,children:"Invoice Details"}),e.jsx(k,{sx:{mb:2}}),e.jsxs(x,{sx:{display:"grid",gap:2,gridTemplateColumns:"repeat(auto-fit, minmax(250px, 1fr))"},children:[e.jsx(g,{fullWidth:!0,label:"Church ID",type:"number",value:i.church_id,onChange:t=>_(p(m({},i),{church_id:Number(t.target.value)}))}),e.jsx(H,{label:"Issue Date",value:i.issue_date,onChange:t=>_(p(m({},i),{issue_date:t||new Date})),slotProps:{textField:{fullWidth:!0}}}),e.jsx(H,{label:"Due Date",value:i.due_date,onChange:t=>_(p(m({},i),{due_date:t||new Date})),slotProps:{textField:{fullWidth:!0}}}),e.jsxs(g,{select:!0,label:"Status",value:i.status,onChange:t=>_(p(m({},i),{status:t.target.value})),fullWidth:!0,children:[e.jsx(o,{value:"draft",children:"Draft"}),e.jsx(o,{value:"pending",children:"Pending"}),e.jsx(o,{value:"paid",children:"Paid"}),e.jsx(o,{value:"overdue",children:"Overdue"}),e.jsx(o,{value:"cancelled",children:"Cancelled"})]}),e.jsxs(g,{select:!0,label:"Currency",value:i.currency,onChange:t=>_(p(m({},i),{currency:t.target.value})),fullWidth:!0,children:[e.jsx(o,{value:"USD",children:"USD"}),e.jsx(o,{value:"EUR",children:"EUR"}),e.jsx(o,{value:"GBP",children:"GBP"})]}),e.jsxs(g,{select:!0,label:"Language",value:i.language,onChange:t=>_(p(m({},i),{language:t.target.value})),fullWidth:!0,children:[e.jsx(o,{value:"en",children:"English"}),e.jsx(o,{value:"el",children:"Greek"}),e.jsx(o,{value:"ru",children:"Russian"})]})]}),e.jsx(x,{sx:{mt:2},children:e.jsx(g,{label:"Internal Notes",multiline:!0,rows:3,value:i.internal_notes,onChange:t=>_(p(m({},i),{internal_notes:t.target.value})),fullWidth:!0})})]})})}),e.jsx(x,{sx:{flex:1},children:e.jsx(W,{children:e.jsxs(P,{children:[e.jsx(j,{variant:"h6",gutterBottom:!0,children:"Totals"}),e.jsx(k,{sx:{mb:2}}),e.jsxs(G,{spacing:2,children:[e.jsxs(x,{display:"flex",justifyContent:"space-between",children:[e.jsx(j,{children:"Subtotal:"}),e.jsxs(j,{fontWeight:"bold",children:["$",X.toFixed(2)]})]}),e.jsxs(x,{display:"flex",justifyContent:"space-between",children:[e.jsx(j,{children:"Tax:"}),e.jsxs(j,{fontWeight:"bold",children:["$",Y.toFixed(2)]})]}),e.jsx(k,{}),e.jsxs(x,{display:"flex",justifyContent:"space-between",children:[e.jsx(j,{variant:"h6",children:"Total:"}),e.jsxs(j,{variant:"h6",fontWeight:"bold",children:["$",Z.toFixed(2)]})]})]})]})})})]}),e.jsx(W,{children:e.jsxs(P,{children:[e.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(j,{variant:"h6",children:"Invoice Items"}),e.jsx(O,{variant:"contained",startIcon:e.jsx(_e,{}),onClick:q,children:"Add Item"})]}),e.jsx(fe,{component:ce,variant:"outlined",children:e.jsxs(Ie,{children:[e.jsx(ye,{children:e.jsxs(M,{children:[e.jsx(u,{children:"Item Code"}),e.jsx(u,{children:"Name"}),e.jsx(u,{children:"Description"}),e.jsx(u,{children:"Category"}),e.jsx(u,{children:"Quantity"}),e.jsx(u,{children:"Unit Price"}),e.jsx(u,{children:"Line Total"}),e.jsx(u,{children:"Actions"})]})}),e.jsx(be,{children:v.map((t,r)=>e.jsxs(M,{children:[e.jsx(u,{children:e.jsx(g,{size:"small",value:t.item_code,onChange:n=>y(r,"item_code",n.target.value)})}),e.jsx(u,{children:e.jsx(g,{size:"small",value:t.name,onChange:n=>y(r,"name",n.target.value)})}),e.jsx(u,{children:e.jsx(g,{size:"small",value:t.description,onChange:n=>y(r,"description",n.target.value)})}),e.jsx(u,{children:e.jsxs(g,{select:!0,size:"small",value:t.category,onChange:n=>y(r,"category",n.target.value),children:[e.jsx(o,{value:"service",children:"Service"}),e.jsx(o,{value:"product",children:"Product"}),e.jsx(o,{value:"subscription",children:"Subscription"}),e.jsx(o,{value:"addon",children:"Addon"}),e.jsx(o,{value:"discount",children:"Discount"}),e.jsx(o,{value:"tax",children:"Tax"}),e.jsx(o,{value:"fee",children:"Fee"})]})}),e.jsx(u,{children:e.jsx(g,{size:"small",type:"number",value:t.quantity,onChange:n=>y(r,"quantity",Number(n.target.value))})}),e.jsx(u,{children:e.jsx(g,{size:"small",type:"number",value:t.unit_price,onChange:n=>y(r,"unit_price",Number(n.target.value))})}),e.jsx(u,{children:e.jsxs(j,{fontWeight:"bold",children:["$",t.line_total.toFixed(2)]})}),e.jsx(u,{children:e.jsx(ue,{title:"Remove Item",children:e.jsx(de,{color:"error",onClick:()=>K(r),children:e.jsx(Ce,{})})})})]},r))})]})})]})})]})})},we=()=>e.jsx(De,{}),Te=[{to:"/",title:"Home"},{title:"Invoice Edit"}],rt=()=>e.jsx(pe,{children:e.jsxs(he,{title:"Edit Invoice",description:"this is Edit Invoice",children:[e.jsx(xe,{title:"Edit Invoice",items:Te}),e.jsx(Se,{children:e.jsx(P,{children:e.jsx(we,{})})})]})});export{rt as default};
//# sourceMappingURL=Edit-CMXP4RVJ.js.map
