var N=(r,o,y)=>new Promise((j,C)=>{var i=d=>{try{b(y.next(d))}catch(S){C(S)}},w=d=>{try{b(y.throw(d))}catch(S){C(S)}},b=d=>d.done?j(d.value):Promise.resolve(d.value).then(i,w);b((y=y.apply(r,o)).next())});import{k as ce,b9 as le,l as he,j as e,B as V,C as G,R as E,S as D,h as A,O as de,T as I,I as v,aI as me,e as g,$ as ue,d as xe}from"./index-CQJq875H.js";import{r as c}from"./vendor-DgfDxsY7.js";import{f as ge}from"./formatDate-DhH_eSW_.js";import{T as pe,a as B}from"./Tabs-Da3Qyh1W.js";import{I as fe}from"./InputAdornment-CNS_vxXH.js";import{I as je}from"./IconSearch-SCSVgCwv.js";import{I as be}from"./IconReport-Dh0mogcM.js";import{T as _e,a as ye,b as Ce,c as k,d as Se}from"./TableRow-DCPT_a5G.js";import{T as a}from"./TableCell-MgPOxDnu.js";import{I as Te}from"./IconEye-9sqyYNKE.js";import{I as we}from"./IconEdit-DVB0PrH1.js";import{I as Pe}from"./IconTrash-CiHBPOoG.js";import{T as Re}from"./TablePagination-CStzre4i.js";import"./KeyboardArrowRight-Z7vVVss9.js";import"./LastPage-Nfpn9sHk.js";import"./Toolbar-BixKUISM.js";const Ie=r=>{if(!r)return[];if(Array.isArray(r))return r;if(typeof r=="string")try{const o=JSON.parse(r);return Array.isArray(o)?o:[r]}catch(o){return r.trim()?[r]:[]}return[]},ve=r=>{const o=Ie(r);return o.length>0?o.join(", "):""},He=()=>{const{user:r}=ce(),[o,y]=le(),j=he(),C=o.get("church_id"),[i,w]=c.useState(C?parseInt(C):(r==null?void 0:r.church_id)||null),[b,d]=c.useState([]),[S,T]=c.useState(!0),[F,l]=c.useState(null),[z,R]=c.useState(0),[$,J]=c.useState(10),[W,O]=c.useState(0),[P,L]=c.useState(""),[h,H]=c.useState("marriage_date"),[m,M]=c.useState("desc");c.useEffect(()=>{const s=o.get("church_id");if(s){const t=parseInt(s);isNaN(t)||w(t)}else r!=null&&r.church_id&&w(r.church_id)},[o,r==null?void 0:r.church_id]),c.useEffect(()=>{r&&N(void 0,null,function*(){var p,u;let t=i;if(!t&&((r==null?void 0:r.role)==="super_admin"||(r==null?void 0:r.role)==="admin"))try{const n=yield fetch("/api/my/churches",{credentials:"include",headers:{"Content-Type":"application/json"}});if(n.ok){const x=yield n.json(),f=((p=x.data)==null?void 0:p.churches)||x.churches||[];if(f.length>0){if(t=f[0].id,!C){w(t),y({church_id:t.toString()},{replace:!0});return}}else{(r==null?void 0:r.role)==="super_admin"?l("No churches found in the system. Please create a church first."):l("No church available. Please ensure you have access to at least one church."),T(!1);return}}else{(r==null?void 0:r.role)==="super_admin"?l("Unable to load churches. Please try again or select a church manually."):l("No church available. Please ensure you have access to at least one church."),T(!1);return}}catch(n){console.error("Error fetching churches:",n),(r==null?void 0:r.role)==="super_admin"?l("Unable to load churches. Please try again or select a church manually."):l("No church available. Please ensure you have access to at least one church."),T(!1);return}if(!t){(r==null?void 0:r.role)!=="super_admin"?l("No church available. Please ensure you have access to at least one church."):l("Select a church to view records. Use the church_id query parameter or ensure churches are available."),T(!1);return}try{T(!0),l(null);const n=new URLSearchParams({page:(z+1).toString(),limit:$.toString()});P.trim()&&n.append("search",P.trim());const x=yield fetch(`/api/marriage-records?${n.toString()}`,{credentials:"include",headers:{"Content-Type":"application/json"}});if(!x.ok)throw new Error(`Failed to load records: ${x.status} ${x.statusText}`);const f=yield x.json();d(f.records||[]),O(((u=f.pagination)==null?void 0:u.total)||f.totalRecords||0)}catch(n){console.error("Error fetching marriage records:",n),l(n.message||"Failed to load marriage records")}finally{T(!1)}})},[r,i,z,$,P]);const Q=(s,t)=>{R(t)},q=s=>{J(parseInt(s.target.value,10)),R(0)},K=s=>{L(s.target.value),R(0)},X=(s,t)=>{const u=["baptism","marriage","funeral"][t],n=new URLSearchParams(o);n.set("church_id",(i==null?void 0:i.toString())||""),j(`/apps/records/${u}?${n.toString()}`)},_=s=>{h===s?M(m==="asc"?"desc":"asc"):(H(s),M("asc"))},Y=s=>{j(`/apps/records/marriage/${s}?church_id=${i}`)},Z=s=>{j(`/apps/records/marriage/edit/${s}?church_id=${i}`)},ee=s=>N(void 0,null,function*(){confirm("Are you sure you want to delete this record?")&&console.log("Delete record:",s)}),se=()=>{R(0),L(""),window.location.reload()},U=[...b].sort((s,t)=>{const p=s[h]||"",u=t[h]||"";return m==="asc"?p>u?1:-1:p<u?1:-1});return S&&b.length===0?e.jsx(V,{sx:{p:3,display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px"},children:e.jsx(G,{})}):e.jsxs(V,{sx:{p:3},children:[e.jsx(E,{sx:{mb:2},children:e.jsxs(pe,{value:1,onChange:X,sx:{borderBottom:1,borderColor:"divider"},children:[e.jsx(B,{label:"Baptism Records"}),e.jsx(B,{label:"Marriage Records"}),e.jsx(B,{label:"Funeral Records"})]})}),e.jsxs(D,{direction:"row",spacing:2,sx:{mb:2},children:[e.jsx(A,{label:`Total: ${W}`,color:"primary",variant:"outlined"}),e.jsx(A,{label:`Showing: ${b.length}`,color:"default",variant:"outlined"}),i&&e.jsx(A,{label:`Church ID: ${i}`,color:"secondary",variant:"outlined"})]}),e.jsx(E,{sx:{p:2,mb:2},children:e.jsxs(D,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(de,{placeholder:"Search records...",value:P,onChange:K,size:"small",sx:{flexGrow:1},InputProps:{startAdornment:e.jsx(fe,{position:"start",children:e.jsx(je,{size:20})})}}),e.jsx(I,{title:"Refresh",children:e.jsx(v,{onClick:se,children:e.jsx(me,{})})}),e.jsx(g,{variant:"contained",onClick:()=>j(`/apps/records/marriage/new?church_id=${i}`),children:"New Record"}),e.jsx(g,{variant:"outlined",startIcon:e.jsx(be,{size:18}),onClick:()=>j(`/apps/interactive-reports/create?recordType=marriage&churchId=${i}`),sx:{ml:1},children:"Generate Report"})]})}),F&&e.jsx(ue,{severity:"error",sx:{mb:2},onClose:()=>l(null),children:F}),e.jsxs(E,{sx:{p:3},children:[e.jsx(_e,{children:e.jsxs(ye,{children:[e.jsx(Ce,{children:e.jsxs(k,{children:[e.jsx(a,{children:e.jsxs(g,{size:"small",onClick:()=>_("id"),sx:{textTransform:"none",fontWeight:"bold"},children:["ID ",h==="id"&&(m==="asc"?"↑":"↓")]})}),e.jsx(a,{children:e.jsxs(g,{size:"small",onClick:()=>_("groom_first_name"),sx:{textTransform:"none",fontWeight:"bold"},children:["Groom ",h==="groom_first_name"&&(m==="asc"?"↑":"↓")]})}),e.jsx(a,{children:e.jsxs(g,{size:"small",onClick:()=>_("bride_first_name"),sx:{textTransform:"none",fontWeight:"bold"},children:["Bride ",h==="bride_first_name"&&(m==="asc"?"↑":"↓")]})}),e.jsx(a,{children:e.jsxs(g,{size:"small",onClick:()=>_("marriage_date"),sx:{textTransform:"none",fontWeight:"bold"},children:["Marriage Date ",h==="marriage_date"&&(m==="asc"?"↑":"↓")]})}),e.jsx(a,{children:e.jsxs(g,{size:"small",onClick:()=>_("marriage_place"),sx:{textTransform:"none",fontWeight:"bold"},children:["Location ",h==="marriage_place"&&(m==="asc"?"↑":"↓")]})}),e.jsx(a,{children:e.jsxs(g,{size:"small",onClick:()=>_("clergy"),sx:{textTransform:"none",fontWeight:"bold"},children:["Clergy ",h==="clergy"&&(m==="asc"?"↑":"↓")]})}),e.jsx(a,{children:e.jsxs(g,{size:"small",onClick:()=>_("witnesses"),sx:{textTransform:"none",fontWeight:"bold"},children:["Witnesses ",h==="witnesses"&&(m==="asc"?"↑":"↓")]})}),e.jsx(a,{align:"center",sx:{fontWeight:"bold"},children:"Actions"})]})}),e.jsx(Se,{children:S?e.jsx(k,{children:e.jsx(a,{colSpan:8,align:"center",children:e.jsx(G,{size:24})})}):U.length===0?e.jsx(k,{children:e.jsx(a,{colSpan:8,align:"center",children:e.jsx(xe,{color:"text.secondary",children:P?"No records found matching your search":"No records found"})})}):U.map(s=>{const t=s.groom_first||s.groom_first_name||"",p=s.groom_middle||"",u=s.groom_last||s.groom_last_name||"",n=s.groom_full||[t,p,u].filter(Boolean).join(" ").trim()||"-",x=s.bride_first||s.bride_first_name||"",f=s.bride_middle||"",re=s.bride_last||s.bride_last_name||"",ae=s.bride_full||[x,f,re].filter(Boolean).join(" ").trim()||"-",te=ge(s.marriage_date)||"-",ne=s.place_name||s.marriage_place||"-",oe=s.officiant_name||s.clergy||"-",ie=ve(s.witnesses)||"-";return e.jsxs(k,{hover:!0,children:[e.jsx(a,{children:s.id}),e.jsx(a,{children:n}),e.jsx(a,{children:ae}),e.jsx(a,{children:te}),e.jsx(a,{children:ne}),e.jsx(a,{children:oe}),e.jsx(a,{children:ie}),e.jsx(a,{align:"center",children:e.jsxs(D,{direction:"row",spacing:1,justifyContent:"center",children:[e.jsx(I,{title:"View",children:e.jsx(v,{size:"small",onClick:()=>Y(s.id),children:e.jsx(Te,{size:18})})}),e.jsx(I,{title:"Edit",children:e.jsx(v,{size:"small",onClick:()=>Z(s.id),children:e.jsx(we,{size:18})})}),e.jsx(I,{title:"Delete",children:e.jsx(v,{size:"small",color:"error",onClick:()=>ee(s.id),children:e.jsx(Pe,{size:18})})})]})})]},s.id)})})]})}),e.jsx(Re,{component:"div",count:W,page:z,onPageChange:Q,rowsPerPage:$,onRowsPerPageChange:q,rowsPerPageOptions:[10,25,50,100]})]})]})};export{He as default};
//# sourceMappingURL=MarriageRecordsPage-BCD0N88i.js.map
