var Ze=Object.defineProperty,es=Object.defineProperties;var ss=Object.getOwnPropertyDescriptors;var Ue=Object.getOwnPropertySymbols;var as=Object.prototype.hasOwnProperty,rs=Object.prototype.propertyIsEnumerable;var Ae=(i,v,a)=>v in i?Ze(i,v,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[v]=a,w=(i,v)=>{for(var a in v||(v={}))as.call(v,a)&&Ae(i,a,v[a]);if(Ue)for(var a of Ue(v))rs.call(v,a)&&Ae(i,a,v[a]);return i},b=(i,v)=>es(i,ss(v));var G=(i,v,a)=>new Promise((A,m)=>{var k=t=>{try{R(a.next(t))}catch(S){m(S)}},h=t=>{try{R(a.throw(t))}catch(S){m(S)}},R=t=>t.done?A(t.value):Promise.resolve(t.value).then(k,h);R((a=a.apply(i,v)).next())});import{c as me,k as Te,j as e,U as oe,Q as ce,d,B as P,C as ve,$ as D,S as _,F as we,r as he,e as ae,A as Re,D as is,p as ts,h as de,J as Le,Y as Oe,I as Z,K as ze,a3 as $e,O as I,a0 as Q,a1 as Y,a2 as X,f as u,aI as ls,cp as ns,a5 as Fe,T as ne}from"./index-CQJq875H.js";import{r as l}from"./vendor-DgfDxsY7.js";import{P as Me}from"./PageContainer-Dcom98rz.js";import{B as os}from"./Breadcrumb-DPJpPJYg.js";import{I as je}from"./IconUsers-BHdUejlj.js";import{I as cs}from"./IconCheck-DICc9aJH.js";import{L as ds}from"./ListItem-C0K_HsLZ.js";import{L as hs}from"./ListItemIcon-DQq1oJdL.js";import{L as ms}from"./ListItemText-CD7DWOrd.js";import{I as us}from"./IconBell-CKDU7WFt.js";import{I as We}from"./IconUserPlus-C4JQpon6.js";import{I as ps}from"./InputAdornment-CNS_vxXH.js";import{I as Ne}from"./IconEye-9sqyYNKE.js";import{u as V}from"./userService-CTt9kRkP.js";import{T as gs,a as ke}from"./Tabs-Da3Qyh1W.js";import{I as xs}from"./IconBuilding-Brclp70H.js";import{I as fs}from"./IconSearch-SCSVgCwv.js";import{T as js,a as vs,b as ws,c as Ee,d as bs}from"./TableRow-DCPT_a5G.js";import{T as O}from"./TableCell-MgPOxDnu.js";import{A as _s}from"./Avatar-B9iJRGlM.js";import{I as ys}from"./IconEdit-DVB0PrH1.js";import{I as Cs}from"./IconTrash-CiHBPOoG.js";import{T as Ss}from"./TablePagination-CStzre4i.js";import"./Helmet-DNWYwtrp.js";import"./index-BvdvJza9.js";import"./Breadcrumbs-CV3hf9fU.js";import"./Link-QuBZyEDj.js";import"./listItemButtonClasses-B2JwQewU.js";import"./KeyboardArrowRight-Z7vVVss9.js";import"./LastPage-Nfpn9sHk.js";import"./Toolbar-BixKUISM.js";/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const Is=[["path",{d:"M3 4m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z",key:"svg-0"}],["path",{d:"M7 8h10",key:"svg-1"}],["path",{d:"M7 12h10",key:"svg-2"}],["path",{d:"M7 16h10",key:"svg-3"}]],Ps=me("outline","article","Article",Is);/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const Us=[["path",{d:"M12 6l4 6l5 -4l-2 10h-14l-2 -10l5 4z",key:"svg-0"}]],As=me("outline","crown","Crown",Us);/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fs=[["path",{d:"M10.585 10.587a2 2 0 0 0 2.829 2.828",key:"svg-0"}],["path",{d:"M16.681 16.673a8.717 8.717 0 0 1 -4.681 1.327c-3.6 0 -6.6 -2 -9 -6c1.272 -2.12 2.712 -3.678 4.32 -4.674m2.86 -1.146a9.055 9.055 0 0 1 1.82 -.18c3.6 0 6.6 2 9 6c-.666 1.11 -1.379 2.067 -2.138 2.87",key:"svg-1"}],["path",{d:"M3 3l18 18",key:"svg-2"}]],Ms=me("outline","eye-off","EyeOff",Fs);/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const ks=[["path",{d:"M16.555 3.843l3.602 3.602a2.877 2.877 0 0 1 0 4.069l-2.643 2.643a2.877 2.877 0 0 1 -4.069 0l-.301 -.301l-6.558 6.558a2 2 0 0 1 -1.239 .578l-.175 .008h-1.172a1 1 0 0 1 -.993 -.883l-.007 -.117v-1.172a2 2 0 0 1 .467 -1.284l.119 -.13l.414 -.414h2v-2h2v-2l2.144 -2.144l-.301 -.301a2.877 2.877 0 0 1 0 -4.069l2.643 -2.643a2.877 2.877 0 0 1 4.069 0z",key:"svg-0"}],["path",{d:"M15 9h.01",key:"svg-1"}]],Es=me("outline","key","Key",ks);/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ts=[["path",{d:"M3 20l1.3 -3.9c-2.324 -3.437 -1.426 -7.872 2.1 -10.374c3.526 -2.501 8.59 -2.296 11.845 .48c3.255 2.777 3.695 7.266 1.029 10.501c-2.666 3.235 -7.615 4.215 -11.574 2.293l-4.7 1",key:"svg-0"}]],Rs=me("outline","message-circle","MessageCircle",Ts),Ls=({userId:i,userEmail:v,userRole:a,onPermissionsChanged:A})=>{const{isSuperAdmin:m}=Te(),[k,h]=l.useState(!1),[R,t]=l.useState([]),[S,y]=l.useState(!1),[E,g]=l.useState(""),[L,p]=l.useState(""),f=o=>{switch(o){case"social":return je;case"social.blog":return Ps;case"social.friends":return We;case"social.chat":return Rs;case"social.notifications":return us;default:return je}},z=()=>G(void 0,null,function*(){var o;try{h(!0),g("");const j=yield fetch(`/api/admin/social-permissions/user/${i}`,{credentials:"include"});if(j.ok){const U=yield j.json();if(U.success){t(U.socialPermissions||[]);const B=((o=U.socialPermissions)==null?void 0:o.some(ie=>ie.enabled))||!1;y(B),console.log("ðŸ“± Loaded social permissions:",U)}else g(U.message||"Failed to load social permissions")}else g("Failed to load social permissions")}catch(j){console.error("Error loading social permissions:",j),g("Failed to load social permissions")}finally{h(!1)}}),T=o=>G(void 0,null,function*(){if(!m()){g("Only super administrators can manage social permissions");return}try{h(!0),g(""),p("");const j=yield fetch(`/api/admin/social-permissions/user/${i}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({enabled:o,socialItems:R.map(U=>U.id)})});if(j.ok){const U=yield j.json();U.success?(y(o),p(U.message||`Social features ${o?"enabled":"disabled"} successfully`),yield z(),A&&A(),console.log("ðŸ“± Updated social permissions:",U)):g(U.message||"Failed to update social permissions")}else g("Failed to update social permissions")}catch(j){console.error("Error updating social permissions:",j),g("Failed to update social permissions")}finally{h(!1)}}),ee=()=>G(void 0,null,function*(){if(!m()){g("Only super administrators can manage social permissions");return}try{h(!0),g(""),p("");const o=yield fetch(`/api/admin/social-permissions/user/${i}/enable`,{method:"POST",credentials:"include"});if(o.ok){const j=yield o.json();j.success?(p(`Social features enabled for ${v}`),yield z(),A&&A(),console.log("ðŸ“± Quick enabled social features:",j)):g(j.message||"Failed to enable social features")}else g("Failed to enable social features")}catch(o){console.error("Error enabling social features:",o),g("Failed to enable social features")}finally{h(!1)}});return l.useEffect(()=>{i&&z()},[i]),l.useEffect(()=>{if(L){const o=setTimeout(()=>p(""),3e3);return()=>clearTimeout(o)}},[L]),l.useEffect(()=>{if(E){const o=setTimeout(()=>g(""),5e3);return()=>clearTimeout(o)}},[E]),m()?e.jsx(oe,{variant:"outlined",children:e.jsxs(ce,{children:[e.jsxs(P,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2},children:[e.jsxs(d,{variant:"h6",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(je,{size:20}),"Social Features"]}),k&&e.jsx(ve,{size:20})]}),E&&e.jsx(D,{severity:"error",sx:{mb:2},children:E}),L&&e.jsx(D,{severity:"success",sx:{mb:2},children:L}),e.jsxs(_,{spacing:2,children:[e.jsx(we,{control:e.jsx(he,{checked:S,onChange:o=>T(o.target.checked),disabled:k}),label:e.jsxs(P,{children:[e.jsx(d,{variant:"body1",children:"Enable Social Features"}),e.jsxs(d,{variant:"body2",color:"text.secondary",children:["Allow this user to access social features (role: ",a,")"]})]})}),e.jsxs(P,{sx:{display:"flex",gap:1},children:[e.jsx(ae,{variant:"outlined",size:"small",onClick:ee,disabled:k||S,startIcon:e.jsx(cs,{size:16}),children:"Quick Enable"}),e.jsx(ae,{variant:"outlined",size:"small",onClick:()=>T(!1),disabled:k||!S,startIcon:e.jsx(Re,{size:16}),children:"Disable All"})]}),R.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(is,{}),e.jsx(d,{variant:"subtitle2",color:"text.secondary",children:"Available Social Features:"}),e.jsx(ts,{dense:!0,children:R.map(o=>{const j=f(o.menu_key);return e.jsxs(ds,{sx:{py:.5},children:[e.jsx(hs,{sx:{minWidth:32},children:e.jsx(j,{size:18})}),e.jsx(ms,{primary:o.title,secondary:o.description,primaryTypographyProps:{variant:"body2"},secondaryTypographyProps:{variant:"caption"}}),e.jsx(de,{label:o.enabled?"Enabled":"Disabled",size:"small",color:o.enabled?"success":"default",variant:o.enabled?"filled":"outlined"})]},o.id)})})]}),e.jsx(P,{sx:{mt:2,p:1,bgcolor:"background.default",borderRadius:1},children:e.jsxs(d,{variant:"caption",color:"text.secondary",children:['Social features are managed per user role. Changes affect all users with the "',a,'" role.']})})]})]})}):e.jsx(oe,{variant:"outlined",children:e.jsx(ce,{children:e.jsx(d,{variant:"body2",color:"text.secondary",children:"Social permissions management is only available to super administrators."})})})},Os=({open:i,onClose:v,user:a,churches:A,mode:m,onSubmit:k,loading:h=!1,currentUserRole:R="admin"})=>{const[t,S]=l.useState({email:"",first_name:"",last_name:"",role:"user",church_id:null,preferred_language:"en",is_active:!0}),[y,E]=l.useState({new_password:"",confirm_password:"",auto_generate:!1}),[g,L]=l.useState(!1),[p,f]=l.useState({}),[z,T]=l.useState("");l.useEffect(()=>{console.log("ðŸ” UserFormModal - Modal open state changed:",i,"mode:",m),i&&a&&m==="edit"&&console.log("ðŸ” UserFormModal - Modal opened in edit mode with user:",JSON.stringify(a,null,2))},[i,m,a]),l.useEffect(()=>{if(a&&m==="edit"){console.log("ðŸ” UserFormModal - FULL DEBUG START"),console.log("ðŸ” User object:",JSON.stringify(a,null,2)),console.log("ðŸ” Churches array:",JSON.stringify(A,null,2)),console.log("ðŸ” User church_id:",a.church_id,"type:",typeof a.church_id);const r=a.church_id?a.church_id.toString():"";console.log("ðŸ” Converting to string:",r);const c=A.find(C=>C.id.toString()===r);console.log("ðŸ” Searching for church with ID matching:",r),console.log("ðŸ” Available church IDs:",A.map(C=>`${C.id} (${typeof C.id})`)),console.log("ðŸ” Matching church found:",c),console.log("ðŸ” UserFormModal - FULL DEBUG END"),S({email:a.email,first_name:a.first_name,last_name:a.last_name,role:a.role,church_id:r,preferred_language:a.preferred_language||"en",is_active:a.is_active})}},[a,m,A]),l.useEffect(()=>{i||(f({}),E({new_password:"",confirm_password:"",auto_generate:!1}),T(""),L(!1))},[i]);const ee=()=>{const r={};return t.email.trim()?/\S+@\S+\.\S+/.test(t.email)||(r.email="Please enter a valid email address"):r.email="Email is required",t.first_name.trim()||(r.first_name="First name is required"),t.last_name.trim()||(r.last_name="Last name is required"),t.role||(r.role="Role is required"),!t.church_id&&t.role!=="super_admin"&&t.role!=="admin"&&(r.church_id="Church selection is required"),f(r),Object.keys(r).length===0},o=()=>{const r={};return y.auto_generate||(y.new_password?y.new_password.length<8&&(r.new_password="Password must be at least 8 characters long"):r.new_password="New password is required",y.confirm_password?y.new_password!==y.confirm_password&&(r.confirm_password="Passwords do not match"):r.confirm_password="Please confirm the password"),f(r),Object.keys(r).length===0},j=()=>{const r="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";let C="";const se="abcdefghijklmnopqrstuvwxyz",ue="ABCDEFGHIJKLMNOPQRSTUVWXYZ",q="0123456789",H="!@#$%^&*";C+=se[Math.floor(Math.random()*se.length)],C+=ue[Math.floor(Math.random()*ue.length)],C+=q[Math.floor(Math.random()*q.length)],C+=H[Math.floor(Math.random()*H.length)];for(let W=4;W<16;W++)C+=r[Math.floor(Math.random()*r.length)];const J=C.split("").sort(()=>Math.random()-.5).join("");T(J),E(W=>b(w({},W),{new_password:J,confirm_password:J,auto_generate:!0}))},U=()=>{z&&navigator.clipboard.writeText(z)},B=()=>G(void 0,null,function*(){if(m==="edit"){if(!ee())return;yield k(t)}else if(m==="reset-password"){if(!o())return;yield k(y)}else m==="delete-confirm"&&(yield k({confirm:!0}))}),ie=r=>R==="super_admin"?r!=="super_admin":R==="admin"?!["admin","super_admin"].includes(r):!1,te=()=>{const r=[{value:"viewer",label:"Viewer",description:"Read-only access"},{value:"editor",label:"Editor",description:"Can edit records/content"},{value:"deacon",label:"Deacon",description:"Partial clergy privileges"},{value:"priest",label:"Priest",description:"Full clergy privileges"},{value:"church_admin",label:"Church Administrator",description:"Church-specific admin access"}];return R==="super_admin"&&r.push({value:"admin",label:"Administrator",description:"Platform administrative access"}),r},be=()=>{switch(m){case"view":return`View User: ${a==null?void 0:a.first_name} ${a==null?void 0:a.last_name}`;case"edit":return`Edit User: ${a==null?void 0:a.first_name} ${a==null?void 0:a.last_name}`;case"reset-password":return`Reset Password: ${a==null?void 0:a.first_name} ${a==null?void 0:a.last_name}`;case"delete-confirm":return`Delete User: ${a==null?void 0:a.first_name} ${a==null?void 0:a.last_name}`;default:return"User Management"}},le=()=>e.jsxs(P,{sx:{display:"flex",flexDirection:"column",gap:3,mt:1},children:[e.jsxs(_,{direction:"row",spacing:2,children:[e.jsx(I,{fullWidth:!0,label:"First Name",value:(a==null?void 0:a.first_name)||"",InputProps:{readOnly:!0},variant:"outlined"}),e.jsx(I,{fullWidth:!0,label:"Last Name",value:(a==null?void 0:a.last_name)||"",InputProps:{readOnly:!0},variant:"outlined"})]}),e.jsx(I,{fullWidth:!0,label:"Email",value:(a==null?void 0:a.email)||"",InputProps:{readOnly:!0},variant:"outlined"}),e.jsxs(_,{direction:"row",spacing:2,children:[e.jsx(I,{fullWidth:!0,label:"Role",value:(a==null?void 0:a.role)||"",InputProps:{readOnly:!0},variant:"outlined"}),e.jsx(I,{fullWidth:!0,label:"Church",value:(a==null?void 0:a.church_name)||"No Church",InputProps:{readOnly:!0},variant:"outlined"})]}),e.jsxs(_,{direction:"row",spacing:2,children:[e.jsx(I,{fullWidth:!0,label:"Status",value:a!=null&&a.is_active?"Active":"Inactive",InputProps:{readOnly:!0},variant:"outlined"}),e.jsx(I,{fullWidth:!0,label:"Last Login",value:a!=null&&a.last_login?new Date(a.last_login).toLocaleDateString():"Never",InputProps:{readOnly:!0},variant:"outlined"})]}),e.jsx(I,{fullWidth:!0,label:"Created At",value:a!=null&&a.created_at?new Date(a.created_at).toLocaleDateString():"Unknown",InputProps:{readOnly:!0},variant:"outlined"})]}),_e=()=>e.jsxs(P,{sx:{display:"flex",flexDirection:"column",gap:3,mt:1},children:[e.jsxs(_,{direction:"row",spacing:2,children:[e.jsx(I,{fullWidth:!0,label:"First Name",value:t.first_name,onChange:r=>S(c=>b(w({},c),{first_name:r.target.value})),error:!!p.first_name,helperText:p.first_name,disabled:h}),e.jsx(I,{fullWidth:!0,label:"Last Name",value:t.last_name,onChange:r=>S(c=>b(w({},c),{last_name:r.target.value})),error:!!p.last_name,helperText:p.last_name,disabled:h})]}),e.jsx(I,{fullWidth:!0,label:"Email",type:"email",value:t.email,onChange:r=>S(c=>b(w({},c),{email:r.target.value})),error:!!p.email,helperText:p.email||"User will be notified of email changes",disabled:h}),e.jsxs(_,{direction:"row",spacing:2,children:[e.jsxs(Q,{fullWidth:!0,error:!!p.role,children:[e.jsx(Y,{children:"Role"}),e.jsx(X,{value:t.role,label:"Role",onChange:r=>S(c=>b(w({},c),{role:r.target.value})),disabled:h||!ie(t.role),children:te().map(r=>e.jsx(u,{value:r.value,children:e.jsxs(P,{children:[e.jsx(d,{variant:"body1",children:r.label}),e.jsx(d,{variant:"caption",color:"text.secondary",children:r.description})]})},r.value))}),p.role&&e.jsx(d,{variant:"caption",color:"error",sx:{mt:1,ml:2},children:p.role})]}),e.jsxs(Q,{fullWidth:!0,required:t.role!=="super_admin"&&t.role!=="admin",error:!!p.church_id,children:[e.jsxs(Y,{children:["Church ",t.role!=="super_admin"&&t.role!=="admin"?"*":"(Optional - Global Access)"]}),e.jsxs(X,{value:t.church_id||"",label:`Church ${t.role!=="super_admin"&&t.role!=="admin"?"*":"(Optional - Global Access)"}`,onChange:r=>{const c=r.target.value;console.log("ðŸ” Church select changed to:",c,"type:",typeof c),S(C=>b(w({},C),{church_id:c||null}))},disabled:h,children:[e.jsx(u,{value:"",children:t.role==="super_admin"||t.role==="admin"?"No specific church (Global access)":"Select a church..."}),A.sort((r,c)=>r.name.localeCompare(c.name)).map(r=>{const c=t.church_id===r.id.toString();return console.log(`ðŸ” MenuItem church ${r.name} (${r.id}): value="${r.id.toString()}", selected=${c}, formData.church_id="${t.church_id}"`),e.jsxs(u,{value:r.id.toString(),children:[r.name," ",c?"âœ“":""]},r.id)})]}),p.church_id&&e.jsx(d,{variant:"caption",color:"error",sx:{mt:1,ml:2},children:p.church_id})]})]}),e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Language"}),e.jsxs(X,{value:t.preferred_language,label:"Language",onChange:r=>S(c=>b(w({},c),{preferred_language:r.target.value})),disabled:h,children:[e.jsx(u,{value:"en",children:"English"}),e.jsx(u,{value:"gr",children:"Greek"}),e.jsx(u,{value:"ru",children:"Russian"}),e.jsx(u,{value:"sr",children:"Serbian"}),e.jsx(u,{value:"bg",children:"Bulgarian"}),e.jsx(u,{value:"ro",children:"Romanian"})]})]}),e.jsx(we,{control:e.jsx(he,{checked:t.is_active,onChange:r=>S(c=>b(w({},c),{is_active:r.target.checked})),disabled:h}),label:e.jsxs(P,{children:[e.jsx(d,{variant:"body2",children:"Account Status"}),e.jsx(d,{variant:"caption",color:"text.secondary",children:t.is_active?"User can access the system":"User access is disabled"})]})})]}),re=()=>e.jsxs(P,{sx:{display:"flex",flexDirection:"column",gap:3,mt:1},children:[e.jsx(we,{control:e.jsx(he,{checked:y.auto_generate,onChange:r=>{const c=r.target.checked;E(C=>b(w({},C),{auto_generate:c})),c?j():(T(""),E(C=>b(w({},C),{new_password:"",confirm_password:""})))},disabled:h}),label:"Auto-generate secure password"}),y.auto_generate&&z&&e.jsxs(P,{sx:{p:2,bgcolor:"background.paper",border:1,borderColor:"divider",borderRadius:1},children:[e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",sx:{mb:1},children:[e.jsx(d,{variant:"subtitle2",color:"primary",children:"Generated Password:"}),e.jsx(Z,{size:"small",onClick:j,disabled:h,children:e.jsx(ls,{size:16})}),e.jsx(Z,{size:"small",onClick:U,disabled:h,children:e.jsx(ns,{size:16})})]}),e.jsx(d,{variant:"body2",sx:{fontFamily:"monospace",bgcolor:"grey.100",p:1,borderRadius:.5,wordBreak:"break-all"},children:z}),e.jsx(d,{variant:"caption",color:"text.secondary",children:"Make sure to copy this password as it won't be shown again."})]}),!y.auto_generate&&e.jsxs(e.Fragment,{children:[e.jsx(I,{fullWidth:!0,label:"New Password",type:g?"text":"password",value:y.new_password,onChange:r=>E(c=>b(w({},c),{new_password:r.target.value})),error:!!p.new_password,helperText:p.new_password||"Minimum 8 characters with uppercase, lowercase, number, and symbol",disabled:h,InputProps:{endAdornment:e.jsx(ps,{position:"end",children:e.jsx(Z,{onClick:()=>L(!g),disabled:h,children:g?e.jsx(Ms,{size:20}):e.jsx(Ne,{size:20})})})}}),e.jsx(I,{fullWidth:!0,label:"Confirm Password",type:g?"text":"password",value:y.confirm_password,onChange:r=>E(c=>b(w({},c),{confirm_password:r.target.value})),error:!!p.confirm_password,helperText:p.confirm_password,disabled:h})]}),e.jsx(D,{severity:"info",children:"The user will be notified via email about their password change and will be required to log in again."})]}),ye=()=>e.jsxs(P,{sx:{mt:1},children:[e.jsxs(D,{severity:"warning",sx:{mb:2},children:[e.jsx(d,{variant:"body1",gutterBottom:!0,children:e.jsx("strong",{children:"Are you sure you want to delete this user?"})}),e.jsx(d,{variant:"body2",children:"This action cannot be undone. The user will lose access to:"}),e.jsxs(P,{component:"ul",sx:{mt:1,mb:1},children:[e.jsx("li",{children:"All account data and settings"}),e.jsx("li",{children:"Access to church management system"}),e.jsx("li",{children:"Historical activity records"})]}),e.jsx(d,{variant:"body2",children:"Consider deactivating the user instead if you want to preserve their data."})]}),e.jsxs(P,{sx:{p:2,bgcolor:"background.paper",border:1,borderColor:"divider",borderRadius:1},children:[e.jsx(d,{variant:"subtitle2",gutterBottom:!0,children:"User Details:"}),e.jsxs(_,{spacing:1,children:[e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(d,{variant:"body2",children:e.jsx("strong",{children:"Name:"})}),e.jsxs(d,{variant:"body2",children:[a==null?void 0:a.first_name," ",a==null?void 0:a.last_name]})]}),e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(d,{variant:"body2",children:e.jsx("strong",{children:"Email:"})}),e.jsx(d,{variant:"body2",children:a==null?void 0:a.email})]}),e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(d,{variant:"body2",children:e.jsx("strong",{children:"Role:"})}),e.jsx(de,{size:"small",label:a==null?void 0:a.role,color:(a==null?void 0:a.role)==="admin"||(a==null?void 0:a.role)==="super_admin"?"error":"primary"})]}),e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(d,{variant:"body2",children:e.jsx("strong",{children:"Church:"})}),e.jsx(d,{variant:"body2",children:(a==null?void 0:a.church_name)||"No Church"})]})]})]})]});return e.jsxs(Le,{open:i,onClose:v,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{minHeight:m==="delete-confirm"?400:500}},children:[e.jsxs(Oe,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(d,{variant:"h6",children:be()}),e.jsx(Z,{onClick:v,disabled:h,children:e.jsx(Re,{size:20})})]}),e.jsxs(ze,{children:[m==="view"&&le(),m==="edit"&&_e(),m==="reset-password"&&re(),m==="delete-confirm"&&ye(),m==="edit"&&a&&e.jsx(P,{sx:{mt:3},children:e.jsx(Ls,{userId:a.id,userEmail:a.email,userRole:a.role})})]}),e.jsxs($e,{sx:{px:3,pb:3},children:[e.jsx(ae,{onClick:v,disabled:h,children:m==="view"?"Close":"Cancel"}),m!=="view"&&e.jsx(ae,{onClick:B,variant:"contained",color:m==="delete-confirm"?"error":"primary",disabled:h,startIcon:h?e.jsx(ve,{size:20}):void 0,children:h?"Processing...":m==="edit"?"Save Changes":m==="reset-password"?"Reset Password":"Delete User"})]})]})},xa=()=>{const{user:i,canCreateAdmins:v,canManageAllUsers:a,isSuperAdmin:A,isRootSuperAdmin:m,canManageUser:k,canPerformDestructiveOperation:h,canChangeRole:R}=Te(),[t,S]=l.useState([]),[y,E]=l.useState([]),[g,L]=l.useState(!1),[p,f]=l.useState(null),[z,T]=l.useState(null),[ee,o]=l.useState(0),[j,U]=l.useState(10),[B,ie]=l.useState(""),[te,be]=l.useState("all"),[le,_e]=l.useState("all"),[re,ye]=l.useState("all"),[r,c]=l.useState(0),[C,se]=l.useState(!1),[ue,q]=l.useState(!1),[H,J]=l.useState("edit"),[W,pe]=l.useState(null),[Be,Se]=l.useState(!1),[x,K]=l.useState({email:"",first_name:"",last_name:"",role:"viewer",church_id:"",phone:"",preferred_language:"en",send_welcome_email:!0}),ge=(i==null?void 0:i.role)==="admin"||(i==null?void 0:i.role)==="super_admin"||(i==null?void 0:i.role)==="church_admin",xe=s=>b(w({},s),{username:s.email,role:s.role,preferred_language:s.preferred_language||"en",timezone:s.timezone||void 0,church_id:s.church_id||void 0}),qe="superadmin@orthodoxmetrics.com";l.useEffect(()=>{ge&&fe()},[ge]);const fe=()=>G(void 0,null,function*(){var s,n,M;L(!0);try{console.log("ðŸ“Š Frontend: Loading data..."),console.log("ðŸ” Current user:",i),console.log("ðŸ” User role:",i==null?void 0:i.role),console.log("ðŸ” Is admin?",ge);try{const F=yield fetch("/api/admin/users",{credentials:"include"});if(console.log("ðŸ” Direct API test response status:",F.status),console.log("ðŸ” Direct API test response headers:",Object.fromEntries(F.headers.entries())),!F.ok){const Ce=yield F.text();console.log("ðŸ” Direct API test error body:",Ce)}}catch(F){console.log("ðŸ” Direct API test failed:",F)}const[$,N]=yield Promise.all([V.getUsers(),V.getChurches()]);console.log("ðŸ“Š Frontend: Users response:",$),$.success?(console.log("ðŸ“Š Frontend: Setting users to:",(s=$.users)==null?void 0:s.length,"users"),(n=$.users)==null||n.forEach((F,Ce)=>{console.log(`ðŸ‘¤ User ${Ce+1}: ${F.email} - is_active: ${F.is_active} (type: ${typeof F.is_active})`)}),S($.users||[])):(console.error("âŒ Users API failed:",$),f($.message||"Failed to load users")),N.success?(console.log("âœ… Churches loaded:",N.churches),console.log("ðŸ” Looking for Saints Peter and Paul:",(M=N.churches)==null?void 0:M.find(F=>F.name&&F.name.includes("Saints Peter and Paul"))),E(N.churches||[])):(console.error("âŒ Churches API failed:",N),console.error("âŒ Failed to load churches:",N.message),N.message===void 0?f("Failed to load churches: API returned undefined message (possible 401 error)"):f("Failed to load churches: "+N.message))}catch($){console.error("âŒ Error loading data:",$),f("Failed to load data")}finally{L(!1)}}),Ge=()=>G(void 0,null,function*(){if(!x.email.trim()){f("Email is required");return}if(!x.first_name.trim()){f("First name is required");return}if(!x.last_name.trim()){f("Last name is required");return}if(!x.role){f("Role is required");return}if(!x.church_id&&!["super_admin","admin"].includes(x.role)){f("Church selection is required for this role");return}try{L(!0);const s=yield V.createUser(x);s.success?(T(`User created successfully! ${s.tempPassword?`Temporary password: ${s.tempPassword}`:""}`),se(!1),K({email:"",first_name:"",last_name:"",role:"viewer",church_id:"",phone:"",preferred_language:"en",send_welcome_email:!0}),yield fe()):f(s.message||"Failed to create user")}catch(s){f("An error occurred while creating the user"),console.error("Error creating user:",s)}finally{L(!1)}}),Ve=s=>{pe(s),J("view"),q(!0)},De=s=>{console.log("ðŸ” EDIT USER CLICKED - userData received:",JSON.stringify(s,null,2)),console.log("ðŸ” userData.church_id:",s.church_id,"type:",typeof s.church_id),console.log("ðŸ” Current churches state:",y.length,"churches loaded"),pe(s),J("edit"),q(!0)},He=s=>{pe(s),J("reset-password"),q(!0)},Je=s=>{pe(s),J("delete-confirm"),q(!0)},Ke=s=>G(void 0,null,function*(){if(W)try{Se(!0);let n;H==="edit"?n=yield V.updateUser(W.id,s):H==="reset-password"?(n=yield V.resetPassword(W.id,s),n.success&&n.newPassword&&T(`Password reset successfully! New password: ${n.newPassword}`)):H==="delete-confirm"&&(n=yield V.deleteUser(W.id)),n!=null&&n.success?((H!=="reset-password"||!n.newPassword)&&T(n.message||"Operation completed successfully"),q(!1),yield fe()):f((n==null?void 0:n.message)||"Operation failed")}catch(n){f("An error occurred during the operation"),console.error("Error in modal operation:",n)}finally{Se(!1)}}),Qe=(s,n)=>G(void 0,null,function*(){try{console.log(`ðŸ”„ Frontend: Toggling user ${s} from ${n} to ${!n}`);const M=yield V.toggleUserStatus(s);console.log("ðŸ”„ Frontend: Toggle response:",M),M.success?(T(M.message||`User ${n?"deactivated":"activated"} successfully`),console.log("ðŸ”„ Frontend: Calling loadData to refresh users list..."),yield fe(),console.log("ðŸ”„ Frontend: loadData completed")):f(M.message||"Failed to update user status")}catch(M){f("An error occurred while updating user status"),console.error("Error toggling user status:",M)}}),Ie=t.filter(s=>{const n=(s.email||"").toLowerCase().includes(B.toLowerCase())||(s.first_name||"").toLowerCase().includes(B.toLowerCase())||(s.last_name||"").toLowerCase().includes(B.toLowerCase())||s.church_name&&s.church_name.toLowerCase().includes(B.toLowerCase()),M=te==="all"||s.role===te,$=le==="all"||s.church_id&&s.church_id.toString()===le,N=re==="all"||re==="active"&&s.is_active||re==="inactive"&&!s.is_active,F=A()||s.role!=="super_admin"&&s.role!=="admin"&&s.role!=="church_admin";return n&&M&&$&&N&&F}),Ye=Ie.slice(ee*j,ee*j+j),Pe=s=>s.email===qe;if(!ge)return e.jsx(Me,{title:"User Management",description:"Admin user management system",children:e.jsx(D,{severity:"error",children:"You do not have permission to access this page."})});const Xe=[{to:"/",title:"Home"},{to:"/admin",title:"Admin"},{title:"User Management"}];return e.jsxs(Me,{title:"User Management",description:"Manage users in the Orthodox Metrics system",children:[e.jsx(os,{title:"User Management",items:Xe}),e.jsxs(P,{p:3,children:[e.jsx(d,{variant:"h4",gutterBottom:!0,children:"User Management"}),e.jsx(Fe,{open:!!p,autoHideDuration:6e3,onClose:()=>f(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(D,{severity:"error",onClose:()=>f(null),children:p})}),e.jsx(Fe,{open:!!z,autoHideDuration:6e3,onClose:()=>T(null),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(D,{severity:"success",onClose:()=>T(null),children:z})}),e.jsxs(gs,{value:r,onChange:(s,n)=>c(n),sx:{mb:3},children:[e.jsx(ke,{icon:e.jsx(je,{}),label:"User Management"}),e.jsx(ke,{icon:e.jsx(xs,{}),label:"Church Management"})]}),r===0&&e.jsxs(e.Fragment,{children:[e.jsx(oe,{sx:{mb:3},children:e.jsx(ce,{children:e.jsxs(_,{direction:{xs:"column",md:"row"},spacing:2,alignItems:"center",children:[e.jsx(I,{sx:{flex:1,minWidth:250},placeholder:"Search users...",value:B,onChange:s=>ie(s.target.value),InputProps:{startAdornment:e.jsx(fs,{size:20})}}),e.jsxs(Q,{sx:{minWidth:120},children:[e.jsx(Y,{children:"Role"}),e.jsxs(X,{value:te,onChange:s=>be(s.target.value),label:"Role",children:[e.jsx(u,{value:"all",children:"All Roles"}),A()&&e.jsxs(e.Fragment,{children:[e.jsx(u,{value:"admin",children:"Admin"}),e.jsx(u,{value:"super_admin",children:"Super Admin"})]}),e.jsx(u,{value:"manager",children:"Manager"}),e.jsx(u,{value:"user",children:"User"}),e.jsx(u,{value:"viewer",children:"Viewer"})]})]}),e.jsxs(Q,{sx:{minWidth:150},children:[e.jsx(Y,{children:"Church"}),e.jsxs(X,{value:le,onChange:s=>_e(s.target.value),label:"Church",children:[e.jsx(u,{value:"all",children:"All Churches"}),y.map(s=>e.jsx(u,{value:s.id.toString(),children:s.name},s.id))]})]}),e.jsxs(Q,{sx:{minWidth:120},children:[e.jsx(Y,{children:"Status"}),e.jsxs(X,{value:re,onChange:s=>ye(s.target.value),label:"Status",children:[e.jsx(u,{value:"all",children:"All Status"}),e.jsx(u,{value:"active",children:"Active"}),e.jsx(u,{value:"inactive",children:"Inactive"})]})]}),e.jsx(ae,{variant:"contained",startIcon:e.jsx(We,{}),onClick:()=>se(!0),children:"Add User"})]})})}),e.jsx(oe,{children:e.jsx(ce,{children:g?e.jsx(P,{display:"flex",justifyContent:"center",p:3,children:e.jsx(ve,{})}):e.jsxs(e.Fragment,{children:[e.jsx(js,{children:e.jsxs(vs,{children:[e.jsx(ws,{children:e.jsxs(Ee,{children:[e.jsx(O,{children:"User"}),e.jsx(O,{children:"Role"}),e.jsx(O,{children:"Church"}),e.jsx(O,{children:"Status"}),e.jsx(O,{children:"Last Login"}),e.jsx(O,{align:"right",children:"Actions"})]})}),e.jsx(bs,{children:Ye.map(s=>{var n,M;return e.jsxs(Ee,{children:[e.jsx(O,{children:e.jsxs(_,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(_s,{sx:{bgcolor:"primary.main"},children:(((n=s.first_name)==null?void 0:n.charAt(0))||"")+(((M=s.last_name)==null?void 0:M.charAt(0))||"")}),e.jsxs(P,{children:[e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(d,{variant:"subtitle2",children:s.full_name||`${s.first_name||""} ${s.last_name||""}`.trim()||s.email}),Pe(s)&&e.jsx(ne,{title:"Root Super Admin",children:e.jsx(As,{size:16,style:{color:"#FFD700"}})})]}),e.jsx(d,{variant:"body2",color:"text.secondary",children:s.email})]})]})}),e.jsx(O,{children:e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(de,{label:s.role,size:"small",color:V.getRoleBadgeColor(s.role)}),Pe(s)&&e.jsx(de,{label:"ROOT",size:"small",sx:{bgcolor:"#FFD700",color:"#000",fontWeight:"bold",fontSize:"0.7rem"}})]})}),e.jsx(O,{children:s.church_name||"No Church"}),e.jsx(O,{children:e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(he,{checked:s.is_active,onChange:()=>Qe(s.id,s.is_active),size:"small",disabled:!h(xe(s))}),e.jsx(de,{label:s.is_active?"Active":"Inactive",size:"small",color:s.is_active?"success":"default"})]})}),e.jsx(O,{children:e.jsx(d,{variant:"body2",children:V.formatLastLogin(s.last_login)})}),e.jsx(O,{align:"right",children:e.jsxs(_,{direction:"row",spacing:1,children:[e.jsx(ne,{title:"View User",children:e.jsx(Z,{size:"small",onClick:()=>Ve(s),color:"info",children:e.jsx(Ne,{size:16})})}),k(xe(s))&&e.jsx(ne,{title:"Edit User",children:e.jsx(Z,{size:"small",onClick:()=>De(s),color:"primary",children:e.jsx(ys,{size:16})})}),k(xe(s))&&e.jsx(ne,{title:"Reset Password",children:e.jsx(Z,{size:"small",onClick:()=>He(s),color:"warning",children:e.jsx(Es,{size:16})})}),h(xe(s))&&e.jsx(ne,{title:"Delete User",children:e.jsx(Z,{size:"small",onClick:()=>Je(s),color:"error",children:e.jsx(Cs,{size:16})})})]})})]},s.id)})})]})}),e.jsx(Ss,{rowsPerPageOptions:[5,10,25,50],component:"div",count:Ie.length,rowsPerPage:j,page:ee,onPageChange:(s,n)=>o(n),onRowsPerPageChange:s=>{U(parseInt(s.target.value,10)),o(0)}})]})})})]}),r===1&&e.jsx(oe,{children:e.jsxs(ce,{children:[e.jsx(d,{variant:"h6",gutterBottom:!0,children:"Church Management"}),e.jsx(D,{severity:"info",children:"Church management features are coming soon."})]})})]}),e.jsxs(Le,{open:C,onClose:()=>se(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Oe,{children:"Create New User"}),e.jsx(ze,{children:e.jsxs(_,{spacing:3,sx:{mt:1},children:[p&&e.jsx(D,{severity:"error",onClose:()=>f(null),children:p}),e.jsxs(_,{direction:"row",spacing:2,children:[e.jsx(I,{fullWidth:!0,label:"First Name",value:x.first_name,onChange:s=>K(b(w({},x),{first_name:s.target.value}))}),e.jsx(I,{fullWidth:!0,label:"Last Name",value:x.last_name,onChange:s=>K(b(w({},x),{last_name:s.target.value}))})]}),e.jsx(I,{fullWidth:!0,label:"Email",type:"email",value:x.email,onChange:s=>K(b(w({},x),{email:s.target.value}))}),e.jsxs(_,{direction:"row",spacing:2,children:[e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Role"}),e.jsxs(X,{value:x.role,onChange:s=>K(b(w({},x),{role:s.target.value})),label:"Role",children:[e.jsx(u,{value:"viewer",children:"Viewer"}),e.jsx(u,{value:"editor",children:"Editor"}),e.jsx(u,{value:"deacon",children:"Deacon"}),e.jsx(u,{value:"priest",children:"Priest"}),e.jsx(u,{value:"church_admin",children:"Church Administrator"}),v()&&e.jsx(u,{value:"admin",children:"Platform Administrator"}),m()&&e.jsx(u,{value:"super_admin",children:"Super Administrator"})]})]}),e.jsxs(Q,{fullWidth:!0,required:!["super_admin","admin"].includes(x.role),children:[e.jsxs(Y,{children:["Church ",["super_admin","admin"].includes(x.role)?"(Optional - Global Access)":"*"]}),e.jsxs(X,{value:x.church_id,onChange:s=>K(b(w({},x),{church_id:s.target.value})),label:`Church ${["super_admin","admin"].includes(x.role)?"(Optional - Global Access)":"*"}`,children:[e.jsx(u,{value:"",children:["super_admin","admin"].includes(x.role)?"No specific church (Global Access)":"Select a church..."}),y.sort((s,n)=>s.name.localeCompare(n.name)).map(s=>e.jsx(u,{value:s.id.toString(),children:s.name},s.id))]})]})]}),e.jsx(I,{fullWidth:!0,label:"Phone",value:x.phone,onChange:s=>K(b(w({},x),{phone:s.target.value}))}),e.jsx(we,{control:e.jsx(he,{checked:x.send_welcome_email,onChange:s=>K(b(w({},x),{send_welcome_email:s.target.checked}))}),label:"Send welcome email with temporary password"})]})}),e.jsxs($e,{children:[e.jsx(ae,{onClick:()=>se(!1),children:"Cancel"}),e.jsx(ae,{onClick:Ge,variant:"contained",disabled:g,startIcon:g?e.jsx(ve,{size:20}):void 0,children:g?"Creating...":"Create User"})]})]}),e.jsx(Os,{open:ue,onClose:()=>q(!1),user:W,churches:y,mode:H,onSubmit:Ke,loading:Be,currentUserRole:i==null?void 0:i.role})]})};export{xa as default};
//# sourceMappingURL=UserManagement-CAnrfH6i.js.map
