var D=(g,R,h)=>new Promise((L,f)=>{var p=d=>{try{b(h.next(d))}catch(u){f(u)}},t=d=>{try{b(h.throw(d))}catch(u){f(u)}},b=d=>d.done?L(d.value):Promise.resolve(d.value).then(p,t);b((h=h.apply(g,R)).next())});import{m as _,j as e,B as a,d as s,e as K,aH as X,O as N,$ as k,C as Y,h as z,S as B,I as P,D as Z,R as M,a5 as ee}from"./index-BDfVhljI.js";import{r as n}from"./vendor-DgfDxsY7.js";import{P as re}from"./PageContainer-CRaXY1g0.js";import{B as te}from"./BlankCard-BXXDi4hm.js";import{B as se}from"./Breadcrumb-BksUUxoN.js";import{I as ae}from"./InputAdornment-ZC5rvhDf.js";import{S as ne}from"./Search-Dsdc-YTk.js";import{T as ie,a as m}from"./Tabs-VYJhMi1b.js";import{T as le,a as oe,b as ce,c as T,d as de}from"./TableRow-CY_CMYLL.js";import{T as i}from"./TableCell-Cc2Re30I.js";import{L as O}from"./LinearProgress-D2-YLZ1_.js";import{V as he}from"./Visibility-DyzL3Bo2.js";import{C as ue}from"./Cancel-nbrqRl5r.js";import{D as xe}from"./Drawer-BXEu_Uoo.js";import{C as pe}from"./Close-Cys3i2MM.js";import"./Helmet-DNWYwtrp.js";import"./index-BvdvJza9.js";import"./Breadcrumbs-neNWuVCu.js";import"./Link-UeZU0xE4.js";import"./KeyboardArrowRight-n0bX-S0N.js";const je=[{to:"/",title:"Home"},{title:"Interactive Report Jobs"}],ze=()=>{_();const[g,R]=n.useState([]),[h,L]=n.useState(!0),[f,p]=n.useState(null),[t,b]=n.useState(null),[d,u]=n.useState(!1),[I,G]=n.useState(""),[C,U]=n.useState(""),[S,$]=n.useState(""),[o,V]=n.useState("ALL"),[w,E]=n.useState(null),[H,W]=n.useState(0),j=n.useRef(null),c=n.useRef(null),A=n.useRef(!0);n.useEffect(()=>{const r=()=>{A.current=!document.hidden,A.current?x():c.current&&(clearInterval(c.current),c.current=null)};return document.addEventListener("visibilitychange",r),()=>{document.removeEventListener("visibilitychange",r)}},[]);const x=n.useCallback(()=>D(void 0,null,function*(){if(A.current)try{j.current&&j.current.abort(),j.current=new AbortController;const r=new URLSearchParams;o!=="ALL"&&r.append("status",o),C&&r.append("churchId",C),S&&r.append("reportId",S),I&&r.append("q",I),r.append("limit","50"),r.append("offset","0");const l=yield fetch(`/api/records/interactive-reports/jobs?${r.toString()}`,{signal:j.current.signal});if(l.status===401||l.status===403){p("Unauthorized. Please log in.");return}if(!l.ok)throw new Error(`Failed to fetch jobs: ${l.statusText}`);const y=yield l.json();R(y.items||[]),W(y.total||0),p(null)}catch(r){if(r.name==="AbortError")return;p(r.message||"Failed to load jobs")}finally{L(!1)}}),[o,C,S,I]);n.useEffect(()=>{x()},[x]),n.useEffect(()=>(c.current&&clearInterval(c.current),c.current=setInterval(()=>{A.current&&x()},5e3),()=>{c.current&&clearInterval(c.current)}),[x]),n.useEffect(()=>()=>{j.current&&j.current.abort(),c.current&&clearInterval(c.current)},[]);const Q=r=>D(void 0,null,function*(){try{const l=yield fetch(`/api/records/interactive-reports/jobs/${r}`);if(!l.ok)throw new Error("Failed to fetch job details");const y=yield l.json();b(y),u(!0)}catch(l){E({message:l.message||"Failed to load job details",severity:"error"})}}),q=r=>D(void 0,null,function*(){if(window.confirm("Are you sure you want to cancel this job?"))try{if(!(yield fetch(`/api/records/interactive-reports/jobs/${r}/cancel`,{method:"POST"})).ok)throw new Error("Failed to cancel job");E({message:"Job cancelled successfully",severity:"success"}),x()}catch(l){E({message:l.message||"Failed to cancel job",severity:"error"})}}),J=r=>{switch(r){case"COMPLETED":return"success";case"RUNNING":return"info";case"PENDING":return"warning";case"FAILED":return"error";case"CANCELLED":return"default";default:return"default"}},v=r=>r?new Date(r).toLocaleString():"N/A",F=g.filter(r=>o==="ALL"?!0:r.status===o);return e.jsxs(re,{title:"Interactive Report Jobs",description:"Monitor background jobs for interactive reports",children:[e.jsx(se,{title:"Interactive Report Jobs",items:je}),e.jsx(te,{children:e.jsxs(a,{sx:{p:3},children:[e.jsxs(a,{sx:{mb:3,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(s,{variant:"h4",children:"Interactive Report Jobs"}),e.jsx(K,{variant:"outlined",startIcon:e.jsx(X,{}),onClick:x,disabled:h,children:"Refresh"})]}),e.jsxs(a,{sx:{mb:3,display:"flex",gap:2,flexWrap:"wrap"},children:[e.jsx(N,{size:"small",placeholder:"Search jobs...",value:I,onChange:r=>G(r.target.value),InputProps:{startAdornment:e.jsx(ae,{position:"start",children:e.jsx(ne,{})})},sx:{minWidth:200}}),e.jsx(N,{size:"small",placeholder:"Church ID",value:C,onChange:r=>U(r.target.value),type:"number",sx:{width:120}}),e.jsx(N,{size:"small",placeholder:"Report ID",value:S,onChange:r=>$(r.target.value),sx:{width:200}})]}),e.jsx(a,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:e.jsxs(ie,{value:o==="ALL"?0:o==="PENDING"?1:o==="RUNNING"?2:o==="FAILED"?3:o==="COMPLETED"?4:5,onChange:(r,l)=>{V(["ALL","PENDING","RUNNING","FAILED","COMPLETED","CANCELLED"][l])},children:[e.jsx(m,{label:`All (${H})`}),e.jsx(m,{label:"Pending"}),e.jsx(m,{label:"Running"}),e.jsx(m,{label:"Failed"}),e.jsx(m,{label:"Completed"}),e.jsx(m,{label:"Cancelled"})]})}),f&&e.jsx(k,{severity:"error",sx:{mb:2},onClose:()=>p(null),children:f}),h&&g.length===0&&e.jsx(a,{sx:{display:"flex",justifyContent:"center",p:4},children:e.jsx(Y,{})}),!h&&e.jsx(le,{children:e.jsxs(oe,{children:[e.jsx(ce,{children:e.jsxs(T,{children:[e.jsx(i,{children:"Job ID"}),e.jsx(i,{children:"Type"}),e.jsx(i,{children:"Status"}),e.jsx(i,{children:"Progress"}),e.jsx(i,{children:"Attempts"}),e.jsx(i,{children:"Created"}),e.jsx(i,{children:"Updated"}),e.jsx(i,{children:"Actions"})]})}),e.jsx(de,{children:F.length===0?e.jsx(T,{children:e.jsx(i,{colSpan:8,align:"center",sx:{py:4},children:e.jsx(s,{variant:"body2",color:"text.secondary",children:"No jobs found. Create an interactive report to see jobs here."})})}):F.map(r=>e.jsxs(T,{hover:!0,children:[e.jsx(i,{children:r.id}),e.jsx(i,{children:r.jobType}),e.jsx(i,{children:e.jsx(z,{label:r.status,color:J(r.status),size:"small"})}),e.jsx(i,{children:e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1,minWidth:150},children:[e.jsx(O,{variant:"determinate",value:r.progress,sx:{flex:1,height:8,borderRadius:4}}),e.jsxs(s,{variant:"caption",sx:{minWidth:35},children:[r.progress,"%"]})]})}),e.jsxs(i,{children:[r.attempts," / ",r.maxAttempts]}),e.jsx(i,{children:v(r.createdAt)}),e.jsx(i,{children:v(r.updatedAt)}),e.jsx(i,{children:e.jsxs(B,{direction:"row",spacing:1,children:[e.jsx(P,{size:"small",onClick:()=>Q(r.id),title:"View Details",children:e.jsx(he,{fontSize:"small"})}),(r.status==="PENDING"||r.status==="RUNNING")&&e.jsx(P,{size:"small",onClick:()=>q(r.id),title:"Cancel Job",color:"error",children:e.jsx(ue,{fontSize:"small"})})]})})]},r.id))})]})})]})}),e.jsx(xe,{anchor:"right",open:d,onClose:()=>u(!1),PaperProps:{sx:{width:600}},children:e.jsxs(a,{sx:{p:3},children:[e.jsxs(a,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(s,{variant:"h5",children:"Job Details"}),e.jsx(P,{onClick:()=>u(!1),children:e.jsx(pe,{})})]}),t&&e.jsxs(B,{spacing:2,children:[e.jsx(Z,{}),e.jsxs(a,{children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Job ID"}),e.jsx(s,{variant:"body1",children:t.id})]}),e.jsxs(a,{children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Type"}),e.jsx(s,{variant:"body1",children:t.jobType})]}),e.jsxs(a,{children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Status"}),e.jsx(z,{label:t.status,color:J(t.status),size:"small"})]}),e.jsxs(a,{children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Progress"}),e.jsx(O,{variant:"determinate",value:t.progress,sx:{mt:1,height:8,borderRadius:4}}),e.jsxs(s,{variant:"caption",children:[t.progress,"%"]})]}),e.jsxs(a,{children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Attempts"}),e.jsxs(s,{variant:"body1",children:[t.attempts," / ",t.maxAttempts]})]}),e.jsxs(a,{children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Created"}),e.jsx(s,{variant:"body1",children:v(t.createdAt)})]}),t.startedAt&&e.jsxs(a,{children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Started"}),e.jsx(s,{variant:"body1",children:v(t.startedAt)})]}),t.finishedAt&&e.jsxs(a,{children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Finished"}),e.jsx(s,{variant:"body1",children:v(t.finishedAt)})]}),t.churchId&&e.jsxs(a,{children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Church ID"}),e.jsx(s,{variant:"body1",children:t.churchId})]}),t.reportId&&e.jsxs(a,{children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Report ID"}),e.jsx(s,{variant:"body1",children:t.reportId})]}),t.errorMessage&&e.jsxs(a,{children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Error Message"}),e.jsx(k,{severity:"error",sx:{mt:1},children:t.errorMessage})]}),t.payload&&e.jsxs(a,{children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Payload"}),e.jsx(M,{sx:{p:2,mt:1,bgcolor:"grey.50"},children:e.jsx("pre",{style:{margin:0,fontSize:"0.875rem",overflow:"auto"},children:JSON.stringify(t.payload,null,2)})})]}),t.result&&e.jsxs(a,{children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Result"}),e.jsx(M,{sx:{p:2,mt:1,bgcolor:"grey.50"},children:e.jsx("pre",{style:{margin:0,fontSize:"0.875rem",overflow:"auto"},children:JSON.stringify(t.result,null,2)})})]})]})]})}),e.jsx(ee,{open:!!w,autoHideDuration:6e3,onClose:()=>E(null),message:w==null?void 0:w.message})]})};export{ze as default};
//# sourceMappingURL=InteractiveReportJobsPage-3EqCNNNu.js.map
