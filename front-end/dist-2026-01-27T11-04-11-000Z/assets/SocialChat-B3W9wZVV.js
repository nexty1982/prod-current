var ve=Object.defineProperty,Ce=Object.defineProperties;var we=Object.getOwnPropertyDescriptors;var J=Object.getOwnPropertySymbols;var Ie=Object.prototype.hasOwnProperty,be=Object.prototype.propertyIsEnumerable;var V=(r,l,o)=>l in r?ve(r,l,{enumerable:!0,configurable:!0,writable:!0,value:o}):r[l]=o,v=(r,l)=>{for(var o in l||(l={}))Ie.call(l,o)&&V(r,o,l[o]);if(J)for(var o of J(l))be.call(l,o)&&V(r,o,l[o]);return r},C=(r,l)=>Ce(r,we(l));var u=(r,l,o)=>new Promise((T,_)=>{var a=x=>{try{w(o.next(x))}catch(f){_(f)}},b=x=>{try{w(o.throw(x))}catch(f){_(f)}},w=x=>x.done?T(x.value):Promise.resolve(x.value).then(a,b);w((o=o.apply(r,l)).next())});import{k as Se,l as Me,v as ze,j as t,U as Ee,B as h,O as D,p as q,d as p,e as R,h as X,S as g,I as z,R as Te,C as ke,M as Ae,f as Be,$ as Le}from"./index-BDfVhljI.js";import{r as c}from"./vendor-DgfDxsY7.js";import{P as De}from"./PageContainer-D68R9_Qt.js";import{B as Re}from"./Breadcrumb-BksUUxoN.js";import{s as y}from"./social.api-CuBdSZE7.js";import{I as Fe}from"./IconSearch-B_Nt8Cv2.js";import{L as Oe}from"./ListItem-CT-O2kow.js";import{L as Z}from"./ListItemAvatar-CmNO8Ku0.js";import{S as F}from"./Skeleton-DBJMna3S.js";import{L as ee}from"./ListItemText-ChoqKKOM.js";import{I as te}from"./IconMessage-DSWttVJ8.js";import{I as He}from"./IconUsers-QySA9rdu.js";import{L as $e}from"./ListItemButton-D_Q1X9Bc.js";import{B as Pe}from"./Badge-DJp7X618.js";import{A as O}from"./Avatar-TOicZKRH.js";import{f as Ne}from"./index-C1cWfy0P.js";import{I as We}from"./IconDots-BMRcBePT.js";import{I as Ge}from"./IconEdit-CBkoJ5aC.js";import{I as Ke}from"./IconTrash-J025iv32.js";import{I as Ue}from"./IconMoodSmile-DIWP6dao.js";import{I as Ye}from"./IconSend-6eQf8rds.js";import{i as se,a as re}from"./index-D_ik0EIw.js";import{f as E}from"./index-B8Cm0CAq.js";import"./Helmet-DNWYwtrp.js";import"./index-BvdvJza9.js";import"./Breadcrumbs-neNWuVCu.js";import"./Link-UeZU0xE4.js";import"./listItemButtonClasses-VSU-3nzN.js";import"./usePreviousProps-BWumOsHT.js";import"./index-B9SIr0Qh.js";import"./typeof-QjJsDpFa.js";import"./index-DmKFFksY.js";import"./index-B8a_guEX.js";import"./index-CZC6yX5H.js";import"./index-CCbV6T5K.js";const ie={like:"ðŸ‘",love:"â¤ï¸",laugh:"ðŸ˜‚",wow:"ðŸ˜²",sad:"ðŸ˜¢",angry:"ðŸ˜ ",pray:"ðŸ™",amen:"âœï¸"},Tt=()=>{const{user:r}=Se(),l=Me(),o=ze(),[T,_]=c.useState([]),[a,b]=c.useState(null),[w,x]=c.useState([]),[f,H]=c.useState(""),[ae,$]=c.useState(!1),[A,P]=c.useState(!1),[N,j]=c.useState(null),[ne,B]=c.useState(null),[W,k]=c.useState(""),[I,L]=c.useState(null),[S,oe]=c.useState(""),G=c.useRef(null),le=c.useRef(null),ce=[{to:"/",title:"Home"},{title:"Social"},{title:"Chat"}];c.useEffect(()=>{var s;de();const e=(s=o.state)==null?void 0:s.conversationId;e&&he(e)},[o.state]),c.useEffect(()=>{a&&(me(),xe())},[a]),c.useEffect(()=>{ge()},[w]);const de=()=>u(void 0,null,function*(){var e,s;try{$(!0),j(null);const i=yield y.chat.getConversations();_(i.conversations||[])}catch(i){console.error("Error fetching conversations:",i),j(((s=(e=i.response)==null?void 0:e.data)==null?void 0:s.message)||"Failed to load conversations")}finally{$(!1)}}),me=()=>u(void 0,null,function*(){var e,s;if(a)try{const i=yield y.chat.getMessages(a.id);x(i.messages||[])}catch(i){console.error("Error fetching messages:",i),j(((s=(e=i.response)==null?void 0:e.data)==null?void 0:s.message)||"Failed to load messages")}}),he=e=>u(void 0,null,function*(){const s=T.find(i=>i.id===e);if(s)b(s);else try{const d=(yield y.chat.getConversation(e)).conversation;b(d),_(n=>[d,...n.filter(m=>m.id!==e)])}catch(i){console.error("Error fetching conversation:",i)}}),xe=()=>u(void 0,null,function*(){if(a)try{yield y.chat.markAsRead(a.id),_(e=>e.map(s=>s.id===a.id?C(v({},s),{unread_count:0,last_read_at:new Date().toISOString()}):s))}catch(e){console.error("Error marking conversation as read:",e)}}),K=()=>u(void 0,null,function*(){var e,s;if(!(!a||!f.trim()))try{P(!0);const d=(yield y.chat.sendMessage(a.id,{content:f.trim(),message_type:"text"})).message;x(n=>[...n,d]),H(""),_(n=>n.map(m=>m.id===a.id?C(v({},m),{last_message_content:f.trim(),last_message_time:new Date().toISOString(),last_message_sender_id:r==null?void 0:r.id,last_activity:new Date().toISOString()}):m))}catch(i){console.error("Error sending message:",i),j(((s=(e=i.response)==null?void 0:e.data)==null?void 0:s.message)||"Failed to send message")}finally{P(!1)}}),pe=(e,s)=>u(void 0,null,function*(){var i,d;try{yield y.chat.editMessage(e,{content:s}),x(n=>n.map(m=>m.id===e?C(v({},m),{content:s,is_edited:!0}):m)),B(null),k("")}catch(n){console.error("Error editing message:",n),j(((d=(i=n.response)==null?void 0:i.data)==null?void 0:d.message)||"Failed to edit message")}}),fe=e=>u(void 0,null,function*(){var s,i;try{yield y.chat.deleteMessage(e),x(d=>d.map(n=>n.id===e?C(v({},n),{content:"This message was deleted",is_deleted:!0}):n))}catch(d){console.error("Error deleting message:",d),j(((i=(s=d.response)==null?void 0:s.data)==null?void 0:i.message)||"Failed to delete message")}}),ue=(e,s)=>u(void 0,null,function*(){var i,d;try{yield y.chat.reactToMessage(e,{reaction_type:s}),x(n=>n.map(m=>{var Q;return m.id===e?C(v({},m),{reactions:C(v({},m.reactions),{[s]:(((Q=m.reactions)==null?void 0:Q[s])||0)+1})}):m})),L(null)}catch(n){console.error("Error reacting to message:",n),j(((d=(i=n.response)==null?void 0:i.data)==null?void 0:d.message)||"Failed to react to message")}}),ge=()=>{var e;(e=G.current)==null||e.scrollIntoView({behavior:"smooth"})},M=e=>{if(e.type==="group")return e.name||"Group Chat";if(e.other_participant){const s=e.other_participant;return s.display_name||`${s.first_name} ${s.last_name}`}return"Direct Chat"},U=e=>{var s;return e.type==="group"?e.avatar_url:(s=e.other_participant)==null?void 0:s.profile_image_url},je=e=>{const s=new Date(e);return se(s)?E(s,"HH:mm"):re(s)?`Yesterday ${E(s,"HH:mm")}`:E(s,"MMM dd HH:mm")},ye=e=>{const s=new Date(e);return se(s)?E(s,"HH:mm"):re(s)?"Yesterday":E(s,"MMM dd")},_e=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),K())},Y=T.filter(e=>S===""||M(e).toLowerCase().includes(S.toLowerCase()));return t.jsxs(De,{title:"Chat",description:"Chat with friends",children:[t.jsx(Re,{title:"Chat",items:ce}),t.jsxs(Ee,{sx:{height:"calc(100vh - 200px)",display:"flex"},children:[t.jsxs(h,{sx:{width:320,borderRight:1,borderColor:"divider",display:"flex",flexDirection:"column"},children:[t.jsx(h,{sx:{p:2,borderBottom:1,borderColor:"divider"},children:t.jsx(D,{fullWidth:!0,size:"small",placeholder:"Search conversations...",value:S,onChange:e=>oe(e.target.value),InputProps:{startAdornment:t.jsx(Fe,{size:18,style:{marginRight:8}})}})}),t.jsx(h,{sx:{flexGrow:1,overflow:"auto"},children:ae?t.jsx(q,{children:[...Array(5)].map((e,s)=>t.jsxs(Oe,{children:[t.jsx(Z,{children:t.jsx(F,{variant:"circular",width:40,height:40})}),t.jsx(ee,{primary:t.jsx(F,{variant:"text",width:"60%"}),secondary:t.jsx(F,{variant:"text",width:"80%"})})]},s))}):Y.length===0?t.jsxs(h,{sx:{p:4,textAlign:"center"},children:[t.jsx(te,{size:48,color:"lightgray"}),t.jsx(p,{variant:"body2",color:"text.secondary",mt:2,children:S?"No conversations found":"No conversations yet"}),!S&&t.jsx(R,{variant:"outlined",size:"small",startIcon:t.jsx(He,{size:16}),onClick:()=>l("/social/friends"),sx:{mt:2},children:"Find Friends"})]}):t.jsx(q,{sx:{p:0},children:Y.map(e=>{var s;return t.jsxs($e,{selected:(a==null?void 0:a.id)===e.id,onClick:()=>b(e),sx:{py:2,px:2},children:[t.jsx(Z,{children:t.jsx(Pe,{overlap:"circular",anchorOrigin:{vertical:"bottom",horizontal:"right"},badgeContent:((s=e.other_participant)==null?void 0:s.is_online)&&t.jsx(h,{sx:{width:12,height:12,borderRadius:"50%",bgcolor:"success.main",border:"2px solid white"}}),children:t.jsx(O,{src:U(e),sx:{width:48,height:48},children:M(e)[0]})})}),t.jsx(ee,{primary:t.jsxs(h,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[t.jsx(p,{variant:"subtitle2",noWrap:!0,children:M(e)}),t.jsx(p,{variant:"caption",color:"text.secondary",children:e.last_message_time&&ye(e.last_message_time)})]}),secondary:t.jsxs(h,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[t.jsx(p,{variant:"body2",color:"text.secondary",noWrap:!0,sx:{flexGrow:1},children:e.last_message_content||"No messages yet"}),e.unread_count>0&&t.jsx(X,{label:e.unread_count,size:"small",color:"primary",sx:{ml:1,minWidth:20,height:20,fontSize:"0.75rem"}})]})})]},e.id)})})})]}),t.jsx(h,{sx:{flexGrow:1,display:"flex",flexDirection:"column"},children:a?t.jsxs(t.Fragment,{children:[t.jsx(h,{sx:{p:2,borderBottom:1,borderColor:"divider"},children:t.jsxs(g,{direction:"row",spacing:2,alignItems:"center",children:[t.jsx(O,{src:U(a),sx:{width:40,height:40},children:M(a)[0]}),t.jsxs(h,{flexGrow:1,children:[t.jsx(p,{variant:"h6",children:M(a)}),a.other_participant&&t.jsx(p,{variant:"caption",color:"text.secondary",children:a.other_participant.is_online?"Online":`Last seen ${Ne(new Date(a.other_participant.last_seen))} ago`})]}),t.jsx(z,{children:t.jsx(We,{size:20})})]})}),t.jsx(h,{sx:{flexGrow:1,overflow:"auto",p:2},children:t.jsxs(g,{spacing:2,children:[w.map(e=>t.jsx(h,{sx:{display:"flex",justifyContent:e.sender_id===(r==null?void 0:r.id)?"flex-end":"flex-start"},children:t.jsxs(h,{sx:{maxWidth:"70%"},children:[e.sender_id!==(r==null?void 0:r.id)&&t.jsxs(g,{direction:"row",spacing:1,alignItems:"center",mb:.5,children:[t.jsx(O,{src:e.sender.profile_image_url,sx:{width:24,height:24},children:e.sender.first_name[0]}),t.jsx(p,{variant:"caption",color:"text.secondary",children:e.sender.display_name||`${e.sender.first_name} ${e.sender.last_name}`})]}),t.jsxs(Te,{sx:{p:1.5,bgcolor:e.sender_id===(r==null?void 0:r.id)?"primary.main":"grey.100",color:e.sender_id===(r==null?void 0:r.id)?"primary.contrastText":"text.primary",position:"relative"},children:[ne===e.id?t.jsxs(g,{spacing:1,children:[t.jsx(D,{fullWidth:!0,multiline:!0,value:W,onChange:s=>k(s.target.value),size:"small"}),t.jsxs(g,{direction:"row",spacing:1,justifyContent:"flex-end",children:[t.jsx(R,{size:"small",onClick:()=>{B(null),k("")},children:"Cancel"}),t.jsx(R,{size:"small",variant:"contained",onClick:()=>pe(e.id,W),children:"Save"})]})]}):t.jsxs(t.Fragment,{children:[t.jsxs(p,{variant:"body2",children:[e.is_deleted?t.jsx("em",{style:{opacity:.7},children:"This message was deleted"}):e.content,e.is_edited&&!e.is_deleted&&t.jsx(p,{component:"span",variant:"caption",sx:{ml:1,opacity:.7},children:"(edited)"})]}),t.jsxs(g,{direction:"row",justifyContent:"space-between",alignItems:"center",mt:.5,children:[t.jsx(p,{variant:"caption",sx:{opacity:.7},children:je(e.created_at)}),e.sender_id===(r==null?void 0:r.id)&&!e.is_deleted&&t.jsxs(g,{direction:"row",spacing:.5,children:[t.jsx(z,{size:"small",onClick:()=>{B(e.id),k(e.content)},children:t.jsx(Ge,{size:14})}),t.jsx(z,{size:"small",onClick:()=>fe(e.id),children:t.jsx(Ke,{size:14})})]})]}),e.reactions&&Object.keys(e.reactions).length>0&&t.jsx(g,{direction:"row",spacing:.5,mt:1,children:Object.entries(e.reactions).map(([s,i])=>t.jsx(X,{label:`${ie[s]} ${i}`,size:"small",variant:"outlined"},s))})]}),!e.is_deleted&&t.jsx(z,{size:"small",sx:{position:"absolute",top:4,right:4,opacity:.7},onClick:s=>L({element:s.currentTarget,messageId:e.id}),children:t.jsx(Ue,{size:14})})]})]})},e.id)),t.jsx("div",{ref:G})]})}),t.jsx(h,{sx:{p:2,borderTop:1,borderColor:"divider"},children:t.jsxs(g,{direction:"row",spacing:1,alignItems:"flex-end",children:[t.jsx(D,{fullWidth:!0,multiline:!0,maxRows:4,placeholder:"Type a message...",value:f,onChange:e=>H(e.target.value),onKeyPress:_e,disabled:A,ref:le}),t.jsx(z,{color:"primary",onClick:K,disabled:!f.trim()||A,children:A?t.jsx(ke,{size:20}):t.jsx(Ye,{size:20})})]})})]}):t.jsxs(h,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",height:"100%",p:4},children:[t.jsx(te,{size:64,color:"lightgray"}),t.jsx(p,{variant:"h6",mt:2,color:"text.secondary",children:"Select a conversation to start chatting"}),t.jsx(p,{variant:"body2",color:"text.secondary",children:"Choose from your existing conversations or start a new one"})]})}),t.jsx(Ae,{anchorEl:I==null?void 0:I.element,open:!!I,onClose:()=>L(null),children:Object.entries(ie).map(([e,s])=>t.jsx(Be,{onClick:()=>I&&ue(I.messageId,e),children:t.jsxs(p,{variant:"body2",children:[s," ",e.charAt(0).toUpperCase()+e.slice(1)]})},e))})]}),N&&t.jsx(Le,{severity:"error",onClose:()=>j(null),sx:{position:"fixed",bottom:16,right:16,zIndex:1e3},children:N})]})};export{Tt as default};
//# sourceMappingURL=SocialChat-B3W9wZVV.js.map
