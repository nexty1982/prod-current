var ir=Object.defineProperty,cr=Object.defineProperties;var fr=Object.getOwnPropertyDescriptors;var G=Object.getOwnPropertySymbols;var dr=Object.prototype.hasOwnProperty,mr=Object.prototype.propertyIsEnumerable;var W=(o,a,t)=>a in o?ir(o,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[a]=t,_=(o,a)=>{for(var t in a||(a={}))dr.call(a,t)&&W(o,t,a[t]);if(G)for(var t of G(a))mr.call(a,t)&&W(o,t,a[t]);return o},q=(o,a)=>cr(o,fr(a));var S=(o,a,t)=>new Promise((C,N)=>{var x=i=>{try{c(t.next(i))}catch(u){N(u)}},v=i=>{try{c(t.throw(i))}catch(u){N(u)}},c=i=>i.done?C(i.value):Promise.resolve(i.value).then(x,v);c((t=t.apply(o,a)).next())});import{k as ur,j as gr}from"./index-CHjTtHW2.js";import{r as n}from"./vendor-DgfDxsY7.js";import{u as k}from"./index-B5AtgTPY.js";import{g as A}from"./globalFetcher-qMb07D1K.js";function $(o){if(!o||!(!!o.id||!!o.email||!!o.username))return!1;if(o.name){const t=o.name.trim();if(t&&t!=="Unknown User")return!0}return!!(o.email&&o.email.trim())}function pr(o){return{firstName:o.first_name||o.firstName||"",lastName:o.last_name||o.lastName||"",username:o.username||null,email:o.email||null,id:o.id||null}}const yr=n.createContext(void 0),y={posts:[],users:[],gallery:[],followers:[],search:"",loading:!0};function Ar({children:o}){const[a,t]=n.useState(y.posts),[C,N]=n.useState(y.users),[x,v]=n.useState(y.gallery),[c,i]=n.useState(y.followers),[u,B]=n.useState(y.search),[H,M]=n.useState(null),[Q,E]=n.useState(y.loading),{user:s}=ur(),h=(s==null?void 0:s.id)||1,F=()=>{if(s)return{name:s.first_name&&s.last_name?`${s.first_name} ${s.last_name}`.trim():s.username||s.email||"User",role:s.role||"User",avatar:"/orthodox/avatars/default.svg",coverImage:"/orthodox/banners/default.svg",postsCount:0,followersCount:0,followingCount:0};try{const r=localStorage.getItem("orthodoxmetrics_profile_data");if(r)return JSON.parse(r)}catch(r){console.error("Error loading profile from localStorage:",r)}return{name:"User",role:"User",avatar:"/orthodox/avatars/default.svg",coverImage:"/orthodox/banners/default.svg",postsCount:0,followersCount:0,followingCount:0}},g=F(),[R,U]=n.useState(g);n.useEffect(()=>{const r=F();U(r)},[s==null?void 0:s.id]);const T=`/api/om/profile/${h}`,V=`/api/om/profile/${h}/posts?page=1&limit=50`,X=`/api/om/profile/${h}/gallery`,Y=`/api/om/profile/${h}/followers`,{data:p,isLoading:J,error:I}=k(T,A),{data:f,isLoading:K,error:L,mutate:wr}=k(V,A),{data:d,isLoading:O,error:P}=k(X,A),{data:m,isLoading:j,error:D}=k(Y,A);n.useEffect(()=>{if(p&&f&&d&&m){if(p&&p.ok&&p.profile){const r=p.profile,e=pr(r),b={name:`${e.firstName||""} ${e.lastName||""}`.trim()||e.username||e.email||"Unknown User",role:r.role||"User",avatar:r.avatarUrl||r.avatar_url||g.avatar,coverImage:r.bannerUrl||r.banner_url||g.coverImage,postsCount:g.postsCount,followersCount:g.followersCount,followingCount:g.followingCount,id:e.id,email:e.email||void 0,username:e.username||void 0};if(U(b),$(b))try{localStorage.setItem("orthodoxmetrics_profile_data",JSON.stringify(b))}catch(w){console.error("Error saving profile to localStorage:",w)}else{console.warn("Skipping localStorage save: profile is not persistable (fallback detected)");try{const w=localStorage.getItem("orthodoxmetrics_profile_data");if(w){const nr=JSON.parse(w);$(nr)||(localStorage.removeItem("orthodoxmetrics_profile_data"),console.log("Removed invalid stored profile from localStorage"))}}catch(w){}}}f&&f.ok&&f.rows&&Array.isArray(f.rows)&&t(f.rows),d&&d.ok&&d.rows&&Array.isArray(d.rows)&&v(d.rows),m&&m.ok&&m.rows&&Array.isArray(m.rows)&&i(m.rows),E(!1)}else I||L||P||D?(M(I||L||P||D),E(!1)):E(J||K||O||j)},[p,f,d,m,J,K,O,j,I,L,P,D]);const Z=r=>{v(e=>!e||!Array.isArray(e)?[r]:[...e,r])},rr=r=>{i(e=>!e||!Array.isArray(e)?[]:e.map(l=>l&&l.id===r?q(_({},l),{isFollowed:!l.isFollowed}):l))},or=()=>c&&Array.isArray(c)?c.filter(r=>r.name&&r.name.toLowerCase().includes(u.toLowerCase())):c||[],er=(r,e)=>S(this,null,function*(){try{console.log("Adding comment:",{postId:r,comment:e})}catch(l){console.error("Error adding comment:",l)}}),tr=(r,e,l)=>S(this,null,function*(){try{console.log("Adding reply:",{postId:r,commentId:e,reply:l})}catch(z){console.error("Error adding reply:",z)}}),ar=r=>S(this,null,function*(){try{console.log("Liking post:",{postId:r})}catch(e){console.error("Error liking post:",e)}}),sr=(r,e)=>S(this,null,function*(){try{console.log("Liking reply:",{postId:r,commentId:e})}catch(l){console.error("Error liking reply:",l)}}),lr=r=>{const e=_(_({},R),r);if(U(e),$(e))try{localStorage.setItem("orthodoxmetrics_profile_data",JSON.stringify(e))}catch(l){console.error("Error saving profile to localStorage:",l)}else console.warn("Skipping localStorage save: updated profile is not persistable (fallback detected)");console.log("Updating profile data:",r)};return gr.jsx(yr.Provider,{value:{posts:a,users:C,error:H,gallery:x,loading:Q,profileData:R,addGalleryItem:Z,addReply:tr,likePost:ar,addComment:er,likeReply:sr,followers:or(),toggleFollow:rr,setSearch:B,search:u,updateProfileData:lr},children:o})}export{yr as U,Ar as a};
//# sourceMappingURL=index-vG--mgsr.js.map
