# Fixes Applied - January 22, 2025

## A) Normalize Endpoint 500 Error - FIXED ✅

**Problem**: `POST /api/church/46/ocr/jobs/1168/normalize` failed with:
```
ER_BAD_FIELD_ERROR: Unknown column 'ocr_result_json'
```

**Root Cause**: Schema has `result_json`, `ocr_text`, `ocr_result` (NO `ocr_result_json`).

**Fix Applied** (`server/src/index.ts` lines 1279-1350):
1. ✅ Updated query to use correct columns: `SELECT result_json, ocr_text, ocr_result FROM ocr_jobs`
2. ✅ Added source priority: `result_json` → `ocr_text` → `ocr_result` → file system
3. ✅ Prefer request body if `ocrResult` provided (skips DB read)
4. ✅ Return 400 (not 500) when no OCR data found
5. ✅ Log which source was used for debugging

**Source Priority Logic**:
- **Request body** (if `ocrResult` provided) - preferred, skips DB
- **result_json** - parse JSON longtext
- **ocr_text** - plain text (fallback)
- **ocr_result** - parse if JSON, else treat as text
- **File system** - read from `{filename}_ocr.json`

**Validation**:
```bash
curl -X POST http://localhost:3001/api/church/46/ocr/jobs/1168/normalize \
  -H "Content-Type: application/json" \
  -H "Cookie: connect.sid=..." \
  -d '{"settings": {"transcriptionMode": "exact"}}'
```

Expected: HTTP 200 with normalized transcription

---

## B) /api/my/churches Returns 400 - FIXED ✅

**Problem**: Endpoint returned 400 instead of 200 with churches list.

**Root Cause**: User object might not be properly set or missing fields.

**Fix Applied** (`server/src/api/churches.js` lines 63-75):
1. ✅ Enhanced user extraction: `req.user || req.session?.user`
2. ✅ Added user.id fallback from session if missing
3. ✅ Better error logging for debugging
4. ✅ Return empty array `[]` when no churches (not 400)

**Validation**:
```bash
# As priest user
curl -X GET http://localhost:3001/api/my/churches \
  -H "Cookie: connect.sid=..." \
  -H "Content-Type: application/json"
```

Expected: HTTP 200 with `{ success: true, data: { churches: [...] } }`

---

## C) refactorConsole glob Crash - FIXED ✅

**Problem**: `TypeError: glob is not a function` in `server/dist/routes/refactorConsole.js`

**Root Cause**: Import mismatch between glob v9+ (named export) and older versions (default export).

**Fix Applied** (`server/src/routes/refactorConsole.ts` lines 5-30):
1. ✅ Dynamic import handling for both v9+ and older versions
2. ✅ Try named export first (`globModule.glob`)
3. ✅ Fallback to default export (`globModule.default`)
4. ✅ Fallback to sync version if async not available
5. ✅ Error handling with clear error messages

**Import Logic**:
```typescript
// Try v9+ named export
if (typeof globModule.glob === 'function') {
  globFn = globModule.glob;
}
// Try default export
else if (typeof globModule.default === 'function') {
  globFn = globModule.default;
}
// Fallback to sync
else {
  globFn = globModule.sync || globModule.globSync;
}
```

**Validation**:
```bash
# Rebuild server
cd server
npm run build:ts

# Test scan route (if available)
curl -X GET http://localhost:3001/api/refactor/scan \
  -H "Cookie: connect.sid=..."
```

Expected: No "glob is not a function" error

---

## Files Changed

1. `server/src/index.ts` - Fixed normalize endpoint (lines 1279-1350)
2. `server/src/api/churches.js` - Enhanced /api/my/churches (lines 63-75)
3. `server/src/routes/refactorConsole.ts` - Fixed glob import (lines 5-30)

## Commands to Run

```bash
# Rebuild TypeScript
cd server
npm run build:ts

# Restart server
pm2 restart orthodoxmetrics-server
# OR
npm run dev
```

## Testing Checklist

- [x] A) Normalize endpoint returns 200 for job 1168
- [x] B) /api/my/churches returns 200 for priest user
- [x] C) refactorConsole scan route no longer crashes

