{"version":3,"file":"EnhancedOCRUploader-BrLj_mgR.js","sources":["../../node_modules/@tabler/icons-react/dist/esm/icons/IconMaximize.mjs","../../node_modules/@tabler/icons-react/dist/esm/icons/IconPlayerPause.mjs","../../node_modules/@tabler/icons-react/dist/esm/icons/IconRotateClockwise.mjs","../../node_modules/@tabler/icons-react/dist/esm/icons/IconZoomOut.mjs","../../src/features/devel-tools/om-ocr/components/RecordSchemaInfoPopover.tsx","../../src/features/devel-tools/om-ocr/hooks/useOcrJobs.ts","../../src/features/devel-tools/om-ocr/context/WorkbenchContext.tsx","../../src/features/devel-tools/om-ocr/utils/recordTypeDetector.ts","../../src/features/devel-tools/om-ocr/components/workbench/WorkbenchHeader.tsx","../../src/features/devel-tools/om-ocr/utils/imageViewportMetrics.ts","../../src/features/devel-tools/om-ocr/components/EditableBBox.tsx","../../src/features/devel-tools/om-ocr/components/FusionOverlay.tsx","../../src/features/devel-tools/om-ocr/utils/visionParser.ts","../../src/features/devel-tools/om-ocr/components/workbench/WorkbenchViewer.tsx","../../src/features/devel-tools/om-ocr/components/workbench/UnifiedJobsList.tsx","../../src/features/devel-tools/om-ocr/utils/displayNormalizer.ts","../../src/features/devel-tools/om-ocr/utils/useServerNormalization.ts","../../src/features/devel-tools/om-ocr/components/TranscriptionPanel.tsx","../../src/features/devel-tools/om-ocr/components/workbench/OcrWorkbench.tsx","../../src/features/devel-tools/om-ocr/context/OcrSelectionContext.tsx","../../src/features/devel-tools/om-ocr/components/OcrSetupGate.tsx","../../src/features/devel-tools/om-ocr/EnhancedOCRUploader.tsx"],"sourcesContent":["/**\n * @license @tabler/icons-react v3.36.1 - MIT\n *\n * This source code is licensed under the MIT license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createReactComponent from '../createReactComponent.mjs';\n\nconst __iconNode = [[\"path\", { \"d\": \"M4 8v-2a2 2 0 0 1 2 -2h2\", \"key\": \"svg-0\" }], [\"path\", { \"d\": \"M4 16v2a2 2 0 0 0 2 2h2\", \"key\": \"svg-1\" }], [\"path\", { \"d\": \"M16 4h2a2 2 0 0 1 2 2v2\", \"key\": \"svg-2\" }], [\"path\", { \"d\": \"M16 20h2a2 2 0 0 0 2 -2v-2\", \"key\": \"svg-3\" }]];\nconst IconMaximize = createReactComponent(\"outline\", \"maximize\", \"Maximize\", __iconNode);\n\nexport { __iconNode, IconMaximize as default };\n//# sourceMappingURL=IconMaximize.mjs.map\n","/**\n * @license @tabler/icons-react v3.36.1 - MIT\n *\n * This source code is licensed under the MIT license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createReactComponent from '../createReactComponent.mjs';\n\nconst __iconNode = [[\"path\", { \"d\": \"M6 6a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1l0 -12\", \"key\": \"svg-0\" }], [\"path\", { \"d\": \"M14 6a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1l0 -12\", \"key\": \"svg-1\" }]];\nconst IconPlayerPause = createReactComponent(\"outline\", \"player-pause\", \"PlayerPause\", __iconNode);\n\nexport { __iconNode, IconPlayerPause as default };\n//# sourceMappingURL=IconPlayerPause.mjs.map\n","/**\n * @license @tabler/icons-react v3.36.1 - MIT\n *\n * This source code is licensed under the MIT license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createReactComponent from '../createReactComponent.mjs';\n\nconst __iconNode = [[\"path\", { \"d\": \"M4.05 11a8 8 0 1 1 .5 4m-.5 5v-5h5\", \"key\": \"svg-0\" }]];\nconst IconRotateClockwise = createReactComponent(\"outline\", \"rotate-clockwise\", \"RotateClockwise\", __iconNode);\n\nexport { __iconNode, IconRotateClockwise as default };\n//# sourceMappingURL=IconRotateClockwise.mjs.map\n","/**\n * @license @tabler/icons-react v3.36.1 - MIT\n *\n * This source code is licensed under the MIT license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createReactComponent from '../createReactComponent.mjs';\n\nconst __iconNode = [[\"path\", { \"d\": \"M3 10a7 7 0 1 0 14 0a7 7 0 1 0 -14 0\", \"key\": \"svg-0\" }], [\"path\", { \"d\": \"M7 10l6 0\", \"key\": \"svg-1\" }], [\"path\", { \"d\": \"M21 21l-6 -6\", \"key\": \"svg-2\" }]];\nconst IconZoomOut = createReactComponent(\"outline\", \"zoom-out\", \"ZoomOut\", __iconNode);\n\nexport { __iconNode, IconZoomOut as default };\n//# sourceMappingURL=IconZoomOut.mjs.map\n","/**\r\n * RecordSchemaInfoPopover\r\n * Rich popover component that displays schema preview images for record types\r\n * Shows on hover/focus of an info trigger\r\n */\r\n\r\nimport React, { useState, useRef } from 'react';\r\nimport {\r\n  Popover,\r\n  Box,\r\n  Typography,\r\n  useTheme,\r\n} from '@mui/material';\r\nimport { IconInfoCircle } from '@tabler/icons-react';\r\n\r\ninterface RecordSchemaInfoPopoverProps {\r\n  title: string;\r\n  imageSrc: string;\r\n  maxWidth?: number;\r\n  children?: React.ReactNode;\r\n}\r\n\r\nexport const RecordSchemaInfoPopover: React.FC<RecordSchemaInfoPopoverProps> = ({\r\n  title,\r\n  imageSrc,\r\n  maxWidth = 600,\r\n  children,\r\n}) => {\r\n  const theme = useTheme();\r\n  const [anchorEl, setAnchorEl] = useState<HTMLElement | null>(null);\r\n  const timeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n  const open = Boolean(anchorEl);\r\n\r\n  const handleOpen = (event: React.MouseEvent<HTMLElement> | React.FocusEvent<HTMLElement>) => {\r\n    // Clear any pending timeout\r\n    if (timeoutRef.current) {\r\n      clearTimeout(timeoutRef.current);\r\n      timeoutRef.current = null;\r\n    }\r\n    setAnchorEl(event.currentTarget);\r\n  };\r\n\r\n  const handleClose = () => {\r\n    // Small delay to allow mouse to move to popover\r\n    timeoutRef.current = setTimeout(() => {\r\n      setAnchorEl(null);\r\n    }, 100);\r\n  };\r\n\r\n  const handlePopoverEnter = () => {\r\n    // Cancel close if mouse enters popover\r\n    if (timeoutRef.current) {\r\n      clearTimeout(timeoutRef.current);\r\n      timeoutRef.current = null;\r\n    }\r\n  };\r\n\r\n  const handlePopoverLeave = () => {\r\n    handleClose();\r\n  };\r\n\r\n  const handleKeyDown = (event: React.KeyboardEvent) => {\r\n    if (event.key === 'Escape') {\r\n      setAnchorEl(null);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <Box\r\n        component=\"span\"\r\n        onMouseEnter={handleOpen}\r\n        onMouseLeave={handleClose}\r\n        onFocus={handleOpen}\r\n        onBlur={handleClose}\r\n        onKeyDown={handleKeyDown}\r\n        sx={{\r\n          display: 'inline-flex',\r\n          alignItems: 'center',\r\n          cursor: 'pointer',\r\n          color: 'primary.main',\r\n          '&:hover': {\r\n            color: 'primary.dark',\r\n          },\r\n        }}\r\n        aria-label={`Show schema info for ${title}`}\r\n        tabIndex={0}\r\n      >\r\n        {children || <IconInfoCircle size={18} />}\r\n      </Box>\r\n\r\n      <Popover\r\n        open={open}\r\n        anchorEl={anchorEl}\r\n        onClose={() => setAnchorEl(null)}\r\n        anchorOrigin={{\r\n          vertical: 'bottom',\r\n          horizontal: 'left',\r\n        }}\r\n        transformOrigin={{\r\n          vertical: 'top',\r\n          horizontal: 'left',\r\n        }}\r\n        onMouseEnter={handlePopoverEnter}\r\n        onMouseLeave={handlePopoverLeave}\r\n        sx={{\r\n          pointerEvents: 'auto',\r\n          '& .MuiPopover-paper': {\r\n            maxWidth: `${maxWidth}px`,\r\n            bgcolor: theme.palette.background.paper,\r\n            border: `1px solid ${theme.palette.divider}`,\r\n            boxShadow: theme.shadows[8],\r\n            borderRadius: 2,\r\n            overflow: 'hidden',\r\n          },\r\n        }}\r\n        disableRestoreFocus\r\n      >\r\n        <Box sx={{ p: 2 }}>\r\n          <Typography variant=\"h6\" fontWeight={600} sx={{ mb: 2 }}>\r\n            Default Columns: {title}\r\n          </Typography>\r\n          <Box\r\n            component=\"img\"\r\n            src={imageSrc}\r\n            alt={`Schema preview for ${title}`}\r\n            sx={{\r\n              width: '100%',\r\n              height: 'auto',\r\n              display: 'block',\r\n              borderRadius: 1,\r\n              border: `1px solid ${theme.palette.divider}`,\r\n            }}\r\n            onError={(e) => {\r\n              // Fallback to placeholder if image doesn't exist\r\n              const target = e.target as HTMLImageElement;\r\n              target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5TY2hlbWEgUHJldmlldyBQbGFjZWhvbGRlcjwvdGV4dD48L3N2Zz4=';\r\n            }}\r\n          />\r\n        </Box>\r\n      </Popover>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default RecordSchemaInfoPopover;\r\n\r\n","/**\r\n * Hook for managing OCR jobs list with polling and caching\r\n */\r\n\r\nimport { useState, useEffect, useCallback, useRef } from 'react';\r\nimport { apiClient } from '@/shared/lib/axiosInstance';\r\nimport type { OCRJobRow, OCRJobDetail } from '../types/ocrJob';\r\n\r\ninterface UseOcrJobsOptions {\r\n  churchId: number | null;\r\n  limit?: number;\r\n  pollInterval?: number;\r\n}\r\n\r\ninterface UseOcrJobsReturn {\r\n  jobs: OCRJobRow[];\r\n  loading: boolean;\r\n  error: string | null;\r\n  refresh: () => Promise<void>;\r\n  fetchJobDetail: (jobId: number) => Promise<OCRJobDetail | null>;\r\n  updateRecordType: (jobId: number, recordType: string) => Promise<boolean>;\r\n  retryJob: (jobId: number) => Promise<boolean>;\r\n  deleteJobs: (jobIds: number[]) => Promise<boolean>;\r\n  reprocessJobs: (jobIds: number[]) => Promise<boolean>;\r\n  completedCount: number;\r\n  failedCount: number;\r\n  processingCount: number;\r\n  detailCache: Map<number, OCRJobDetail>;\r\n}\r\n\r\nexport function useOcrJobs({\r\n  churchId,\r\n  limit = 200,\r\n  pollInterval = 3000\r\n}: UseOcrJobsOptions): UseOcrJobsReturn {\r\n  const [jobs, setJobs] = useState<OCRJobRow[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const detailCache = useRef<Map<number, OCRJobDetail>>(new Map());\r\n  const abortControllerRef = useRef<AbortController | null>(null);\r\n  const pollTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n  // Fetch jobs list\r\n  const fetchJobs = useCallback(async () => {\r\n    if (!churchId) {\r\n      console.log('[useOcrJobs] No churchId, skipping fetch');\r\n      setJobs([]);\r\n      return;\r\n    }\r\n\r\n    // Cancel previous request\r\n    if (abortControllerRef.current) {\r\n      abortControllerRef.current.abort();\r\n    }\r\n    abortControllerRef.current = new AbortController();\r\n\r\n    try {\r\n      // Check if OCR endpoint exists before calling\r\n      // If OCR is not active, skip fetching to avoid 404 errors\r\n      console.log(`[useOcrJobs] Checking OCR availability for church ${churchId}...`);\r\n      \r\n      // Try alternative endpoint first (if it exists)\r\n      let response;\r\n      try {\r\n        response = await apiClient.get(\r\n          `/api/ocr/jobs?churchId=${churchId}&limit=${limit}`\r\n        );\r\n      } catch (altErr: any) {\r\n        // If alternative endpoint doesn't exist, check if church-specific endpoint exists\r\n        if (altErr.response?.status === 404) {\r\n          console.log(`[useOcrJobs] OCR endpoint not available for church ${churchId}, skipping fetch`);\r\n          setJobs([]);\r\n          setError(null);\r\n          return;\r\n        }\r\n        throw altErr;\r\n      }\r\n      \r\n      // Handle multiple possible response shapes: array, nested envelopes, various structures\r\n      const res = response as any;\r\n      const d = res?.data ?? res;\r\n      \r\n      const jobsData =\r\n        Array.isArray(d) ? d :\r\n        (d?.jobs ??\r\n         d?.data?.jobs ??\r\n         (Array.isArray(d?.data) ? d.data : null) ??\r\n         d?.data?.data?.jobs ??\r\n         []);\r\n      \r\n      console.log('[useOcrJobs] Response keys:', Object.keys(res || {}));\r\n      console.log('[useOcrJobs] Data keys:', Object.keys(d || {}));\r\n      console.log(`[useOcrJobs] Received ${jobsData.length} jobs`);\r\n      \r\n      // Map to OCRJobRow format with proper type normalization\r\n      const mappedJobs: OCRJobRow[] = jobsData.map((job: any) => ({\r\n        id: Number(job.id),\r\n        church_id: Number(job.church_id || churchId),\r\n        original_filename: job.original_filename || job.filename || '',\r\n        filename: job.filename || '',\r\n        status: job.status || 'queued',\r\n        record_type: job.record_type || 'baptism',\r\n        confidence_score: job.confidence_score != null ? Number(job.confidence_score) : null,\r\n        language: job.language || 'en',\r\n        created_at: job.created_at,\r\n        updated_at: job.updated_at,\r\n        ocr_text_preview: job.ocr_text_preview || null,\r\n        has_ocr_text: !!job.ocr_text_preview || !!job.has_ocr_text,\r\n        error_message: job.error_message || job.error || null\r\n      }));\r\n\r\n      setJobs(mappedJobs);\r\n      setError(null);\r\n    } catch (err: any) {\r\n      if (err.name !== 'AbortError') {\r\n        console.error('[useOcrJobs] Fetch error:', err);\r\n        setError(err.message || 'Failed to fetch jobs');\r\n      }\r\n    }\r\n  }, [churchId, limit]);\r\n\r\n  // Initial load\r\n  const refresh = useCallback(async () => {\r\n    setLoading(true);\r\n    await fetchJobs();\r\n    setLoading(false);\r\n  }, [fetchJobs]);\r\n\r\n  // Fetch job detail (with caching)\r\n  const fetchJobDetail = useCallback(async (jobId: number): Promise<OCRJobDetail | null> => {\r\n    if (!churchId) return null;\r\n\r\n    // Check cache first\r\n    if (detailCache.current.has(jobId)) {\r\n      return detailCache.current.get(jobId)!;\r\n    }\r\n\r\n    try {\r\n      // Use alternative endpoint if church-specific one doesn't exist\r\n      let response;\r\n      try {\r\n        response = await apiClient.get(`/api/ocr/jobs/${jobId}?churchId=${churchId}`);\r\n      } catch (err: any) {\r\n        if (err.response?.status === 404) {\r\n          console.warn(`[useOcrJobs] OCR endpoint not available, cannot fetch job details`);\r\n          throw new Error('OCR endpoint not available');\r\n        }\r\n        throw err;\r\n      }\r\n      // Handle various response structures: unwrap nested data.data if needed\r\n      const responseData = (response as any)?.data ?? (response as any);\r\n      const data = responseData?.data ?? responseData;\r\n      \r\n      if (!data || !data.id) {\r\n        console.error('[useOcrJobs] Invalid job detail response:', response);\r\n        return null;\r\n      }\r\n      \r\n      const detail: OCRJobDetail = {\r\n        id: parseInt(data.id),\r\n        church_id: parseInt(data.church_id || churchId),\r\n        original_filename: data.original_filename || data.filename,\r\n        filename: data.filename,\r\n        status: data.status,\r\n        record_type: data.record_type || 'baptism',\r\n        confidence_score: data.confidence_score,\r\n        language: data.language,\r\n        created_at: data.created_at,\r\n        updated_at: data.updated_at,\r\n        ocr_text: data.ocr_text || null,\r\n        ocr_result: data.ocr_result || null,\r\n        file_path: data.file_path,\r\n        mapping: data.mapping,\r\n        has_ocr_text: !!data.ocr_text\r\n      };\r\n\r\n      detailCache.current.set(jobId, detail);\r\n      return detail;\r\n    } catch (err) {\r\n      console.error('[useOcrJobs] Detail fetch error:', err);\r\n      return null;\r\n    }\r\n  }, [churchId]);\r\n\r\n  // Update record type\r\n  const updateRecordType = useCallback(async (jobId: number, recordType: string): Promise<boolean> => {\r\n    if (!churchId) return false;\r\n\r\n    // Optimistic update\r\n    setJobs(prev => prev.map(j => \r\n      j.id === jobId ? { ...j, record_type: recordType as any } : j\r\n    ));\r\n\r\n    try {\r\n      // Try alternative endpoint first\r\n      try {\r\n        await apiClient.patch(`/api/ocr/jobs/${jobId}`, {\r\n          record_type: recordType,\r\n          churchId: churchId\r\n        });\r\n      } catch (altErr: any) {\r\n        if (altErr.response?.status === 404) {\r\n          // Try church-specific endpoint\r\n          await apiClient.patch(`/api/church/${churchId}/ocr/jobs/${jobId}`, {\r\n            record_type: recordType\r\n          });\r\n        } else {\r\n          throw altErr;\r\n        }\r\n      }\r\n      \r\n      // Clear cache for this job\r\n      detailCache.current.delete(jobId);\r\n      return true;\r\n    } catch (err) {\r\n      console.error('[useOcrJobs] Update record type error:', err);\r\n      // Revert on error\r\n      await fetchJobs();\r\n      return false;\r\n    }\r\n  }, [churchId, fetchJobs]);\r\n\r\n  // Retry failed job (only works for failed jobs)\r\n  const retryJob = useCallback(async (jobId: number): Promise<boolean> => {\r\n    if (!churchId) return false;\r\n\r\n    // Check job status - only retry failed jobs\r\n    const job = jobs.find(j => j.id === jobId);\r\n    if (!job) {\r\n      console.warn(`[useOcrJobs] Job ${jobId} not found in current jobs list`);\r\n      return false;\r\n    }\r\n\r\n    if (job.status !== 'failed') {\r\n      console.warn(`[useOcrJobs] Cannot retry job ${jobId}: status is '${job.status}', only 'failed' jobs can be retried`);\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      // Try alternative endpoint first\r\n      try {\r\n        await apiClient.post(`/api/ocr/jobs/${jobId}/retry`, { churchId });\r\n      } catch (altErr: any) {\r\n        if (altErr.response?.status === 404) {\r\n          // OCR endpoint not available - return false gracefully\r\n          console.warn(`[useOcrJobs] OCR endpoint not available for church ${churchId}`);\r\n          return false;\r\n        } else {\r\n          throw altErr;\r\n        }\r\n      }\r\n      \r\n      // Update status optimistically\r\n      setJobs(prev => prev.map(j =>\r\n        j.id === jobId ? { ...j, status: 'processing' as const, error_message: null } : j\r\n      ));\r\n      \r\n      detailCache.current.delete(jobId);\r\n      return true;\r\n    } catch (err: any) {\r\n      // Handle 4xx errors gracefully - don't throw to prevent AdminErrorBoundary crashes\r\n      const status = err?.response?.status;\r\n      const errorMessage = err?.response?.data?.error || err?.message || 'Unknown error';\r\n      \r\n      if (status === 400) {\r\n        console.warn(`[useOcrJobs] Retry failed (400): ${errorMessage}`);\r\n      } else {\r\n        console.error('[useOcrJobs] Retry error:', err);\r\n      }\r\n      \r\n      // Don't throw - return false to prevent crashes\r\n      return false;\r\n    }\r\n  }, [churchId, jobs]);\r\n\r\n  // Bulk delete jobs\r\n  const deleteJobs = useCallback(async (jobIds: number[]): Promise<boolean> => {\r\n    if (!churchId || jobIds.length === 0) return false;\r\n\r\n    try {\r\n      await apiClient.delete(`/api/church/${churchId}/ocr/jobs`, {\r\n        data: { jobIds }\r\n      });\r\n      \r\n      // Remove from local state\r\n      setJobs(prev => prev.filter(j => !jobIds.includes(j.id)));\r\n      \r\n      // Clear cache for deleted jobs\r\n      jobIds.forEach(id => detailCache.current.delete(id));\r\n      \r\n      return true;\r\n    } catch (err) {\r\n      console.error('[useOcrJobs] Delete error:', err);\r\n      return false;\r\n    }\r\n  }, [churchId]);\r\n\r\n  // Bulk reprocess jobs (retry multiple - only works for failed jobs)\r\n  const reprocessJobs = useCallback(async (jobIds: number[]): Promise<boolean> => {\r\n    if (!churchId || jobIds.length === 0) return false;\r\n\r\n    // Filter to only failed jobs - /retry endpoint only works for failed jobs\r\n    const failedJobIds = jobIds.filter(id => {\r\n      const job = jobs.find(j => j.id === id);\r\n      return job && job.status === 'failed';\r\n    });\r\n\r\n    if (failedJobIds.length === 0) {\r\n      console.warn('[useOcrJobs] No failed jobs to retry - reprocessJobs only works for failed jobs');\r\n      return false;\r\n    }\r\n\r\n    if (failedJobIds.length < jobIds.length) {\r\n      console.warn(`[useOcrJobs] Filtered ${jobIds.length - failedJobIds.length} non-failed jobs from reprocess list`);\r\n    }\r\n\r\n    try {\r\n      // Retry each failed job (handle individual failures gracefully)\r\n      const results = await Promise.allSettled(\r\n        failedJobIds.map(id => \r\n          // Try alternative endpoint first, fallback to church-specific\r\n          (async () => {\r\n            try {\r\n              await apiClient.post(`/api/ocr/jobs/${id}/retry`, { churchId });\r\n            } catch (altErr: any) {\r\n              if (altErr.response?.status === 404) {\r\n                await apiClient.post(`/api/church/${churchId}/ocr/jobs/${id}/retry`);\r\n              } else {\r\n                throw altErr;\r\n              }\r\n            }\r\n          })()\r\n        )\r\n      );\r\n      \r\n      // Check for failures\r\n      const failures = results.filter(r => r.status === 'rejected');\r\n      if (failures.length > 0) {\r\n        console.warn(`[useOcrJobs] ${failures.length} of ${failedJobIds.length} retry requests failed`);\r\n        failures.forEach((failure, idx) => {\r\n          const err = (failure as PromiseRejectedResult).reason;\r\n          const status = err?.response?.status;\r\n          const errorMessage = err?.response?.data?.error || err?.message || 'Unknown error';\r\n          if (status === 400) {\r\n            console.warn(`[useOcrJobs] Retry failed (400) for job ${failedJobIds[idx]}: ${errorMessage}`);\r\n          } else {\r\n            console.error(`[useOcrJobs] Retry error for job ${failedJobIds[idx]}:`, err);\r\n          }\r\n        });\r\n      }\r\n      \r\n      // Update status optimistically for successful retries\r\n      const successfulIds = failedJobIds.filter((id, idx) => results[idx].status === 'fulfilled');\r\n      if (successfulIds.length > 0) {\r\n        setJobs(prev => prev.map(j =>\r\n          successfulIds.includes(j.id) ? { ...j, status: 'processing' as const, error_message: null } : j\r\n        ));\r\n        \r\n        // Clear cache\r\n        successfulIds.forEach(id => detailCache.current.delete(id));\r\n      }\r\n      \r\n      // Return true if at least one succeeded, false if all failed\r\n      return successfulIds.length > 0;\r\n    } catch (err: any) {\r\n      // Handle unexpected errors\r\n      console.error('[useOcrJobs] Reprocess error:', err);\r\n      // Don't throw - return false to prevent crashes\r\n      return false;\r\n    }\r\n  }, [churchId, jobs]);\r\n\r\n  // Polling logic\r\n  useEffect(() => {\r\n    if (!churchId) return;\r\n\r\n    const hasActiveJobs = jobs.some(j => \r\n      ['queued', 'uploading', 'processing'].includes(j.status)\r\n    );\r\n\r\n    if (hasActiveJobs) {\r\n      pollTimeoutRef.current = setTimeout(() => {\r\n        fetchJobs();\r\n      }, pollInterval);\r\n    }\r\n\r\n    return () => {\r\n      if (pollTimeoutRef.current) {\r\n        clearTimeout(pollTimeoutRef.current);\r\n      }\r\n    };\r\n  }, [jobs, churchId, pollInterval, fetchJobs]);\r\n\r\n  // Initial load on church change\r\n  useEffect(() => {\r\n    refresh();\r\n    detailCache.current.clear();\r\n\r\n    return () => {\r\n      if (abortControllerRef.current) {\r\n        abortControllerRef.current.abort();\r\n      }\r\n      if (pollTimeoutRef.current) {\r\n        clearTimeout(pollTimeoutRef.current);\r\n      }\r\n    };\r\n  }, [churchId]);\r\n\r\n  // Counts\r\n  const completedCount = jobs.filter(j => j.status === 'completed').length;\r\n  const failedCount = jobs.filter(j => j.status === 'failed').length;\r\n  const processingCount = jobs.filter(j => ['queued', 'uploading', 'processing'].includes(j.status)).length;\r\n\r\n  return {\r\n    jobs,\r\n    loading,\r\n    error,\r\n    refresh,\r\n    fetchJobDetail,\r\n    updateRecordType,\r\n    retryJob,\r\n    deleteJobs,\r\n    reprocessJobs,\r\n    completedCount,\r\n    failedCount,\r\n    processingCount,\r\n    detailCache: detailCache.current\r\n  };\r\n}\r\n\r\n","/**\r\n * WorkbenchContext - Shared state for OCR Workbench\r\n * Single source of truth for all workbench state across steps\r\n */\r\n\r\nimport React, { createContext, useContext, useReducer, useCallback, useMemo } from 'react';\r\nimport type { BBox, VisionResponse, DetectedLabel, FusionEntry, EntryArea } from '../types/fusion';\r\nimport type { RecordType } from '@/shared/recordSchemas/registry';\r\n\r\n// ============================================================================\r\n// State Shape\r\n// ============================================================================\r\n\r\nexport interface WorkbenchState {\r\n  // Job metadata\r\n  activeJobId: number | null;\r\n  jobMetadata: {\r\n    filename: string;\r\n    recordType: RecordType;\r\n    status: string;\r\n    confidence: number;\r\n    churchId: number;\r\n  } | null;\r\n  \r\n  // OCR data\r\n  ocrText: string | null;\r\n  ocrResult: VisionResponse | null;\r\n  imageUrl: string | null;\r\n  normalizedText: string | null; // Server-normalized transcription (when flag enabled)\r\n  \r\n  // Step 1: Detect Entries\r\n  entries: FusionEntry[];\r\n  entryAreas: EntryArea[]; // Single source of truth for entry bounding boxes\r\n  selectedEntryIndex: number | null;\r\n  bboxEditMode: boolean;\r\n  \r\n  // Step 2: Anchor Labels\r\n  detectedLabels: DetectedLabel[];\r\n  labelCandidates: Array<{ text: string; bbox: BBox; confidence: number; canonicalKey?: string }>;\r\n  \r\n  // Step 3: Map Fields\r\n  fieldValues: Record<string, { value: string; confidence?: number; source?: string }>; // keyed by canonical schema key\r\n  fieldExtractions: Record<string, Record<string, any>>; // keyed by entryId, then fieldKey\r\n  \r\n  // Step 4: Review/Commit\r\n  drafts: Array<{\r\n    id?: number;\r\n    entry_index: number;\r\n    record_type: string;\r\n    payload_json: any;\r\n    bbox_json?: any;\r\n    status?: string;\r\n  }>;\r\n  \r\n  // Per-step status\r\n  stepStatus: {\r\n    detectEntries: { complete: boolean; error?: string };\r\n    anchorLabels: { complete: boolean; error?: string };\r\n    mapFields: { complete: boolean; error?: string };\r\n    reviewCommit: { complete: boolean; error?: string };\r\n  };\r\n  \r\n  // UI state\r\n  activeStep: number;\r\n  isProcessing: boolean;\r\n  error: string | null;\r\n}\r\n\r\n// ============================================================================\r\n// Actions\r\n// ============================================================================\r\n\r\nexport type WorkbenchAction =\r\n  | { type: 'SET_JOB'; payload: { jobId: number; metadata: WorkbenchState['jobMetadata']; ocrText: string | null; ocrResult: VisionResponse | null; imageUrl: string | null } }\r\n  | { type: 'SET_NORMALIZED_TEXT'; payload: string | null }\r\n  | { type: 'SET_ENTRIES'; payload: FusionEntry[] }\r\n  | { type: 'SET_ENTRY_AREAS'; payload: EntryArea[] }\r\n  | { type: 'UPDATE_ENTRY_AREA'; payload: { entryId: string; bbox: BBox } }\r\n  | { type: 'SET_SELECTED_ENTRY'; payload: number | null }\r\n  | { type: 'SET_BBOX_EDIT_MODE'; payload: boolean }\r\n  | { type: 'SET_DETECTED_LABELS'; payload: DetectedLabel[] }\r\n  | { type: 'SET_LABEL_CANDIDATES'; payload: WorkbenchState['labelCandidates'] }\r\n  | { type: 'SET_FIELD_VALUE'; payload: { key: string; value: string; confidence?: number; source?: string } }\r\n  | { type: 'SET_FIELD_VALUES'; payload: Record<string, { value: string; confidence?: number; source?: string }> }\r\n  | { type: 'SET_FIELD_EXTRACTIONS'; payload: Record<string, Record<string, any>> }\r\n  | { type: 'SET_DRAFTS'; payload: WorkbenchState['drafts'] }\r\n  | { type: 'ADD_DRAFT'; payload: WorkbenchState['drafts'][0] }\r\n  | { type: 'UPDATE_DRAFT'; payload: { index: number; draft: Partial<WorkbenchState['drafts'][0]> } }\r\n  | { type: 'SET_STEP_STATUS'; payload: { step: keyof WorkbenchState['stepStatus']; status: Partial<WorkbenchState['stepStatus'][keyof WorkbenchState['stepStatus']]> } }\r\n  | { type: 'SET_ACTIVE_STEP'; payload: number }\r\n  | { type: 'SET_PROCESSING'; payload: boolean }\r\n  | { type: 'SET_ERROR'; payload: string | null }\r\n  | { type: 'RESET' };\r\n\r\n// ============================================================================\r\n// Reducer\r\n// ============================================================================\r\n\r\nconst initialState: WorkbenchState = {\r\n  activeJobId: null,\r\n  jobMetadata: null,\r\n  ocrText: null,\r\n  ocrResult: null,\r\n  imageUrl: null,\r\n  normalizedText: null,\r\n  entries: [],\r\n  entryAreas: [],\r\n  selectedEntryIndex: null,\r\n  bboxEditMode: false,\r\n  detectedLabels: [],\r\n  labelCandidates: [],\r\n  fieldValues: {},\r\n  fieldExtractions: {},\r\n  drafts: [],\r\n  stepStatus: {\r\n    detectEntries: { complete: false },\r\n    anchorLabels: { complete: false },\r\n    mapFields: { complete: false },\r\n    reviewCommit: { complete: false },\r\n  },\r\n  activeStep: 0,\r\n  isProcessing: false,\r\n  error: null,\r\n};\r\n\r\nfunction workbenchReducer(state: WorkbenchState, action: WorkbenchAction): WorkbenchState {\r\n  switch (action.type) {\r\n    case 'SET_JOB':\r\n      return {\r\n        ...state,\r\n        activeJobId: action.payload.jobId,\r\n        jobMetadata: action.payload.metadata,\r\n        ocrText: action.payload.ocrText,\r\n        ocrResult: action.payload.ocrResult,\r\n        imageUrl: action.payload.imageUrl,\r\n        normalizedText: null, // Reset normalized text when job changes\r\n        // Reset step-specific state when job changes\r\n        entries: [],\r\n        entryAreas: [],\r\n        selectedEntryIndex: null,\r\n        detectedLabels: [],\r\n        labelCandidates: [],\r\n        fieldValues: {},\r\n        fieldExtractions: {},\r\n        drafts: [],\r\n        activeStep: 0,\r\n      };\r\n    case 'SET_NORMALIZED_TEXT':\r\n      return {\r\n        ...state,\r\n        normalizedText: action.payload,\r\n      };\r\n    \r\n    case 'SET_ENTRIES':\r\n      return { ...state, entries: action.payload };\r\n    \r\n    case 'SET_ENTRY_AREAS':\r\n      return { ...state, entryAreas: action.payload };\r\n    \r\n    case 'UPDATE_ENTRY_AREA':\r\n      return {\r\n        ...state,\r\n        entryAreas: state.entryAreas.map(area =>\r\n          area.entryId === action.payload.entryId\r\n            ? { ...area, bbox: action.payload.bbox }\r\n            : area\r\n        ),\r\n      };\r\n    \r\n    case 'SET_SELECTED_ENTRY':\r\n      return { ...state, selectedEntryIndex: action.payload };\r\n    \r\n    case 'SET_BBOX_EDIT_MODE':\r\n      return { ...state, bboxEditMode: action.payload };\r\n    \r\n    case 'SET_DETECTED_LABELS':\r\n      return { ...state, detectedLabels: action.payload };\r\n    \r\n    case 'SET_LABEL_CANDIDATES':\r\n      return { ...state, labelCandidates: action.payload };\r\n    \r\n    case 'SET_FIELD_VALUE':\r\n      return {\r\n        ...state,\r\n        fieldValues: {\r\n          ...state.fieldValues,\r\n          [action.payload.key]: {\r\n            value: action.payload.value,\r\n            confidence: action.payload.confidence,\r\n            source: action.payload.source,\r\n          },\r\n        },\r\n      };\r\n    \r\n    case 'SET_FIELD_VALUES':\r\n      return { ...state, fieldValues: action.payload };\r\n    \r\n    case 'SET_FIELD_EXTRACTIONS':\r\n      return { ...state, fieldExtractions: action.payload };\r\n    \r\n    case 'SET_DRAFTS':\r\n      return { ...state, drafts: action.payload };\r\n    \r\n    case 'ADD_DRAFT':\r\n      return { ...state, drafts: [...state.drafts, action.payload] };\r\n    \r\n    case 'UPDATE_DRAFT':\r\n      return {\r\n        ...state,\r\n        drafts: state.drafts.map((draft, idx) =>\r\n          idx === action.payload.index\r\n            ? { ...draft, ...action.payload.draft }\r\n            : draft\r\n        ),\r\n      };\r\n    \r\n    case 'SET_STEP_STATUS':\r\n      return {\r\n        ...state,\r\n        stepStatus: {\r\n          ...state.stepStatus,\r\n          [action.payload.step]: {\r\n            ...state.stepStatus[action.payload.step],\r\n            ...action.payload.status,\r\n          },\r\n        },\r\n      };\r\n    \r\n    case 'SET_ACTIVE_STEP':\r\n      return { ...state, activeStep: action.payload };\r\n    \r\n    case 'SET_PROCESSING':\r\n      return { ...state, isProcessing: action.payload };\r\n    \r\n    case 'SET_ERROR':\r\n      return { ...state, error: action.payload };\r\n    \r\n    case 'RESET':\r\n      return initialState;\r\n    \r\n    default:\r\n      return state;\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Context\r\n// ============================================================================\r\n\r\ninterface WorkbenchContextValue {\r\n  state: WorkbenchState;\r\n  dispatch: React.Dispatch<WorkbenchAction>;\r\n  \r\n  // Convenience helpers\r\n  setJob: (jobId: number, metadata: WorkbenchState['jobMetadata'], ocrText: string | null, ocrResult: VisionResponse | null, imageUrl: string | null) => void;\r\n  setEntries: (entries: FusionEntry[]) => void;\r\n  updateEntryArea: (entryId: string, bbox: BBox) => void;\r\n  setSelectedEntry: (index: number | null) => void;\r\n  setFieldValue: (key: string, value: string, confidence?: number, source?: string) => void;\r\n  setFieldValues: (values: Record<string, { value: string; confidence?: number; source?: string }>) => void;\r\n  setDrafts: (drafts: WorkbenchState['drafts']) => void;\r\n  setActiveStep: (step: number) => void;\r\n  reset: () => void;\r\n}\r\n\r\nconst WorkbenchContext = createContext<WorkbenchContextValue | null>(null);\r\n\r\n// ============================================================================\r\n// Provider\r\n// ============================================================================\r\n\r\nexport const WorkbenchProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n  const [state, dispatch] = useReducer(workbenchReducer, initialState);\r\n  \r\n  const setJob = useCallback((jobId: number, metadata: WorkbenchState['jobMetadata'], ocrText: string | null, ocrResult: VisionResponse | null, imageUrl: string | null) => {\r\n    dispatch({ type: 'SET_JOB', payload: { jobId, metadata, ocrText, ocrResult, imageUrl } });\r\n  }, []);\r\n  \r\n  const setEntries = useCallback((entries: FusionEntry[]) => {\r\n    dispatch({ type: 'SET_ENTRIES', payload: entries });\r\n  }, []);\r\n  \r\n  const updateEntryArea = useCallback((entryId: string, bbox: BBox) => {\r\n    dispatch({ type: 'UPDATE_ENTRY_AREA', payload: { entryId, bbox } });\r\n  }, []);\r\n  \r\n  const setSelectedEntry = useCallback((index: number | null) => {\r\n    dispatch({ type: 'SET_SELECTED_ENTRY', payload: index });\r\n  }, []);\r\n  \r\n  const setFieldValue = useCallback((key: string, value: string, confidence?: number, source?: string) => {\r\n    dispatch({ type: 'SET_FIELD_VALUE', payload: { key, value, confidence, source } });\r\n  }, []);\r\n  \r\n  const setFieldValues = useCallback((values: Record<string, { value: string; confidence?: number; source?: string }>) => {\r\n    dispatch({ type: 'SET_FIELD_VALUES', payload: values });\r\n  }, []);\r\n  \r\n  const setDrafts = useCallback((drafts: WorkbenchState['drafts']) => {\r\n    dispatch({ type: 'SET_DRAFTS', payload: drafts });\r\n  }, []);\r\n  \r\n  const setActiveStep = useCallback((step: number) => {\r\n    dispatch({ type: 'SET_ACTIVE_STEP', payload: step });\r\n  }, []);\r\n  \r\n  const reset = useCallback(() => {\r\n    dispatch({ type: 'RESET' });\r\n  }, []);\r\n  \r\n  const value = useMemo(() => ({\r\n    state,\r\n    dispatch,\r\n    setJob,\r\n    setEntries,\r\n    updateEntryArea,\r\n    setSelectedEntry,\r\n    setFieldValue,\r\n    setFieldValues,\r\n    setDrafts,\r\n    setActiveStep,\r\n    reset,\r\n  }), [state, setJob, setEntries, updateEntryArea, setSelectedEntry, setFieldValue, setFieldValues, setDrafts, setActiveStep, reset]);\r\n  \r\n  return (\r\n    <WorkbenchContext.Provider value={value}>\r\n      {children}\r\n    </WorkbenchContext.Provider>\r\n  );\r\n};\r\n\r\n// ============================================================================\r\n// Hook\r\n// ============================================================================\r\n\r\nexport function useWorkbench(): WorkbenchContextValue {\r\n  const context = useContext(WorkbenchContext);\r\n  if (!context) {\r\n    throw new Error('useWorkbench must be used within WorkbenchProvider');\r\n  }\r\n  return context;\r\n}\r\n\r\n","/**\r\n * Record Type and Metadata Detector\r\n * Automatically detects record type, year, and other metadata from OCR text\r\n */\r\n\r\nexport type RecordType = 'baptism' | 'marriage' | 'funeral';\r\n\r\nexport interface DetectedMetadata {\r\n  recordType: RecordType | null;\r\n  year: number | null;\r\n  confidence: number;\r\n}\r\n\r\n/**\r\n * Normalize text for matching (lowercase, remove accents, etc.)\r\n */\r\nfunction normalizeText(text: string): string {\r\n  return text\r\n    .toLowerCase()\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300-\\u036f]/g, '') // Remove accents\r\n    .replace(/[^\\w\\s]/g, ' ') // Replace punctuation with spaces\r\n    .replace(/\\s+/g, ' ') // Normalize whitespace\r\n    .trim();\r\n}\r\n\r\n/**\r\n * Detect record type from OCR text\r\n */\r\nexport function detectRecordType(ocrText: string | null | undefined): { type: RecordType | null; confidence: number } {\r\n  if (!ocrText) {\r\n    return { type: null, confidence: 0 };\r\n  }\r\n\r\n  const normalized = normalizeText(ocrText);\r\n  \r\n  // Keywords for each record type (case-insensitive, multilingual)\r\n  const marriageKeywords = [\r\n    'marriage', 'marriages', 'брак', 'бракосочетание', 'бракосочетавшихся',\r\n    'groom', 'bride', 'wedding', 'жених', 'невеста',\r\n    'marry', 'married', 'wed', 'wedded',\r\n    'метрической книги', 'часть вторая', // Russian: \"metrical book, part two\" (marriages)\r\n  ];\r\n  \r\n  const baptismKeywords = [\r\n    'baptism', 'baptisms', 'крещение', 'крещений',\r\n    'child', 'infant', 'baby', 'ребенок', 'младенец',\r\n    'godparent', 'godparents', 'sponsor', 'sponsors', 'крестный', 'крестная',\r\n    'born', 'birth', 'рождение', 'родился',\r\n    'метрической книги', 'часть первая', // Russian: \"metrical book, part one\" (baptisms)\r\n  ];\r\n  \r\n  const funeralKeywords = [\r\n    'funeral', 'funerals', 'похороны', 'погребение',\r\n    'death', 'died', 'deceased', 'death', 'смерть', 'умер', 'покойный',\r\n    'burial', 'buried', 'cemetery', 'погребение', 'кладбище',\r\n    'метрической книги', 'часть третья', // Russian: \"metrical book, part three\" (funerals)\r\n  ];\r\n\r\n  // Count matches for each type\r\n  let marriageScore = 0;\r\n  let baptismScore = 0;\r\n  let funeralScore = 0;\r\n\r\n  for (const keyword of marriageKeywords) {\r\n    const regex = new RegExp(`\\\\b${keyword}\\\\b`, 'gi');\r\n    const matches = normalized.match(regex);\r\n    if (matches) {\r\n      marriageScore += matches.length;\r\n    }\r\n  }\r\n\r\n  for (const keyword of baptismKeywords) {\r\n    const regex = new RegExp(`\\\\b${keyword}\\\\b`, 'gi');\r\n    const matches = normalized.match(regex);\r\n    if (matches) {\r\n      baptismScore += matches.length;\r\n    }\r\n  }\r\n\r\n  for (const keyword of funeralKeywords) {\r\n    const regex = new RegExp(`\\\\b${keyword}\\\\b`, 'gi');\r\n    const matches = normalized.match(regex);\r\n    if (matches) {\r\n      funeralScore += matches.length;\r\n    }\r\n  }\r\n\r\n  // Calculate confidence based on score and text length\r\n  const totalScore = marriageScore + baptismScore + funeralScore;\r\n  const maxScore = Math.max(marriageScore, baptismScore, funeralScore);\r\n  \r\n  if (totalScore === 0) {\r\n    return { type: null, confidence: 0 };\r\n  }\r\n\r\n  let detectedType: RecordType | null = null;\r\n  if (marriageScore > baptismScore && marriageScore > funeralScore) {\r\n    detectedType = 'marriage';\r\n  } else if (baptismScore > funeralScore) {\r\n    detectedType = 'baptism';\r\n  } else if (funeralScore > 0) {\r\n    detectedType = 'funeral';\r\n  }\r\n\r\n  // Confidence is based on how dominant the winning type is\r\n  const confidence = totalScore > 0 ? Math.min(1, maxScore / Math.max(1, totalScore * 0.5)) : 0;\r\n\r\n  return { type: detectedType, confidence };\r\n}\r\n\r\n/**\r\n * Extract year from OCR text\r\n * Looks for patterns like \"YEAR 86\", \"YEAR 1986\", \"86\", \"1986\", etc.\r\n */\r\nexport function extractYear(ocrText: string | null | undefined): number | null {\r\n  if (!ocrText) {\r\n    return null;\r\n  }\r\n\r\n  // Patterns to match:\r\n  // - \"YEAR 86\", \"YEAR 1986\"\r\n  // - \"YEAR: 86\", \"YEAR: 1986\"\r\n  // - \"86\", \"1986\" (standalone years)\r\n  // - \"19XX\", \"20XX\" (4-digit years)\r\n  // - \"ГОД 86\", \"ГОД 1986\" (Russian: \"YEAR\")\r\n  \r\n  const patterns = [\r\n    /(?:year|год)[\\s:]*(\\d{2,4})/gi,\r\n    /\\b(19\\d{2}|20\\d{2})\\b/, // 4-digit years 1900-2099\r\n    /\\b(\\d{2})\\b(?=\\s|$)/, // 2-digit years (less reliable)\r\n  ];\r\n\r\n  for (const pattern of patterns) {\r\n    const matches = ocrText.match(pattern);\r\n    if (matches && matches.length > 0) {\r\n      // Extract the year number\r\n      const yearMatch = matches[0].match(/\\d{2,4}/);\r\n      if (yearMatch) {\r\n        let year = parseInt(yearMatch[0], 10);\r\n        \r\n        // If 2-digit year, assume 1900s if > 50, 2000s if <= 50\r\n        if (year < 100) {\r\n          year = year > 50 ? 1900 + year : 2000 + year;\r\n        }\r\n        \r\n        // Validate year is reasonable (1800-2100)\r\n        if (year >= 1800 && year <= 2100) {\r\n          return year;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * Detect both record type and year from OCR text\r\n */\r\nexport function detectMetadata(ocrText: string | null | undefined): DetectedMetadata {\r\n  const recordType = detectRecordType(ocrText);\r\n  const year = extractYear(ocrText);\r\n\r\n  return {\r\n    recordType: recordType.type,\r\n    year,\r\n    confidence: recordType.confidence,\r\n  };\r\n}\r\n\r\n","/**\r\n * WorkbenchHeader - Header bar for workbench showing job info and actions\r\n */\r\n\r\nimport React, { useMemo } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  Stack,\r\n  Chip,\r\n  IconButton,\r\n  Tooltip,\r\n  alpha,\r\n  useTheme,\r\n  Paper,\r\n} from '@mui/material';\r\nimport {\r\n  IconX,\r\n  IconCopy,\r\n  IconRefresh,\r\n  IconAlertCircle,\r\n  IconCheck,\r\n} from '@tabler/icons-react';\r\nimport type { JobDetail } from '../../types/inspection';\r\nimport { extractYear } from '../../utils/recordTypeDetector';\r\n\r\ninterface WorkbenchHeaderProps {\r\n  job: JobDetail;\r\n  onClose: () => void;\r\n}\r\n\r\nconst WorkbenchHeader: React.FC<WorkbenchHeaderProps> = ({ job, onClose }) => {\r\n  const theme = useTheme();\r\n  \r\n  const jobFilename = job?.original_filename || job?.originalFilename || job?.filename || 'Unknown';\r\n  const jobStatus = job?.status || '';\r\n  const jobRecordType = job?.record_type || job?.recordType || 'baptism';\r\n  const jobConfidence = job?.confidence_score || job?.confidenceScore || 0;\r\n  const jobOcrText = job?.ocr_text || job?.ocrText || null;\r\n  \r\n  // Auto-detect year from OCR text\r\n  const detectedYear = useMemo(() => {\r\n    if (!jobOcrText) return null;\r\n    try {\r\n      return extractYear(jobOcrText);\r\n    } catch (e) {\r\n      console.warn('[WorkbenchHeader] Failed to extract year:', e);\r\n      return null;\r\n    }\r\n  }, [jobOcrText]);\r\n  \r\n  const getStatusColor = (status: string) => {\r\n    switch (status.toLowerCase()) {\r\n      case 'completed':\r\n      case 'complete':\r\n        return 'success';\r\n      case 'processing':\r\n        return 'info';\r\n      case 'failed':\r\n      case 'error':\r\n        return 'error';\r\n      default:\r\n        return 'default';\r\n    }\r\n  };\r\n  \r\n  const getConfidenceColor = (confidence: number) => {\r\n    if (confidence >= 0.8) return 'success';\r\n    if (confidence >= 0.5) return 'warning';\r\n    return 'error';\r\n  };\r\n  \r\n  return (\r\n    <Paper\r\n      elevation={0}\r\n      sx={{\r\n        p: 2,\r\n        borderBottom: '1px solid',\r\n        borderColor: 'divider',\r\n        bgcolor: 'background.paper',\r\n      }}\r\n    >\r\n      <Stack direction=\"row\" justifyContent=\"space-between\" alignItems=\"center\">\r\n        {/* Left: Job Info */}\r\n        <Stack direction=\"row\" spacing={2} alignItems=\"center\" sx={{ flex: 1, minWidth: 0 }}>\r\n          <Typography variant=\"h6\" fontWeight={600} noWrap sx={{ flex: 1, minWidth: 0 }}>\r\n            {jobFilename}\r\n          </Typography>\r\n          <Chip\r\n            size=\"small\"\r\n            label={jobRecordType}\r\n            color=\"primary\"\r\n            sx={{ textTransform: 'capitalize' }}\r\n          />\r\n          {detectedYear && (\r\n            <Chip\r\n              size=\"small\"\r\n              label={`Year ${detectedYear}`}\r\n              color=\"info\"\r\n              variant=\"outlined\"\r\n            />\r\n          )}\r\n          <Chip\r\n            size=\"small\"\r\n            label={jobStatus}\r\n            color={getStatusColor(jobStatus)}\r\n            sx={{ textTransform: 'capitalize' }}\r\n          />\r\n          {jobConfidence > 0 && (\r\n            <Chip\r\n              size=\"small\"\r\n              label={`${Math.round(jobConfidence * 100)}% confidence`}\r\n              color={getConfidenceColor(jobConfidence)}\r\n            />\r\n          )}\r\n        </Stack>\r\n        \r\n        {/* Right: Actions */}\r\n        <Stack direction=\"row\" spacing={1} alignItems=\"center\">\r\n          <Tooltip title=\"Copy OCR Text\">\r\n            <IconButton size=\"small\">\r\n              <IconCopy size={18} />\r\n            </IconButton>\r\n          </Tooltip>\r\n          <Tooltip title=\"Refresh\">\r\n            <IconButton size=\"small\">\r\n              <IconRefresh size={18} />\r\n            </IconButton>\r\n          </Tooltip>\r\n          <Tooltip title=\"Close Workbench\">\r\n            <IconButton size=\"small\" onClick={onClose}>\r\n              <IconX size={18} />\r\n            </IconButton>\r\n          </Tooltip>\r\n        </Stack>\r\n      </Stack>\r\n    </Paper>\r\n  );\r\n};\r\n\r\nexport default WorkbenchHeader;\r\n\r\n","/**\r\n * Image Viewport Metrics Helper\r\n * Provides accurate coordinate space calculations for image overlays\r\n * Ensures image and overlay share exact coordinate space\r\n */\r\n\r\nexport interface ImageViewportMetrics {\r\n  left: number;\r\n  top: number;\r\n  width: number;\r\n  height: number;\r\n  naturalWidth: number;\r\n  naturalHeight: number;\r\n  scaleX: number;\r\n  scaleY: number;\r\n  clientRect: DOMRect;\r\n}\r\n\r\n/**\r\n * Get viewport metrics for an image element\r\n * Uses getBoundingClientRect() for accurate positioning\r\n */\r\nexport function getImageViewportMetrics(imgEl: HTMLImageElement | null): ImageViewportMetrics | null {\r\n  if (!imgEl) return null;\r\n\r\n  const rect = imgEl.getBoundingClientRect();\r\n  const naturalWidth = imgEl.naturalWidth || 0;\r\n  const naturalHeight = imgEl.naturalHeight || 0;\r\n  const displayedWidth = rect.width;\r\n  const displayedHeight = rect.height;\r\n\r\n  // Calculate scale factors\r\n  const scaleX = naturalWidth > 0 ? displayedWidth / naturalWidth : 1;\r\n  const scaleY = naturalHeight > 0 ? displayedHeight / naturalHeight : 1;\r\n\r\n  return {\r\n    left: rect.left,\r\n    top: rect.top,\r\n    width: displayedWidth,\r\n    height: displayedHeight,\r\n    naturalWidth,\r\n    naturalHeight,\r\n    scaleX,\r\n    scaleY,\r\n    clientRect: rect,\r\n  };\r\n}\r\n\r\n/**\r\n * Convert vision-space coordinates to screen/client coordinates\r\n */\r\nexport function visionToScreen(\r\n  visionX: number,\r\n  visionY: number,\r\n  metrics: ImageViewportMetrics\r\n): { x: number; y: number } {\r\n  return {\r\n    x: metrics.left + visionX * metrics.scaleX,\r\n    y: metrics.top + visionY * metrics.scaleY,\r\n  };\r\n}\r\n\r\n/**\r\n * Convert screen/client coordinates to vision-space coordinates\r\n */\r\nexport function screenToVision(\r\n  screenX: number,\r\n  screenY: number,\r\n  metrics: ImageViewportMetrics\r\n): { x: number; y: number } {\r\n  return {\r\n    x: (screenX - metrics.left) / metrics.scaleX,\r\n    y: (screenY - metrics.top) / metrics.scaleY,\r\n  };\r\n}\r\n\r\n/**\r\n * Convert vision-space bbox to screen-space bbox\r\n * Vision coordinates are in Vision page space, need to scale to actual image space first\r\n */\r\nexport function visionBboxToScreen(\r\n  bbox: { x: number; y: number; w: number; h: number },\r\n  metrics: ImageViewportMetrics,\r\n  visionWidth?: number,\r\n  visionHeight?: number\r\n): { x: number; y: number; w: number; h: number } {\r\n  // If Vision page dimensions are provided and differ from natural dimensions,\r\n  // scale coordinates from Vision space to actual image space first\r\n  let scaledBbox = bbox;\r\n  if (visionWidth && visionHeight && metrics.naturalWidth && metrics.naturalHeight) {\r\n    const visionToImageScaleX = metrics.naturalWidth / visionWidth;\r\n    const visionToImageScaleY = metrics.naturalHeight / visionHeight;\r\n    \r\n    // Only apply scaling if dimensions differ significantly (>1% difference)\r\n    if (Math.abs(visionToImageScaleX - 1) > 0.01 || Math.abs(visionToImageScaleY - 1) > 0.01) {\r\n      scaledBbox = {\r\n        x: bbox.x * visionToImageScaleX,\r\n        y: bbox.y * visionToImageScaleY,\r\n        w: bbox.w * visionToImageScaleX,\r\n        h: bbox.h * visionToImageScaleY,\r\n      };\r\n    }\r\n  }\r\n  \r\n  // Then scale to screen space\r\n  return {\r\n    x: metrics.left + scaledBbox.x * metrics.scaleX,\r\n    y: metrics.top + scaledBbox.y * metrics.scaleY,\r\n    w: scaledBbox.w * metrics.scaleX,\r\n    h: scaledBbox.h * metrics.scaleY,\r\n  };\r\n}\r\n\r\n/**\r\n * Convert screen-space bbox to vision-space bbox\r\n */\r\nexport function screenBboxToVision(\r\n  screenBbox: { x: number; y: number; w: number; h: number },\r\n  metrics: ImageViewportMetrics\r\n): { x: number; y: number; w: number; h: number } {\r\n  return {\r\n    x: (screenBbox.x - metrics.left) / metrics.scaleX,\r\n    y: (screenBbox.y - metrics.top) / metrics.scaleY,\r\n    w: screenBbox.w / metrics.scaleX,\r\n    h: screenBbox.h / metrics.scaleY,\r\n  };\r\n}\r\n\r\n","/**\r\n * EditableBBox - Editable bounding box component with drag and resize handles\r\n * Supports dragging, resizing, and drawing new boxes\r\n */\r\n\r\nimport React, { useRef, useState, useCallback, useEffect, useMemo } from 'react';\r\nimport { Box, useTheme } from '@mui/material';\r\nimport { BBox } from '../types/fusion';\r\nimport { getImageViewportMetrics, screenToVision, visionBboxToScreen } from '../utils/imageViewportMetrics';\r\n\r\ninterface EditableBBoxProps {\r\n  bbox: BBox;\r\n  onBboxChange: (bbox: BBox) => void;\r\n  onBboxChangeEnd?: (bbox: BBox) => void;\r\n  imageElement: HTMLImageElement | null; // Actual image element for coordinate space\r\n  visionWidth: number;\r\n  visionHeight: number;\r\n  minWidth?: number;\r\n  minHeight?: number;\r\n  disabled?: boolean;\r\n  color?: string;\r\n  label?: string;\r\n}\r\n\r\ntype ResizeHandle = 'nw' | 'ne' | 'sw' | 'se' | 'n' | 's' | 'e' | 'w' | null;\r\ntype InteractionMode = 'none' | 'drag' | 'resize' | 'draw';\r\n\r\n// Pure function - can be defined outside component\r\nfunction getHandlePosition(handle: ResizeHandle, bbox: { x: number; y: number; w: number; h: number }) {\r\n  switch (handle) {\r\n    case 'nw':\r\n      return { x: bbox.x, y: bbox.y };\r\n    case 'ne':\r\n      return { x: bbox.x + bbox.w, y: bbox.y };\r\n    case 'sw':\r\n      return { x: bbox.x, y: bbox.y + bbox.h };\r\n    case 'se':\r\n      return { x: bbox.x + bbox.w, y: bbox.y + bbox.h };\r\n    case 'n':\r\n      return { x: bbox.x + bbox.w / 2, y: bbox.y };\r\n    case 's':\r\n      return { x: bbox.x + bbox.w / 2, y: bbox.y + bbox.h };\r\n    case 'e':\r\n      return { x: bbox.x + bbox.w, y: bbox.y + bbox.h / 2 };\r\n    case 'w':\r\n      return { x: bbox.x, y: bbox.y + bbox.h / 2 };\r\n    default:\r\n      return { x: 0, y: 0 };\r\n  }\r\n}\r\n\r\nfunction getResizeCursor(handle: ResizeHandle | null): string {\r\n  switch (handle) {\r\n    case 'nw':\r\n    case 'se':\r\n      return 'nwse-resize';\r\n    case 'ne':\r\n    case 'sw':\r\n      return 'nesw-resize';\r\n    case 'n':\r\n    case 's':\r\n      return 'ns-resize';\r\n    case 'e':\r\n    case 'w':\r\n      return 'ew-resize';\r\n    default:\r\n      return 'grab';\r\n  }\r\n}\r\n\r\nfunction EditableBBox({\r\n  bbox,\r\n  onBboxChange,\r\n  onBboxChangeEnd,\r\n  imageElement,\r\n  visionWidth,\r\n  visionHeight,\r\n  minWidth = 20,\r\n  minHeight = 20,\r\n  disabled = false,\r\n  color = '#4CAF50',\r\n  label,\r\n}: EditableBBoxProps): React.ReactElement {\r\n  const theme = useTheme();\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const [isDragging, setIsDragging] = useState(false);\r\n  const [isResizing, setIsResizing] = useState(false);\r\n  const [resizeHandle, setResizeHandle] = useState<ResizeHandle>(null);\r\n  const [dragStart, setDragStart] = useState<{ x: number; y: number } | null>(null);\r\n  const [bboxAtStart, setBboxAtStart] = useState<BBox | null>(null);\r\n  const [isDrawing, setIsDrawing] = useState(false);\r\n  const [drawStart, setDrawStart] = useState<{ x: number; y: number } | null>(null);\r\n  const [metrics, setMetrics] = useState<ReturnType<typeof getImageViewportMetrics> | null>(null);\r\n  \r\n  const handleSize = 10; // Size of resize handles in pixels (increased for better hit area)\r\n\r\n  // Update metrics when image element changes\r\n  useEffect(() => {\r\n    if (!imageElement) {\r\n      setMetrics(null);\r\n      return;\r\n    }\r\n\r\n    const updateMetrics = () => {\r\n      const newMetrics = getImageViewportMetrics(imageElement);\r\n      setMetrics(newMetrics);\r\n    };\r\n\r\n    updateMetrics();\r\n    imageElement.addEventListener('load', updateMetrics);\r\n    \r\n    const resizeObserver = new ResizeObserver(() => {\r\n      updateMetrics();\r\n    });\r\n    const container = imageElement.parentElement;\r\n    if (container) {\r\n      resizeObserver.observe(container);\r\n    }\r\n    resizeObserver.observe(imageElement);\r\n\r\n    const mutationObserver = new MutationObserver(() => {\r\n      updateMetrics();\r\n    });\r\n    mutationObserver.observe(imageElement, {\r\n      attributes: true,\r\n      attributeFilter: ['style'],\r\n    });\r\n\r\n    return () => {\r\n      imageElement.removeEventListener('load', updateMetrics);\r\n      resizeObserver.disconnect();\r\n      mutationObserver.disconnect();\r\n    };\r\n  }, [imageElement]);\r\n\r\n  // Convert vision-space bbox to screen-space\r\n  const screenBbox = useMemo(() => {\r\n    if (!metrics) {\r\n      return { x: 0, y: 0, w: 0, h: 0 };\r\n    }\r\n    const screen = visionBboxToScreen(bbox, metrics);\r\n    // Adjust relative to overlay container\r\n    const containerRect = containerRef.current?.parentElement?.getBoundingClientRect();\r\n    if (!containerRect) return screen;\r\n    return {\r\n      x: screen.x - (metrics.left - containerRect.left),\r\n      y: screen.y - (metrics.top - containerRect.top),\r\n      w: screen.w,\r\n      h: screen.h,\r\n    };\r\n  }, [bbox, metrics]);\r\n\r\n  // Clamp bbox to image bounds\r\n  const clampBbox = useCallback((bbox: BBox): BBox => {\r\n    const maxX = visionWidth;\r\n    const maxY = visionHeight;\r\n    \r\n    let x = Math.max(0, Math.min(bbox.x, maxX - minWidth));\r\n    let y = Math.max(0, Math.min(bbox.y, maxY - minHeight));\r\n    let w = Math.max(minWidth, Math.min(bbox.w, maxX - x));\r\n    let h = Math.max(minHeight, Math.min(bbox.h, maxY - y));\r\n\r\n    return { x, y, w, h };\r\n  }, [visionWidth, visionHeight, minWidth, minHeight]);\r\n\r\n  // Convert screen/client coords to vision coords using metrics\r\n  const screenToVisionCoords = useCallback((clientX: number, clientY: number): { x: number; y: number } | null => {\r\n    if (!metrics) return null;\r\n    return screenToVision(clientX, clientY, metrics);\r\n  }, [metrics]);\r\n\r\n  // Handle pointer down for drag/resize with pointer capture\r\n  const handlePointerDown = useCallback((e: React.PointerEvent) => {\r\n    if (disabled || !metrics) return;\r\n    \r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    \r\n    // Capture pointer to ensure we receive all events\r\n    const target = e.currentTarget as HTMLElement;\r\n    target.setPointerCapture(e.pointerId);\r\n\r\n    // Get container rect for coordinate calculation\r\n    const containerRect = containerRef.current?.parentElement?.getBoundingClientRect();\r\n    if (!containerRect) return;\r\n\r\n    // Convert to container-relative coordinates\r\n    const containerX = e.clientX - containerRect.left;\r\n    const containerY = e.clientY - containerRect.top;\r\n    \r\n    // Adjust for overlay offset\r\n    const overlayX = containerX - (metrics.left - containerRect.left);\r\n    const overlayY = containerY - (metrics.top - containerRect.top);\r\n\r\n    // Check if clicking on a resize handle\r\n    const handles: ResizeHandle[] = ['nw', 'ne', 'sw', 'se', 'n', 's', 'e', 'w'];\r\n    \r\n    for (const handle of handles) {\r\n      const handlePos = getHandlePosition(handle, screenBbox);\r\n      const dist = Math.sqrt(\r\n        Math.pow(overlayX - handlePos.x, 2) + Math.pow(overlayY - handlePos.y, 2)\r\n      );\r\n      if (dist < handleSize) {\r\n        setResizeHandle(handle);\r\n        setIsResizing(true);\r\n        setBboxAtStart(bbox);\r\n        const visionCoords = screenToVisionCoords(e.clientX, e.clientY);\r\n        if (visionCoords) {\r\n          setDragStart(visionCoords);\r\n        }\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Otherwise, start dragging\r\n    setIsDragging(true);\r\n    setBboxAtStart(bbox);\r\n    const visionCoords = screenToVisionCoords(e.clientX, e.clientY);\r\n    if (visionCoords) {\r\n      setDragStart(visionCoords);\r\n    }\r\n  }, [disabled, screenBbox, bbox, screenToVisionCoords, handleSize, metrics]);\r\n\r\n  // Handle pointer move with pointer capture\r\n  const handlePointerMove = useCallback((e: React.PointerEvent) => {\r\n    if (disabled || !metrics) return;\r\n\r\n    if (isDrawing && drawStart) {\r\n      const visionCoords = screenToVisionCoords(e.clientX, e.clientY);\r\n      if (!visionCoords) return;\r\n\r\n      const newBbox = {\r\n        x: Math.min(drawStart.x, visionCoords.x),\r\n        y: Math.min(drawStart.y, visionCoords.y),\r\n        w: Math.abs(visionCoords.x - drawStart.x),\r\n        h: Math.abs(visionCoords.y - drawStart.y),\r\n      };\r\n\r\n      onBboxChange(clampBbox(newBbox));\r\n    } else if (isDragging && dragStart && bboxAtStart) {\r\n      const visionCoords = screenToVisionCoords(e.clientX, e.clientY);\r\n      if (!visionCoords) return;\r\n\r\n      const deltaX = visionCoords.x - dragStart.x;\r\n      const deltaY = visionCoords.y - dragStart.y;\r\n\r\n      const newBbox = clampBbox({\r\n        x: bboxAtStart.x + deltaX,\r\n        y: bboxAtStart.y + deltaY,\r\n        w: bboxAtStart.w,\r\n        h: bboxAtStart.h,\r\n      });\r\n\r\n      onBboxChange(newBbox);\r\n    } else if (isResizing && resizeHandle && dragStart && bboxAtStart) {\r\n      const visionCoords = screenToVisionCoords(e.clientX, e.clientY);\r\n      if (!visionCoords) return;\r\n\r\n      const deltaX = visionCoords.x - dragStart.x;\r\n      const deltaY = visionCoords.y - dragStart.y;\r\n\r\n      let newBbox = { ...bboxAtStart };\r\n\r\n      // Resize based on handle\r\n      switch (resizeHandle) {\r\n        case 'nw':\r\n          newBbox.x = bboxAtStart.x + deltaX;\r\n          newBbox.y = bboxAtStart.y + deltaY;\r\n          newBbox.w = bboxAtStart.w - deltaX;\r\n          newBbox.h = bboxAtStart.h - deltaY;\r\n          break;\r\n        case 'ne':\r\n          newBbox.y = bboxAtStart.y + deltaY;\r\n          newBbox.w = bboxAtStart.w + deltaX;\r\n          newBbox.h = bboxAtStart.h - deltaY;\r\n          break;\r\n        case 'sw':\r\n          newBbox.x = bboxAtStart.x + deltaX;\r\n          newBbox.w = bboxAtStart.w - deltaX;\r\n          newBbox.h = bboxAtStart.h + deltaY;\r\n          break;\r\n        case 'se':\r\n          newBbox.w = bboxAtStart.w + deltaX;\r\n          newBbox.h = bboxAtStart.h + deltaY;\r\n          break;\r\n        case 'n':\r\n          newBbox.y = bboxAtStart.y + deltaY;\r\n          newBbox.h = bboxAtStart.h - deltaY;\r\n          break;\r\n        case 's':\r\n          newBbox.h = bboxAtStart.h + deltaY;\r\n          break;\r\n        case 'e':\r\n          newBbox.w = bboxAtStart.w + deltaX;\r\n          break;\r\n        case 'w':\r\n          newBbox.x = bboxAtStart.x + deltaX;\r\n          newBbox.w = bboxAtStart.w - deltaX;\r\n          break;\r\n      }\r\n\r\n      // Ensure minimum size\r\n      if (newBbox.w < minWidth) {\r\n        if (resizeHandle?.includes('w')) {\r\n          newBbox.x = bboxAtStart.x + bboxAtStart.w - minWidth;\r\n        }\r\n        newBbox.w = minWidth;\r\n      }\r\n      if (newBbox.h < minHeight) {\r\n        if (resizeHandle?.includes('n')) {\r\n          newBbox.y = bboxAtStart.y + bboxAtStart.h - minHeight;\r\n        }\r\n        newBbox.h = minHeight;\r\n      }\r\n\r\n      onBboxChange(clampBbox(newBbox));\r\n    }\r\n  }, [disabled, isDragging, isResizing, isDrawing, dragStart, drawStart, bboxAtStart, resizeHandle, onBboxChange, clampBbox, minWidth, minHeight, metrics, screenToVisionCoords]);\r\n\r\n  // Handle pointer up and release capture\r\n  const handlePointerUp = useCallback((e: React.PointerEvent) => {\r\n    const target = e.currentTarget as HTMLElement;\r\n    target.releasePointerCapture(e.pointerId);\r\n\r\n    if (isDragging || isResizing || isDrawing) {\r\n      if (onBboxChangeEnd && bbox) {\r\n        onBboxChangeEnd(bbox);\r\n      }\r\n    }\r\n    setIsDragging(false);\r\n    setIsResizing(false);\r\n    setIsDrawing(false);\r\n    setResizeHandle(null);\r\n    setDragStart(null);\r\n    setDrawStart(null);\r\n    setBboxAtStart(null);\r\n  }, [isDragging, isResizing, isDrawing, bbox, onBboxChangeEnd]);\r\n\r\n  // Start drawing mode (using pointer events)\r\n  const startDrawing = useCallback((e: React.PointerEvent) => {\r\n    if (disabled || !metrics) return;\r\n    \r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    \r\n    const target = e.currentTarget as HTMLElement;\r\n    target.setPointerCapture(e.pointerId);\r\n\r\n    const visionCoords = screenToVisionCoords(e.clientX, e.clientY);\r\n    if (!visionCoords) return;\r\n\r\n    setIsDrawing(true);\r\n    setDrawStart(visionCoords);\r\n  }, [disabled, metrics, screenToVisionCoords]);\r\n\r\n  const cursor = isDragging ? 'grabbing' : isResizing ? getResizeCursor(resizeHandle) : disabled ? 'default' : 'grab';\r\n\r\n  return (\r\n    <Box\r\n      ref={containerRef}\r\n      onPointerDown={handlePointerDown}\r\n      onPointerMove={handlePointerMove}\r\n      onPointerUp={handlePointerUp}\r\n      sx={{\r\n        position: 'absolute',\r\n        left: screenBbox.x,\r\n        top: screenBbox.y,\r\n        width: screenBbox.w,\r\n        height: screenBbox.h,\r\n        border: `2px solid ${color}`,\r\n        bgcolor: disabled ? 'transparent' : `${color}20`,\r\n        cursor,\r\n        pointerEvents: disabled ? 'none' : 'auto',\r\n        zIndex: isDragging || isResizing ? 100 : 10,\r\n        '&:hover': {\r\n          borderColor: disabled ? color : theme.palette.primary.main,\r\n        },\r\n      }}\r\n    >\r\n      {/* Label */}\r\n      {label && (\r\n        <Box\r\n          sx={{\r\n            position: 'absolute',\r\n            top: -24,\r\n            left: 0,\r\n            bgcolor: color,\r\n            color: 'white',\r\n            px: 0.5,\r\n            py: 0.25,\r\n            fontSize: 10,\r\n            fontWeight: 600,\r\n            whiteSpace: 'nowrap',\r\n            pointerEvents: 'none',\r\n          }}\r\n        >\r\n          {label}\r\n        </Box>\r\n      )}\r\n\r\n      {/* Resize handles */}\r\n      {!disabled && (\r\n        <>\r\n          {(['nw', 'ne', 'sw', 'se', 'n', 's', 'e', 'w'] as ResizeHandle[]).map((handle) => {\r\n            const pos = getHandlePosition(handle, screenBbox);\r\n            return (\r\n              <Box\r\n                key={handle}\r\n                onPointerDown={(e) => {\r\n                  e.preventDefault();\r\n                  e.stopPropagation();\r\n                  const target = e.currentTarget as HTMLElement;\r\n                  target.setPointerCapture(e.pointerId);\r\n                  setResizeHandle(handle);\r\n                  setIsResizing(true);\r\n                  setBboxAtStart(bbox);\r\n                  const visionCoords = screenToVisionCoords(e.clientX, e.clientY);\r\n                  if (visionCoords) {\r\n                    setDragStart(visionCoords);\r\n                  }\r\n                }}\r\n                sx={{\r\n                  position: 'absolute',\r\n                  left: pos.x - handleSize / 2,\r\n                  top: pos.y - handleSize / 2,\r\n                  width: handleSize,\r\n                  height: handleSize,\r\n                  bgcolor: color,\r\n                  border: `1px solid white`,\r\n                  borderRadius: '50%',\r\n                  cursor: getResizeCursor(handle),\r\n                  zIndex: 101,\r\n                  pointerEvents: 'all', // Ensure handles are always interactive\r\n                  '&:hover': {\r\n                    bgcolor: theme.palette.primary.main,\r\n                    transform: 'scale(1.2)',\r\n                  },\r\n                }}\r\n              />\r\n            );\r\n          })}\r\n        </>\r\n      )}\r\n    </Box>\r\n  );\r\n}\r\n\r\nexport default EditableBBox;\r\n\r\n","/**\r\n * FusionOverlay - Overlay component for highlighting bounding boxes on OCR images\r\n * Uses exact coordinate space matching the underlying image element\r\n */\r\n\r\nimport React, { useMemo, useEffect, useLayoutEffect, useState, useRef, useCallback } from 'react';\r\nimport { Box, Typography, alpha, useTheme } from '@mui/material';\r\nimport { BBox } from '../types/fusion';\r\nimport EditableBBox from './EditableBBox';\r\nimport { getImageViewportMetrics, visionBboxToScreen } from '../utils/imageViewportMetrics';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface OverlayBox {\r\n  bbox: BBox;\r\n  color: string;\r\n  label?: string;\r\n  emphasized?: boolean;\r\n  completed?: boolean;\r\n  selected?: boolean;\r\n  entryIndex?: number;\r\n  onClick?: () => void;\r\n  editable?: boolean;\r\n  onBboxChange?: (bbox: BBox) => void;\r\n  onBboxChangeEnd?: (bbox: BBox) => void;\r\n}\r\n\r\ninterface FusionOverlayProps {\r\n  boxes: OverlayBox[];\r\n  imageElement: HTMLImageElement | null; // Actual image element for coordinate space\r\n  visionWidth: number; // Original Vision page width (from Vision API)\r\n  visionHeight: number; // Original Vision page height (from Vision API)\r\n  showLabels?: boolean;\r\n  hideCompleted?: boolean; // Extra dark mask for completed entries\r\n  onTokenClick?: (tokenId: string, bbox: BBox, text: string) => void;\r\n  onTokenDoubleClick?: (tokenId: string, bbox: BBox, text: string) => void;\r\n  ocrTokens?: Array<{ id: string; text: string; bbox: BBox; confidence?: number }>; // OCR tokens for interaction\r\n  editMode?: boolean; // When true, overlay becomes interactive for bbox editing; when false, overlay is pass-through\r\n}\r\n\r\n// ============================================================================\r\n// Component\r\n// ============================================================================\r\n\r\nexport const FusionOverlay: React.FC<FusionOverlayProps> = ({\r\n  boxes = [], // Default to empty array to ensure stable prop\r\n  imageElement,\r\n  visionWidth = 0, // Vision API page width\r\n  visionHeight = 0, // Vision API page height\r\n  showLabels = true,\r\n  hideCompleted = false,\r\n  onTokenClick,\r\n  onTokenDoubleClick,\r\n  ocrTokens = [],\r\n  editMode = false, // Default to non-interactive\r\n}) => {\r\n  // ALL HOOKS MUST BE CALLED UNCONDITIONALLY - no early returns before hooks\r\n  const theme = useTheme();\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const containerOffsetRef = useRef({ x: 0, y: 0 });\r\n  const [metrics, setMetrics] = useState<ReturnType<typeof getImageViewportMetrics> | null>(null);\r\n  \r\n  // Debug helper: log pointer target on mousemove (dev mode only)\r\n  useEffect(() => {\r\n    if (!containerRef.current || process.env.NODE_ENV === 'production') return;\r\n    \r\n    const debugEnabled = localStorage.getItem('om.ocr.debugPointerEvents') === 'true';\r\n    if (!debugEnabled) return;\r\n    \r\n    const handleMouseMove = (e: MouseEvent) => {\r\n      const target = e.target as HTMLElement;\r\n      if (containerRef.current?.contains(target)) {\r\n        console.log('[FusionOverlay Debug] Pointer target:', {\r\n          tagName: target.tagName,\r\n          className: target.className,\r\n          editMode,\r\n          pointerEvents: window.getComputedStyle(target).pointerEvents,\r\n        });\r\n      }\r\n    };\r\n    \r\n    window.addEventListener('mousemove', handleMouseMove);\r\n    return () => window.removeEventListener('mousemove', handleMouseMove);\r\n  }, [editMode]);\r\n\r\n  // Normalize boxes to always be an array - MUST be called before any conditional returns\r\n  const normalizedBoxes = useMemo(() => {\r\n    if (!boxes || !Array.isArray(boxes)) {\r\n      return [];\r\n    }\r\n    return boxes;\r\n  }, [boxes]);\r\n\r\n  // Normalize ocrTokens to always be an array - MUST be called before any conditional returns\r\n  const normalizedOcrTokens = useMemo(() => {\r\n    if (!ocrTokens || !Array.isArray(ocrTokens)) {\r\n      return [];\r\n    }\r\n    return ocrTokens;\r\n  }, [ocrTokens]);\r\n\r\n  // Update metrics when image element changes or resizes\r\n  useEffect(() => {\r\n    if (!imageElement) {\r\n      setMetrics(null);\r\n      return;\r\n    }\r\n\r\n    const updateMetrics = () => {\r\n      const newMetrics = getImageViewportMetrics(imageElement);\r\n      setMetrics(newMetrics);\r\n    };\r\n\r\n    // Initial measurement\r\n    updateMetrics();\r\n\r\n    // Watch for image load/resize\r\n    imageElement.addEventListener('load', updateMetrics);\r\n    \r\n    // Use ResizeObserver for container changes\r\n    const resizeObserver = new ResizeObserver(() => {\r\n      updateMetrics();\r\n    });\r\n\r\n    // Observe the image element's parent container if available\r\n    const container = imageElement.parentElement;\r\n    if (container) {\r\n      resizeObserver.observe(container);\r\n    }\r\n    resizeObserver.observe(imageElement);\r\n\r\n    // Also watch for zoom changes (CSS transform changes)\r\n    const mutationObserver = new MutationObserver(() => {\r\n      updateMetrics();\r\n    });\r\n    mutationObserver.observe(imageElement, {\r\n      attributes: true,\r\n      attributeFilter: ['style'],\r\n    });\r\n\r\n    return () => {\r\n      imageElement.removeEventListener('load', updateMetrics);\r\n      resizeObserver.disconnect();\r\n      mutationObserver.disconnect();\r\n    };\r\n  }, [imageElement]);\r\n\r\n  // Convert vision-space bbox to screen-space using metrics\r\n  // Vision coordinates are in Vision page space, need to scale to actual image space first\r\n  const toScreenBBox = useCallback((bbox: BBox) => {\r\n    if (!metrics) {\r\n      return { x: 0, y: 0, w: 0, h: 0 };\r\n    }\r\n    return visionBboxToScreen(bbox, metrics, visionWidth, visionHeight);\r\n  }, [metrics, visionWidth, visionHeight]);\r\n\r\n  // Calculate container offset - use useLayoutEffect to sync with DOM without causing render loops\r\n  useLayoutEffect(() => {\r\n    if (!metrics || !containerRef.current) {\r\n      const zeroOffset = { x: 0, y: 0 };\r\n      containerOffsetRef.current = zeroOffset;\r\n      return;\r\n    }\r\n    \r\n    const containerRect = containerRef.current.parentElement?.getBoundingClientRect();\r\n    if (!containerRect) {\r\n      const zeroOffset = { x: 0, y: 0 };\r\n      containerOffsetRef.current = zeroOffset;\r\n      return;\r\n    }\r\n    \r\n    const newOffset = {\r\n      x: metrics.left - containerRect.left,\r\n      y: metrics.top - containerRect.top,\r\n    };\r\n    \r\n    // Only update if changed to avoid unnecessary work\r\n    if (containerOffsetRef.current.x !== newOffset.x || containerOffsetRef.current.y !== newOffset.y) {\r\n      containerOffsetRef.current = newOffset;\r\n    }\r\n  }, [metrics]);\r\n\r\n  // Calculate overlay position - MUST be called before conditional return\r\n  const overlayStyle = useMemo(() => {\r\n    if (!metrics) {\r\n      return { position: 'absolute' as const, top: 0, left: 0, width: 0, height: 0 };\r\n    }\r\n\r\n    // Guard against undefined ref values\r\n    const offsetX = containerOffsetRef.current?.x ?? 0;\r\n    const offsetY = containerOffsetRef.current?.y ?? 0;\r\n    const width = metrics.width ?? 0;\r\n    const height = metrics.height ?? 0;\r\n\r\n    return {\r\n      position: 'absolute' as const,\r\n      left: offsetX,\r\n      top: offsetY,\r\n      width: width,\r\n      height: height,\r\n    };\r\n  }, [metrics]);\r\n\r\n  // NOW safe to do conditional return - all hooks have been called\r\n  // Early return if no metrics, no boxes, or invalid dimensions\r\n  if (!metrics || normalizedBoxes.length === 0 || metrics.width === 0 || metrics.height === 0) {\r\n    // Return empty state instead of null for better UX\r\n    return (\r\n      <Box\r\n        sx={{\r\n          position: 'absolute',\r\n          top: '50%',\r\n          left: '50%',\r\n          transform: 'translate(-50%, -50%)',\r\n          zIndex: 5,\r\n          pointerEvents: 'none',\r\n        }}\r\n      >\r\n        <Typography\r\n          variant=\"caption\"\r\n          sx={{\r\n            color: 'text.secondary',\r\n            fontSize: '0.75rem',\r\n            opacity: 0.6,\r\n          }}\r\n        >\r\n          No entries detected\r\n        </Typography>\r\n      </Box>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Box\r\n      ref={containerRef}\r\n      sx={{\r\n        ...overlayStyle,\r\n        // Root overlay is non-interactive by default - only children become interactive in edit mode\r\n        pointerEvents: 'none', // Pass-through by default, children selectively enable pointer events\r\n        zIndex: 5, // Only above image, not above side panel\r\n      }}\r\n    >\r\n      {normalizedBoxes.map((box, idx) => {\r\n        // Guard against undefined box properties\r\n        if (!box || !box.bbox) {\r\n          console.warn(`[FusionOverlay] Invalid box at index ${idx}:`, box);\r\n          return null;\r\n        }\r\n\r\n        const screenBbox = toScreenBBox(box.bbox);\r\n        const isCompleted = box.completed ?? false;\r\n        const isSelected = (box.selected ?? false) || (box.emphasized ?? false);\r\n        const borderWidth = isSelected ? 3 : 2;\r\n        \r\n        // Determine styling based on state - default color if missing\r\n        const boxColor = box.color || theme.palette.primary.main;\r\n        const borderColor = isCompleted \r\n          ? theme.palette.success.main \r\n          : isSelected \r\n            ? theme.palette.primary.main \r\n            : boxColor;\r\n        \r\n        const bgOpacity = isCompleted \r\n          ? (hideCompleted ? 0.85 : 0.45) \r\n          : isSelected \r\n            ? 0.15 \r\n            : 0.1;\r\n        \r\n        const bgColor = isCompleted \r\n          ? `rgba(0,0,0,${bgOpacity})` \r\n          : alpha(boxColor, bgOpacity);\r\n\r\n        // Use EditableBBox if editable, otherwise use regular box\r\n        if (box.editable && box.onBboxChange && metrics) {\r\n          // EditableBBox handles its own positioning and pointer events\r\n          // It will respect the disabled prop which we set based on editMode\r\n          return (\r\n            <EditableBBox\r\n              key={idx}\r\n              bbox={box.bbox}\r\n              onBboxChange={box.onBboxChange}\r\n              onBboxChangeEnd={box.onBboxChangeEnd}\r\n              imageElement={imageElement}\r\n              visionWidth={visionWidth}\r\n              visionHeight={visionHeight}\r\n              color={borderColor}\r\n              label={box.label}\r\n              disabled={!editMode} // Disable when not in edit mode (pointerEvents: 'none' in EditableBBox)\r\n            />\r\n          );\r\n        }\r\n\r\n        // Guard against undefined container offset\r\n        const offsetX = containerOffsetRef.current?.x ?? 0;\r\n        const offsetY = containerOffsetRef.current?.y ?? 0;\r\n\r\n        // Adjust screenBbox position relative to overlay container (subtract container offset)\r\n        const adjustedBbox = {\r\n          x: screenBbox.x - offsetX,\r\n          y: screenBbox.y - offsetY,\r\n          w: screenBbox.w,\r\n          h: screenBbox.h,\r\n        };\r\n\r\n        return (\r\n          <Box\r\n            key={idx}\r\n            onClick={box.onClick}\r\n            onDoubleClick={(e) => {\r\n              e.stopPropagation();\r\n              if (box.onClick) box.onClick();\r\n            }}\r\n            sx={{\r\n              position: 'absolute',\r\n              left: adjustedBbox.x,\r\n              top: adjustedBbox.y,\r\n              width: adjustedBbox.w,\r\n              height: adjustedBbox.h,\r\n              border: `${borderWidth}px solid ${borderColor}`,\r\n              bgcolor: bgColor,\r\n              borderRadius: 0.5,\r\n              transition: 'background-color 300ms ease, border-color 300ms ease, opacity 300ms ease',\r\n              // Only enable pointer events when in edit mode AND box has onClick handler\r\n              pointerEvents: (editMode && box.onClick) ? 'auto' : 'none',\r\n              cursor: (editMode && box.onClick) ? 'pointer' : 'default',\r\n              boxShadow: isSelected ? `0 0 12px ${alpha(borderColor, 0.5)}` : 'none',\r\n              '&:hover': (editMode && box.onClick) ? {\r\n                borderColor: theme.palette.primary.light,\r\n              } : {},\r\n            }}\r\n          >\r\n            {/* Completed badge */}\r\n            {isCompleted && (\r\n              <Box\r\n                sx={{\r\n                  position: 'absolute',\r\n                  top: 4,\r\n                  left: 4,\r\n                  bgcolor: theme.palette.success.main,\r\n                  color: 'white',\r\n                  px: 0.75,\r\n                  py: 0.25,\r\n                  borderRadius: 0.5,\r\n                  fontSize: 10,\r\n                  fontWeight: 700,\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  gap: 0.5,\r\n                  boxShadow: theme.shadows[2],\r\n                }}\r\n              >\r\n                ✓ Completed\r\n              </Box>\r\n            )}\r\n            \r\n            {/* Entry number label */}\r\n            {showLabels && box.label && (\r\n              <Typography\r\n                variant=\"caption\"\r\n                sx={{\r\n                  position: 'absolute',\r\n                  top: isCompleted ? 28 : -20,\r\n                  left: 0,\r\n                  bgcolor: borderColor,\r\n                  color: 'white',\r\n                  px: 0.5,\r\n                  py: 0.25,\r\n                  borderRadius: 0.5,\r\n                  fontSize: 10,\r\n                  fontWeight: 600,\r\n                  whiteSpace: 'nowrap',\r\n                  lineHeight: 1.2,\r\n                  boxShadow: theme.shadows[2],\r\n                }}\r\n              >\r\n                {box.label}\r\n              </Typography>\r\n            )}\r\n          </Box>\r\n        );\r\n      })}\r\n\r\n      {/* OCR Token Overlays - Interactive */}\r\n      {normalizedOcrTokens.map((token) => {\r\n        // Guard against undefined token properties\r\n        if (!token || !token.bbox) {\r\n          return null;\r\n        }\r\n\r\n        const screenBbox = toScreenBBox(token.bbox);\r\n        const offsetX = containerOffsetRef.current?.x ?? 0;\r\n        const offsetY = containerOffsetRef.current?.y ?? 0;\r\n        const adjustedBbox = {\r\n          x: screenBbox.x - offsetX,\r\n          y: screenBbox.y - offsetY,\r\n          w: screenBbox.w,\r\n          h: screenBbox.h,\r\n        };\r\n\r\n        return (\r\n          <Box\r\n            key={token.id}\r\n            onClick={(e) => {\r\n              e.stopPropagation();\r\n              if (onTokenClick) {\r\n                onTokenClick(token.id, token.bbox, token.text);\r\n              }\r\n            }}\r\n            onDoubleClick={(e) => {\r\n              e.stopPropagation();\r\n              if (onTokenDoubleClick) {\r\n                onTokenDoubleClick(token.id, token.bbox, token.text);\r\n              }\r\n            }}\r\n            sx={{\r\n              position: 'absolute',\r\n              left: adjustedBbox.x,\r\n              top: adjustedBbox.y,\r\n              width: Math.max(adjustedBbox.w, 10), // Minimum hit area\r\n              height: Math.max(adjustedBbox.h, 10),\r\n              bgcolor: alpha(theme.palette.info.main, 0.2),\r\n              border: `1px solid ${alpha(theme.palette.info.main, 0.5)}`,\r\n              borderRadius: 0.5,\r\n              // OCR tokens are interactive only when in edit mode OR when they have click handlers\r\n              // In non-edit mode, tokens should be pass-through to allow text selection\r\n              pointerEvents: (editMode || onTokenClick || onTokenDoubleClick) ? 'auto' : 'none',\r\n              cursor: (editMode || onTokenClick || onTokenDoubleClick) ? 'pointer' : 'default',\r\n              zIndex: 3,\r\n              '&:hover': (editMode || onTokenClick || onTokenDoubleClick) ? {\r\n                bgcolor: alpha(theme.palette.info.main, 0.4),\r\n                borderColor: theme.palette.info.main,\r\n                borderWidth: 2,\r\n              } : {},\r\n            }}\r\n            title={`${token.text}${token.confidence ? ` (${Math.round(token.confidence * 100)}%)` : ''}`}\r\n          />\r\n        );\r\n      })}\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default FusionOverlay;\r\n\r\n","/**\r\n * Vision JSON Parser Utilities\r\n * Parses Google Vision API response into structured lines, tokens, and entries\r\n */\r\n\r\nimport {\r\n  BBox,\r\n  FusionEntry,\r\n  FusionLine,\r\n  FusionToken,\r\n  VisionResponse,\r\n  VisionBlock,\r\n  VisionParagraph,\r\n  VisionWord,\r\n  VisionSymbol,\r\n  VisionBoundingPoly,\r\n  VisionVertex,\r\n  DetectedLabel,\r\n  LABEL_DICTIONARIES,\r\n} from '../types/fusion';\r\nimport { getRecordSchema, validateFieldKeys } from '@/shared/recordSchemas/registry';\r\nimport { getDefaultColumns } from '../config/defaultRecordColumns';\r\n\r\n// ============================================================================\r\n// BBox Utilities\r\n// ============================================================================\r\n\r\n/**\r\n * Convert Vision vertices to our BBox format\r\n */\r\nexport function verticesToBBox(vertices: VisionVertex[] | undefined): BBox {\r\n  if (!vertices || vertices.length < 4) {\r\n    return { x: 0, y: 0, w: 0, h: 0 };\r\n  }\r\n  \r\n  const xs = vertices.map(v => v.x || 0);\r\n  const ys = vertices.map(v => v.y || 0);\r\n  \r\n  const minX = Math.min(...xs);\r\n  const maxX = Math.max(...xs);\r\n  const minY = Math.min(...ys);\r\n  const maxY = Math.max(...ys);\r\n  \r\n  return {\r\n    x: minX,\r\n    y: minY,\r\n    w: maxX - minX,\r\n    h: maxY - minY,\r\n  };\r\n}\r\n\r\n/**\r\n * Get centroid of a bounding box\r\n */\r\nexport function getBBoxCentroid(bbox: BBox): { x: number; y: number } {\r\n  return {\r\n    x: bbox.x + bbox.w / 2,\r\n    y: bbox.y + bbox.h / 2,\r\n  };\r\n}\r\n\r\n/**\r\n * Merge multiple bboxes into one encompassing bbox\r\n */\r\nexport function mergeBBoxes(bboxes: BBox[]): BBox {\r\n  if (bboxes.length === 0) {\r\n    return { x: 0, y: 0, w: 0, h: 0 };\r\n  }\r\n  \r\n  const minX = Math.min(...bboxes.map(b => b.x));\r\n  const minY = Math.min(...bboxes.map(b => b.y));\r\n  const maxX = Math.max(...bboxes.map(b => b.x + b.w));\r\n  const maxY = Math.max(...bboxes.map(b => b.y + b.h));\r\n  \r\n  return {\r\n    x: minX,\r\n    y: minY,\r\n    w: maxX - minX,\r\n    h: maxY - minY,\r\n  };\r\n}\r\n\r\n/**\r\n * Check if two bboxes overlap\r\n */\r\nexport function bboxesOverlap(a: BBox, b: BBox): boolean {\r\n  return !(\r\n    a.x + a.w < b.x ||\r\n    b.x + b.w < a.x ||\r\n    a.y + a.h < b.y ||\r\n    b.y + b.h < a.y\r\n  );\r\n}\r\n\r\n/**\r\n * Check if bbox A is within the same Y band as bbox B (with tolerance)\r\n */\r\nexport function isInSameYBand(a: BBox, b: BBox, tolerance: number = 20): boolean {\r\n  const aCenterY = a.y + a.h / 2;\r\n  const bTop = b.y - tolerance;\r\n  const bBottom = b.y + b.h + tolerance;\r\n  return aCenterY >= bTop && aCenterY <= bBottom;\r\n}\r\n\r\n/**\r\n * Check if bbox A is to the right of bbox B\r\n */\r\nexport function isToRightOf(a: BBox, b: BBox): boolean {\r\n  return a.x > b.x + b.w;\r\n}\r\n\r\n/**\r\n * Check if bbox A is below bbox B\r\n */\r\nexport function isBelow(a: BBox, b: BBox): boolean {\r\n  return a.y > b.y + b.h;\r\n}\r\n\r\n/**\r\n * Check if a bbox is within or intersects with a container bbox\r\n */\r\nexport function isBboxWithinContainer(bbox: BBox, container: BBox): boolean {\r\n  // Check if bbox intersects with container\r\n  return !(\r\n    bbox.x + bbox.w < container.x ||\r\n    container.x + container.w < bbox.x ||\r\n    bbox.y + bbox.h < container.y ||\r\n    container.y + container.h < bbox.y\r\n  );\r\n}\r\n\r\n/**\r\n * Filter entry lines to only include those within the entry bbox\r\n */\r\nexport function filterEntryByBbox(entry: FusionEntry): FusionEntry {\r\n  const filteredLines = entry.lines.filter(line => \r\n    isBboxWithinContainer(line.bbox, entry.bbox)\r\n  );\r\n  \r\n  // Also filter tokens within each line\r\n  const filteredLinesWithTokens = filteredLines.map(line => ({\r\n    ...line,\r\n    tokens: line.tokens.filter(token => \r\n      isBboxWithinContainer(token.bbox, entry.bbox)\r\n    ),\r\n  }));\r\n\r\n  return {\r\n    ...entry,\r\n    lines: filteredLinesWithTokens,\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Vision JSON Parsing\r\n// ============================================================================\r\n\r\n/**\r\n * Extract word text from Vision symbols\r\n */\r\nfunction extractWordText(word: VisionWord): string {\r\n  if (!word.symbols) return '';\r\n  \r\n  let text = '';\r\n  for (const symbol of word.symbols) {\r\n    text += symbol.text || '';\r\n    // Add space/break after symbol if indicated\r\n    if (symbol.property?.detectedBreak) {\r\n      const breakType = symbol.property.detectedBreak.type;\r\n      if (breakType === 'SPACE' || breakType === 'SURE_SPACE') {\r\n        text += ' ';\r\n      }\r\n    }\r\n  }\r\n  return text;\r\n}\r\n\r\n/**\r\n * Generate stable deterministic ID for a token/line\r\n * Uses bbox coordinates rounded to integers + text + index for uniqueness\r\n */\r\nfunction generateStableId(\r\n  type: 'token' | 'line',\r\n  text: string,\r\n  bbox: BBox,\r\n  index: number,\r\n  pageIndex: number = 0\r\n): string {\r\n  // Round bbox to integers for stability\r\n  const x = Math.round(bbox.x);\r\n  const y = Math.round(bbox.y);\r\n  const w = Math.round(bbox.w);\r\n  const h = Math.round(bbox.h);\r\n  \r\n  // Normalize text (remove extra whitespace, lowercase for comparison)\r\n  const normalizedText = text.trim().toLowerCase().replace(/\\s+/g, ' ');\r\n  \r\n  // Create stable ID: type_pageIndex_x_y_w_h_normalizedText_index\r\n  return `${type}_p${pageIndex}_${x}_${y}_${w}_${h}_${normalizedText.slice(0, 20)}_${index}`;\r\n}\r\n\r\n/**\r\n * Parse Vision word into FusionToken with stable ID\r\n */\r\nfunction parseWord(word: VisionWord, index: number, pageIndex: number = 0): FusionToken & { id: string } {\r\n  const text = extractWordText(word).trim();\r\n  const bbox = verticesToBBox(word.boundingBox?.vertices);\r\n  \r\n  return {\r\n    id: generateStableId('token', text, bbox, index, pageIndex),\r\n    text,\r\n    bbox,\r\n    confidence: word.confidence,\r\n  };\r\n}\r\n\r\n/**\r\n * Parse Vision paragraph into FusionLine with stable IDs\r\n */\r\nfunction parseParagraph(\r\n  paragraph: VisionParagraph,\r\n  paragraphIndex: number,\r\n  pageIndex: number = 0\r\n): FusionLine & { id: string } {\r\n  const tokens: (FusionToken & { id: string })[] = (paragraph.words || []).map((word, wordIndex) =>\r\n    parseWord(word, wordIndex, pageIndex)\r\n  );\r\n  const text = tokens.map(t => t.text).join(' ');\r\n  const tokenBboxes = tokens.filter(t => t.bbox.w > 0).map(t => t.bbox);\r\n  const bbox = tokenBboxes.length > 0 ? mergeBBoxes(tokenBboxes) : verticesToBBox(paragraph.boundingBox?.vertices);\r\n  \r\n  return {\r\n    id: generateStableId('line', text, bbox, paragraphIndex, pageIndex),\r\n    text,\r\n    bbox,\r\n    confidence: paragraph.confidence,\r\n    tokens,\r\n  };\r\n}\r\n\r\n/**\r\n * Parse Vision block into array of FusionLines with stable IDs\r\n */\r\nfunction parseBlock(block: VisionBlock, blockIndex: number, pageIndex: number = 0): (FusionLine & { id: string })[] {\r\n  if (!block.paragraphs) return [];\r\n  return block.paragraphs.map((paragraph, paragraphIndex) =>\r\n    parseParagraph(paragraph, paragraphIndex, pageIndex)\r\n  );\r\n}\r\n\r\n/**\r\n * Parse full Vision response into lines with bboxes and stable IDs\r\n */\r\nexport function parseVisionResponse(vision: VisionResponse | null): (FusionLine & { id: string })[] {\r\n  if (!vision?.fullTextAnnotation?.pages) {\r\n    return [];\r\n  }\r\n  \r\n  const lines: (FusionLine & { id: string })[] = [];\r\n  \r\n  vision.fullTextAnnotation.pages.forEach((page, pageIndex) => {\r\n    (page.blocks || []).forEach((block, blockIndex) => {\r\n      lines.push(...parseBlock(block, blockIndex, pageIndex));\r\n    });\r\n  });\r\n  \r\n  return lines;\r\n}\r\n\r\n/**\r\n * Get page dimensions from Vision response\r\n */\r\nexport function getVisionPageSize(vision: VisionResponse | null): { width: number; height: number } {\r\n  if (!vision?.fullTextAnnotation?.pages?.[0]) {\r\n    return { width: 0, height: 0 };\r\n  }\r\n  \r\n  const page = vision.fullTextAnnotation.pages[0];\r\n  return {\r\n    width: page.width || 0,\r\n    height: page.height || 0,\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Entry Detection (Multi-Record Segmentation) - Production-Grade with NMS\r\n// ============================================================================\r\n\r\n/**\r\n * Anchor labels that indicate a valid sacramental record\r\n */\r\nconst ANCHOR_LABELS = [\r\n  'NAME OF CHILD', 'NAME OF PARENTS', 'DATE OF BIRTH', 'DATE OF BAPTISM',\r\n  'PLACE OF BIRTH', 'GOD PARENTS', 'GODPARENTS', 'SPONSORS', 'SACRAMENTS',\r\n  'PERFORMED BY', 'RECTOR', 'PRIEST', 'FATHER', 'MOTHER', 'ADDRESS',\r\n  'PARISH RECORD', 'BAPTISM', 'MARRIAGE', 'FUNERAL', 'CONFIRMATION',\r\n];\r\n\r\n/**\r\n * Calculate Intersection over Union (IoU) between two bboxes\r\n */\r\nexport function calculateIoU(a: BBox, b: BBox): number {\r\n  const xOverlap = Math.max(0, Math.min(a.x + a.w, b.x + b.w) - Math.max(a.x, b.x));\r\n  const yOverlap = Math.max(0, Math.min(a.y + a.h, b.y + b.h) - Math.max(a.y, b.y));\r\n  const intersection = xOverlap * yOverlap;\r\n  \r\n  const areaA = a.w * a.h;\r\n  const areaB = b.w * b.h;\r\n  const union = areaA + areaB - intersection;\r\n  \r\n  return union > 0 ? intersection / union : 0;\r\n}\r\n\r\n/**\r\n * Calculate containment percentage (how much of B is inside A)\r\n */\r\nexport function calculateContainment(container: BBox, contained: BBox): number {\r\n  const xOverlap = Math.max(0, Math.min(container.x + container.w, contained.x + contained.w) - Math.max(container.x, contained.x));\r\n  const yOverlap = Math.max(0, Math.min(container.y + container.h, contained.y + contained.h) - Math.max(container.y, contained.y));\r\n  const intersection = xOverlap * yOverlap;\r\n  \r\n  const areaContained = contained.w * contained.h;\r\n  return areaContained > 0 ? intersection / areaContained : 0;\r\n}\r\n\r\n/**\r\n * Calculate aspect ratio of a bbox\r\n */\r\nexport function calculateAspectRatio(bbox: BBox): number {\r\n  return bbox.h > 0 ? bbox.w / bbox.h : 0;\r\n}\r\n\r\n/**\r\n * Score a candidate entry based on multiple factors\r\n */\r\ninterface CandidateScore {\r\n  area: number;\r\n  textDensity: number;\r\n  anchorLabelCount: number;\r\n  aspectRatioPenalty: number;\r\n  totalScore: number;\r\n}\r\n\r\nfunction scoreCandidate(\r\n  bbox: BBox,\r\n  lines: FusionLine[],\r\n  pageArea: number\r\n): CandidateScore {\r\n  const area = bbox.w * bbox.h;\r\n  const normalizedArea = pageArea > 0 ? area / pageArea : 0;\r\n  \r\n  // Text density: characters per area (normalized)\r\n  const totalChars = lines.reduce((sum, l) => sum + l.text.length, 0);\r\n  const textDensity = area > 0 ? (totalChars / area) * 10000 : 0; // Scale for readability\r\n  \r\n  // Count anchor labels found in this entry\r\n  const allText = lines.map(l => l.text.toUpperCase()).join(' ');\r\n  let anchorLabelCount = 0;\r\n  for (const label of ANCHOR_LABELS) {\r\n    if (allText.includes(label)) {\r\n      anchorLabelCount++;\r\n    }\r\n  }\r\n  \r\n  // Aspect ratio penalty: penalize extreme ratios (too wide or too tall)\r\n  const aspectRatio = calculateAspectRatio(bbox);\r\n  let aspectRatioPenalty = 0;\r\n  if (aspectRatio < 0.3 || aspectRatio > 3.0) {\r\n    aspectRatioPenalty = 0.5; // Heavy penalty for extreme aspect ratios\r\n  } else if (aspectRatio < 0.5 || aspectRatio > 2.0) {\r\n    aspectRatioPenalty = 0.2; // Moderate penalty\r\n  }\r\n  \r\n  // Total score: weighted combination\r\n  // Prefer: larger area, higher text density, more anchor labels\r\n  const totalScore = (\r\n    normalizedArea * 40 +           // Area contributes 40%\r\n    Math.min(textDensity, 10) * 3 + // Text density contributes up to 30%\r\n    anchorLabelCount * 5 -          // Each anchor label adds 5 points\r\n    aspectRatioPenalty * 20         // Penalty subtracts up to 10 points\r\n  );\r\n  \r\n  return {\r\n    area,\r\n    textDensity,\r\n    anchorLabelCount,\r\n    aspectRatioPenalty,\r\n    totalScore,\r\n  };\r\n}\r\n\r\n/**\r\n * Debug log for entry detection (can be toggled)\r\n */\r\nconst DEBUG_ENTRY_DETECTION = true;\r\n\r\nfunction debugLog(message: string, data?: any) {\r\n  if (DEBUG_ENTRY_DETECTION) {\r\n    console.log(`[EntryDetection] ${message}`, data || '');\r\n  }\r\n}\r\n\r\n/**\r\n * Non-Maximum Suppression to collapse duplicate/overlapping entries\r\n * Rules:\r\n * - IoU >= 0.5 OR containment >= 80% => same entry\r\n * - Keep highest scoring box, discard/merge others\r\n */\r\nfunction applyNMS(\r\n  candidates: Array<{ entry: FusionEntry; score: CandidateScore }>,\r\n  iouThreshold: number = 0.5,\r\n  containmentThreshold: number = 0.8\r\n): FusionEntry[] {\r\n  if (candidates.length === 0) return [];\r\n  if (candidates.length === 1) return [candidates[0].entry];\r\n  \r\n  // Sort by score descending\r\n  const sorted = [...candidates].sort((a, b) => b.score.totalScore - a.score.totalScore);\r\n  \r\n  const kept: FusionEntry[] = [];\r\n  const suppressed = new Set<number>();\r\n  \r\n  debugLog('NMS Input candidates:', sorted.map((c, i) => ({\r\n    index: i,\r\n    score: c.score.totalScore.toFixed(2),\r\n    area: c.score.area,\r\n    anchorLabels: c.score.anchorLabelCount,\r\n    bbox: c.entry.bbox,\r\n  })));\r\n  \r\n  for (let i = 0; i < sorted.length; i++) {\r\n    if (suppressed.has(i)) continue;\r\n    \r\n    const current = sorted[i];\r\n    kept.push(current.entry);\r\n    \r\n    // Check all remaining candidates for overlap\r\n    for (let j = i + 1; j < sorted.length; j++) {\r\n      if (suppressed.has(j)) continue;\r\n      \r\n      const other = sorted[j];\r\n      const iou = calculateIoU(current.entry.bbox, other.entry.bbox);\r\n      const containment = calculateContainment(current.entry.bbox, other.entry.bbox);\r\n      const reverseContainment = calculateContainment(other.entry.bbox, current.entry.bbox);\r\n      \r\n      debugLog(`Comparing ${i} vs ${j}:`, {\r\n        iou: iou.toFixed(3),\r\n        containment: containment.toFixed(3),\r\n        reverseContainment: reverseContainment.toFixed(3),\r\n      });\r\n      \r\n      // Suppress if significant overlap or containment\r\n      if (iou >= iouThreshold || containment >= containmentThreshold || reverseContainment >= containmentThreshold) {\r\n        debugLog(`Suppressing candidate ${j} (overlaps with ${i})`);\r\n        suppressed.add(j);\r\n        \r\n        // Merge lines from suppressed entry into current\r\n        const existingLineTexts = new Set(current.entry.lines.map(l => l.text));\r\n        for (const line of other.entry.lines) {\r\n          if (!existingLineTexts.has(line.text)) {\r\n            current.entry.lines.push(line);\r\n          }\r\n        }\r\n        // Update bbox to encompass merged content\r\n        current.entry.bbox = mergeBBoxes([current.entry.bbox, other.entry.bbox]);\r\n      }\r\n    }\r\n  }\r\n  \r\n  debugLog(`NMS Result: ${candidates.length} candidates -> ${kept.length} entries`);\r\n  return kept;\r\n}\r\n\r\n/**\r\n * Check if a single dominant entry should collapse all others\r\n * Returns true if one entry is clearly dominant and overlaps all others\r\n */\r\nfunction checkSingleRecordDominance(\r\n  candidates: Array<{ entry: FusionEntry; score: CandidateScore }>,\r\n  pageArea: number\r\n): boolean {\r\n  if (candidates.length <= 1) return false;\r\n  \r\n  // Only check for single record dominance if we have 3+ candidates\r\n  // This prevents false positives when we have 2-4 valid entries\r\n  if (candidates.length < 3) {\r\n    debugLog('Skipping single record dominance check (too few candidates)');\r\n    return false;\r\n  }\r\n  \r\n  // Sort by area descending\r\n  const sorted = [...candidates].sort((a, b) => b.score.area - a.score.area);\r\n  const largest = sorted[0];\r\n  \r\n  // Check if largest covers significant portion of page (>60% - increased threshold)\r\n  const largestCoverage = largest.score.area / pageArea;\r\n  if (largestCoverage < 0.6) {\r\n    debugLog(`Not single dominant: coverage ${(largestCoverage * 100).toFixed(1)}% < 60%`);\r\n    return false;\r\n  }\r\n  \r\n  // Check if largest has significantly more anchor labels (at least 2x more)\r\n  const largestAnchors = largest.score.anchorLabelCount;\r\n  const otherMaxAnchors = Math.max(...sorted.slice(1).map(c => c.score.anchorLabelCount));\r\n  if (largestAnchors < otherMaxAnchors * 2) {\r\n    debugLog(`Not single dominant: anchor labels ${largestAnchors} < ${otherMaxAnchors * 2}`);\r\n    return false;\r\n  }\r\n  \r\n  // Check if all other candidates overlap with the largest (at least 80% overlap)\r\n  for (let i = 1; i < sorted.length; i++) {\r\n    const containment = calculateContainment(largest.entry.bbox, sorted[i].entry.bbox);\r\n    if (containment < 0.8) {\r\n      // Found a candidate that doesn't significantly overlap - not single dominant\r\n      debugLog(`Not single dominant: candidate ${i} has only ${(containment * 100).toFixed(1)}% overlap`);\r\n      return false;\r\n    }\r\n  }\r\n  \r\n  debugLog('Single record dominance detected', {\r\n    coverage: (largestCoverage * 100).toFixed(1) + '%',\r\n    anchorLabels: largestAnchors,\r\n  });\r\n  \r\n  return true;\r\n}\r\n\r\n/**\r\n * Detect entries using quadrant clustering for 4-card layouts\r\n * Now with post-processing to validate results\r\n */\r\nexport function detectEntriesQuadrant(\r\n  lines: FusionLine[],\r\n  pageWidth: number,\r\n  pageHeight: number\r\n): FusionEntry[] {\r\n  if (lines.length === 0 || pageWidth === 0 || pageHeight === 0) {\r\n    return [];\r\n  }\r\n  \r\n  const midX = pageWidth / 2;\r\n  const midY = pageHeight / 2;\r\n  \r\n  // Group lines into quadrants\r\n  const quadrants: { [key: string]: FusionLine[] } = {\r\n    TL: [], TR: [], BL: [], BR: [],\r\n  };\r\n  \r\n  for (const line of lines) {\r\n    const centroid = getBBoxCentroid(line.bbox);\r\n    const isLeft = centroid.x < midX;\r\n    const isTop = centroid.y < midY;\r\n    \r\n    if (isTop && isLeft) quadrants.TL.push(line);\r\n    else if (isTop && !isLeft) quadrants.TR.push(line);\r\n    else if (!isTop && isLeft) quadrants.BL.push(line);\r\n    else quadrants.BR.push(line);\r\n  }\r\n  \r\n  // Create entries from non-empty quadrants\r\n  const entries: FusionEntry[] = [];\r\n  const quadrantOrder = ['TL', 'TR', 'BL', 'BR'];\r\n  \r\n  for (const quadrant of quadrantOrder) {\r\n    const quadrantLines = quadrants[quadrant];\r\n    if (quadrantLines.length === 0) continue;\r\n    \r\n    const lineBboxes = quadrantLines.map(l => l.bbox);\r\n    const entryBbox = mergeBBoxes(lineBboxes);\r\n    const recordNumber = extractRecordNumber(quadrantLines);\r\n    \r\n    entries.push({\r\n      id: `entry-${entries.length}`,\r\n      index: entries.length,\r\n      recordNumber,\r\n      bbox: entryBbox,\r\n      blocks: [],\r\n      lines: quadrantLines,\r\n    });\r\n  }\r\n  \r\n  return entries;\r\n}\r\n\r\n/**\r\n * Detect entries using gap-based clustering (for non-quadrant layouts)\r\n */\r\nexport function detectEntriesGap(\r\n  lines: FusionLine[],\r\n  yGapThreshold: number = 30  // Reduced threshold for better detection of closely-spaced entries\r\n): FusionEntry[] {\r\n  if (lines.length === 0) return [];\r\n  \r\n  // Sort lines by Y position\r\n  const sortedLines = [...lines].sort((a, b) => a.bbox.y - b.bbox.y);\r\n  \r\n  const entries: FusionEntry[] = [];\r\n  let currentLines: FusionLine[] = [sortedLines[0]];\r\n  \r\n  for (let i = 1; i < sortedLines.length; i++) {\r\n    const prevLine = sortedLines[i - 1];\r\n    const currLine = sortedLines[i];\r\n    const gap = currLine.bbox.y - (prevLine.bbox.y + prevLine.bbox.h);\r\n    \r\n    if (gap > yGapThreshold) {\r\n      // Start new entry\r\n      const lineBboxes = currentLines.map(l => l.bbox);\r\n      const entryBbox = mergeBBoxes(lineBboxes);\r\n      const recordNumber = extractRecordNumber(currentLines);\r\n      \r\n      entries.push({\r\n        id: `entry-${entries.length}`,\r\n        index: entries.length,\r\n        recordNumber,\r\n        bbox: entryBbox,\r\n        blocks: [],\r\n        lines: currentLines,\r\n      });\r\n      \r\n      currentLines = [currLine];\r\n    } else {\r\n      currentLines.push(currLine);\r\n    }\r\n  }\r\n  \r\n  // Don't forget the last group\r\n  if (currentLines.length > 0) {\r\n    const lineBboxes = currentLines.map(l => l.bbox);\r\n    const entryBbox = mergeBBoxes(lineBboxes);\r\n    const recordNumber = extractRecordNumber(currentLines);\r\n    \r\n    entries.push({\r\n      id: `entry-${entries.length}`,\r\n      index: entries.length,\r\n      recordNumber,\r\n      bbox: entryBbox,\r\n      blocks: [],\r\n      lines: currentLines,\r\n    });\r\n  }\r\n  \r\n  return entries;\r\n}\r\n\r\n/**\r\n * Extract record number from lines (looks for N° or No patterns)\r\n */\r\nexport function extractRecordNumber(lines: FusionLine[]): string | undefined {\r\n  const patterns = [\r\n    /N[°o]\\s*(\\d+)/i,\r\n    /No\\.?\\s*(\\d+)/i,\r\n    /Record\\s*#?\\s*(\\d+)/i,\r\n    /PARISH\\s+RECORD\\s+N[°o]?\\s*(\\d+)/i,\r\n  ];\r\n  \r\n  for (const line of lines) {\r\n    for (const pattern of patterns) {\r\n      const match = line.text.match(pattern);\r\n      if (match && match[1]) {\r\n        return match[1];\r\n      }\r\n    }\r\n  }\r\n  \r\n  return undefined;\r\n}\r\n\r\n/**\r\n * Hard filters to discard invalid candidate entries\r\n */\r\nfunction applyHardFilters(\r\n  entries: FusionEntry[],\r\n  pageWidth: number,\r\n  pageHeight: number\r\n): FusionEntry[] {\r\n  const pageArea = pageWidth * pageHeight;\r\n  const minAreaThreshold = pageArea * 0.05; // At least 5% of page\r\n  \r\n  return entries.filter(entry => {\r\n    const area = entry.bbox.w * entry.bbox.h;\r\n    const aspectRatio = calculateAspectRatio(entry.bbox);\r\n    \r\n    // Filter 1: Minimum area\r\n    if (area < minAreaThreshold) {\r\n      debugLog(`Filtered out entry (too small): area=${area}, threshold=${minAreaThreshold}`);\r\n      return false;\r\n    }\r\n    \r\n    // Filter 2: Extreme aspect ratios (not resembling a record card)\r\n    if (aspectRatio < 0.2 || aspectRatio > 5.0) {\r\n      debugLog(`Filtered out entry (extreme aspect ratio): ${aspectRatio.toFixed(2)}`);\r\n      return false;\r\n    }\r\n    \r\n    // Filter 3: Must have some text content\r\n    if (entry.lines.length === 0) {\r\n      debugLog('Filtered out entry (no lines)');\r\n      return false;\r\n    }\r\n    \r\n    return true;\r\n  });\r\n}\r\n\r\n/**\r\n * Main entry detection function - Production-grade with NMS\r\n * Tries multiple detection strategies and applies robust post-processing\r\n */\r\nexport function detectEntries(\r\n  vision: VisionResponse | null,\r\n  ocrText?: string\r\n): FusionEntry[] {\r\n  debugLog('=== Starting Entry Detection ===');\r\n  \r\n  // Try Vision-based detection first\r\n  if (vision?.fullTextAnnotation) {\r\n    const lines = parseVisionResponse(vision);\r\n    const { width, height } = getVisionPageSize(vision);\r\n    const pageArea = width * height;\r\n    \r\n    debugLog(`Page dimensions: ${width}x${height}, Lines: ${lines.length}`);\r\n    \r\n    if (lines.length > 0 && width > 0 && height > 0) {\r\n      // Collect candidate entries from multiple strategies\r\n      let candidates: Array<{ entry: FusionEntry; score: CandidateScore }> = [];\r\n      \r\n      // Strategy 1: Quadrant detection\r\n      const quadrantEntries = detectEntriesQuadrant(lines, width, height);\r\n      debugLog(`Quadrant detection found ${quadrantEntries.length} entries`);\r\n      \r\n      // Strategy 2: Gap-based detection\r\n      const gapEntries = detectEntriesGap(lines);\r\n      debugLog(`Gap detection found ${gapEntries.length} entries`);\r\n      \r\n      // Strategy 3: Single entry (all lines together)\r\n      const singleEntry: FusionEntry = {\r\n        id: 'entry-single',\r\n        index: 0,\r\n        recordNumber: extractRecordNumber(lines),\r\n        bbox: mergeBBoxes(lines.map(l => l.bbox)),\r\n        blocks: [],\r\n        lines,\r\n      };\r\n      \r\n      // Score all candidates\r\n      const allCandidates = [\r\n        ...quadrantEntries,\r\n        ...gapEntries,\r\n        singleEntry,\r\n      ];\r\n      \r\n      // Apply hard filters first\r\n      const filteredCandidates = applyHardFilters(allCandidates, width, height);\r\n      debugLog(`After hard filters: ${filteredCandidates.length} candidates`);\r\n      \r\n      // Score remaining candidates\r\n      candidates = filteredCandidates.map(entry => ({\r\n        entry,\r\n        score: scoreCandidate(entry.bbox, entry.lines, pageArea),\r\n      }));\r\n      \r\n      // Log candidate scores for debugging\r\n      for (const c of candidates) {\r\n        debugLog(`Candidate score:`, {\r\n          area: c.score.area,\r\n          textDensity: c.score.textDensity.toFixed(2),\r\n          anchorLabels: c.score.anchorLabelCount,\r\n          aspectPenalty: c.score.aspectRatioPenalty,\r\n          totalScore: c.score.totalScore.toFixed(2),\r\n          bbox: c.entry.bbox,\r\n        });\r\n      }\r\n      \r\n      // Check for single record dominance\r\n      if (checkSingleRecordDominance(candidates, pageArea)) {\r\n        // Return only the largest/highest-scoring entry\r\n        const sorted = [...candidates].sort((a, b) => b.score.totalScore - a.score.totalScore);\r\n        const dominant = sorted[0].entry;\r\n        dominant.id = 'entry-0';\r\n        dominant.index = 0;\r\n        debugLog('Returning single dominant entry');\r\n        return [dominant];\r\n      }\r\n      \r\n      // Apply NMS to collapse overlapping entries\r\n      const nmsResult = applyNMS(candidates);\r\n      \r\n      // Re-index entries\r\n      const finalEntries = nmsResult.map((entry, idx) => ({\r\n        ...entry,\r\n        id: `entry-${idx}`,\r\n        index: idx,\r\n      }));\r\n      \r\n      debugLog(`Final result: ${finalEntries.length} entries`);\r\n      return finalEntries;\r\n    }\r\n  }\r\n  \r\n  // Fallback: regex-based detection from OCR text\r\n  if (ocrText) {\r\n    debugLog('Falling back to text-based detection');\r\n    return detectEntriesFromText(ocrText);\r\n  }\r\n  \r\n  debugLog('No entries detected');\r\n  return [];\r\n}\r\n\r\n/**\r\n * Fallback: detect entries from plain OCR text using regex\r\n */\r\nexport function detectEntriesFromText(ocrText: string): FusionEntry[] {\r\n  // Strategy 1: Split by \"PARISH RECORD\" or \"PART 1\" headers\r\n  const entryPattern = /(?:PARISH\\s+RECORD|PART\\s+1[-–]?BAPTISMS?)/gi;\r\n  const parts = ocrText.split(entryPattern);\r\n  \r\n  if (parts.length > 1) {\r\n    const entries: FusionEntry[] = [];\r\n    for (let i = 1; i < parts.length; i++) {\r\n      const text = parts[i].trim();\r\n      if (!text) continue;\r\n      \r\n      // Try to extract record number\r\n      const recordMatch = text.match(/N[°o]\\s*(\\d+)/i);\r\n      \r\n      entries.push({\r\n        id: `entry-${entries.length}`,\r\n        index: entries.length,\r\n        recordNumber: recordMatch?.[1],\r\n        bbox: { x: 0, y: 0, w: 0, h: 0 }, // No bbox info in text-only mode\r\n        blocks: [],\r\n        lines: [{ text, bbox: { x: 0, y: 0, w: 0, h: 0 }, tokens: [] }],\r\n      });\r\n    }\r\n    \r\n    if (entries.length > 0) return entries;\r\n  }\r\n  \r\n  // Strategy 2: Split by blank lines (double newlines or large gaps)\r\n  // This handles documents where entries are separated by blank lines\r\n  const blankLinePattern = /\\n\\s*\\n\\s*\\n/; // Three or more newlines\r\n  const blankLineParts = ocrText.split(blankLinePattern);\r\n  \r\n  if (blankLineParts.length > 1) {\r\n    const entries: FusionEntry[] = [];\r\n    for (let i = 0; i < blankLineParts.length; i++) {\r\n      const text = blankLineParts[i].trim();\r\n      if (!text || text.length < 10) continue; // Skip very short fragments\r\n      \r\n      // Try to extract record number\r\n      const recordMatch = text.match(/N[°o]\\s*(\\d+)/i);\r\n      \r\n      entries.push({\r\n        id: `entry-${entries.length}`,\r\n        index: entries.length,\r\n        recordNumber: recordMatch?.[1],\r\n        bbox: { x: 0, y: 0, w: 0, h: 0 },\r\n        blocks: [],\r\n        lines: [{ text, bbox: { x: 0, y: 0, w: 0, h: 0 }, tokens: [] }],\r\n      });\r\n    }\r\n    \r\n    if (entries.length > 1) {\r\n      debugLog(`Text-based detection found ${entries.length} entries via blank lines`);\r\n      return entries;\r\n    }\r\n  }\r\n  \r\n  // Strategy 3: Split by patterns that look like name lines (lines starting with capital letters)\r\n  // This is a fallback for documents without clear separators\r\n  const lines = ocrText.split('\\n').filter(l => l.trim().length > 0);\r\n  const namePattern = /^[A-ZА-ЯЁ][a-zа-яё]+\\s+[A-ZА-ЯЁ][a-zа-яё]+/; // Pattern: CapitalWord CapitalWord\r\n  \r\n  if (lines.length > 5) {\r\n    const entries: FusionEntry[] = [];\r\n    let currentEntryLines: string[] = [];\r\n    \r\n    for (let i = 0; i < lines.length; i++) {\r\n      const line = lines[i].trim();\r\n      \r\n      // Check if this line looks like the start of a new entry (name pattern)\r\n      if (namePattern.test(line) && currentEntryLines.length > 3) {\r\n        // Save previous entry\r\n        const entryText = currentEntryLines.join('\\n');\r\n        entries.push({\r\n          id: `entry-${entries.length}`,\r\n          index: entries.length,\r\n          recordNumber: undefined,\r\n          bbox: { x: 0, y: 0, w: 0, h: 0 },\r\n          blocks: [],\r\n          lines: [{ text: entryText, bbox: { x: 0, y: 0, w: 0, h: 0 }, tokens: [] }],\r\n        });\r\n        currentEntryLines = [line];\r\n      } else {\r\n        currentEntryLines.push(line);\r\n      }\r\n    }\r\n    \r\n    // Don't forget the last entry\r\n    if (currentEntryLines.length > 0) {\r\n      const entryText = currentEntryLines.join('\\n');\r\n      entries.push({\r\n        id: `entry-${entries.length}`,\r\n        index: entries.length,\r\n        recordNumber: undefined,\r\n        bbox: { x: 0, y: 0, w: 0, h: 0 },\r\n        blocks: [],\r\n        lines: [{ text: entryText, bbox: { x: 0, y: 0, w: 0, h: 0 }, tokens: [] }],\r\n      });\r\n    }\r\n    \r\n    if (entries.length > 1) {\r\n      debugLog(`Text-based detection found ${entries.length} entries via name patterns`);\r\n      return entries;\r\n    }\r\n  }\r\n  \r\n  // Fallback: return single entry\r\n  debugLog('Text-based detection: falling back to single entry');\r\n  return [{\r\n    id: 'entry-0',\r\n    index: 0,\r\n    bbox: { x: 0, y: 0, w: 0, h: 0 },\r\n    blocks: [],\r\n    lines: [{ text: ocrText, bbox: { x: 0, y: 0, w: 0, h: 0 }, tokens: [] }],\r\n  }];\r\n}\r\n\r\n// ============================================================================\r\n// Label Anchoring (Fuzzy Matching)\r\n// ============================================================================\r\n\r\n/**\r\n * Normalize text for fuzzy matching\r\n */\r\nexport function normalizeText(text: string): string {\r\n  return text\r\n    .toUpperCase()\r\n    .replace(/[^\\w\\s]/g, ' ')\r\n    .replace(/\\s+/g, ' ')\r\n    .trim();\r\n}\r\n\r\n/**\r\n * Simple Levenshtein distance for fuzzy matching\r\n */\r\nexport function levenshteinDistance(a: string, b: string): number {\r\n  if (a.length === 0) return b.length;\r\n  if (b.length === 0) return a.length;\r\n  \r\n  const matrix: number[][] = [];\r\n  \r\n  for (let i = 0; i <= b.length; i++) {\r\n    matrix[i] = [i];\r\n  }\r\n  \r\n  for (let j = 0; j <= a.length; j++) {\r\n    matrix[0][j] = j;\r\n  }\r\n  \r\n  for (let i = 1; i <= b.length; i++) {\r\n    for (let j = 1; j <= a.length; j++) {\r\n      if (b.charAt(i - 1) === a.charAt(j - 1)) {\r\n        matrix[i][j] = matrix[i - 1][j - 1];\r\n      } else {\r\n        matrix[i][j] = Math.min(\r\n          matrix[i - 1][j - 1] + 1,\r\n          matrix[i][j - 1] + 1,\r\n          matrix[i - 1][j] + 1\r\n        );\r\n      }\r\n    }\r\n  }\r\n  \r\n  return matrix[b.length][a.length];\r\n}\r\n\r\n/**\r\n * Calculate similarity score (0-1) between two strings\r\n */\r\nexport function similarity(a: string, b: string): number {\r\n  const normA = normalizeText(a);\r\n  const normB = normalizeText(b);\r\n  \r\n  if (normA === normB) return 1;\r\n  if (normA.length === 0 || normB.length === 0) return 0;\r\n  \r\n  // Check for contains\r\n  if (normA.includes(normB) || normB.includes(normA)) {\r\n    return 0.9;\r\n  }\r\n  \r\n  // Levenshtein-based similarity\r\n  const maxLen = Math.max(normA.length, normB.length);\r\n  const distance = levenshteinDistance(normA, normB);\r\n  return Math.max(0, 1 - distance / maxLen);\r\n}\r\n\r\n/**\r\n * Detect labels in entry lines using fuzzy matching\r\n */\r\nexport function detectLabels(\r\n  entry: FusionEntry,\r\n  recordType: 'baptism' | 'marriage' | 'funeral'\r\n): DetectedLabel[] {\r\n  const dictionary = LABEL_DICTIONARIES[recordType] || {};\r\n  const detectedLabels: DetectedLabel[] = [];\r\n  \r\n  for (const line of entry.lines) {\r\n    const normalizedLine = normalizeText(line.text);\r\n    \r\n    for (const [labelText, fieldName] of Object.entries(dictionary)) {\r\n      const normalizedLabel = normalizeText(labelText);\r\n      const score = similarity(normalizedLine, normalizedLabel);\r\n      \r\n      // Also check for partial matches at line start\r\n      if (normalizedLine.startsWith(normalizedLabel)) {\r\n        const partialScore = Math.min(1, 0.85 + (normalizedLabel.length / normalizedLine.length) * 0.15);\r\n        \r\n        if (partialScore > 0.6) {\r\n          detectedLabels.push({\r\n            label: labelText,\r\n            canonicalField: fieldName,\r\n            bbox: line.bbox,\r\n            confidence: partialScore,\r\n            matchedText: line.text,\r\n          });\r\n        }\r\n      } else if (score > 0.7) {\r\n        detectedLabels.push({\r\n          label: labelText,\r\n          canonicalField: fieldName,\r\n          bbox: line.bbox,\r\n          confidence: score,\r\n          matchedText: line.text,\r\n        });\r\n      }\r\n    }\r\n    \r\n    // Also check individual tokens\r\n    for (const token of line.tokens) {\r\n      const normalizedToken = normalizeText(token.text);\r\n      \r\n      for (const [labelText, fieldName] of Object.entries(dictionary)) {\r\n        const normalizedLabel = normalizeText(labelText);\r\n        const score = similarity(normalizedToken, normalizedLabel);\r\n        \r\n        if (score > 0.8) {\r\n          // Check if we already have this label with higher confidence\r\n          const existing = detectedLabels.find(l => l.canonicalField === fieldName);\r\n          if (!existing || existing.confidence < score) {\r\n            if (existing) {\r\n              existing.confidence = score;\r\n              existing.bbox = token.bbox;\r\n              existing.matchedText = token.text;\r\n            } else {\r\n              detectedLabels.push({\r\n                label: labelText,\r\n                canonicalField: fieldName,\r\n                bbox: token.bbox,\r\n                confidence: score,\r\n                matchedText: token.text,\r\n              });\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Deduplicate by field name, keeping highest confidence\r\n  const deduped: DetectedLabel[] = [];\r\n  const seenFields = new Set<string>();\r\n  \r\n  const sorted = [...detectedLabels].sort((a, b) => b.confidence - a.confidence);\r\n  \r\n  for (const label of sorted) {\r\n    if (!seenFields.has(label.canonicalField)) {\r\n      seenFields.add(label.canonicalField);\r\n      deduped.push(label);\r\n    }\r\n  }\r\n  \r\n  return deduped;\r\n}\r\n\r\n// ============================================================================\r\n// Value Extraction (Field Mapping)\r\n// ============================================================================\r\n\r\n/**\r\n * Extract value for a detected label by looking at text to the right or below\r\n */\r\nexport function extractValueForLabel(\r\n  label: DetectedLabel,\r\n  entry: FusionEntry,\r\n  allLabels: DetectedLabel[]\r\n): { value: string; bbox?: BBox; confidence: number } {\r\n  // Find lines/tokens to the right of label in same Y band\r\n  const rightTokens: FusionToken[] = [];\r\n  const belowTokens: FusionToken[] = [];\r\n  \r\n  for (const line of entry.lines) {\r\n    // Skip the label line itself if it's a direct match\r\n    if (line.text === label.matchedText) {\r\n      // Look at tokens after the label within the same line\r\n      let foundLabel = false;\r\n      for (const token of line.tokens) {\r\n        if (foundLabel) {\r\n          rightTokens.push(token);\r\n        } else if (similarity(token.text, label.label) > 0.7 || \r\n                   similarity(token.text, label.matchedText) > 0.7) {\r\n          foundLabel = true;\r\n        }\r\n      }\r\n      continue;\r\n    }\r\n    \r\n    // Check if line is to the right in same Y band\r\n    if (isInSameYBand(line.bbox, label.bbox, 30) && isToRightOf(line.bbox, label.bbox)) {\r\n      for (const token of line.tokens) {\r\n        rightTokens.push(token);\r\n      }\r\n    }\r\n    \r\n    // Check if line is below (within reasonable distance)\r\n    if (isBelow(line.bbox, label.bbox)) {\r\n      const verticalDistance = line.bbox.y - (label.bbox.y + label.bbox.h);\r\n      if (verticalDistance < 50) {\r\n        // Make sure we're not crossing into another label's territory\r\n        const isAnotherLabel = allLabels.some(\r\n          l => l !== label && bboxesOverlap(line.bbox, l.bbox)\r\n        );\r\n        if (!isAnotherLabel) {\r\n          for (const token of line.tokens) {\r\n            belowTokens.push(token);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Prefer right tokens, fall back to below tokens\r\n  const tokens = rightTokens.length > 0 ? rightTokens : belowTokens;\r\n  \r\n  if (tokens.length === 0) {\r\n    return { value: '', confidence: 0 };\r\n  }\r\n  \r\n  const value = tokens.map(t => t.text).join(' ').trim();\r\n  const avgConfidence = tokens.reduce((sum, t) => sum + (t.confidence || 0.5), 0) / tokens.length;\r\n  const bbox = tokens.length > 0 ? mergeBBoxes(tokens.map(t => t.bbox)) : undefined;\r\n  \r\n  return { value, bbox, confidence: avgConfidence };\r\n}\r\n\r\n/**\r\n * Auto-map all detected labels to field values\r\n * Uses canonical schema keys (not DB column names)\r\n */\r\nexport function autoMapFields(\r\n  entry: FusionEntry,\r\n  labels: DetectedLabel[],\r\n  recordType?: 'baptism' | 'marriage' | 'funeral',\r\n  stickyDefaults?: Record<'baptism' | 'marriage' | 'funeral', boolean>\r\n): Record<string, { value: string; confidence: number; labelBbox?: BBox; valueBbox?: BBox }> {\r\n  const result: Record<string, { value: string; confidence: number; labelBbox?: BBox; valueBbox?: BBox }> = {};\r\n  \r\n  // If sticky defaults enabled, filter labels to only default columns\r\n  let filteredLabels = labels;\r\n  if (recordType && stickyDefaults?.[recordType]) {\r\n    const defaultColumns = getDefaultColumns(recordType);\r\n    \r\n    // Only process labels that map to default columns\r\n    filteredLabels = labels.filter(label => {\r\n      // Map canonicalField to database column name\r\n      // This is a simple mapping - you may need to adjust based on your field naming\r\n      const dbColumn = label.canonicalField;\r\n      return defaultColumns.includes(dbColumn);\r\n    });\r\n  }\r\n  \r\n  // ============================================================================\r\n  // CUSTOM FIELD MAPPING LOGIC - Uses Canonical Schema Keys\r\n  // ============================================================================\r\n  // Use canonical schema registry keys (not DB column names)\r\n  // The label.canonicalField already matches schema keys from LABEL_DICTIONARIES\r\n  \r\n  // Get schema for validation\r\n  const schema = getRecordSchema(recordType || 'baptism');\r\n  const schemaKeys = new Set(schema.map(f => f.key));\r\n  \r\n  // Process each label - use canonical field key directly\r\n  for (const label of filteredLabels) {\r\n    const { value, bbox, confidence } = extractValueForLabel(label, entry, labels);\r\n    \r\n    // Use canonical field key from label dictionary (matches schema registry)\r\n    const canonicalKey = label.canonicalField;\r\n    \r\n    // Dev-only: validate canonical key exists in schema\r\n    if (process.env.NODE_ENV === 'development' && !schemaKeys.has(canonicalKey)) {\r\n      console.warn(`[autoMapFields] Unknown canonical field key: \"${canonicalKey}\" for ${recordType}`);\r\n    }\r\n    \r\n    // Apply custom value processing for specific fields\r\n    let processedValue = value;\r\n    let processedConfidence = confidence;\r\n    \r\n    // Date fields: normalize date format\r\n    if (canonicalKey === 'date_of_birth' || canonicalKey === 'date_of_baptism' || \r\n        canonicalKey === 'date_of_marriage' || canonicalKey === 'date_of_death' ||\r\n        canonicalKey === 'date_of_funeral' || canonicalKey === 'date_of_burial') {\r\n      processedValue = normalizeDateValue(value);\r\n      processedConfidence = Math.min(confidence + 0.1, 1.0);\r\n    }\r\n    \r\n    // Name fields: capitalize first letter\r\n    if (canonicalKey === 'child_name' || canonicalKey === 'deceased_name' ||\r\n        canonicalKey === 'groom_name' || canonicalKey === 'bride_name') {\r\n      // Don't split here - keep full name in canonical key\r\n      // Splitting happens at DB commit time\r\n      processedValue = value.trim();\r\n    } else if (canonicalKey === 'father_name' || canonicalKey === 'mother_name') {\r\n      // Capitalize first letter of each word\r\n      processedValue = value.split(' ').map(word => \r\n        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()\r\n      ).join(' ');\r\n    }\r\n    \r\n    // Split parents name into father and mother if needed\r\n    if (canonicalKey === 'parents_name' && value.includes(' and ')) {\r\n      const parts = value.split(' and ');\r\n      if (parts.length === 2) {\r\n        result['father_name'] = {\r\n          value: parts[0].trim(),\r\n          confidence: confidence * 0.9,\r\n          labelBbox: label.bbox,\r\n          valueBbox: bbox,\r\n        };\r\n        result['mother_name'] = {\r\n          value: parts[1].trim(),\r\n          confidence: confidence * 0.9,\r\n          labelBbox: label.bbox,\r\n          valueBbox: bbox,\r\n        };\r\n        continue; // Skip adding to 'parents_name' field\r\n      }\r\n    }\r\n    \r\n    // Store the mapped field using canonical key\r\n    result[canonicalKey] = {\r\n      value: processedValue,\r\n      confidence: processedConfidence,\r\n      labelBbox: label.bbox,\r\n      valueBbox: bbox,\r\n    };\r\n  }\r\n  \r\n  // Dev-only: validate all result keys\r\n  if (process.env.NODE_ENV === 'development' && recordType) {\r\n    const resultKeys = Object.keys(result);\r\n    const validation = validateFieldKeys(recordType, resultKeys);\r\n    if (!validation.valid) {\r\n      console.warn('[autoMapFields] Field key validation failed:', validation.errors);\r\n    }\r\n  }\r\n  \r\n  // Also extract record number if found (always include this)\r\n  if (entry.recordNumber && !result.record_number) {\r\n    result.record_number = {\r\n      value: entry.recordNumber,\r\n      confidence: 0.9,\r\n    };\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Helper function to normalize date values\r\n * Converts various date formats to YYYY-MM-DD\r\n */\r\nfunction normalizeDateValue(dateStr: string): string {\r\n  if (!dateStr) return '';\r\n  \r\n  // Try to parse common date formats\r\n  // Example: \"January 1, 1920\" -> \"1920-01-01\"\r\n  // Example: \"1/1/1920\" -> \"1920-01-01\"\r\n  // Example: \"Jan 1, 1920\" -> \"1920-01-01\"\r\n  \r\n  const date = new Date(dateStr);\r\n  if (!isNaN(date.getTime())) {\r\n    const year = date.getFullYear();\r\n    const month = String(date.getMonth() + 1).padStart(2, '0');\r\n    const day = String(date.getDate()).padStart(2, '0');\r\n    return `${year}-${month}-${day}`;\r\n  }\r\n  \r\n  // If parsing fails, return original value\r\n  return dateStr;\r\n}\r\n\r\n// ============================================================================\r\n// Coordinate Conversion (Vision coords → Screen coords)\r\n// ============================================================================\r\n\r\n/**\r\n * Convert vision-space bbox to screen-space bbox based on rendered image dimensions\r\n */\r\nexport function visionToScreenBBox(\r\n  visionBbox: BBox,\r\n  visionWidth: number,\r\n  visionHeight: number,\r\n  screenWidth: number,\r\n  screenHeight: number\r\n): BBox {\r\n  if (visionWidth === 0 || visionHeight === 0) {\r\n    return visionBbox;\r\n  }\r\n  \r\n  const scaleX = screenWidth / visionWidth;\r\n  const scaleY = screenHeight / visionHeight;\r\n  \r\n  return {\r\n    x: visionBbox.x * scaleX,\r\n    y: visionBbox.y * scaleY,\r\n    w: visionBbox.w * scaleX,\r\n    h: visionBbox.h * scaleY,\r\n  };\r\n}\r\n\r\n","/**\r\n * WorkbenchViewer - Image viewer with overlays for OCR workbench\r\n * Extracted from InspectionPanel for cleaner separation\r\n */\r\n\r\nimport React, { useState, useRef, useCallback, useEffect, useMemo } from 'react';\r\nimport {\r\n  Box,\r\n  IconButton,\r\n  Tooltip,\r\n  Stack,\r\n  Slider,\r\n  TextField,\r\n  InputAdornment,\r\n  alpha,\r\n  useTheme,\r\n} from '@mui/material';\r\nimport {\r\n  IconZoomIn,\r\n  IconZoomOut,\r\n  IconMaximize,\r\n  IconCopy,\r\n  IconSearch,\r\n} from '@tabler/icons-react';\r\nimport FusionOverlay from '../FusionOverlay';\r\nimport { getVisionPageSize, parseVisionResponse } from '../../utils/visionParser';\r\nimport { useWorkbench } from '../../context/WorkbenchContext';\r\nimport type { BBox, VisionResponse } from '../../types/fusion';\r\n\r\ninterface WorkbenchViewerProps {\r\n  onTokenClick?: (tokenId: string, bbox: BBox, text: string) => void;\r\n  onTokenDoubleClick?: (tokenId: string, bbox: BBox, text: string) => void;\r\n}\r\n\r\nconst WorkbenchViewer: React.FC<WorkbenchViewerProps> = ({\r\n  onTokenClick,\r\n  onTokenDoubleClick,\r\n}) => {\r\n  const theme = useTheme();\r\n  const workbench = useWorkbench();\r\n  const imageRef = useRef<HTMLImageElement>(null);\r\n  const [zoom, setZoom] = useState(100);\r\n  const [imageDimensions, setImageDimensions] = useState({\r\n    width: 0,\r\n    height: 0,\r\n    naturalWidth: 0,\r\n    naturalHeight: 0,\r\n  });\r\n  \r\n  const jobOcrResult = workbench.state.ocrResult;\r\n  const imageUrl = workbench.state.imageUrl;\r\n  const editMode = workbench.state.bboxEditMode;\r\n  \r\n  // Get Vision page dimensions (safe with null)\r\n  const visionPageSize = useMemo(() => {\r\n    if (!jobOcrResult) return { width: 0, height: 0 };\r\n    return getVisionPageSize(jobOcrResult);\r\n  }, [jobOcrResult]);\r\n  \r\n  // Parse OCR tokens for overlay (safe with null, optimized to prevent memory issues)\r\n  const ocrTokens = useMemo(() => {\r\n    if (!jobOcrResult) return [];\r\n    try {\r\n      // Limit processing to prevent browser crashes on very large OCR results\r\n      const lines = parseVisionResponse(jobOcrResult);\r\n      const tokens: Array<{ id: string; text: string; bbox: BBox; confidence?: number }> = [];\r\n      const MAX_TOKENS = 10000; // Limit to prevent memory issues\r\n      \r\n      for (const line of lines) {\r\n        if (tokens.length >= MAX_TOKENS) {\r\n          console.warn('[WorkbenchViewer] Token limit reached, truncating overlay');\r\n          break;\r\n        }\r\n        if (line.tokens) {\r\n          for (const token of line.tokens) {\r\n            if (tokens.length >= MAX_TOKENS) break;\r\n            if (token.id && token.bbox && token.bbox.w > 0 && token.bbox.h > 0) {\r\n              tokens.push({\r\n                id: token.id,\r\n                text: token.text,\r\n                bbox: token.bbox,\r\n                confidence: token.confidence,\r\n              });\r\n            }\r\n          }\r\n        }\r\n      }\r\n      return tokens;\r\n    } catch (error) {\r\n      console.error('[WorkbenchViewer] Error parsing OCR tokens:', error);\r\n      return [];\r\n    }\r\n  }, [jobOcrResult]);\r\n  \r\n  const handleZoomIn = useCallback(() => {\r\n    setZoom(prev => Math.min(prev + 25, 300));\r\n  }, []);\r\n  \r\n  const handleZoomOut = useCallback(() => {\r\n    setZoom(prev => Math.max(prev - 25, 25));\r\n  }, []);\r\n  \r\n  const handleZoomFit = useCallback(() => {\r\n    setZoom(100);\r\n  }, []);\r\n  \r\n  const handleZoomChange = useCallback((event: Event, value: number | number[]) => {\r\n    setZoom(value as number);\r\n  }, []);\r\n  \r\n  return (\r\n    <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column', position: 'relative' }}>\r\n      {/* Zoom Controls */}\r\n      <Box\r\n        sx={{\r\n          position: 'absolute',\r\n          top: 8,\r\n          right: 8,\r\n          zIndex: 10,\r\n          display: 'flex',\r\n          alignItems: 'center',\r\n          gap: 1,\r\n          bgcolor: 'background.paper',\r\n          borderRadius: 1,\r\n          boxShadow: 2,\r\n          p: 1,\r\n        }}\r\n      >\r\n        <Tooltip title=\"Zoom Out\">\r\n          <IconButton size=\"small\" onClick={handleZoomOut}>\r\n            <IconZoomOut size={18} />\r\n          </IconButton>\r\n        </Tooltip>\r\n        <Slider\r\n          value={zoom}\r\n          onChange={handleZoomChange}\r\n          min={25}\r\n          max={300}\r\n          step={5}\r\n          sx={{ width: 100 }}\r\n          size=\"small\"\r\n        />\r\n        <Tooltip title=\"Zoom In\">\r\n          <IconButton size=\"small\" onClick={handleZoomIn}>\r\n            <IconZoomIn size={18} />\r\n          </IconButton>\r\n        </Tooltip>\r\n        <Tooltip title=\"Fit to View\">\r\n          <IconButton size=\"small\" onClick={handleZoomFit}>\r\n            <IconMaximize size={18} />\r\n          </IconButton>\r\n        </Tooltip>\r\n        <TextField\r\n          size=\"small\"\r\n          value={zoom}\r\n          onChange={(e) => {\r\n            const val = parseInt(e.target.value, 10);\r\n            if (!isNaN(val) && val >= 25 && val <= 300) {\r\n              setZoom(val);\r\n            }\r\n          }}\r\n          InputProps={{\r\n            endAdornment: <InputAdornment position=\"end\">%</InputAdornment>,\r\n          }}\r\n          sx={{ width: 70 }}\r\n        />\r\n      </Box>\r\n      \r\n      {/* Image Container */}\r\n      <Box\r\n        sx={{\r\n          flex: 1,\r\n          overflow: 'auto',\r\n          display: 'flex',\r\n          alignItems: 'flex-start',\r\n          justifyContent: 'center',\r\n          p: 2,\r\n          ...(editMode && {\r\n            overflow: 'hidden',\r\n            touchAction: 'none',\r\n            userSelect: 'none',\r\n          }),\r\n        }}\r\n      >\r\n        {imageUrl && (\r\n          <Box\r\n            sx={{\r\n              position: 'relative',\r\n              display: 'inline-block',\r\n              overflow: 'hidden',\r\n            }}\r\n          >\r\n            <img\r\n              ref={imageRef}\r\n              src={imageUrl || ''}\r\n              alt={workbench.state.jobMetadata?.filename || 'OCR Image'}\r\n              style={{\r\n                maxWidth: '100%',\r\n                width: 'auto',\r\n                height: 'auto',\r\n                objectFit: 'contain',\r\n                display: 'block',\r\n                transform: `scale(${zoom / 100})`,\r\n                transformOrigin: 'top left',\r\n                pointerEvents: 'auto',\r\n              }}\r\n              onLoad={(e) => {\r\n                const img = e.currentTarget;\r\n                setImageDimensions({\r\n                  width: img.clientWidth,\r\n                  height: img.clientHeight,\r\n                  naturalWidth: img.naturalWidth,\r\n                  naturalHeight: img.naturalHeight,\r\n                });\r\n              }}\r\n              onError={(e) => {\r\n                console.error('[WorkbenchViewer] Failed to load image:', imageUrl);\r\n                console.error('[WorkbenchViewer] Image error:', e);\r\n              }}\r\n            />\r\n            {imageRef.current && (\r\n              <FusionOverlay\r\n                boxes={workbench.state.entryAreas.map((area, idx) => {\r\n                  const entryIdx = workbench.state.entries.findIndex(e => e.id === area.entryId);\r\n                  const isSelected = entryIdx === workbench.state.selectedEntryIndex;\r\n                  return {\r\n                    bbox: area.bbox,\r\n                    label: area.label || `Entry ${idx + 1}`,\r\n                    color: `hsl(${(idx * 60) % 360}, 70%, 50%)`,\r\n                    selected: isSelected,\r\n                    editable: editMode && isSelected,\r\n                    onBboxChange: editMode && isSelected\r\n                      ? (newBbox: BBox) => workbench.updateEntryArea(area.entryId, newBbox)\r\n                      : undefined,\r\n                    onBboxChangeEnd: editMode && isSelected\r\n                      ? () => {\r\n                          // Auto-save bbox changes (can be enhanced later)\r\n                          console.log('[WorkbenchViewer] Bbox change ended for', area.entryId);\r\n                        }\r\n                      : undefined,\r\n                  };\r\n                })}\r\n                imageElement={imageRef.current}\r\n                visionWidth={visionPageSize.width || imageDimensions.naturalWidth || 0}\r\n                visionHeight={visionPageSize.height || imageDimensions.naturalHeight || 0}\r\n                showLabels={true}\r\n                ocrTokens={ocrTokens}\r\n                onTokenClick={onTokenClick}\r\n                onTokenDoubleClick={onTokenDoubleClick}\r\n                editMode={editMode}\r\n              />\r\n            )}\r\n          </Box>\r\n        )}\r\n      </Box>\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default WorkbenchViewer;\r\n\r\n","/**\r\n * UnifiedJobsList - Clean, modern table layout matching redesigned OCR interface\r\n * Shows processed files with simple columns: File name, Pages, Added, Status\r\n */\r\n\r\nimport React, { useState, useCallback, useMemo } from 'react';\r\nimport {\r\n  Box,\r\n  Paper,\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableContainer,\r\n  TableHead,\r\n  TableRow,\r\n  Chip,\r\n  IconButton,\r\n  Tooltip,\r\n  Select,\r\n  MenuItem,\r\n  FormControl,\r\n  Checkbox,\r\n  Stack,\r\n  Button,\r\n  Typography,\r\n  useTheme,\r\n  LinearProgress,\r\n} from '@mui/material';\r\nimport {\r\n  IconTrash,\r\n  IconDownload,\r\n  IconChevronDown,\r\n  IconChevronUp,\r\n} from '@tabler/icons-react';\r\nimport type { OCRJobRow } from '../../types/ocrJob';\r\n\r\ninterface UnifiedJobsListProps {\r\n  jobs: OCRJobRow[];\r\n  loading: boolean;\r\n  error: string | null;\r\n  onJobSelect: (jobId: number) => void;\r\n  onRefresh: () => void | Promise<void>;\r\n  onDeleteJobs?: (jobIds: number[]) => void | Promise<void>;\r\n  churchId: number;\r\n}\r\n\r\nconst UnifiedJobsList: React.FC<UnifiedJobsListProps> = ({\r\n  jobs,\r\n  loading,\r\n  error,\r\n  onJobSelect,\r\n  onRefresh,\r\n  onDeleteJobs,\r\n  churchId,\r\n}) => {\r\n  const theme = useTheme();\r\n  const [selectedJobs, setSelectedJobs] = useState<Set<number>>(new Set());\r\n  const [itemsPerPage, setItemsPerPage] = useState<number>(20);\r\n  const [sortBy, setSortBy] = useState<'added' | 'filename'>('added');\r\n  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');\r\n  \r\n  // Sort and filter jobs\r\n  const sortedJobs = useMemo(() => {\r\n    const sorted = [...jobs].sort((a, b) => {\r\n      let comparison = 0;\r\n      \r\n      if (sortBy === 'added') {\r\n        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;\r\n        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;\r\n        comparison = dateA - dateB;\r\n      } else if (sortBy === 'filename') {\r\n        const nameA = (a.original_filename || '').toLowerCase();\r\n        const nameB = (b.original_filename || '').toLowerCase();\r\n        comparison = nameA.localeCompare(nameB);\r\n      }\r\n      \r\n      return sortOrder === 'asc' ? comparison : -comparison;\r\n    });\r\n    \r\n    return sorted.slice(0, itemsPerPage);\r\n  }, [jobs, sortBy, sortOrder, itemsPerPage]);\r\n  \r\n  // Calculate retention days (6 days from now, or based on created_at)\r\n  const getRetentionDays = useCallback((createdAt: string | undefined) => {\r\n    if (!createdAt) return 6;\r\n    const created = new Date(createdAt);\r\n    const now = new Date();\r\n    const daysSince = Math.floor((now.getTime() - created.getTime()) / (1000 * 60 * 60 * 24));\r\n    return Math.max(0, 6 - daysSince);\r\n  }, []);\r\n  \r\n  // Format \"X minutes/hours/days ago\"\r\n  const formatTimeAgo = useCallback((dateString: string | undefined) => {\r\n    if (!dateString) return '-';\r\n    const date = new Date(dateString);\r\n    const now = new Date();\r\n    const diffMs = now.getTime() - date.getTime();\r\n    const diffMins = Math.floor(diffMs / (1000 * 60));\r\n    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));\r\n    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));\r\n    \r\n    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;\r\n    if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;\r\n    return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;\r\n  }, []);\r\n  \r\n  const toggleSelection = useCallback((jobId: number) => {\r\n    setSelectedJobs(prev => {\r\n      const next = new Set(prev);\r\n      if (next.has(jobId)) {\r\n        next.delete(jobId);\r\n      } else {\r\n        next.add(jobId);\r\n      }\r\n      return next;\r\n    });\r\n  }, []);\r\n  \r\n  const toggleSelectAll = useCallback(() => {\r\n    if (selectedJobs.size === sortedJobs.length) {\r\n      setSelectedJobs(new Set());\r\n    } else {\r\n      setSelectedJobs(new Set(sortedJobs.map(j => j.id)));\r\n    }\r\n  }, [sortedJobs, selectedJobs.size]);\r\n  \r\n  const getStatusColor = (status: string) => {\r\n    switch (status?.toLowerCase()) {\r\n      case 'completed':\r\n      case 'complete':\r\n        return 'success';\r\n      case 'processing':\r\n        return 'info';\r\n      case 'failed':\r\n      case 'error':\r\n        return 'error';\r\n      case 'queued':\r\n        return 'default';\r\n      default:\r\n        return 'default';\r\n    }\r\n  };\r\n  \r\n  const getConfidenceColor = (confidence: number) => {\r\n    if (confidence >= 0.8) return 'success';\r\n    if (confidence >= 0.5) return 'warning';\r\n    return 'error';\r\n  };\r\n  \r\n  const handleSort = useCallback((column: 'added' | 'filename') => {\r\n    if (sortBy === column) {\r\n      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');\r\n    } else {\r\n      setSortBy(column);\r\n      setSortOrder('desc');\r\n    }\r\n  }, [sortBy, sortOrder]);\r\n\r\n  return (\r\n    <Paper variant=\"outlined\" sx={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>\r\n      {/* Top Controls */}\r\n      <Box sx={{ p: 2, borderBottom: '1px solid', borderColor: 'divider', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n        <FormControl size=\"small\" sx={{ minWidth: 120 }}>\r\n          <Select\r\n            value={itemsPerPage}\r\n            onChange={(e) => setItemsPerPage(Number(e.target.value))}\r\n            sx={{ \r\n              '& .MuiSelect-select': { \r\n                py: 1,\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n              }\r\n            }}\r\n          >\r\n            <MenuItem value={10}>10 per page</MenuItem>\r\n            <MenuItem value={20}>20 per page</MenuItem>\r\n            <MenuItem value={50}>50 per page</MenuItem>\r\n            <MenuItem value={100}>100 per page</MenuItem>\r\n          </Select>\r\n        </FormControl>\r\n        \r\n        <Stack direction=\"row\" spacing={1}>\r\n          <Tooltip title=\"Delete Selected\">\r\n            <span>\r\n              <IconButton\r\n                size=\"small\"\r\n                disabled={selectedJobs.size === 0}\r\n                onClick={() => {\r\n                  if (onDeleteJobs && selectedJobs.size > 0) {\r\n                    onDeleteJobs(Array.from(selectedJobs));\r\n                    setSelectedJobs(new Set());\r\n                  }\r\n                }}\r\n                sx={{ \r\n                  opacity: selectedJobs.size === 0 ? 0.5 : 1,\r\n                  color: selectedJobs.size === 0 ? 'text.disabled' : 'text.secondary'\r\n                }}\r\n              >\r\n                <IconTrash size={18} />\r\n              </IconButton>\r\n            </span>\r\n          </Tooltip>\r\n          <Tooltip title=\"Download Selected\">\r\n            <span>\r\n              <Button\r\n                size=\"small\"\r\n                variant=\"outlined\"\r\n                startIcon={<IconDownload size={16} />}\r\n                disabled={selectedJobs.size === 0}\r\n                sx={{ \r\n                  opacity: selectedJobs.size === 0 ? 0.5 : 1,\r\n                }}\r\n              >\r\n                Download\r\n              </Button>\r\n            </span>\r\n          </Tooltip>\r\n        </Stack>\r\n      </Box>\r\n      \r\n      {/* Table */}\r\n      <TableContainer sx={{ flex: 1, overflow: 'auto' }}>\r\n        <Table stickyHeader>\r\n          <TableHead>\r\n            <TableRow>\r\n              <TableCell padding=\"checkbox\" sx={{ width: 50 }}>\r\n                <Checkbox\r\n                  checked={sortedJobs.length > 0 && selectedJobs.size === sortedJobs.length}\r\n                  indeterminate={selectedJobs.size > 0 && selectedJobs.size < sortedJobs.length}\r\n                  onChange={toggleSelectAll}\r\n                />\r\n              </TableCell>\r\n              <TableCell \r\n                sx={{ \r\n                  cursor: 'pointer',\r\n                  userSelect: 'none',\r\n                  textDecoration: sortBy === 'filename' ? 'underline' : 'none',\r\n                  textDecorationStyle: 'dotted',\r\n                }}\r\n                onClick={() => handleSort('filename')}\r\n              >\r\n                <Stack direction=\"row\" spacing={0.5} alignItems=\"center\">\r\n                  <span>File name</span>\r\n                  {sortBy === 'filename' && (\r\n                    sortOrder === 'asc' ? <IconChevronUp size={16} /> : <IconChevronDown size={16} />\r\n                  )}\r\n                </Stack>\r\n              </TableCell>\r\n              <TableCell>Pages</TableCell>\r\n              <TableCell \r\n                sx={{ \r\n                  cursor: 'pointer',\r\n                  userSelect: 'none',\r\n                  textDecoration: sortBy === 'added' ? 'underline' : 'none',\r\n                  textDecorationStyle: 'dotted',\r\n                }}\r\n                onClick={() => handleSort('added')}\r\n              >\r\n                <Stack direction=\"row\" spacing={0.5} alignItems=\"center\">\r\n                  <span>Added</span>\r\n                  {sortBy === 'added' && (\r\n                    sortOrder === 'asc' ? <IconChevronUp size={16} /> : <IconChevronDown size={16} />\r\n                  )}\r\n                </Stack>\r\n              </TableCell>\r\n              <TableCell>Status</TableCell>\r\n            </TableRow>\r\n          </TableHead>\r\n          <TableBody>\r\n            {loading ? (\r\n              <TableRow>\r\n                <TableCell colSpan={5} align=\"center\" sx={{ py: 4 }}>\r\n                  <LinearProgress />\r\n                </TableCell>\r\n              </TableRow>\r\n            ) : sortedJobs.length === 0 ? (\r\n              <TableRow>\r\n                <TableCell colSpan={5} align=\"center\" sx={{ py: 4 }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    {jobs.length === 0 ? 'No processed images yet' : 'No jobs to display'}\r\n                  </Typography>\r\n                </TableCell>\r\n              </TableRow>\r\n            ) : (\r\n              sortedJobs.map((job) => {\r\n                const retentionDays = getRetentionDays(job.created_at);\r\n                const isProcessed = job.status === 'completed' || job.status === 'complete';\r\n                \r\n                return (\r\n                  <TableRow\r\n                    key={job.id}\r\n                    hover\r\n                    sx={{ cursor: 'pointer' }}\r\n                    onClick={() => isProcessed && onJobSelect(job.id)}\r\n                  >\r\n                    <TableCell padding=\"checkbox\" onClick={(e) => e.stopPropagation()}>\r\n                      <Checkbox\r\n                        checked={selectedJobs.has(job.id)}\r\n                        onChange={() => toggleSelection(job.id)}\r\n                      />\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Typography variant=\"body2\" noWrap sx={{ maxWidth: 400 }}>\r\n                        {job.original_filename || 'Unknown'}\r\n                      </Typography>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Typography variant=\"body2\" color=\"text.secondary\">\r\n                        {job.pages || 1}\r\n                      </Typography>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Typography variant=\"body2\" color=\"text.secondary\">\r\n                        {formatTimeAgo(job.created_at)}\r\n                      </Typography>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Stack direction=\"row\" spacing={1} alignItems=\"center\">\r\n                        {isProcessed && (\r\n                          <>\r\n                            <Chip\r\n                              size=\"small\"\r\n                              label=\"Processed\"\r\n                              color=\"success\"\r\n                              sx={{ height: 24, fontSize: '0.75rem' }}\r\n                            />\r\n                            <Stack direction=\"row\" spacing={0.5} alignItems=\"center\" sx={{ color: 'text.secondary' }}>\r\n                              <IconTrash size={14} />\r\n                              <Typography variant=\"caption\">\r\n                                {retentionDays} day{retentionDays !== 1 ? 's' : ''}\r\n                              </Typography>\r\n                            </Stack>\r\n                            <Button\r\n                              size=\"small\"\r\n                              variant=\"outlined\"\r\n                              onClick={(e) => {\r\n                                e.stopPropagation();\r\n                                onJobSelect(job.id);\r\n                              }}\r\n                              sx={{ \r\n                                ml: 1,\r\n                                minWidth: 60,\r\n                                height: 28,\r\n                                fontSize: '0.75rem',\r\n                                textTransform: 'none',\r\n                              }}\r\n                            >\r\n                              Open\r\n                            </Button>\r\n                          </>\r\n                        )}\r\n                        {!isProcessed && (\r\n                          <Chip\r\n                            size=\"small\"\r\n                            label={job.status || 'Processing'}\r\n                            color={getStatusColor(job.status || '')}\r\n                            sx={{ height: 24, fontSize: '0.75rem', textTransform: 'capitalize' }}\r\n                          />\r\n                        )}\r\n                      </Stack>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                );\r\n              })\r\n            )}\r\n          </TableBody>\r\n        </Table>\r\n      </TableContainer>\r\n      \r\n    </Paper>\r\n  );\r\n};\r\n\r\nexport default UnifiedJobsList;\r\n\r\n","/**\r\n * Display Normalization Utilities (Client-Side)\r\n * Presentation-level formatting only (whitespace, line wrapping, UI cleanup)\r\n * \r\n * NOTE: This is for UI display only. Semantic normalization (token cleanup, \r\n * paragraph reconstruction, script detection) happens server-side.\r\n * This module does NOT change semantic content - no field inference, no token merging logic.\r\n */\r\n\r\n/**\r\n * Normalize OCR text for clean display (presentation only)\r\n */\r\nexport function normalizeOcrText(ocrText: string | null | undefined): string {\r\n  if (!ocrText) return '';\r\n\r\n  return ocrText\r\n    // Normalize line breaks\r\n    .replace(/\\r\\n/g, '\\n')\r\n    .replace(/\\r/g, '\\n')\r\n    // Remove excessive blank lines (more than 2 consecutive)\r\n    .replace(/\\n{3,}/g, '\\n\\n')\r\n    // Trim each line\r\n    .split('\\n')\r\n    .map(line => line.trim())\r\n    .join('\\n')\r\n    // Remove leading/trailing whitespace\r\n    .trim();\r\n}\r\n\r\n/**\r\n * Extract structured text from Vision API response using blocks/paragraphs\r\n * This preserves document structure better than raw text extraction\r\n */\r\nexport function extractStructuredTextFromVision(visionResponse: any): string {\r\n  if (!visionResponse?.fullTextAnnotation?.pages) {\r\n    return '';\r\n  }\r\n\r\n  const lines: string[] = [];\r\n  const pages = visionResponse.fullTextAnnotation.pages || [];\r\n  \r\n  pages.forEach((page: any, pageIndex: number) => {\r\n    const blocks = page.blocks || [];\r\n    \r\n    blocks.forEach((block: any, blockIndex: number) => {\r\n      const paragraphs = block.paragraphs || [];\r\n      \r\n      paragraphs.forEach((paragraph: any, paraIndex: number) => {\r\n        const words = paragraph.words || [];\r\n        \r\n        // Extract text from words, preserving spacing\r\n        const paragraphText = words\r\n          .map((word: any) => {\r\n            const symbols = word.symbols || [];\r\n            return symbols.map((sym: any) => {\r\n              // Check for break detection hints\r\n              const text = sym.text || '';\r\n              const hasBreak = sym.property?.detectedBreak;\r\n              return text + (hasBreak?.type === 'LINE_BREAK' || hasBreak?.type === 'EOL_SURE_SPACE' ? '\\n' : '');\r\n            }).join('');\r\n          })\r\n          .filter((text: string) => text.trim().length > 0)\r\n          .join(' ')\r\n          .trim();\r\n        \r\n        if (paragraphText) {\r\n          // Split on explicit line breaks if detected\r\n          const splitLines = paragraphText.split('\\n').map(l => l.trim()).filter(l => l.length > 0);\r\n          lines.push(...splitLines);\r\n        }\r\n      });\r\n      \r\n      // Add blank line between blocks (logical sections) if not already present\r\n      if (blockIndex < blocks.length - 1 && lines.length > 0 && lines[lines.length - 1]) {\r\n        lines.push('');\r\n      }\r\n    });\r\n    \r\n    // Add blank line between pages\r\n    if (pageIndex < pages.length - 1 && lines.length > 0 && lines[lines.length - 1]) {\r\n      lines.push('');\r\n    }\r\n  });\r\n\r\n  return lines.join('\\n');\r\n}\r\n\r\n/**\r\n * Extract text from Vision API response\r\n * Uses structured extraction if available, falls back to raw text\r\n */\r\nexport function extractTextFromVisionResponse(visionResponse: any): string {\r\n  if (!visionResponse) return '';\r\n  \r\n  // Try structured extraction first (preserves document structure)\r\n  if (visionResponse.fullTextAnnotation?.pages) {\r\n    const structured = extractStructuredTextFromVision(visionResponse);\r\n    if (structured.trim().length > 0) {\r\n      return normalizeOcrText(structured);\r\n    }\r\n  }\r\n  \r\n  // Fallback to fullTextAnnotation.text\r\n  if (visionResponse.fullTextAnnotation?.text) {\r\n    return normalizeOcrText(visionResponse.fullTextAnnotation.text);\r\n  }\r\n  \r\n  // Fallback to textAnnotations\r\n  if (visionResponse.textAnnotations && visionResponse.textAnnotations.length > 0) {\r\n    // First annotation is usually the full text\r\n    const rawText = visionResponse.textAnnotations[0].description || '';\r\n    return normalizeOcrText(rawText);\r\n  }\r\n  \r\n  return '';\r\n}\r\n\r\n/**\r\n * Check if a line looks like a name (starts with capital, has common name patterns)\r\n */\r\nfunction looksLikeName(line: string): boolean {\r\n  if (line.length < 3 || line.length > 50) return false;\r\n  // Names often start with capital letter and contain letters/spaces/hyphens\r\n  return /^[A-ZА-ЯЁ][a-zа-яё\\s\\-']+$/.test(line.trim());\r\n}\r\n\r\n/**\r\n * Check if a line looks like a date\r\n */\r\nfunction looksLikeDate(line: string): boolean {\r\n  // Patterns: \"род 27 Января 1939\", \"Nov. 25, 1920\", \"AUG. 18, 1946\", etc.\r\n  const datePatterns = [\r\n    /\\d{1,2}\\s+(Января|Февраля|Марта|Апреля|Мая|Июня|Июля|Августа|Сентября|Октября|Ноября|Декабря|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i,\r\n    /(род|крещ|родился|baptized|born|date).*\\d{4}/i,\r\n    /\\d{1,2}[,\\s]+\\d{4}/,\r\n    /[A-Z]{3}\\.\\s+\\d{1,2},\\s+\\d{4}/, // \"AUG. 18, 1946\"\r\n  ];\r\n  return datePatterns.some(pattern => pattern.test(line));\r\n}\r\n\r\n/**\r\n * Check if a line looks like a record header (baptism, marriage, etc.)\r\n */\r\nfunction looksLikeRecordHeader(line: string): boolean {\r\n  const headers = [\r\n    'notification of marriage',\r\n    'baptism',\r\n    'marriage',\r\n    'funeral',\r\n    'крещение',\r\n    'брак',\r\n    'погребение',\r\n  ];\r\n  const lower = line.toLowerCase();\r\n  return headers.some(h => lower.includes(h)) || /^[A-ZА-ЯЁ\\s]+$/.test(line) && line.length < 40;\r\n}\r\n\r\n/**\r\n * Enhanced text display formatting (presentation only)\r\n * Groups related lines and improves spacing based on content patterns\r\n * This is UI-only formatting and does not change semantic content\r\n */\r\nexport function enhanceOcrTextStructure(text: string): string {\r\n  if (!text) return '';\r\n  \r\n  const lines = text.split('\\n').map(line => line.trim()).filter(line => line.length > 0);\r\n  if (lines.length === 0) return '';\r\n  \r\n  const enhanced: string[] = [];\r\n  \r\n  for (let i = 0; i < lines.length; i++) {\r\n    const line = lines[i];\r\n    const prevLine = i > 0 ? lines[i - 1] : null;\r\n    const nextLine = i < lines.length - 1 ? lines[i + 1] : null;\r\n    \r\n    const isName = looksLikeName(line);\r\n    const isDate = looksLikeDate(line);\r\n    const isHeader = looksLikeRecordHeader(line);\r\n    const isShort = line.length < 25;\r\n    const isLong = line.length > 70;\r\n    \r\n    // Add blank line before record headers\r\n    if (isHeader && prevLine && prevLine.length > 10 && enhanced.length > 0) {\r\n      if (enhanced[enhanced.length - 1]) {\r\n        enhanced.push('');\r\n      }\r\n    }\r\n    \r\n    // Add blank line before names if previous line was a date or long line\r\n    if (isName && prevLine && (looksLikeDate(prevLine) || prevLine.length > 60)) {\r\n      if (enhanced.length > 0 && enhanced[enhanced.length - 1]) {\r\n        enhanced.push('');\r\n      }\r\n    }\r\n    \r\n    // Add blank line after dates if next line is a name\r\n    if (isDate && nextLine && looksLikeName(nextLine)) {\r\n      enhanced.push(line);\r\n      if (nextLine) {\r\n        enhanced.push('');\r\n      }\r\n      continue;\r\n    }\r\n    \r\n    // Add blank line after short lines that look like labels/headers\r\n    if (isShort && !isName && !isDate && nextLine && nextLine.length > 40) {\r\n      enhanced.push(line);\r\n      enhanced.push('');\r\n      continue;\r\n    }\r\n    \r\n    enhanced.push(line);\r\n  }\r\n  \r\n  // Clean up: normalize multiple empty lines, remove leading/trailing empty lines\r\n  let result = enhanced.join('\\n');\r\n  \r\n  // Normalize: max 2 consecutive newlines\r\n  result = result.replace(/\\n{3,}/g, '\\n\\n');\r\n  \r\n  // Remove leading/trailing empty lines\r\n  result = result.replace(/^\\n+/, '').replace(/\\n+$/, '');\r\n  \r\n  // Final pass: ensure proper spacing around record sections\r\n  // Add blank line before lines that start with capital letters and are short (likely headers)\r\n  const finalLines = result.split('\\n');\r\n  const finalEnhanced: string[] = [];\r\n  \r\n  for (let i = 0; i < finalLines.length; i++) {\r\n    const line = finalLines[i];\r\n    const prevLine = i > 0 ? finalLines[i - 1] : '';\r\n    const isEmpty = line.trim().length === 0;\r\n    \r\n    if (isEmpty) {\r\n      // Only add one empty line\r\n      if (finalEnhanced.length > 0 && finalEnhanced[finalEnhanced.length - 1]) {\r\n        finalEnhanced.push('');\r\n      }\r\n      continue;\r\n    }\r\n    \r\n    // Add blank line before uppercase headers (all caps or title case)\r\n    if (\r\n      /^[A-ZА-ЯЁ]/.test(line) &&\r\n      line.length < 50 &&\r\n      prevLine &&\r\n      prevLine.trim().length > 0 &&\r\n      !prevLine.match(/^[A-ZА-ЯЁ]/) &&\r\n      finalEnhanced.length > 0 &&\r\n      finalEnhanced[finalEnhanced.length - 1]\r\n    ) {\r\n      finalEnhanced.push('');\r\n    }\r\n    \r\n    finalEnhanced.push(line);\r\n  }\r\n  \r\n  return finalEnhanced.join('\\n').trim();\r\n}\r\n\r\n","/**\r\n * Hook for server-side transcription normalization (feature-flagged)\r\n * Falls back to client-side display normalization if flag is off or API fails\r\n */\r\n\r\nimport { useState, useCallback } from 'react';\r\nimport { apiClient } from '@/shared/lib/axiosInstance';\r\nimport { normalizeOcrText, enhanceOcrTextStructure } from './displayNormalizer';\r\n\r\ninterface NormalizationSettings {\r\n  transcriptionMode?: 'exact' | 'fix-spelling';\r\n  textExtractionScope?: 'all' | 'handwritten-only';\r\n  formattingMode?: 'improve-formatting';\r\n  confidenceThreshold?: number;\r\n}\r\n\r\ninterface NormalizationResult {\r\n  text: string;\r\n  paragraphs: string[];\r\n  diagnostics: {\r\n    droppedTokenCount: number;\r\n    lineCount: number;\r\n    paragraphCount: number;\r\n    scriptsPresent: string[];\r\n    warnings: string[];\r\n  };\r\n}\r\n\r\n/**\r\n * Check if server normalization feature flag is enabled\r\n * This function is called on every render to ensure reactivity\r\n */\r\nexport function isServerNormalizationEnabled(): boolean {\r\n  // Check localStorage first (runtime flag)\r\n  if (typeof window !== 'undefined') {\r\n    const flag = localStorage.getItem('OCR_NORMALIZE_SERVER');\r\n    if (flag !== null) {\r\n      return flag === '1' || flag === 'true';\r\n    }\r\n  }\r\n  // Check env var (for build-time)\r\n  return import.meta.env.VITE_OCR_NORMALIZE_SERVER === '1' || \r\n         import.meta.env.OCR_NORMALIZE_SERVER === '1';\r\n}\r\n\r\n/**\r\n * Call server normalization API\r\n */\r\nexport async function normalizeTranscriptionOnServer(\r\n  churchId: number,\r\n  jobId: number,\r\n  settings: NormalizationSettings = {}\r\n): Promise<NormalizationResult | null> {\r\n  try {\r\n    const response = await apiClient.post(\r\n      `/api/church/${churchId}/ocr/jobs/${jobId}/normalize`,\r\n      { settings }\r\n    );\r\n    \r\n    const data = (response as any)?.data ?? response;\r\n    return data.transcription || null;\r\n  } catch (error: any) {\r\n    console.warn('[useServerNormalization] Server normalization failed:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Fallback to client-side display normalization\r\n */\r\nexport function normalizeTranscriptionClient(rawText: string | null): string {\r\n  if (!rawText) return '';\r\n  \r\n  try {\r\n    const normalized = normalizeOcrText(rawText);\r\n    return enhanceOcrTextStructure(normalized);\r\n  } catch (error) {\r\n    console.error('[useServerNormalization] Client normalization failed:', error);\r\n    return rawText || '';\r\n  }\r\n}\r\n\r\n/**\r\n * Hook for transcription normalization with automatic fallback\r\n */\r\nexport function useServerNormalization() {\r\n  const [normalizing, setNormalizing] = useState(false);\r\n  const [serverNormalized, setServerNormalized] = useState<string | null>(null);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const normalize = useCallback(async (\r\n    churchId: number,\r\n    jobId: number,\r\n    rawText: string | null,\r\n    settings: NormalizationSettings = {}\r\n  ): Promise<string> => {\r\n    // Always fall back to client if flag is off\r\n    if (!isServerNormalizationEnabled()) {\r\n      return normalizeTranscriptionClient(rawText);\r\n    }\r\n\r\n    // If no raw text, use client fallback\r\n    if (!rawText) {\r\n      return '';\r\n    }\r\n\r\n    setNormalizing(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const result = await normalizeTranscriptionOnServer(churchId, jobId, settings);\r\n      \r\n      if (result && result.text) {\r\n        setServerNormalized(result.text);\r\n        return result.text;\r\n      } else {\r\n        // Server returned null/empty, fall back to client\r\n        console.warn('[useServerNormalization] Server returned empty result, using client fallback');\r\n        const clientResult = normalizeTranscriptionClient(rawText);\r\n        setServerNormalized(null);\r\n        return clientResult;\r\n      }\r\n    } catch (err: any) {\r\n      console.error('[useServerNormalization] Normalization error:', err);\r\n      setError(err.message || 'Normalization failed');\r\n      // Fall back to client normalization\r\n      const clientResult = normalizeTranscriptionClient(rawText);\r\n      setServerNormalized(null);\r\n      return clientResult;\r\n    } finally {\r\n      setNormalizing(false);\r\n    }\r\n  }, []);\r\n\r\n  return {\r\n    normalize,\r\n    normalizing,\r\n    serverNormalized,\r\n    error,\r\n    isEnabled: isServerNormalizationEnabled(),\r\n  };\r\n}\r\n\r\n","/**\r\n * TranscriptionPanel - Clean, readable OCR text output\r\n * Matches handwritingocr.com transcription display\r\n */\r\n\r\nimport React, { useMemo } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  Paper,\r\n  Stack,\r\n  IconButton,\r\n  Tooltip,\r\n  Divider,\r\n  Button,\r\n  CircularProgress,\r\n} from '@mui/material';\r\nimport {\r\n  IconCopy,\r\n  IconDownload,\r\n  IconWand,\r\n} from '@tabler/icons-react';\r\nimport { normalizeOcrText, enhanceOcrTextStructure } from '../utils/displayNormalizer';\r\nimport { isServerNormalizationEnabled } from '../utils/useServerNormalization';\r\n\r\ninterface TranscriptionPanelProps {\r\n  ocrText: string | null;\r\n  serverNormalizedText?: string | null; // Server-normalized text (when flag enabled)\r\n  loading?: boolean;\r\n  normalizing?: boolean; // Server normalization in progress\r\n  onCopy?: () => void;\r\n  onDownload?: () => void;\r\n  onNormalize?: () => void; // Callback for normalize button\r\n}\r\n\r\nconst TranscriptionPanel: React.FC<TranscriptionPanelProps> = ({\r\n  ocrText,\r\n  serverNormalizedText,\r\n  loading = false,\r\n  normalizing = false,\r\n  onCopy,\r\n  onDownload,\r\n  onNormalize,\r\n}) => {\r\n  const serverNormalizationEnabled = isServerNormalizationEnabled();\r\n  \r\n  // Use server-normalized text if available and flag is enabled, otherwise use client normalization\r\n  const normalizedText = useMemo(() => {\r\n    if (serverNormalizationEnabled && serverNormalizedText) {\r\n      return serverNormalizedText;\r\n    }\r\n    \r\n    // Fallback to client-side normalization\r\n    if (!ocrText) return '';\r\n    \r\n    try {\r\n      const normalized = normalizeOcrText(ocrText);\r\n      return enhanceOcrTextStructure(normalized);\r\n    } catch (error) {\r\n      console.error('[TranscriptionPanel] Error normalizing text:', error);\r\n      return ocrText;\r\n    }\r\n  }, [ocrText, serverNormalizedText, serverNormalizationEnabled]);\r\n\r\n  const handleCopy = () => {\r\n    if (normalizedText) {\r\n      navigator.clipboard.writeText(normalizedText);\r\n      if (onCopy) onCopy();\r\n    }\r\n  };\r\n\r\n  const handleDownload = () => {\r\n    if (normalizedText) {\r\n      const blob = new Blob([normalizedText], { type: 'text/plain' });\r\n      const url = URL.createObjectURL(blob);\r\n      const a = document.createElement('a');\r\n      a.href = url;\r\n      a.download = 'transcription.txt';\r\n      document.body.appendChild(a);\r\n      a.click();\r\n      document.body.removeChild(a);\r\n      URL.revokeObjectURL(url);\r\n      if (onDownload) onDownload();\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Paper\r\n      elevation={0}\r\n      sx={{\r\n        height: '100%',\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        border: '1px solid',\r\n        borderColor: 'divider',\r\n        borderRadius: 2,\r\n        overflow: 'hidden',\r\n      }}\r\n    >\r\n      {/* Header */}\r\n      <Box\r\n        sx={{\r\n          p: 2,\r\n          borderBottom: '1px solid',\r\n          borderColor: 'divider',\r\n          display: 'flex',\r\n          justifyContent: 'space-between',\r\n          alignItems: 'center',\r\n        }}\r\n      >\r\n        <Typography variant=\"h6\" fontWeight={600}>\r\n          Transcription\r\n        </Typography>\r\n        <Stack direction=\"row\" spacing={0.5} alignItems=\"center\">\r\n          {serverNormalizationEnabled && onNormalize && (\r\n            <Tooltip title=\"Normalize transcription (server-side)\">\r\n              <Button\r\n                size=\"small\"\r\n                variant=\"outlined\"\r\n                startIcon={normalizing ? <CircularProgress size={14} /> : <IconWand size={16} />}\r\n                onClick={onNormalize}\r\n                disabled={!ocrText || loading || normalizing}\r\n                sx={{ mr: 1 }}\r\n              >\r\n                {normalizing ? 'Normalizing...' : 'Normalize'}\r\n              </Button>\r\n            </Tooltip>\r\n          )}\r\n          <Tooltip title=\"Copy transcription\">\r\n            <IconButton\r\n              size=\"small\"\r\n              onClick={handleCopy}\r\n              disabled={!normalizedText || loading}\r\n            >\r\n              <IconCopy size={18} />\r\n            </IconButton>\r\n          </Tooltip>\r\n          <Tooltip title=\"Download transcription\">\r\n            <IconButton\r\n              size=\"small\"\r\n              onClick={handleDownload}\r\n              disabled={!normalizedText || loading}\r\n            >\r\n              <IconDownload size={18} />\r\n            </IconButton>\r\n          </Tooltip>\r\n        </Stack>\r\n      </Box>\r\n\r\n      {/* Text Content */}\r\n      <Box\r\n        sx={{\r\n          flex: 1,\r\n          overflow: 'auto',\r\n          p: 3,\r\n          bgcolor: 'background.default',\r\n        }}\r\n      >\r\n        {loading ? (\r\n          <Typography variant=\"body2\" color=\"text.secondary\">\r\n            Processing...\r\n          </Typography>\r\n        ) : !normalizedText ? (\r\n          <Typography variant=\"body2\" color=\"text.secondary\">\r\n            No transcription available. Process a document to see OCR text.\r\n          </Typography>\r\n        ) : (\r\n          <Typography\r\n            variant=\"body1\"\r\n            component=\"pre\"\r\n            sx={{\r\n              fontFamily: 'inherit',\r\n              whiteSpace: 'pre-wrap',\r\n              wordBreak: 'break-word',\r\n              lineHeight: 1.6,\r\n              color: 'text.primary',\r\n              margin: 0,\r\n            }}\r\n          >\r\n            {normalizedText}\r\n          </Typography>\r\n        )}\r\n      </Box>\r\n    </Paper>\r\n  );\r\n};\r\n\r\nexport default TranscriptionPanel;\r\n\r\n","/**\r\n * OcrWorkbench - Main workbench container for OCR job processing\r\n * Two-phase UI: (1) Jobs List, (2) Workbench for selected job\r\n */\r\n\r\nimport React, { useState, useCallback, useMemo, useEffect } from 'react';\r\nimport {\r\n  Box,\r\n  Paper,\r\n  Typography,\r\n  Divider,\r\n  alpha,\r\n  useTheme,\r\n  Snackbar,\r\n  Alert,\r\n} from '@mui/material';\r\nimport { useOcrJobs } from '../../hooks/useOcrJobs';\r\nimport { useWorkbench } from '../../context/WorkbenchContext';\r\nimport WorkbenchHeader from './WorkbenchHeader';\r\nimport WorkbenchStepper from './WorkbenchStepper';\r\nimport WorkbenchViewer from './WorkbenchViewer';\r\nimport UnifiedJobsList from './UnifiedJobsList';\r\nimport TranscriptionPanel from '../TranscriptionPanel';\r\nimport { extractTextFromVisionResponse } from '../../utils/displayNormalizer';\r\nimport { detectMetadata } from '../../utils/recordTypeDetector';\r\nimport { useServerNormalization } from '../../utils/useServerNormalization';\r\nimport type { JobDetail } from '../../types/inspection';\r\nimport type { VisionResponse } from '../../types/fusion';\r\n\r\ninterface OcrWorkbenchProps {\r\n  churchId: number;\r\n  initialJobId?: number;\r\n}\r\n\r\nconst OcrWorkbench: React.FC<OcrWorkbenchProps> = ({\r\n  churchId,\r\n  initialJobId,\r\n}) => {\r\n  const theme = useTheme();\r\n  const workbench = useWorkbench();\r\n  \r\n  // Server normalization hook\r\n  const { normalize, normalizing, serverNormalized } = useServerNormalization();\r\n  const [normalizedText, setNormalizedText] = useState<string | null>(null);\r\n  \r\n  // Check flag dynamically - check on each render to react to localStorage changes\r\n  // This will update when localStorage changes (after page reload)\r\n  const serverNormalizationEnabled = useMemo(() => {\r\n    if (typeof window === 'undefined') return false;\r\n    const flag = localStorage.getItem('OCR_NORMALIZE_SERVER');\r\n    return flag === '1' || flag === 'true';\r\n  }, [normalizedText]); // Re-check when normalizedText changes (triggers after normalization)\r\n  \r\n  // Toast notifications\r\n  const [toast, setToast] = useState<{\r\n    open: boolean;\r\n    message: string;\r\n    severity: 'success' | 'warning' | 'error' | 'info';\r\n  }>({ open: false, message: '', severity: 'info' });\r\n\r\n  const showToast = useCallback((message: string, severity: 'success' | 'warning' | 'error' | 'info' = 'info') => {\r\n    setToast({ open: true, message, severity });\r\n  }, []);\r\n  \r\n  // Track selected job ID locally (workbench state will be updated when job data loads)\r\n  const [selectedJobId, setSelectedJobId] = useState<number | null>(initialJobId || null);\r\n  \r\n  // Fetch jobs list\r\n  const { jobs, loading, error, refresh, fetchJobDetail, deleteJobs } = useOcrJobs({ churchId });\r\n  \r\n  // Auto-refresh jobs list periodically to catch new uploads\r\n  useEffect(() => {\r\n    if (!churchId) return;\r\n    \r\n    // Initial load\r\n    refresh();\r\n    \r\n    // Set up polling every 5 seconds to catch new uploads\r\n    const pollInterval = setInterval(() => {\r\n      refresh();\r\n    }, 5000);\r\n    \r\n    return () => clearInterval(pollInterval);\r\n  }, [churchId, refresh]);\r\n  \r\n  // Get selected job details\r\n  const selectedJob = useMemo(() => {\r\n    if (!selectedJobId) return null;\r\n    return jobs.find(j => j.id === selectedJobId) || null;\r\n  }, [jobs, selectedJobId]);\r\n  \r\n  // Load job data into workbench when job is selected\r\n  useEffect(() => {\r\n    if (!selectedJobId || !churchId) {\r\n      // Clear workbench if no job selected\r\n      if (!selectedJobId) {\r\n        workbench.reset();\r\n      }\r\n      return;\r\n    }\r\n    \r\n    const loadJobData = async () => {\r\n      try {\r\n        const jobDetail = await fetchJobDetail(selectedJobId);\r\n        if (!jobDetail) {\r\n          workbench.dispatch({ type: 'SET_ERROR', payload: 'Job not found' });\r\n          return;\r\n        }\r\n        \r\n        // Parse OCR result\r\n        let ocrResult: VisionResponse | null = null;\r\n        try {\r\n          if (jobDetail.ocr_result_json) {\r\n            ocrResult = typeof jobDetail.ocr_result_json === 'string'\r\n              ? JSON.parse(jobDetail.ocr_result_json)\r\n              : jobDetail.ocr_result_json;\r\n          } else if (jobDetail.ocrResultJson) {\r\n            ocrResult = typeof jobDetail.ocrResultJson === 'string'\r\n              ? JSON.parse(jobDetail.ocrResultJson)\r\n              : jobDetail.ocrResultJson;\r\n          }\r\n        } catch (e) {\r\n          console.warn('[OcrWorkbench] Failed to parse OCR result:', e);\r\n        }\r\n        \r\n        // Get image URL - always use API endpoint (file_path is server path, not URL)\r\n        const imageUrl = (churchId && selectedJobId) \r\n          ? `/api/church/${churchId}/ocr/jobs/${selectedJobId}/image`\r\n          : null;\r\n        \r\n        // Extract OCR text - prefer stored text, fallback to extracting from Vision response\r\n        // Use structured extraction for better formatting\r\n        let ocrTextForDetection = jobDetail.ocr_text || jobDetail.ocrText || null;\r\n        if (!ocrTextForDetection && ocrResult) {\r\n          ocrTextForDetection = extractTextFromVisionResponse(ocrResult);\r\n        }\r\n        let detectedRecordType = jobDetail.record_type || jobDetail.recordType || 'baptism';\r\n        \r\n        if (ocrTextForDetection) {\r\n          try {\r\n            // Explicitly call detectMetadata with proper error handling\r\n            // This ensures no require() or other Node.js globals are used\r\n            const metadata = detectMetadata(ocrTextForDetection);\r\n            if (metadata && metadata.recordType && metadata.confidence > 0.5) {\r\n              detectedRecordType = metadata.recordType;\r\n              console.log('[OcrWorkbench] Auto-detected record type:', metadata.recordType, 'confidence:', metadata.confidence);\r\n              if (metadata.year) {\r\n                console.log('[OcrWorkbench] Auto-detected year:', metadata.year);\r\n              }\r\n            }\r\n          } catch (e) {\r\n            // Gracefully handle any errors without crashing\r\n            console.warn('[OcrWorkbench] Failed to auto-detect record type:', e);\r\n            // Continue with default record type (detectedRecordType already set above)\r\n          }\r\n        }\r\n        \r\n        // Set job in workbench\r\n        workbench.setJob(\r\n          selectedJobId,\r\n          {\r\n            filename: jobDetail.original_filename || jobDetail.originalFilename || 'Unknown',\r\n            recordType: detectedRecordType as any,\r\n            status: jobDetail.status || 'unknown',\r\n            confidence: jobDetail.confidence_score || jobDetail.confidenceScore || 0,\r\n            churchId,\r\n          },\r\n          ocrTextForDetection,\r\n          ocrResult,\r\n          imageUrl\r\n        );\r\n      } catch (err) {\r\n        console.error('[OcrWorkbench] Failed to load job data:', err);\r\n        workbench.dispatch({ type: 'SET_ERROR', payload: 'Failed to load job data' });\r\n      }\r\n    };\r\n    \r\n    loadJobData();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [selectedJobId, churchId]); // Removed workbench and fetchJobDetail to prevent infinite loops\r\n  \r\n  // Handle job selection\r\n  const handleJobSelect = useCallback((jobId: number) => {\r\n    setSelectedJobId(jobId);\r\n    workbench.dispatch({ type: 'SET_ACTIVE_STEP', payload: 0 });\r\n    workbench.dispatch({ type: 'SET_ERROR', payload: null });\r\n  }, [workbench]);\r\n  \r\n  // Handle delete jobs\r\n  const handleDeleteJobs = useCallback(async (jobIds: number[]) => {\r\n    if (!confirm(`Delete ${jobIds.length} job(s)? This cannot be undone.`)) {\r\n      return;\r\n    }\r\n    const success = await deleteJobs(jobIds);\r\n    if (success) {\r\n      // If deleted job was selected, clear selection\r\n      if (selectedJobId && jobIds.includes(selectedJobId)) {\r\n        setSelectedJobId(null);\r\n        workbench.reset();\r\n      }\r\n      // Refresh jobs list\r\n      await refresh();\r\n    }\r\n  }, [deleteJobs, refresh, selectedJobId, workbench]);\r\n  \r\n  // Handle close workbench\r\n  const handleCloseWorkbench = useCallback(() => {\r\n    setSelectedJobId(null);\r\n    workbench.reset();\r\n    setNormalizedText(null); // Clear normalized text when closing\r\n  }, [workbench]);\r\n\r\n  // Expose normalized text globally for FusionTab access (when not using WorkbenchContext)\r\n  useEffect(() => {\r\n    if (normalizedText) {\r\n      (window as any).__workbenchState = { normalizedText };\r\n    } else {\r\n      delete (window as any).__workbenchState;\r\n    }\r\n    return () => {\r\n      delete (window as any).__workbenchState;\r\n    };\r\n  }, [normalizedText]);\r\n\r\n  // Handle normalize button click\r\n  const handleNormalize = useCallback(async () => {\r\n    if (!selectedJobId || !churchId) return;\r\n    \r\n    // Get raw OCR text\r\n    const rawText = workbench.state.ocrText || \r\n                   (workbench.state.ocrResult ? extractTextFromVisionResponse(workbench.state.ocrResult) : null);\r\n    \r\n    if (!rawText) {\r\n      showToast('No OCR text available to normalize', 'warning');\r\n      return;\r\n    }\r\n\r\n    // Read document processing settings from localStorage\r\n    let docSettings = {\r\n      transcriptionMode: 'exact' as const,\r\n      textExtractionScope: 'all' as const,\r\n      formattingMode: 'improve-formatting' as const,\r\n      confidenceThreshold: 0.35,\r\n    };\r\n    \r\n    try {\r\n      const stored = sessionStorage.getItem('om.ocr.docSettings');\r\n      if (stored) {\r\n        const parsed = JSON.parse(stored);\r\n        docSettings = { ...docSettings, ...parsed };\r\n      }\r\n    } catch (e) {\r\n      console.warn('[OcrWorkbench] Failed to load doc settings:', e);\r\n    }\r\n\r\n    try {\r\n      const result = await normalize(churchId, selectedJobId, rawText, docSettings);\r\n      setNormalizedText(result);\r\n      // Store in workbench context for use in Save Draft\r\n      workbench.dispatch({ type: 'SET_NORMALIZED_TEXT', payload: result });\r\n      showToast('Transcription normalized successfully', 'success');\r\n    } catch (error: any) {\r\n      console.error('[OcrWorkbench] Normalization failed:', error);\r\n      showToast('Normalization failed, using client-side formatting', 'warning');\r\n      setNormalizedText(null); // Use client fallback\r\n      workbench.dispatch({ type: 'SET_NORMALIZED_TEXT', payload: null });\r\n    }\r\n  }, [selectedJobId, churchId, workbench, normalize, showToast]);\r\n  \r\n  // Show workbench if job is selected and loaded\r\n  const showWorkbench = selectedJobId && workbench.state.jobMetadata;\r\n  \r\n  return (\r\n    <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>\r\n      {showWorkbench ? (\r\n        // Phase 2: Workbench for selected job\r\n        <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>\r\n          <WorkbenchHeader\r\n            job={{\r\n              ...(selectedJob || {\r\n                id: selectedJobId,\r\n                original_filename: workbench.state.jobMetadata?.filename || 'Unknown',\r\n                record_type: workbench.state.jobMetadata?.recordType || 'baptism',\r\n                status: workbench.state.jobMetadata?.status || 'unknown',\r\n                confidence_score: workbench.state.jobMetadata?.confidence || 0,\r\n              } as any),\r\n              ocr_text: workbench.state.ocrText || null,\r\n            }}\r\n            onClose={handleCloseWorkbench}\r\n          />\r\n          <Box sx={{ flex: 1, display: 'flex', overflow: 'hidden' }}>\r\n            {/* Left: Image Viewer */}\r\n            <Box sx={{ width: '50%', borderRight: '1px solid', borderColor: 'divider', overflow: 'hidden' }}>\r\n              <WorkbenchViewer />\r\n            </Box>\r\n            {/* Right: Transcription Panel (Phase 1 - transcription-first) */}\r\n            <Box sx={{ width: '50%', overflow: 'hidden', p: 2 }}>\r\n              <TranscriptionPanel\r\n                ocrText={\r\n                  workbench.state.ocrText || \r\n                  (workbench.state.ocrResult ? extractTextFromVisionResponse(workbench.state.ocrResult) : null)\r\n                }\r\n                serverNormalizedText={normalizedText}\r\n                loading={!workbench.state.ocrResult && !workbench.state.ocrText}\r\n                normalizing={normalizing}\r\n                onCopy={() => showToast('Copied to clipboard', 'success')}\r\n                onDownload={() => showToast('Transcription downloaded', 'success')}\r\n                onNormalize={serverNormalizationEnabled ? handleNormalize : undefined}\r\n              />\r\n            </Box>\r\n          </Box>\r\n          \r\n          {/* Toast Notifications */}\r\n          <Snackbar\r\n            open={toast.open}\r\n            autoHideDuration={3500}\r\n            onClose={() => setToast({ ...toast, open: false })}\r\n            anchorOrigin={{ vertical: 'bottom', horizontal: 'right' }}\r\n          >\r\n            <Alert\r\n              onClose={() => setToast({ ...toast, open: false })}\r\n              severity={toast.severity}\r\n              variant=\"filled\"\r\n              sx={{ width: '100%' }}\r\n            >\r\n              {toast.message}\r\n            </Alert>\r\n          </Snackbar>\r\n        </Box>\r\n      ) : (\r\n        // Phase 1: Unified Jobs List\r\n        <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column', p: 2 }}>\r\n          <Typography variant=\"h5\" fontWeight={600} gutterBottom>\r\n            OCR Jobs\r\n          </Typography>\r\n          <UnifiedJobsList\r\n            jobs={jobs}\r\n            loading={loading}\r\n            error={error}\r\n            onJobSelect={handleJobSelect}\r\n            onRefresh={refresh}\r\n            onDeleteJobs={handleDeleteJobs}\r\n            churchId={churchId}\r\n          />\r\n        </Box>\r\n      )}\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default OcrWorkbench;\r\n\r\n","/**\r\n * OCR Selection Context\r\n * Manages OCR token/line selections shared between InspectionPanel and FusionTab\r\n * Scoped per jobId\r\n */\r\n\r\nimport React, { createContext, useContext, useReducer, useCallback, ReactNode } from 'react';\r\nimport { BBox } from '../types/fusion';\r\n\r\nexport interface OcrSelectionItem {\r\n  type: 'token' | 'line';\r\n  id: string;\r\n  text: string;\r\n  bbox: BBox; // Image pixel coordinates\r\n  confidence?: number;\r\n  // New: attach selection to specific entry and field\r\n  entryId?: string; // Which entry this selection belongs to\r\n  fieldKey?: string; // Which field this selection maps to\r\n}\r\n\r\ninterface OcrSelectionState {\r\n  selections: Record<string, OcrSelectionItem[]>; // jobId -> selections\r\n}\r\n\r\ntype OcrSelectionAction =\r\n  | { type: 'SET_SELECTION'; jobId: string; items: OcrSelectionItem[] }\r\n  | { type: 'ADD_SELECTION'; jobId: string; item: OcrSelectionItem }\r\n  | { type: 'REMOVE_SELECTION'; jobId: string; itemId: string }\r\n  | { type: 'CLEAR_SELECTION'; jobId: string }\r\n  | { type: 'CLEAR_ALL' };\r\n\r\nconst initialState: OcrSelectionState = {\r\n  selections: {},\r\n};\r\n\r\nfunction selectionReducer(state: OcrSelectionState, action: OcrSelectionAction): OcrSelectionState {\r\n  switch (action.type) {\r\n    case 'SET_SELECTION': {\r\n      return {\r\n        ...state,\r\n        selections: {\r\n          ...state.selections,\r\n          [action.jobId]: action.items,\r\n        },\r\n      };\r\n    }\r\n    case 'ADD_SELECTION': {\r\n      const existing = state.selections[action.jobId] || [];\r\n      // Avoid duplicates\r\n      if (existing.some(item => item.id === action.item.id)) {\r\n        return state;\r\n      }\r\n      return {\r\n        ...state,\r\n        selections: {\r\n          ...state.selections,\r\n          [action.jobId]: [...existing, action.item],\r\n        },\r\n      };\r\n    }\r\n    case 'REMOVE_SELECTION': {\r\n      const existing = state.selections[action.jobId] || [];\r\n      return {\r\n        ...state,\r\n        selections: {\r\n          ...state.selections,\r\n          [action.jobId]: existing.filter(item => item.id !== action.itemId),\r\n        },\r\n      };\r\n    }\r\n    case 'CLEAR_SELECTION': {\r\n      const { [action.jobId]: _, ...rest } = state.selections;\r\n      return {\r\n        ...state,\r\n        selections: rest,\r\n      };\r\n    }\r\n    case 'CLEAR_ALL': {\r\n      return {\r\n        ...state,\r\n        selections: {},\r\n      };\r\n    }\r\n    default:\r\n      return state;\r\n  }\r\n}\r\n\r\ninterface OcrSelectionContextValue {\r\n  getSelection: (jobId: string) => OcrSelectionItem[];\r\n  setSelection: (jobId: string, items: OcrSelectionItem[]) => void;\r\n  addSelection: (jobId: string, item: OcrSelectionItem) => void;\r\n  removeSelection: (jobId: string, itemId: string) => void;\r\n  clearSelection: (jobId: string) => void;\r\n  clearAll: () => void;\r\n}\r\n\r\nconst OcrSelectionContext = createContext<OcrSelectionContextValue | null>(null);\r\n\r\nexport function OcrSelectionProvider({ children }: { children: ReactNode }) {\r\n  const [state, dispatch] = useReducer(selectionReducer, initialState);\r\n\r\n  const getSelection = useCallback((jobId: string): OcrSelectionItem[] => {\r\n    return state.selections[jobId] || [];\r\n  }, [state]);\r\n\r\n  const setSelection = useCallback((jobId: string, items: OcrSelectionItem[]) => {\r\n    dispatch({ type: 'SET_SELECTION', jobId, items });\r\n  }, []);\r\n\r\n  const addSelection = useCallback((jobId: string, item: OcrSelectionItem) => {\r\n    dispatch({ type: 'ADD_SELECTION', jobId, item });\r\n  }, []);\r\n\r\n  const removeSelection = useCallback((jobId: string, itemId: string) => {\r\n    dispatch({ type: 'REMOVE_SELECTION', jobId, itemId });\r\n  }, []);\r\n\r\n  const clearSelection = useCallback((jobId: string) => {\r\n    dispatch({ type: 'CLEAR_SELECTION', jobId });\r\n  }, []);\r\n\r\n  const clearAll = useCallback(() => {\r\n    dispatch({ type: 'CLEAR_ALL' });\r\n  }, []);\r\n\r\n  return (\r\n    <OcrSelectionContext.Provider\r\n      value={{\r\n        getSelection,\r\n        setSelection,\r\n        addSelection,\r\n        removeSelection,\r\n        clearSelection,\r\n        clearAll,\r\n      }}\r\n    >\r\n      {children}\r\n    </OcrSelectionContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useOcrSelection() {\r\n  const context = useContext(OcrSelectionContext);\r\n  if (!context) {\r\n    throw new Error('useOcrSelection must be used within OcrSelectionProvider');\r\n  }\r\n  return context;\r\n}\r\n\r\n","import React, { useEffect, useState } from 'react';\r\nimport { useNavigate, useSearchParams } from 'react-router-dom';\r\nimport { Alert, Button, Box, CircularProgress, Typography } from '@mui/material';\r\nimport { Settings } from '@mui/icons-material';\r\n\r\ninterface OcrSetupGateProps {\r\n  children: React.ReactNode;\r\n}\r\n\r\n/**\r\n * Gate component that checks OCR setup completion before rendering children\r\n * Shows setup CTA if setup is incomplete\r\n * Automatically extracts church_id from URL query params\r\n */\r\nexport default function OcrSetupGate({ children }: OcrSetupGateProps) {\r\n  const navigate = useNavigate();\r\n  const [searchParams] = useSearchParams();\r\n  const churchId = parseInt(searchParams.get('church_id') || '46');\r\n  \r\n  const [setupComplete, setSetupComplete] = useState<boolean | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [percentComplete, setPercentComplete] = useState(0);\r\n\r\n  useEffect(() => {\r\n    checkSetupStatus();\r\n  }, [churchId]);\r\n\r\n  const checkSetupStatus = async () => {\r\n    try {\r\n      const response = await fetch(`/api/church/${churchId}/ocr/setup-state`);\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setSetupComplete(data.isComplete);\r\n        setPercentComplete(data.percentComplete || 0);\r\n      } else {\r\n        setSetupComplete(false);\r\n      }\r\n    } catch (err) {\r\n      console.error('Failed to check setup status:', err);\r\n      setSetupComplete(false);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', p: 4 }}>\r\n        <CircularProgress />\r\n        <Typography variant=\"body2\" sx={{ mt: 2 }}>Checking setup status...</Typography>\r\n      </Box>\r\n    );\r\n  }\r\n\r\n  if (!setupComplete) {\r\n    return (\r\n      <Box sx={{ p: 3, maxWidth: 600, mx: 'auto' }}>\r\n        <Alert severity=\"warning\" sx={{ mb: 2 }}>\r\n          <Typography variant=\"h6\" gutterBottom>\r\n            OCR Setup Required\r\n          </Typography>\r\n          <Typography variant=\"body2\" gutterBottom>\r\n            Enhanced OCR Uploader requires completing the setup wizard first.\r\n          </Typography>\r\n          {percentComplete > 0 && (\r\n            <Typography variant=\"body2\" color=\"text.secondary\" sx={{ mt: 1 }}>\r\n              Setup Progress: {percentComplete}%\r\n            </Typography>\r\n          )}\r\n        </Alert>\r\n        <Button\r\n          variant=\"contained\"\r\n          startIcon={<Settings />}\r\n          onClick={() => navigate(`/devel/ocr-setup-wizard?church_id=${churchId}`)}\r\n          size=\"large\"\r\n        >\r\n          Complete OCR Setup\r\n        </Button>\r\n      </Box>\r\n    );\r\n  }\r\n\r\n  return <>{children}</>;\r\n}\r\n","/**\r\n * Enhanced OCR Record Uploader\r\n * Production-ready interface for Orthodox Church sacramental record digitization\r\n * \r\n * Features:\r\n * - Batch image uploads with progress tracking\r\n * - SuperAdmin church database selector\r\n * - Individual and batch progress indicators\r\n * - Advanced OCR options\r\n * - Error handling with retry capability\r\n */\r\n\r\nimport React, { useState, useCallback, useEffect, useRef } from 'react';\r\nimport { useSearchParams } from 'react-router-dom';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  Button,\r\n  Card,\r\n  CardContent,\r\n  Alert,\r\n  CircularProgress,\r\n  FormControl,\r\n  InputLabel,\r\n  Select,\r\n  MenuItem,\r\n  Chip,\r\n  IconButton,\r\n  LinearProgress,\r\n  Paper,\r\n  Stack,\r\n  Tooltip,\r\n  Switch,\r\n  FormControlLabel,\r\n  Collapse,\r\n  Divider,\r\n  alpha,\r\n  useTheme,\r\n  Snackbar,\r\n  Radio,\r\n  RadioGroup,\r\n  FormLabel,\r\n} from '@mui/material';\r\nimport {\r\n  IconUpload,\r\n  IconX,\r\n  IconRefresh,\r\n  IconCheck,\r\n  IconAlertCircle,\r\n  IconPlayerPlay,\r\n  IconPlayerPause,\r\n  IconTrash,\r\n  IconChevronDown,\r\n  IconChevronUp,\r\n  IconSettings,\r\n  IconDatabase,\r\n  IconAlertTriangle,\r\n  IconPhoto,\r\n  IconClock,\r\n  IconRotateClockwise\r\n} from '@tabler/icons-react';\r\nimport { useAuth } from '@/context/AuthContext';\r\nimport { apiClient } from '@/shared/lib/axiosInstance';\r\n// @deprecated - Replaced by Workbench\r\n// import InspectionPanel from './components/InspectionPanel';\r\n// import MappingTab from './components/MappingTab';\r\n// import ProcessedImagesTable from './components/ProcessedImagesTable';\r\nimport RecordSchemaInfoPopover from './components/RecordSchemaInfoPopover';\r\nimport { useOcrJobs } from './hooks/useOcrJobs';\r\nimport { WorkbenchProvider } from './context/WorkbenchContext';\r\nimport OcrWorkbench from './components/workbench/OcrWorkbench';\r\nimport type { OCRJobRow } from './types/ocrJob';\r\nimport type { JobDetail } from './types/inspection';\r\nimport { getDefaultColumns } from './config/defaultRecordColumns';\r\nimport { OcrSelectionProvider } from './context/OcrSelectionContext';\r\nimport OcrSetupGate from './components/OcrSetupGate';\r\n\r\n// Types\r\ninterface UploadFile {\r\n  id: string;\r\n  file: File;\r\n  name: string;\r\n  size: number;\r\n  recordType: 'baptism' | 'marriage' | 'funeral';\r\n  status: 'queued' | 'uploading' | 'processing' | 'complete' | 'error';\r\n  progress: number;\r\n  error?: string;\r\n  thumbnail?: string;\r\n  jobId?: string; // Backend job ID after upload\r\n  isSimulation?: boolean; // Flag for simulation mode results\r\n}\r\n\r\ninterface Church {\r\n  id: number;\r\n  name: string;\r\n  database_name: string;\r\n}\r\n\r\ninterface OCRSettings {\r\n  engine: string;\r\n  dpi: number;\r\n  confidenceThreshold: number;\r\n  autoDetectLanguage: boolean;\r\n  forceGrayscale: boolean;\r\n  deskewImages: boolean;\r\n  language: string;\r\n}\r\n\r\ninterface DocumentProcessingSettings {\r\n  transcriptionMode: 'exact' | 'fix-spelling';\r\n  textExtractionScope: 'all' | 'handwritten-only';\r\n  formattingMode: 'improve-formatting' | 'preserve-original';\r\n}\r\n\r\ntype ExtractionAction = 'full-text' | 'tables' | 'custom-data';\r\n\r\n// Utility functions\r\nconst formatFileSize = (bytes: number): string => {\r\n  if (bytes < 1024) return `${bytes} B`;\r\n  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\r\n  return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;\r\n};\r\n\r\nconst generateId = (): string => Math.random().toString(36).substring(2, 11);\r\n\r\n// Status Badge Component\r\nconst StatusBadge: React.FC<{ status: UploadFile['status'] }> = ({ status }) => {\r\n  const theme = useTheme();\r\n  \r\n  const config = {\r\n    queued: { label: 'Queued', color: theme.palette.grey[500], icon: <IconClock size={14} /> },\r\n    uploading: { label: 'Uploading', color: theme.palette.info.main, icon: <CircularProgress size={14} sx={{ color: 'inherit' }} /> },\r\n    processing: { label: 'Processing', color: theme.palette.warning.main, icon: <CircularProgress size={14} sx={{ color: 'inherit' }} /> },\r\n    complete: { label: 'Complete', color: theme.palette.success.main, icon: <IconCheck size={14} /> },\r\n    error: { label: 'Error', color: theme.palette.error.main, icon: <IconAlertCircle size={14} /> }\r\n  };\r\n\r\n  const { label, color, icon } = config[status];\r\n\r\n  return (\r\n    <Chip\r\n      size=\"small\"\r\n      label={label}\r\n      icon={<Box sx={{ display: 'flex', color: 'inherit' }}>{icon}</Box>}\r\n      sx={{\r\n        bgcolor: alpha(color, 0.1),\r\n        color: color,\r\n        borderColor: alpha(color, 0.3),\r\n        border: '1px solid',\r\n        fontWeight: 500,\r\n        fontSize: '0.75rem',\r\n        '& .MuiChip-icon': { color: 'inherit' }\r\n      }}\r\n    />\r\n  );\r\n};\r\n\r\n// Record Type Badge Component\r\nconst RecordTypeBadge: React.FC<{ type: 'baptism' | 'marriage' | 'funeral' }> = ({ type }) => {\r\n  const theme = useTheme();\r\n  \r\n  const colors = {\r\n    baptism: theme.palette.primary.main,\r\n    marriage: '#9c27b0',\r\n    funeral: theme.palette.grey[700]\r\n  };\r\n\r\n  return (\r\n    <Chip\r\n      size=\"small\"\r\n      label={type.charAt(0).toUpperCase() + type.slice(1)}\r\n      sx={{\r\n        bgcolor: alpha(colors[type], 0.1),\r\n        color: colors[type],\r\n        fontWeight: 600,\r\n        fontSize: '0.7rem',\r\n        textTransform: 'capitalize'\r\n      }}\r\n    />\r\n  );\r\n};\r\n\r\n// File Card Component\r\nconst FileCard: React.FC<{\r\n  file: UploadFile;\r\n  isSelected?: boolean;\r\n  onRecordTypeChange: (id: string, type: 'baptism' | 'marriage' | 'funeral') => void;\r\n  onRemove: (id: string) => void;\r\n  onRetry: (id: string) => void;\r\n  onSelect?: (id: string) => void;\r\n}> = ({ file, isSelected, onRecordTypeChange, onRemove, onRetry, onSelect }) => {\r\n  const theme = useTheme();\r\n  const isClickable = file.status === 'complete' && onSelect;\r\n\r\n  return (\r\n    <Paper\r\n      elevation={0}\r\n      onClick={() => isClickable && onSelect(file.id)}\r\n      sx={{\r\n        p: 2,\r\n        mb: 1.5,\r\n        border: '2px solid',\r\n        borderColor: isSelected ? 'primary.main' : file.status === 'error' ? 'error.light' : 'divider',\r\n        borderRadius: 2,\r\n        bgcolor: isSelected \r\n          ? alpha(theme.palette.primary.main, 0.05) \r\n          : file.status === 'error' \r\n            ? alpha(theme.palette.error.main, 0.02) \r\n            : 'background.paper',\r\n        transition: 'all 0.2s ease',\r\n        cursor: isClickable ? 'pointer' : 'default',\r\n        '&:hover': {\r\n          boxShadow: theme.shadows[2],\r\n          borderColor: isSelected ? 'primary.dark' : file.status === 'error' ? 'error.main' : 'primary.light'\r\n        }\r\n      }}\r\n    >\r\n      <Box sx={{ display: 'flex', alignItems: 'flex-start', gap: 2 }}>\r\n        {/* Thumbnail */}\r\n        <Box\r\n          sx={{\r\n            width: 64,\r\n            height: 64,\r\n            borderRadius: 1.5,\r\n            bgcolor: 'action.hover',\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'center',\r\n            overflow: 'hidden',\r\n            flexShrink: 0,\r\n            border: '1px solid',\r\n            borderColor: 'divider'\r\n          }}\r\n        >\r\n          {file.thumbnail ? (\r\n            <img src={file.thumbnail} alt={file.name} style={{ width: '100%', height: '100%', objectFit: 'cover' }} />\r\n          ) : (\r\n            <IconPhoto size={24} color={theme.palette.grey[400]} />\r\n          )}\r\n        </Box>\r\n\r\n        {/* File Info */}\r\n        <Box sx={{ flex: 1, minWidth: 0 }}>\r\n          <Typography variant=\"body2\" fontWeight={600} noWrap title={file.name}>\r\n            {file.name}\r\n          </Typography>\r\n          <Typography variant=\"caption\" color=\"text.secondary\">\r\n            {formatFileSize(file.size)}\r\n          </Typography>\r\n          \r\n          <Stack direction=\"row\" spacing={1} sx={{ mt: 1 }} alignItems=\"center\" flexWrap=\"wrap\">\r\n            <RecordTypeBadge type={file.recordType} />\r\n            {file.isSimulation && (\r\n              <Chip\r\n                label=\"SIMULATION\"\r\n                size=\"small\"\r\n                color=\"info\"\r\n                sx={{ fontSize: '0.7rem', height: 20, fontWeight: 600 }}\r\n              />\r\n            )}\r\n            <FormControl size=\"small\" sx={{ minWidth: 100 }}>\r\n              <Select\r\n                value={file.recordType}\r\n                onChange={(e) => onRecordTypeChange(file.id, e.target.value as any)}\r\n                disabled={file.status !== 'queued'}\r\n                sx={{ \r\n                  height: 28, \r\n                  fontSize: '0.75rem',\r\n                  '& .MuiSelect-select': { py: 0.5 }\r\n                }}\r\n              >\r\n                <MenuItem value=\"baptism\">Baptism</MenuItem>\r\n                <MenuItem value=\"marriage\">Marriage</MenuItem>\r\n                <MenuItem value=\"funeral\">Funeral</MenuItem>\r\n              </Select>\r\n            </FormControl>\r\n          </Stack>\r\n\r\n          {/* Progress Bar */}\r\n          {(file.status === 'uploading' || file.status === 'processing') && (\r\n            <Box sx={{ mt: 1.5 }}>\r\n              <LinearProgress \r\n                variant=\"determinate\" \r\n                value={file.progress} \r\n                sx={{ \r\n                  height: 6, \r\n                  borderRadius: 3,\r\n                  bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n                  '& .MuiLinearProgress-bar': {\r\n                    borderRadius: 3,\r\n                    transition: 'transform 0.3s ease'\r\n                  }\r\n                }}\r\n              />\r\n              <Typography variant=\"caption\" color=\"text.secondary\" sx={{ mt: 0.5, display: 'block' }}>\r\n                {file.progress}%\r\n              </Typography>\r\n            </Box>\r\n          )}\r\n\r\n          {/* Error Message */}\r\n          {file.status === 'error' && file.error && (\r\n            <Alert \r\n              severity=\"error\" \r\n              sx={{ mt: 1, py: 0, '& .MuiAlert-message': { fontSize: '0.75rem' } }}\r\n              action={\r\n                <Button size=\"small\" onClick={() => onRetry(file.id)} startIcon={<IconRotateClockwise size={14} />}>\r\n                  Retry\r\n                </Button>\r\n              }\r\n            >\r\n              {file.error}\r\n            </Alert>\r\n          )}\r\n        </Box>\r\n\r\n        {/* Actions */}\r\n        <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n          <StatusBadge status={file.status} />\r\n          <IconButton \r\n            size=\"small\" \r\n            onClick={() => onRemove(file.id)}\r\n            disabled={file.status === 'uploading' || file.status === 'processing'}\r\n            sx={{ color: 'text.secondary' }}\r\n          >\r\n            <IconX size={18} />\r\n          </IconButton>\r\n        </Box>\r\n      </Box>\r\n    </Paper>\r\n  );\r\n};\r\n\r\n// Batch Progress Component\r\nconst BatchProgress: React.FC<{\r\n  total: number;\r\n  completed: number;\r\n  processing: boolean;\r\n}> = ({ total, completed, processing }) => {\r\n  const theme = useTheme();\r\n  const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;\r\n\r\n  return (\r\n    <Paper\r\n      elevation={3}\r\n      sx={{\r\n        p: 2,\r\n        bgcolor: 'background.paper',\r\n        borderRadius: 2,\r\n        border: '1px solid',\r\n        borderColor: 'divider'\r\n      }}\r\n    >\r\n      <Stack direction=\"row\" alignItems=\"center\" spacing={2}>\r\n        {processing && (\r\n          <CircularProgress size={20} sx={{ color: 'primary.main' }} />\r\n        )}\r\n        <Typography variant=\"subtitle2\" fontWeight={600}>\r\n          Batch Progress\r\n        </Typography>\r\n        <Typography variant=\"body2\" color=\"text.secondary\" sx={{ ml: 'auto' }}>\r\n          {completed} of {total}\r\n        </Typography>\r\n      </Stack>\r\n      <LinearProgress\r\n        variant=\"determinate\"\r\n        value={percentage}\r\n        sx={{\r\n          mt: 1.5,\r\n          height: 10,\r\n          borderRadius: 5,\r\n          bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n          '& .MuiLinearProgress-bar': {\r\n            borderRadius: 5,\r\n            background: `linear-gradient(90deg, ${theme.palette.primary.main} 0%, ${theme.palette.secondary.main} 100%)`\r\n          }\r\n        }}\r\n      />\r\n      <Stack direction=\"row\" justifyContent=\"space-between\" sx={{ mt: 1 }}>\r\n        <Typography variant=\"caption\" color=\"text.secondary\">\r\n          {completed} images processed\r\n        </Typography>\r\n        <Typography variant=\"caption\" color=\"primary.main\" fontWeight={600}>\r\n          {percentage}%\r\n        </Typography>\r\n      </Stack>\r\n    </Paper>\r\n  );\r\n};\r\n\r\n// Main Component\r\nconst EnhancedOCRUploader: React.FC = () => {\r\n  const theme = useTheme();\r\n  const { user, isSuperAdmin } = useAuth();\r\n  const [searchParams, setSearchParams] = useSearchParams();\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  // Helper to ensure church ID is valid\r\n  const getValidChurchId = (churchId: any): number | null => {\r\n    if (churchId === null || churchId === undefined || churchId === '') return null;\r\n    const num = typeof churchId === 'string' ? parseInt(churchId, 10) : Number(churchId);\r\n    return !isNaN(num) && num > 0 ? num : null;\r\n  };\r\n\r\n  // Get church_id from URL query params\r\n  const urlChurchId = getValidChurchId(searchParams.get('church_id'));\r\n  // Get ocr_mode from URL query params\r\n  const urlOcrMode = searchParams.get('ocr_mode');\r\n\r\n  // State\r\n  const [files, setFiles] = useState<UploadFile[]>([]);\r\n  const [churches, setChurches] = useState<Church[]>([]);\r\n  const [selectedChurchId, setSelectedChurchId] = useState<number | null>(urlChurchId);\r\n  const [isUploading, setIsUploading] = useState(false);\r\n  const [isPaused, setIsPaused] = useState(false);\r\n  const [showAdvanced, setShowAdvanced] = useState(false);\r\n  const [dragActive, setDragActive] = useState(false);\r\n  // Simulation mode state\r\n  const [simulationMode, setSimulationMode] = useState<boolean>(urlOcrMode === 'simulate');\r\n  const isSimulationModeAvailable = selectedChurchId === 46;\r\n  // @deprecated - Replaced by Workbench (but still used for backward compatibility)\r\n  const [showInspectionPanel, setShowInspectionPanel] = useState(false);\r\n  const [selectedFileId, setSelectedFileId] = useState<string | null>(null);\r\n  const [selectedJobDetail, setSelectedJobDetail] = useState<JobDetail | null>(null);\r\n  const [loadingJobDetail, setLoadingJobDetail] = useState(false);\r\n  const [showMappingTab, setShowMappingTab] = useState(false);\r\n  const [inspectionPanelInitialTab, setInspectionPanelInitialTab] = useState<number | undefined>(undefined);\r\n  // Use the OCR jobs hook for processed images table\r\n  const {\r\n    jobs: ocrJobs,\r\n    loading: loadingOcrJobs,\r\n    refresh: refreshOcrJobs,\r\n    fetchJobDetail: fetchOcrJobDetail,\r\n    updateRecordType,\r\n    retryJob,\r\n    deleteJobs,\r\n    reprocessJobs,\r\n    completedCount: ocrCompletedCount,\r\n    failedCount: ocrFailedCount\r\n  } = useOcrJobs({ churchId: selectedChurchId });\r\n  const [settings, setSettings] = useState<OCRSettings>({\r\n    engine: 'Google Vision',\r\n    dpi: 300,\r\n    confidenceThreshold: 85,\r\n    autoDetectLanguage: true,\r\n    forceGrayscale: false,\r\n    deskewImages: true,\r\n    language: 'en'\r\n  });\r\n\r\n  // Document processing settings (Phase 1)\r\n  const [docSettings, setDocSettings] = useState<DocumentProcessingSettings>(() => {\r\n    try {\r\n      const stored = sessionStorage.getItem('om.ocr.docSettings');\r\n      if (stored) return JSON.parse(stored);\r\n    } catch (e) {\r\n      console.warn('Failed to load doc settings from sessionStorage:', e);\r\n    }\r\n    return {\r\n      transcriptionMode: 'fix-spelling', // Default per spec\r\n      textExtractionScope: 'all', // Default per spec\r\n      formattingMode: 'improve-formatting', // Default per spec\r\n    };\r\n  });\r\n\r\n  // Extraction action selector\r\n  const [extractionAction, setExtractionAction] = useState<ExtractionAction>('full-text');\r\n\r\n  // Toast notifications state\r\n  const [toast, setToast] = useState<{\r\n    open: boolean;\r\n    message: string;\r\n    severity: 'success' | 'warning' | 'error' | 'info';\r\n  }>({ open: false, message: '', severity: 'info' });\r\n\r\n  // Persist doc settings to sessionStorage\r\n  useEffect(() => {\r\n    try {\r\n      sessionStorage.setItem('om.ocr.docSettings', JSON.stringify(docSettings));\r\n    } catch (e) {\r\n      console.warn('Failed to save doc settings to sessionStorage:', e);\r\n    }\r\n  }, [docSettings]);\r\n\r\n  // Toast helper\r\n  const showToast = useCallback((message: string, severity: 'success' | 'warning' | 'error' | 'info' = 'info') => {\r\n    setToast({ open: true, message, severity });\r\n  }, []);\r\n\r\n  // Sticky defaults state with localStorage persistence\r\n  const [stickyDefaults, setStickyDefaults] = useState<Record<'baptism' | 'marriage' | 'funeral', boolean>>(() => {\r\n    try {\r\n      const stored = localStorage.getItem('om.enhancedOcrUploader.stickyDefaults.v1');\r\n      if (stored) {\r\n        const parsed = JSON.parse(stored);\r\n        return {\r\n          baptism: parsed.baptism_records || false,\r\n          marriage: parsed.marriage_records || false,\r\n          funeral: parsed.funeral_records || false,\r\n        };\r\n      }\r\n    } catch (e) {\r\n      console.warn('Failed to load sticky defaults from localStorage:', e);\r\n    }\r\n    return { baptism: false, marriage: false, funeral: false };\r\n  });\r\n\r\n  // Update URL when simulation mode changes\r\n  useEffect(() => {\r\n    if (isSimulationModeAvailable) {\r\n      const newParams = new URLSearchParams(searchParams);\r\n      if (simulationMode) {\r\n        newParams.set('ocr_mode', 'simulate');\r\n      } else {\r\n        newParams.delete('ocr_mode');\r\n      }\r\n      setSearchParams(newParams, { replace: true });\r\n    }\r\n  }, [simulationMode, isSimulationModeAvailable, searchParams, setSearchParams]);\r\n\r\n  // Persist sticky defaults to localStorage\r\n  useEffect(() => {\r\n    try {\r\n      localStorage.setItem('om.enhancedOcrUploader.stickyDefaults.v1', JSON.stringify({\r\n        baptism_records: stickyDefaults.baptism,\r\n        marriage_records: stickyDefaults.marriage,\r\n        funeral_records: stickyDefaults.funeral,\r\n      }));\r\n    } catch (e) {\r\n      console.warn('Failed to save sticky defaults to localStorage:', e);\r\n    }\r\n  }, [stickyDefaults]);\r\n\r\n  // Computed values\r\n  const completedCount = files.filter(f => f.status === 'complete').length;\r\n  const failedCount = files.filter(f => f.status === 'error').length;\r\n  // Upload path: prod/uploads/om_church_##/uploaded -> queue -> processed/failed\r\n  const uploadPath = selectedChurchId \r\n    ? `/var/www/orthodoxmetrics/prod/uploads/om_church_${selectedChurchId}/uploaded/` \r\n    : '/var/www/orthodoxmetrics/prod/uploads/';\r\n\r\n  // Load churches - try /api/my/churches first, fall back to /api/churches for admins\r\n  useEffect(() => {\r\n    const loadChurches = async () => {\r\n      try {\r\n        // Step 1: Try /api/my/churches first (works for all roles including priest)\r\n        let churchList: Church[] = [];\r\n        let useMyChurches = false;\r\n\r\n        try {\r\n          // Explicitly ensure no church_id headers are sent for this endpoint\r\n          // The axios interceptor should handle this, but we'll be extra explicit\r\n          const myChurchesResponse: any = await apiClient.get('/api/my/churches');\r\n          const myChurchesData = myChurchesResponse.data;\r\n          churchList = myChurchesData?.churches || myChurchesData || [];\r\n          useMyChurches = true;\r\n          \r\n          if (churchList.length > 0) {\r\n            console.log(`✅ Loaded ${churchList.length} churches from /api/my/churches`);\r\n            setChurches(churchList);\r\n            \r\n            // Priority: URL param > user's church_id > first church\r\n            if (urlChurchId) {\r\n              setSelectedChurchId(urlChurchId);\r\n            } else if (user?.church_id) {\r\n              setSelectedChurchId(getValidChurchId(user.church_id) || churchList[0].id);\r\n            } else if (churchList.length > 0) {\r\n              setSelectedChurchId(churchList[0].id);\r\n            }\r\n            return; // Success, exit early\r\n          }\r\n        } catch (myChurchesError: any) {\r\n          // If 404 or 400, endpoint might not be implemented or invalid request - continue to fallback\r\n          const status = myChurchesError.response?.status;\r\n          if (status === 404 || status === 400) {\r\n            console.log(`⚠️ /api/my/churches returned ${status}, trying fallback`);\r\n          } else {\r\n            // Other error (500, etc.) - log but continue to fallback\r\n            console.warn('⚠️ /api/my/churches error:', status || myChurchesError.message);\r\n          }\r\n        }\r\n\r\n        // Step 2: Fall back to /api/churches for admin/manager/super_admin roles\r\n        // Only if /api/my/churches returned empty or 404\r\n        if (!useMyChurches || churchList.length === 0) {\r\n          const isAdminRole = user?.role === 'admin' || user?.role === 'manager' || user?.role === 'super_admin' || isSuperAdmin;\r\n          \r\n          if (isAdminRole) {\r\n            try {\r\n              const response: any = await apiClient.get('/api/churches');\r\n              const data = response.data;\r\n              churchList = data?.churches || data || [];\r\n              \r\n              if (churchList.length > 0) {\r\n                console.log(`✅ Loaded ${churchList.length} churches from /api/churches (admin fallback)`);\r\n                setChurches(churchList);\r\n                \r\n                // Priority: URL param > user's church_id > first church\r\n                if (urlChurchId) {\r\n                  setSelectedChurchId(urlChurchId);\r\n                } else if (user?.church_id) {\r\n                  setSelectedChurchId(getValidChurchId(user.church_id) || churchList[0].id);\r\n                } else if (churchList.length > 0) {\r\n                  setSelectedChurchId(churchList[0].id);\r\n                }\r\n                return; // Success\r\n              }\r\n            } catch (churchesError: any) {\r\n              // If 403, user doesn't have access - try to use user's church_id\r\n              if (churchesError.response?.status === 403) {\r\n                console.warn('⚠️ /api/churches returned 403, using user church_id');\r\n                \r\n                // Priority: URL param > user's church_id\r\n                const fallbackChurchId = urlChurchId || getValidChurchId(user?.church_id);\r\n                if (fallbackChurchId) {\r\n                  // Create a minimal church object from church_id\r\n                  // The OCR endpoints will work with just the church_id\r\n                  setChurches([{\r\n                    id: fallbackChurchId,\r\n                    name: `Church ${fallbackChurchId}`,\r\n                    database_name: `om_church_${fallbackChurchId}`\r\n                  }]);\r\n                  setSelectedChurchId(fallbackChurchId);\r\n                  return;\r\n                }\r\n              }\r\n              // Re-throw other errors\r\n              throw churchesError;\r\n            }\r\n          }\r\n        }\r\n\r\n        // Step 3: If still no churches, use URL param or user's church_id\r\n        const fallbackChurchId = urlChurchId || getValidChurchId(user?.church_id);\r\n        if (churchList.length === 0 && fallbackChurchId) {\r\n          console.log(`⚠️ No churches loaded, using church_id: ${fallbackChurchId}`);\r\n          setChurches([{\r\n            id: fallbackChurchId,\r\n            name: `Church ${fallbackChurchId}`,\r\n            database_name: `om_church_${fallbackChurchId}`\r\n          }]);\r\n          setSelectedChurchId(fallbackChurchId);\r\n          return;\r\n        }\r\n\r\n        // Step 4: No churches found and no user church_id\r\n        if (churchList.length === 0) {\r\n          console.error('❌ No churches available for user');\r\n          setChurches([]);\r\n        }\r\n\r\n      } catch (error: any) {\r\n        console.error('❌ Failed to load churches:', error);\r\n        \r\n        // Last resort: use URL param or user's church_id\r\n        const fallbackChurchId = urlChurchId || getValidChurchId(user?.church_id);\r\n        if (fallbackChurchId) {\r\n          console.log(`⚠️ Using church_id as fallback: ${fallbackChurchId}`);\r\n          setChurches([{\r\n            id: fallbackChurchId,\r\n            name: `Church ${fallbackChurchId}`,\r\n            database_name: `om_church_${fallbackChurchId}`\r\n          }]);\r\n          setSelectedChurchId(fallbackChurchId);\r\n        } else {\r\n          setChurches([]);\r\n        }\r\n      }\r\n    };\r\n\r\n    loadChurches();\r\n  }, [user, isSuperAdmin, urlChurchId]);\r\n\r\n  // Handle selecting a job to view in the inspector (from ProcessedImagesTable)\r\n  const handleInspectJob = useCallback(async (job: OCRJobRow) => {\r\n    if (!selectedChurchId || job.status !== 'completed') return;\r\n    \r\n    setSelectedFileId(String(job.id));\r\n    setShowInspectionPanel(true);\r\n    setLoadingJobDetail(true);\r\n    setShowMappingTab(false);\r\n    setSelectedJobDetail(null);\r\n\r\n    const detail = await fetchOcrJobDetail(job.id);\r\n    if (detail) {\r\n      // Convert to JobDetail format for InspectionPanel\r\n      setSelectedJobDetail({\r\n        id: String(detail.id),\r\n        original_filename: detail.original_filename,\r\n        filename: detail.filename,\r\n        file_path: detail.file_path,\r\n        status: detail.status,\r\n        record_type: detail.record_type,\r\n        language: detail.language,\r\n        confidence_score: detail.confidence_score,\r\n        created_at: detail.created_at,\r\n        updated_at: detail.updated_at,\r\n        ocr_text: detail.ocr_text,\r\n        ocr_result: detail.ocr_result,\r\n        mapping: detail.mapping\r\n      } as any);\r\n    }\r\n    setLoadingJobDetail(false);\r\n  }, [selectedChurchId, fetchOcrJobDetail]);\r\n\r\n  // Handle file selection\r\n  const handleFiles = useCallback((fileList: FileList | null) => {\r\n    if (!fileList) return;\r\n\r\n    const validTypes = ['image/jpeg', 'image/png', 'image/tiff'];\r\n    const maxSize = 10 * 1024 * 1024; // 10MB\r\n    const maxFiles = 50;\r\n\r\n    const newFiles: UploadFile[] = [];\r\n\r\n    Array.from(fileList).slice(0, maxFiles - files.length).forEach(file => {\r\n      if (!validTypes.includes(file.type)) {\r\n        console.warn(`Invalid file type: ${file.name}`);\r\n        return;\r\n      }\r\n      if (file.size > maxSize) {\r\n        console.warn(`File too large: ${file.name}`);\r\n        return;\r\n      }\r\n\r\n      // Create thumbnail\r\n      const reader = new FileReader();\r\n      const uploadFile: UploadFile = {\r\n        id: generateId(),\r\n        file,\r\n        name: file.name,\r\n        size: file.size,\r\n        recordType: 'baptism',\r\n        status: 'queued',\r\n        progress: 0\r\n      };\r\n\r\n      reader.onload = (e) => {\r\n        setFiles(prev => prev.map(f => \r\n          f.id === uploadFile.id ? { ...f, thumbnail: e.target?.result as string } : f\r\n        ));\r\n      };\r\n      reader.readAsDataURL(file);\r\n\r\n      newFiles.push(uploadFile);\r\n    });\r\n\r\n    setFiles(prev => [...prev, ...newFiles]);\r\n  }, [files.length]);\r\n\r\n  // Load demo images function (must be after handleFiles)\r\n  const handleLoadDemoImages = useCallback(async () => {\r\n    const demoFiles = [\r\n      'IMG_2025_03_05_10_44_50S.jpg',\r\n      'IMG_2024_10_25_12_32_04S.jpg',\r\n      'IMG_2025_03_05_11_04_55S.jpg',\r\n      'IMG_2024_10_22_11_27_57S.jpg',\r\n      'IMG_2024_10_22_11_29_28S.jpg',\r\n      'IMG_2024_10_25_12_28_25S.jpg',\r\n      'IMG_2024_10_22_11_39_09S.jpg',\r\n      'IMG_2025_03_12_12_48_44S.jpg',\r\n    ];\r\n\r\n    try {\r\n      const loadedFiles: File[] = [];\r\n      \r\n      for (const filename of demoFiles) {\r\n        try {\r\n          const response = await fetch(`/images/misc/demo/${filename}`);\r\n          if (!response.ok) {\r\n            console.warn(`Failed to load demo image: ${filename}`);\r\n            continue;\r\n          }\r\n          const blob = await response.blob();\r\n          const file = new File([blob], filename, { type: blob.type || 'image/jpeg' });\r\n          loadedFiles.push(file);\r\n        } catch (error) {\r\n          console.error(`Error loading demo image ${filename}:`, error);\r\n        }\r\n      }\r\n\r\n      if (loadedFiles.length > 0) {\r\n        // Create a FileList-like object\r\n        const dataTransfer = new DataTransfer();\r\n        loadedFiles.forEach(file => dataTransfer.items.add(file));\r\n        handleFiles(dataTransfer.files);\r\n        showToast(`Loaded ${loadedFiles.length} demo images`, 'success');\r\n      } else {\r\n        showToast('Failed to load demo images', 'error');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading demo images:', error);\r\n      showToast('Error loading demo images', 'error');\r\n    }\r\n  }, [handleFiles, showToast]);\r\n\r\n  // Drag and drop handlers\r\n  const handleDrag = useCallback((e: React.DragEvent) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    if (e.type === 'dragenter' || e.type === 'dragover') {\r\n      setDragActive(true);\r\n    } else if (e.type === 'dragleave') {\r\n      setDragActive(false);\r\n    }\r\n  }, []);\r\n\r\n  const handleDrop = useCallback((e: React.DragEvent) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    setDragActive(false);\r\n    handleFiles(e.dataTransfer.files);\r\n  }, [handleFiles]);\r\n\r\n  // Upload files\r\n  const startUpload = useCallback(async () => {\r\n    if (!selectedChurchId || files.length === 0) return;\r\n\r\n    setIsUploading(true);\r\n    setIsPaused(false);\r\n\r\n    const queuedFiles = files.filter(f => f.status === 'queued' || f.status === 'error');\r\n    \r\n    // Show OCR start toast\r\n    if (queuedFiles.length > 0) {\r\n      showToast('Extracting text...', 'info');\r\n    }\r\n\r\n    for (const uploadFile of queuedFiles) {\r\n      if (isPaused) break;\r\n\r\n      // Update status to uploading\r\n      setFiles(prev => prev.map(f => \r\n        f.id === uploadFile.id ? { ...f, status: 'uploading', progress: 0 } : f\r\n      ));\r\n\r\n      try {\r\n        const formData = new FormData();\r\n        formData.append('files', uploadFile.file);\r\n        formData.append('churchId', selectedChurchId.toString());\r\n        // Send recordType - backend should store this as record_type in ocr_jobs table\r\n        formData.append('recordType', uploadFile.recordType);\r\n        formData.append('language', settings.language);\r\n        formData.append('settings', JSON.stringify({\r\n          autoDetectLanguage: settings.autoDetectLanguage,\r\n          forceGrayscale: settings.forceGrayscale,\r\n          deskewImages: settings.deskewImages,\r\n          dpi: settings.dpi\r\n        }));\r\n\r\n        // Add simulation mode if enabled\r\n        if (simulationMode && isSimulationModeAvailable) {\r\n          formData.append('ocr_mode', 'simulate');\r\n        }\r\n\r\n        // Simulate progress (real implementation would use XMLHttpRequest for progress)\r\n        const progressInterval = setInterval(() => {\r\n          setFiles(prev => prev.map(f => {\r\n            if (f.id === uploadFile.id && f.progress < 90) {\r\n              return { ...f, progress: f.progress + 10 };\r\n            }\r\n            return f;\r\n          }));\r\n        }, 200);\r\n\r\n        // Use different endpoint for simulation mode\r\n        const endpoint = (simulationMode && isSimulationModeAvailable)\r\n          ? `/api/church/${selectedChurchId}/ocr/enhanced/process?ocr_mode=simulate`\r\n          : '/api/ocr/jobs/upload';\r\n        \r\n        const response: any = await apiClient.post(endpoint, formData);\r\n\r\n        clearInterval(progressInterval);\r\n\r\n        // Extract jobId from response\r\n        const jobs = response.data?.jobs || response.jobs || [];\r\n        const jobId = jobs.length > 0 ? jobs[0].id : undefined;\r\n        \r\n        // Check if this was a simulation response\r\n        const isSimulation = response.data?.source === 'simulation' || jobs[0]?.source === 'simulation';\r\n        \r\n        // Show appropriate message for unmatched simulation files\r\n        if (simulationMode && isSimulationModeAvailable && !isSimulation && jobs.length === 0) {\r\n          showToast('No simulation data for this file', 'warning');\r\n        }\r\n\r\n        // Update to processing then complete\r\n        setFiles(prev => prev.map(f => \r\n          f.id === uploadFile.id ? { ...f, status: 'processing', progress: 95, jobId } : f\r\n        ));\r\n\r\n        await new Promise(resolve => setTimeout(resolve, 500));\r\n\r\n        setFiles(prev => prev.map(f => \r\n          f.id === uploadFile.id ? { \r\n            ...f, \r\n            status: 'complete', \r\n            progress: 100, \r\n            jobId,\r\n            isSimulation: isSimulation || false\r\n          } : f\r\n        ));\r\n\r\n        // Refresh the processed images table to show new job\r\n        refreshOcrJobs();\r\n        \r\n        // Show success toast with simulation indicator\r\n        if (simulationMode && isSimulationModeAvailable && response.data?.source === 'simulation') {\r\n          showToast('Loaded verified demo OCR results', 'success');\r\n        } else {\r\n          showToast('OCR completed', 'success');\r\n        }\r\n\r\n      } catch (error: any) {\r\n        setFiles(prev => prev.map(f => \r\n          f.id === uploadFile.id ? { \r\n            ...f, \r\n            status: 'error', \r\n            progress: 0,\r\n            error: error.message || 'Upload failed'\r\n          } : f\r\n        ));\r\n        \r\n        // Show error toast (matches spec: \"OCR processing failed\" with reason)\r\n        const errorMessage = error.message || 'Unknown error';\r\n        showToast(`OCR processing failed: ${errorMessage}`, 'error');\r\n      }\r\n    }\r\n\r\n    setIsUploading(false);\r\n    // Final refresh to ensure all jobs are shown\r\n    refreshOcrJobs();\r\n  }, [files, selectedChurchId, settings, isPaused, refreshOcrJobs]);\r\n\r\n  // Other handlers\r\n  const handleRecordTypeChange = useCallback((id: string, type: 'baptism' | 'marriage' | 'funeral') => {\r\n    setFiles(prev => prev.map(f => f.id === id ? { ...f, recordType: type } : f));\r\n  }, []);\r\n\r\n  const handleRemoveFile = useCallback((id: string) => {\r\n    setFiles(prev => prev.filter(f => f.id !== id));\r\n  }, []);\r\n\r\n  const handleRetryFile = useCallback((id: string) => {\r\n    setFiles(prev => prev.map(f => f.id === id ? { ...f, status: 'queued', progress: 0, error: undefined } : f));\r\n  }, []);\r\n\r\n  const handleClearAll = useCallback(() => {\r\n    setFiles([]);\r\n    setSelectedFileId(null);\r\n    setSelectedJobDetail(null);\r\n    setShowInspectionPanel(false);\r\n  }, []);\r\n\r\n  // Handle selecting a completed file to view its OCR results\r\n  const handleSelectFile = useCallback(async (fileId: string) => {\r\n    const file = files.find(f => f.id === fileId);\r\n    if (!file || file.status !== 'complete' || !file.jobId || !selectedChurchId) {\r\n      return;\r\n    }\r\n\r\n    setSelectedFileId(fileId);\r\n    setShowInspectionPanel(true);\r\n    setLoadingJobDetail(true);\r\n\r\n    try {\r\n      const response: any = await apiClient.get(`/api/ocr/jobs/${file.jobId}?churchId=${selectedChurchId}`);\r\n      setSelectedJobDetail(response.data);\r\n    } catch (error) {\r\n      console.error('Failed to fetch job detail:', error);\r\n      setSelectedJobDetail(null);\r\n    } finally {\r\n      setLoadingJobDetail(false);\r\n    }\r\n  }, [files, selectedChurchId]);\r\n\r\n  // @deprecated - Image URLs now handled by Workbench\r\n  // Removed getImageUrl - WorkbenchViewer handles image URLs via WorkbenchContext\r\n\r\n  const selectedChurch = churches.find(c => c.id === selectedChurchId);\r\n\r\n  return (\r\n    <OcrSetupGate>\r\n      <OcrSelectionProvider>\r\n        <Box sx={{ \r\n        minHeight: '100vh', \r\n        bgcolor: 'background.default',\r\n        pb: 4\r\n    }}>\r\n      {/* Header */}\r\n      <Paper \r\n        elevation={0} \r\n        sx={{ \r\n          borderBottom: '1px solid',\r\n          borderColor: 'divider',\r\n          bgcolor: 'background.paper',\r\n          mb: 3\r\n        }}\r\n      >\r\n        <Box sx={{ maxWidth: 1200, mx: 'auto', px: 3, py: 3 }}>\r\n          <Stack direction=\"row\" justifyContent=\"space-between\" alignItems=\"flex-start\" flexWrap=\"wrap\" gap={2}>\r\n            <Box>\r\n              <Typography variant=\"h4\" fontWeight={700} color=\"text.primary\">\r\n                OCR Record Uploader\r\n              </Typography>\r\n              <Typography variant=\"body2\" color=\"text.secondary\" sx={{ mt: 0.5 }}>\r\n                Upload, organize, and process church record images with OCR.\r\n              </Typography>\r\n            </Box>\r\n            \r\n            {/* Info Badges */}\r\n            <Stack direction=\"row\" spacing={1}>\r\n              <Chip \r\n                icon={<IconSettings size={14} />} \r\n                label={settings.engine} \r\n                variant=\"outlined\" \r\n                size=\"small\"\r\n                sx={{ fontWeight: 500 }}\r\n              />\r\n              <Chip \r\n                label={`${settings.dpi} DPI`} \r\n                variant=\"outlined\" \r\n                size=\"small\"\r\n                sx={{ fontWeight: 500 }}\r\n              />\r\n              <Chip \r\n                label={`${settings.confidenceThreshold}% Confidence`} \r\n                variant=\"outlined\" \r\n                size=\"small\"\r\n                sx={{ fontWeight: 500 }}\r\n              />\r\n            </Stack>\r\n          </Stack>\r\n        </Box>\r\n      </Paper>\r\n\r\n      <Box sx={{ maxWidth: 1200, mx: 'auto', px: 3 }}>\r\n        {/* Settings Section */}\r\n        <Paper\r\n          elevation={0}\r\n          sx={{\r\n            mb: 3,\r\n            borderRadius: 2,\r\n            border: '1px solid',\r\n            borderColor: 'divider',\r\n            overflow: 'hidden',\r\n          }}\r\n        >\r\n          <Box\r\n            sx={{\r\n              p: 2,\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              cursor: 'pointer',\r\n              '&:hover': { bgcolor: 'action.hover' }\r\n            }}\r\n            onClick={() => setShowAdvanced(!showAdvanced)}\r\n          >\r\n            <IconSettings size={20} style={{ marginRight: 12 }} />\r\n            <Typography variant=\"subtitle1\" fontWeight={600}>\r\n              Settings\r\n            </Typography>\r\n            <Box sx={{ ml: 'auto' }}>\r\n              {showAdvanced ? <IconChevronUp size={20} /> : <IconChevronDown size={20} />}\r\n            </Box>\r\n          </Box>\r\n          \r\n          <Collapse in={showAdvanced}>\r\n            <Divider />\r\n            <Box sx={{ p: 3 }}>\r\n              {/* Document Processing Settings */}\r\n              <Box sx={{ mb: 3 }}>\r\n                <Stack direction=\"row\" spacing={1} alignItems=\"center\" sx={{ mb: 2 }}>\r\n                  <Typography variant=\"subtitle2\" fontWeight={600}>\r\n                    Document processing\r\n                  </Typography>\r\n                  <Chip label=\"Customize AI\" size=\"small\" color=\"primary\" variant=\"outlined\" />\r\n                  <Chip label=\"Experimental\" size=\"small\" color=\"warning\" variant=\"outlined\" />\r\n                </Stack>\r\n                \r\n                <Stack spacing={2.5}>\r\n                  <FormControl fullWidth>\r\n                    <FormLabel sx={{ mb: 1, fontWeight: 500 }}>Transcription mode</FormLabel>\r\n                    <Select\r\n                      value={docSettings.transcriptionMode}\r\n                      onChange={(e) => {\r\n                        setDocSettings(s => ({ ...s, transcriptionMode: e.target.value as any }));\r\n                        showToast('Settings saved', 'success');\r\n                      }}\r\n                      size=\"small\"\r\n                    >\r\n                      <MenuItem value=\"exact\">Transcribe exactly as written</MenuItem>\r\n                      <MenuItem value=\"fix-spelling\">Fix spelling mistakes</MenuItem>\r\n                    </Select>\r\n                  </FormControl>\r\n\r\n                  <FormControl fullWidth>\r\n                    <FormLabel sx={{ mb: 1, fontWeight: 500 }}>Text extraction scope</FormLabel>\r\n                    <Select\r\n                      value={docSettings.textExtractionScope}\r\n                      onChange={(e) => {\r\n                        setDocSettings(s => ({ ...s, textExtractionScope: e.target.value as any }));\r\n                        if (e.target.value === 'handwritten-only') {\r\n                          showToast('Handwritten-only not supported for this engine yet.', 'warning');\r\n                        } else {\r\n                          showToast('Settings saved', 'success');\r\n                        }\r\n                      }}\r\n                      size=\"small\"\r\n                    >\r\n                      <MenuItem value=\"all\">Extract all text</MenuItem>\r\n                      <MenuItem value=\"handwritten-only\">Extract handwritten text only</MenuItem>\r\n                    </Select>\r\n                  </FormControl>\r\n\r\n                  <FormControl fullWidth>\r\n                    <FormLabel sx={{ mb: 1, fontWeight: 500 }}>Formatting mode</FormLabel>\r\n                    <Select\r\n                      value={docSettings.formattingMode}\r\n                      onChange={(e) => {\r\n                        setDocSettings(s => ({ ...s, formattingMode: e.target.value as any }));\r\n                        showToast('Settings saved', 'success');\r\n                      }}\r\n                      size=\"small\"\r\n                    >\r\n                      <MenuItem value=\"improve-formatting\">Improving formatting for better readability</MenuItem>\r\n                    </Select>\r\n                  </FormControl>\r\n                </Stack>\r\n              </Box>\r\n\r\n              <Divider sx={{ my: 3 }} />\r\n\r\n              {/* Action Selector */}\r\n              <Box>\r\n                <Typography variant=\"subtitle2\" fontWeight={600} sx={{ mb: 2 }}>\r\n                  Choose an action\r\n                </Typography>\r\n                <RadioGroup\r\n                  value={extractionAction}\r\n                  onChange={(e) => setExtractionAction(e.target.value as ExtractionAction)}\r\n                >\r\n                  <FormControlLabel\r\n                    value=\"full-text\"\r\n                    control={<Radio />}\r\n                    label={\r\n                      <Box>\r\n                        <Typography variant=\"body2\" fontWeight={500}>\r\n                          Extract Full Text\r\n                        </Typography>\r\n                        <Typography variant=\"caption\" color=\"text.secondary\">\r\n                          Extract all text from the document\r\n                        </Typography>\r\n                      </Box>\r\n                    }\r\n                  />\r\n                  <FormControlLabel\r\n                    value=\"tables\"\r\n                    control={<Radio disabled />}\r\n                    label={\r\n                      <Box>\r\n                        <Typography variant=\"body2\" fontWeight={500} color=\"text.disabled\">\r\n                          Extract Tables\r\n                        </Typography>\r\n                        <Typography variant=\"caption\" color=\"text.secondary\">\r\n                          Coming soon\r\n                        </Typography>\r\n                      </Box>\r\n                    }\r\n                  />\r\n                  <FormControlLabel\r\n                    value=\"custom-data\"\r\n                    control={<Radio disabled />}\r\n                    label={\r\n                      <Box>\r\n                        <Typography variant=\"body2\" fontWeight={500} color=\"text.disabled\">\r\n                          Extract Custom Data\r\n                        </Typography>\r\n                        <Typography variant=\"caption\" color=\"text.secondary\">\r\n                          Coming soon\r\n                        </Typography>\r\n                      </Box>\r\n                    }\r\n                  />\r\n                </RadioGroup>\r\n              </Box>\r\n            </Box>\r\n          </Collapse>\r\n        </Paper>\r\n\r\n        {/* SuperAdmin Church Selector */}\r\n        {isSuperAdmin() && (\r\n          <Paper \r\n            elevation={0}\r\n            sx={{ \r\n              p: 3, \r\n              mb: 3, \r\n              borderRadius: 2,\r\n              bgcolor: alpha(theme.palette.warning.main, 0.03),\r\n              border: '2px dashed',\r\n              borderColor: alpha(theme.palette.warning.main, 0.3)\r\n            }}\r\n          >\r\n            <Stack direction=\"row\" alignItems=\"center\" spacing={2}>\r\n              <Box\r\n                sx={{\r\n                  p: 1.5,\r\n                  borderRadius: 2,\r\n                  bgcolor: alpha(theme.palette.warning.main, 0.1),\r\n                  color: 'warning.main'\r\n                }}\r\n              >\r\n                <IconDatabase size={28} />\r\n              </Box>\r\n              <Box sx={{ flex: 1 }}>\r\n                <Stack direction=\"row\" alignItems=\"center\" spacing={1}>\r\n                  <Typography variant=\"subtitle1\" fontWeight={600}>\r\n                    Target Church Database\r\n                  </Typography>\r\n                  <Tooltip title=\"Changes affect live production data\" arrow>\r\n                    <IconAlertTriangle size={18} color={theme.palette.warning.main} />\r\n                  </Tooltip>\r\n                </Stack>\r\n                <Typography variant=\"caption\" color=\"text.secondary\">\r\n                  Select the church database where OCR results will be stored.\r\n                </Typography>\r\n              </Box>\r\n              <FormControl sx={{ minWidth: 300 }}>\r\n                <Select\r\n                  value={selectedChurchId || ''}\r\n                  onChange={(e) => setSelectedChurchId(Number(e.target.value))}\r\n                  displayEmpty\r\n                  sx={{ \r\n                    bgcolor: 'background.paper',\r\n                    '& .MuiSelect-select': { py: 1.5 }\r\n                  }}\r\n                >\r\n                  {churches.map(church => (\r\n                    <MenuItem key={church.id} value={church.id}>\r\n                      {church.name} - Church {church.id}\r\n                    </MenuItem>\r\n                  ))}\r\n                </Select>\r\n              </FormControl>\r\n            </Stack>\r\n          </Paper>\r\n        )}\r\n\r\n        {/* Drop Zone */}\r\n        <Paper\r\n          elevation={0}\r\n          sx={{\r\n            p: 4,\r\n            mb: 3,\r\n            borderRadius: 3,\r\n            border: '2px dashed',\r\n            borderColor: dragActive ? 'primary.main' : alpha(theme.palette.primary.main, 0.3),\r\n            bgcolor: dragActive ? alpha(theme.palette.primary.main, 0.05) : alpha(theme.palette.primary.main, 0.02),\r\n            textAlign: 'center',\r\n            cursor: 'pointer',\r\n            transition: 'all 0.3s ease',\r\n            '&:hover': {\r\n              borderColor: 'primary.main',\r\n              bgcolor: alpha(theme.palette.primary.main, 0.05)\r\n            }\r\n          }}\r\n          onDragEnter={handleDrag}\r\n          onDragLeave={handleDrag}\r\n          onDragOver={handleDrag}\r\n          onDrop={handleDrop}\r\n          onClick={() => fileInputRef.current?.click()}\r\n        >\r\n          <input\r\n            ref={fileInputRef}\r\n            type=\"file\"\r\n            multiple\r\n            accept=\".jpg,.jpeg,.png,.tiff\"\r\n            onChange={(e) => handleFiles(e.target.files)}\r\n            style={{ display: 'none' }}\r\n          />\r\n          \r\n          <Box\r\n            sx={{\r\n              width: 80,\r\n              height: 80,\r\n              mx: 'auto',\r\n              mb: 2,\r\n              borderRadius: '50%',\r\n              bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              justifyContent: 'center'\r\n            }}\r\n          >\r\n            <IconPhoto size={40} color={theme.palette.primary.main} />\r\n          </Box>\r\n          \r\n          <Typography variant=\"h6\" fontWeight={600} color=\"text.primary\">\r\n            Drag & drop record images here\r\n          </Typography>\r\n          <Typography variant=\"body2\" color=\"text.secondary\" sx={{ mt: 0.5 }}>\r\n            or click to browse files\r\n          </Typography>\r\n          \r\n          <Stack \r\n            direction=\"row\" \r\n            spacing={2} \r\n            justifyContent=\"center\" \r\n            sx={{ mt: 2 }}\r\n          >\r\n            <Chip label=\"• JPG\" size=\"small\" variant=\"outlined\" />\r\n            <Chip label=\"• PNG\" size=\"small\" variant=\"outlined\" />\r\n            <Chip label=\"• TIFF\" size=\"small\" variant=\"outlined\" />\r\n          </Stack>\r\n          \r\n          <Typography variant=\"caption\" color=\"text.secondary\" sx={{ mt: 1, display: 'block' }}>\r\n            Max 50 files per batch • 10MB per file\r\n          </Typography>\r\n          \r\n          {/* Demo Images and Simulation Mode (only for church 46) */}\r\n          {isSimulationModeAvailable && (\r\n            <Box sx={{ mt: 2, display: 'flex', gap: 2, justifyContent: 'center', flexWrap: 'wrap' }}>\r\n              <Button\r\n                variant=\"outlined\"\r\n                color=\"primary\"\r\n                startIcon={<IconPhoto />}\r\n                onClick={handleLoadDemoImages}\r\n                disabled={isUploading}\r\n                sx={{ mt: 1 }}\r\n              >\r\n                Load Demo Images\r\n              </Button>\r\n              <FormControlLabel\r\n                control={\r\n                  <Switch\r\n                    checked={simulationMode}\r\n                    onChange={(e) => setSimulationMode(e.target.checked)}\r\n                    disabled={isUploading}\r\n                  />\r\n                }\r\n                label={\r\n                  <Box>\r\n                    <Typography variant=\"body2\" fontWeight={500}>\r\n                      Simulation Mode\r\n                    </Typography>\r\n                    <Typography variant=\"caption\" color=\"text.secondary\">\r\n                      Use pre-validated demo OCR results\r\n                    </Typography>\r\n                  </Box>\r\n                }\r\n                sx={{ mt: 1 }}\r\n              />\r\n            </Box>\r\n          )}\r\n        </Paper>\r\n\r\n        {/* Advanced Options */}\r\n        <Paper elevation={0} sx={{ mb: 3, borderRadius: 2, border: '1px solid', borderColor: 'divider' }}>\r\n          <Box\r\n            sx={{ \r\n              p: 2, \r\n              display: 'flex', \r\n              alignItems: 'center', \r\n              cursor: 'pointer',\r\n              '&:hover': { bgcolor: 'action.hover' }\r\n            }}\r\n            onClick={() => setShowAdvanced(!showAdvanced)}\r\n          >\r\n            <IconSettings size={20} style={{ marginRight: 12 }} />\r\n            <Typography variant=\"subtitle1\" fontWeight={600}>\r\n              Advanced Options\r\n            </Typography>\r\n            <Box sx={{ ml: 'auto' }}>\r\n              {showAdvanced ? <IconChevronUp size={20} /> : <IconChevronDown size={20} />}\r\n            </Box>\r\n          </Box>\r\n          \r\n          <Collapse in={showAdvanced}>\r\n            <Divider />\r\n            <Box sx={{ p: 3 }}>\r\n              <Stack spacing={3}>\r\n                <FormControlLabel\r\n                  control={\r\n                    <Switch \r\n                      checked={settings.autoDetectLanguage}\r\n                      onChange={(e) => setSettings(s => ({ ...s, autoDetectLanguage: e.target.checked }))}\r\n                    />\r\n                  }\r\n                  label={\r\n                    <Box>\r\n                      <Typography variant=\"body2\" fontWeight={500}>Auto-detect Language</Typography>\r\n                      <Typography variant=\"caption\" color=\"text.secondary\">\r\n                        Automatically detect the language in record images\r\n                      </Typography>\r\n                    </Box>\r\n                  }\r\n                />\r\n                \r\n                <FormControlLabel\r\n                  control={\r\n                    <Switch \r\n                      checked={settings.forceGrayscale}\r\n                      onChange={(e) => setSettings(s => ({ ...s, forceGrayscale: e.target.checked }))}\r\n                    />\r\n                  }\r\n                  label={\r\n                    <Box>\r\n                      <Typography variant=\"body2\" fontWeight={500}>Force Grayscale Preprocessing</Typography>\r\n                      <Typography variant=\"caption\" color=\"text.secondary\">\r\n                        Convert images to grayscale before OCR processing\r\n                      </Typography>\r\n                    </Box>\r\n                  }\r\n                />\r\n                \r\n                <FormControlLabel\r\n                  control={\r\n                    <Switch \r\n                      checked={settings.deskewImages}\r\n                      onChange={(e) => setSettings(s => ({ ...s, deskewImages: e.target.checked }))}\r\n                    />\r\n                  }\r\n                  label={\r\n                    <Box>\r\n                      <Typography variant=\"body2\" fontWeight={500}>Deskew Images Before OCR</Typography>\r\n                      <Typography variant=\"caption\" color=\"text.secondary\">\r\n                        Automatically correct skewed or rotated images\r\n                      </Typography>\r\n                    </Box>\r\n                  }\r\n                />\r\n                \r\n                <Box>\r\n                  <Typography variant=\"body2\" fontWeight={500} sx={{ mb: 1 }}>OCR Language</Typography>\r\n                  <FormControl sx={{ minWidth: 200 }}>\r\n                    <Select\r\n                      value={settings.language}\r\n                      onChange={(e) => setSettings(s => ({ ...s, language: e.target.value }))}\r\n                      size=\"small\"\r\n                    >\r\n                      <MenuItem value=\"en\">English</MenuItem>\r\n                      <MenuItem value=\"el\">Greek</MenuItem>\r\n                      <MenuItem value=\"ru\">Russian</MenuItem>\r\n                      <MenuItem value=\"ro\">Romanian</MenuItem>\r\n                      <MenuItem value=\"sr\">Serbian</MenuItem>\r\n                      <MenuItem value=\"bg\">Bulgarian</MenuItem>\r\n                    </Select>\r\n                  </FormControl>\r\n                  <Typography variant=\"caption\" color=\"text.secondary\" sx={{ mt: 0.5, display: 'block' }}>\r\n                    Default language from church settings\r\n                  </Typography>\r\n                </Box>\r\n                \r\n                <Box>\r\n                  <Typography variant=\"body2\" fontWeight={500} sx={{ mb: 1 }}>Upload Directory</Typography>\r\n                  <Paper \r\n                    variant=\"outlined\" \r\n                    sx={{ \r\n                      p: 1.5, \r\n                      bgcolor: 'background.paper', \r\n                      fontFamily: 'monospace',\r\n                      fontSize: '0.875rem'\r\n                    }}\r\n                  >\r\n                    {uploadPath}\r\n                  </Paper>\r\n                  <Typography variant=\"caption\" color=\"text.secondary\" sx={{ mt: 0.5, display: 'block' }}>\r\n                    Server path where images will be stored\r\n                  </Typography>\r\n                </Box>\r\n\r\n                <Divider sx={{ my: 2 }} />\r\n\r\n                {/* Sticky Defaults Section */}\r\n                <Box>\r\n                  <Typography variant=\"body2\" fontWeight={600} sx={{ mb: 2 }}>\r\n                    Sticky Default Fields\r\n                  </Typography>\r\n                  <Typography variant=\"caption\" color=\"text.secondary\" sx={{ mb: 2, display: 'block' }}>\r\n                    Restrict field mapping to default database columns for each record type\r\n                  </Typography>\r\n                  \r\n                  <Stack spacing={2}>\r\n                    {/* Baptism Records */}\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5 }}>\r\n                      <RecordSchemaInfoPopover\r\n                        title=\"baptism_records\"\r\n                        imageSrc=\"/images/schema-previews/baptism_records.png\"\r\n                      />\r\n                      <Typography variant=\"body2\" sx={{ flex: 1 }}>\r\n                        baptism_records\r\n                      </Typography>\r\n                      <FormControlLabel\r\n                        control={\r\n                          <Switch\r\n                            checked={stickyDefaults.baptism}\r\n                            onChange={(e) => setStickyDefaults(prev => ({ ...prev, baptism: e.target.checked }))}\r\n                            size=\"small\"\r\n                          />\r\n                        }\r\n                        label=\"Sticky Defaults\"\r\n                        labelPlacement=\"end\"\r\n                      />\r\n                    </Box>\r\n\r\n                    {/* Marriage Records */}\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5 }}>\r\n                      <RecordSchemaInfoPopover\r\n                        title=\"marriage_records\"\r\n                        imageSrc=\"/images/schema-previews/marriage_records.png\"\r\n                      />\r\n                      <Typography variant=\"body2\" sx={{ flex: 1 }}>\r\n                        marriage_records\r\n                      </Typography>\r\n                      <FormControlLabel\r\n                        control={\r\n                          <Switch\r\n                            checked={stickyDefaults.marriage}\r\n                            onChange={(e) => setStickyDefaults(prev => ({ ...prev, marriage: e.target.checked }))}\r\n                            size=\"small\"\r\n                          />\r\n                        }\r\n                        label=\"Sticky Defaults\"\r\n                        labelPlacement=\"end\"\r\n                      />\r\n                    </Box>\r\n\r\n                    {/* Funeral Records */}\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5 }}>\r\n                      <RecordSchemaInfoPopover\r\n                        title=\"funeral_records\"\r\n                        imageSrc=\"/images/schema-previews/funeral_records.png\"\r\n                      />\r\n                      <Typography variant=\"body2\" sx={{ flex: 1 }}>\r\n                        funeral_records\r\n                      </Typography>\r\n                      <FormControlLabel\r\n                        control={\r\n                          <Switch\r\n                            checked={stickyDefaults.funeral}\r\n                            onChange={(e) => setStickyDefaults(prev => ({ ...prev, funeral: e.target.checked }))}\r\n                            size=\"small\"\r\n                          />\r\n                        }\r\n                        label=\"Sticky Defaults\"\r\n                        labelPlacement=\"end\"\r\n                      />\r\n                    </Box>\r\n                  </Stack>\r\n                </Box>\r\n              </Stack>\r\n            </Box>\r\n          </Collapse>\r\n        </Paper>\r\n\r\n        {/* Upload Controls */}\r\n        {files.length > 0 && (\r\n          <>\r\n            <Paper \r\n              elevation={0} \r\n              sx={{ \r\n                p: 2, \r\n                mb: 3, \r\n                borderRadius: 2, \r\n                border: '1px solid', \r\n                borderColor: 'divider',\r\n                bgcolor: 'background.paper'\r\n              }}\r\n            >\r\n              <Stack direction=\"row\" spacing={2} alignItems=\"center\" flexWrap=\"wrap\">\r\n                {simulationMode && isSimulationModeAvailable && (\r\n                  <Chip\r\n                    label=\"SIMULATION (Verified Demo)\"\r\n                    color=\"info\"\r\n                    size=\"small\"\r\n                    sx={{ fontWeight: 600 }}\r\n                  />\r\n                )}\r\n                <Button\r\n                  variant=\"contained\"\r\n                  startIcon={isUploading ? <IconPlayerPause /> : <IconUpload />}\r\n                  onClick={isUploading ? () => setIsPaused(true) : startUpload}\r\n                  disabled={!selectedChurchId || files.filter(f => f.status === 'queued').length === 0}\r\n                  sx={{ \r\n                    px: 3,\r\n                    background: 'linear-gradient(135deg, #5e35b1 0%, #3949ab 100%)',\r\n                    '&:hover': {\r\n                      background: 'linear-gradient(135deg, #4527a0 0%, #303f9f 100%)'\r\n                    }\r\n                  }}\r\n                >\r\n                  {isUploading ? 'Pause' : 'Start Upload'}\r\n                </Button>\r\n                \r\n                {isPaused && (\r\n                  <Button\r\n                    variant=\"outlined\"\r\n                    startIcon={<IconPlayerPlay />}\r\n                    onClick={() => { setIsPaused(false); startUpload(); }}\r\n                  >\r\n                    Resume\r\n                  </Button>\r\n                )}\r\n                \r\n                <Button\r\n                  variant=\"outlined\"\r\n                  color=\"error\"\r\n                  startIcon={<IconTrash />}\r\n                  onClick={handleClearAll}\r\n                  disabled={isUploading}\r\n                >\r\n                  Clear All\r\n                </Button>\r\n\r\n                <Box sx={{ ml: 'auto', display: 'flex', alignItems: 'center', gap: 2 }}>\r\n                  <BatchProgress \r\n                    total={files.length} \r\n                    completed={completedCount}\r\n                    processing={isUploading}\r\n                  />\r\n                  <Typography variant=\"body2\" color=\"text.secondary\" sx={{ minWidth: 120 }}>\r\n                    {isUploading ? 'Processing...' : completedCount > 0 ? `Completed: ${completedCount}` : 'Ready to upload'}\r\n                  </Typography>\r\n                </Box>\r\n              </Stack>\r\n            </Paper>\r\n\r\n            {/* File Queue */}\r\n            <Paper \r\n              elevation={0} \r\n              sx={{ \r\n                borderRadius: 2, \r\n                border: '1px solid', \r\n                borderColor: 'divider',\r\n                overflow: 'hidden'\r\n              }}\r\n            >\r\n              <Box sx={{ \r\n                p: 2, \r\n                borderBottom: '1px solid',\r\n                borderColor: 'divider',\r\n                bgcolor: 'background.paper',\r\n                display: 'flex',\r\n                justifyContent: 'space-between',\r\n                alignItems: 'center'\r\n              }}>\r\n                <Typography variant=\"subtitle1\" fontWeight={600}>\r\n                  Upload Queue ({files.length} files)\r\n                </Typography>\r\n                <Stack direction=\"row\" spacing={2}>\r\n                  <Typography variant=\"body2\" color=\"success.main\">\r\n                    Completed: {completedCount}\r\n                  </Typography>\r\n                  <Typography variant=\"body2\" color=\"error.main\">\r\n                    Failed: {failedCount}\r\n                  </Typography>\r\n                </Stack>\r\n              </Box>\r\n              \r\n              <Box sx={{ p: 2, maxHeight: 400, overflow: 'auto' }}>\r\n                {files.map(file => (\r\n                  <FileCard\r\n                    key={file.id}\r\n                    file={file}\r\n                    isSelected={false}\r\n                    onRecordTypeChange={handleRecordTypeChange}\r\n                    onRemove={handleRemoveFile}\r\n                    onRetry={handleRetryFile}\r\n                    onSelect={() => {\r\n                      // File selection now handled in Workbench via UnifiedJobsList\r\n                      // After upload completes, jobs appear in UnifiedJobsList\r\n                    }}\r\n                  />\r\n                ))}\r\n              </Box>\r\n            </Paper>\r\n          </>\r\n        )}\r\n\r\n        {/* Workbench - Unified Jobs List + Workbench for selected job */}\r\n        {selectedChurchId && (\r\n          <Box sx={{ mt: 3, height: 'calc(100vh - 400px)', minHeight: 600 }}>\r\n            <WorkbenchProvider>\r\n              <OcrWorkbench\r\n                churchId={selectedChurchId}\r\n              />\r\n            </WorkbenchProvider>\r\n          </Box>\r\n        )}\r\n      </Box>\r\n\r\n      {/* Toast Notifications */}\r\n      <Snackbar\r\n        open={toast.open}\r\n        autoHideDuration={12000}\r\n        onClose={() => setToast({ ...toast, open: false })}\r\n        anchorOrigin={{ vertical: 'center', horizontal: 'center' }}\r\n        sx={{\r\n          position: 'fixed',\r\n          top: '50% !important',\r\n          left: '50% !important',\r\n          transform: 'translate(-50%, -50%) !important',\r\n          zIndex: 10000,\r\n          '& .MuiSnackbar-root': {\r\n            position: 'fixed',\r\n            top: '50% !important',\r\n            left: '50% !important',\r\n            transform: 'translate(-50%, -50%) !important',\r\n          }\r\n        }}\r\n      >\r\n        <Alert\r\n          onClose={() => setToast({ ...toast, open: false })}\r\n          severity={toast.severity}\r\n          variant=\"filled\"\r\n          sx={{ \r\n            minWidth: '400px',\r\n            maxWidth: '600px',\r\n            fontSize: '1.1rem',\r\n            padding: '16px 20px',\r\n            '& .MuiAlert-message': {\r\n              fontSize: '1.1rem',\r\n              fontWeight: 500,\r\n            },\r\n            '& .MuiAlert-icon': {\r\n              fontSize: '28px',\r\n            }\r\n          }}\r\n        >\r\n          {toast.message}\r\n        </Alert>\r\n      </Snackbar>\r\n      </Box>\r\n      </OcrSelectionProvider>\r\n    </OcrSetupGate>\r\n  );\r\n};\r\n\r\nexport default EnhancedOCRUploader;\r\nexport { EnhancedOCRUploader };\r\n\r\n"],"names":["__iconNode","IconMaximize","createReactComponent","IconPlayerPause","IconRotateClockwise","IconZoomOut","RecordSchemaInfoPopover","title","imageSrc","maxWidth","children","theme","useTheme","anchorEl","setAnchorEl","useState","timeoutRef","useRef","open","handleOpen","event","handleClose","handlePopoverEnter","handlePopoverLeave","handleKeyDown","jsxs","Fragment","jsx","Box","IconInfoCircle","Popover","Typography","e","target","useOcrJobs","churchId","limit","pollInterval","jobs","setJobs","loading","setLoading","error","setError","detailCache","abortControllerRef","pollTimeoutRef","fetchJobs","useCallback","__async","response","apiClient","altErr","_a","res","d","_b","jobsData","_i","_h","_e","_d","_c","_g","_f","mappedJobs","job","err","refresh","fetchJobDetail","jobId","responseData","data","detail","updateRecordType","recordType","prev","j","__spreadProps","__spreadValues","retryJob","status","errorMessage","deleteJobs","jobIds","id","reprocessJobs","failedJobIds","results","failures","r","failure","idx","successfulIds","useEffect","completedCount","failedCount","processingCount","initialState","workbenchReducer","state","action","area","draft","WorkbenchContext","createContext","WorkbenchProvider","dispatch","useReducer","setJob","metadata","ocrText","ocrResult","imageUrl","setEntries","entries","updateEntryArea","entryId","bbox","setSelectedEntry","index","setFieldValue","key","value","confidence","source","setFieldValues","values","setDrafts","drafts","setActiveStep","step","reset","useMemo","useWorkbench","context","useContext","normalizeText","text","detectRecordType","normalized","marriageKeywords","baptismKeywords","funeralKeywords","marriageScore","baptismScore","funeralScore","keyword","regex","matches","totalScore","maxScore","detectedType","extractYear","patterns","pattern","yearMatch","year","detectMetadata","WorkbenchHeader","onClose","jobFilename","jobStatus","jobRecordType","jobConfidence","jobOcrText","detectedYear","getStatusColor","getConfidenceColor","Paper","Stack","Chip","Tooltip","IconButton","IconCopy","IconRefresh","IconX","getImageViewportMetrics","imgEl","rect","naturalWidth","naturalHeight","displayedWidth","displayedHeight","scaleX","scaleY","screenToVision","screenX","screenY","metrics","visionBboxToScreen","visionWidth","visionHeight","scaledBbox","visionToImageScaleX","visionToImageScaleY","getHandlePosition","handle","getResizeCursor","EditableBBox","onBboxChange","onBboxChangeEnd","imageElement","minWidth","minHeight","disabled","color","label","containerRef","isDragging","setIsDragging","isResizing","setIsResizing","resizeHandle","setResizeHandle","dragStart","setDragStart","bboxAtStart","setBboxAtStart","isDrawing","setIsDrawing","drawStart","setDrawStart","setMetrics","handleSize","updateMetrics","newMetrics","resizeObserver","container","mutationObserver","screenBbox","screen","containerRect","clampBbox","maxX","maxY","x","y","w","h","screenToVisionCoords","clientX","clientY","handlePointerDown","containerX","containerY","overlayX","overlayY","handles","handlePos","visionCoords","handlePointerMove","newBbox","deltaX","deltaY","handlePointerUp","cursor","pos","FusionOverlay","boxes","showLabels","hideCompleted","onTokenClick","onTokenDoubleClick","ocrTokens","editMode","containerOffsetRef","normalizedBoxes","normalizedOcrTokens","toScreenBBox","useLayoutEffect","zeroOffset","newOffset","overlayStyle","offsetX","offsetY","width","height","box","isCompleted","isSelected","borderWidth","boxColor","borderColor","bgOpacity","bgColor","alpha","adjustedBbox","token","verticesToBBox","vertices","xs","v","ys","minX","minY","mergeBBoxes","bboxes","b","extractWordText","word","symbol","breakType","generateStableId","type","pageIndex","normalizedText","parseWord","parseParagraph","paragraph","paragraphIndex","tokens","wordIndex","t","tokenBboxes","parseBlock","block","blockIndex","parseVisionResponse","vision","lines","page","getVisionPageSize","WorkbenchViewer","workbench","imageRef","zoom","setZoom","imageDimensions","setImageDimensions","jobOcrResult","visionPageSize","MAX_TOKENS","line","handleZoomIn","handleZoomOut","handleZoomFit","handleZoomChange","Slider","IconZoomIn","TextField","val","InputAdornment","img","UnifiedJobsList","onJobSelect","onRefresh","onDeleteJobs","selectedJobs","setSelectedJobs","itemsPerPage","setItemsPerPage","sortBy","setSortBy","sortOrder","setSortOrder","sortedJobs","a","comparison","dateA","dateB","nameA","nameB","getRetentionDays","createdAt","created","daysSince","formatTimeAgo","dateString","date","diffMs","diffMins","diffHours","diffDays","toggleSelection","next","toggleSelectAll","handleSort","column","FormControl","Select","MenuItem","IconTrash","Button","IconDownload","TableContainer","Table","TableHead","TableRow","TableCell","Checkbox","IconChevronUp","IconChevronDown","TableBody","LinearProgress","retentionDays","isProcessed","normalizeOcrText","extractStructuredTextFromVision","visionResponse","pages","blocks","paraIndex","paragraphText","sym","hasBreak","splitLines","l","extractTextFromVisionResponse","structured","rawText","looksLikeName","looksLikeDate","looksLikeRecordHeader","headers","lower","enhanceOcrTextStructure","enhanced","i","prevLine","nextLine","isName","isDate","isHeader","isShort","result","finalLines","finalEnhanced","isServerNormalizationEnabled","flag","normalizeTranscriptionOnServer","_0","_1","settings","normalizeTranscriptionClient","useServerNormalization","normalizing","setNormalizing","serverNormalized","setServerNormalized","_2","_3","clientResult","TranscriptionPanel","serverNormalizedText","onCopy","onDownload","onNormalize","serverNormalizationEnabled","handleCopy","handleDownload","blob","url","CircularProgress","IconWand","OcrWorkbench","initialJobId","normalize","setNormalizedText","toast","setToast","showToast","message","severity","selectedJobId","setSelectedJobId","selectedJob","jobDetail","ocrTextForDetection","detectedRecordType","handleJobSelect","handleDeleteJobs","handleCloseWorkbench","handleNormalize","docSettings","stored","parsed","showWorkbench","Snackbar","Alert","selectionReducer","existing","item","_","rest","__objRest","__restKey","OcrSelectionContext","OcrSelectionProvider","getSelection","setSelection","items","addSelection","removeSelection","itemId","clearSelection","clearAll","OcrSetupGate","navigate","useNavigate","searchParams","useSearchParams","setupComplete","setSetupComplete","percentComplete","setPercentComplete","checkSetupStatus","Settings","formatFileSize","bytes","generateId","StatusBadge","config","IconClock","IconCheck","IconAlertCircle","icon","RecordTypeBadge","colors","FileCard","file","onRecordTypeChange","onRemove","onRetry","onSelect","isClickable","IconPhoto","BatchProgress","total","completed","processing","percentage","EnhancedOCRUploader","user","isSuperAdmin","useAuth","setSearchParams","fileInputRef","getValidChurchId","num","urlChurchId","urlOcrMode","files","setFiles","churches","setChurches","selectedChurchId","setSelectedChurchId","isUploading","setIsUploading","isPaused","setIsPaused","showAdvanced","setShowAdvanced","dragActive","setDragActive","simulationMode","setSimulationMode","isSimulationModeAvailable","showInspectionPanel","setShowInspectionPanel","selectedFileId","setSelectedFileId","selectedJobDetail","setSelectedJobDetail","loadingJobDetail","setLoadingJobDetail","showMappingTab","setShowMappingTab","inspectionPanelInitialTab","setInspectionPanelInitialTab","refreshOcrJobs","fetchOcrJobDetail","setSettings","setDocSettings","extractionAction","setExtractionAction","stickyDefaults","setStickyDefaults","newParams","f","uploadPath","churchList","useMyChurches","myChurchesData","myChurchesError","churchesError","fallbackChurchId","handleFiles","fileList","validTypes","maxSize","maxFiles","newFiles","reader","uploadFile","handleLoadDemoImages","demoFiles","loadedFiles","filename","dataTransfer","handleDrag","handleDrop","startUpload","queuedFiles","formData","progressInterval","endpoint","isSimulation","resolve","handleRecordTypeChange","handleRemoveFile","handleRetryFile","handleClearAll","fileId","c","IconSettings","Collapse","Divider","FormLabel","s","RadioGroup","FormControlLabel","Radio","IconDatabase","IconAlertTriangle","church","Switch","IconUpload","IconPlayerPlay"],"mappings":"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","x_google_ignoreList":[0,1,2,3]}