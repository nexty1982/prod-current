var _=(y,g,j)=>new Promise((d,v)=>{var b=c=>{try{m(j.next(c))}catch(h){v(h)}},T=c=>{try{m(j.throw(c))}catch(h){v(h)}},m=c=>c.done?d(c.value):Promise.resolve(c.value).then(b,T);m((j=j.apply(y,g)).next())});import{k as be,j as e,a0 as O,d as t,G as r,V as p,R as f,B as n,S as $,h as w,P as D,s as Ce,a1 as Ae,t as Ie,f as x,e as u,aH as Se,C as _e,U as se,T as we,I as De,K as te,Z as re,O as ie,a2 as ne,a4 as ae}from"./index-Dgvcv9SG.js";import{r as i}from"./vendor-Dkfty7_r.js";import{a as V}from"./admin.api-KTUJsu5j.js";import{P as le}from"./PageContainer-CE1CdJ_Q.js";import{D as Te}from"./DashboardCard-Dv-ZmD1u.js";import{I as ke}from"./IconActivity-Ds2cYHjn.js";import{I as Le}from"./IconUser-5i6r9hmN.js";import{I as Fe}from"./IconCalendar-CsRfdV1H.js";import{I as oe}from"./IconFilter-BMn8qhQU.js";import{A as Pe,a as Ue,b as We}from"./AccordionSummary-Dm3m9TCz.js";import{I as ze}from"./IconChevronDown-f9fpkikX.js";import{I as ce}from"./IconSearch-Yybor66O.js";import{I as Re}from"./IconTrash-C3ez3ykA.js";import{T as Be,a as Ee,b as Me,c as H,d as Oe}from"./TableRow-GBYhOGTG.js";import{T as l}from"./TableCell-jHKItVVU.js";import{I as $e}from"./IconMapPin-BSqaMgXI.js";import{I as Ve}from"./IconEye-DalVfBSb.js";import{P as He}from"./Pagination-DMJsNFIO.js";import"./api.config-C9UNSeTF.js";import"./Helmet-B7mFktpd.js";import"./index-Ch3W3BYh.js";import"./LastPage-BXUC_f7y.js";const js=()=>{const{hasRole:y}=be(),[g,j]=i.useState([]),[d,v]=i.useState(null),[b,T]=i.useState([]),[m,c]=i.useState(!0),[h,N]=i.useState(""),[k,G]=i.useState(""),[q,de]=i.useState(""),[L,J]=i.useState(""),[F,K]=i.useState(""),[P,U]=i.useState(1),[W,he]=i.useState(1),[o,xe]=i.useState(null),[ue,z]=i.useState(!1),[je,C]=i.useState(!1),[Y,me]=i.useState(90),[Z,A]=i.useState(""),[Q,I]=i.useState(""),R=25,ge=s=>{A(s),setTimeout(()=>A(""),5e3)},B=s=>{I(s),setTimeout(()=>I(""),5e3)};if(!y(["super_admin","admin"]))return e.jsx(le,{title:"Activity Logs",description:"View system activity logs",children:e.jsxs(O,{severity:"error",sx:{mt:2},children:[e.jsx(t,{variant:"h6",children:"Access Denied"}),e.jsx(t,{children:"You don't have permission to view activity logs."})]})});const S=()=>_(void 0,null,function*(){try{c(!0);const s={search:h||void 0,action_filter:k||void 0,user_filter:q||void 0,date_from:L||void 0,date_to:F||void 0,limit:R,offset:(P-1)*R},a=yield V.activityLogs.getAll(s);j(a.activities||[]),v(a.stats),T(a.topActions||[]),he(a.pagination.pages)}catch(s){console.error("Failed to fetch activity logs:",s),B("Failed to load activity logs")}finally{c(!1)}});i.useEffect(()=>{S()},[P,h,k,q,L,F]);const pe=()=>{U(1),S()},fe=()=>{N(""),G(""),de(""),J(""),K(""),U(1)},ye=s=>_(void 0,null,function*(){try{const a=yield V.activityLogs.getById(s.id);xe(a),z(!0)}catch(a){console.error("Failed to fetch activity details:",a),B("Failed to load activity details")}}),ve=()=>_(void 0,null,function*(){try{const s=yield V.activityLogs.cleanup(Y);ge(`Successfully cleaned up ${s.records_deleted} old activity log records`),C(!1),S()}catch(s){console.error("Failed to cleanup activity logs:",s),B("Failed to cleanup activity logs")}}),E=s=>s.split("_").map(a=>a.charAt(0).toUpperCase()+a.slice(1)).join(" "),M=s=>s.includes("login")||s.includes("authenticate")?"success":s.includes("logout")||s.includes("terminate")?"warning":s.includes("delete")||s.includes("remove")?"error":s.includes("create")||s.includes("add")?"primary":s.includes("update")||s.includes("modify")?"info":"default",X=s=>new Date(s).toLocaleString(),ee=s=>s.first_name||s.last_name?`${s.first_name||""} ${s.last_name||""}`.trim():s.user_email||`User ${s.user_id}`;return e.jsxs(le,{title:"Activity Logs",description:"View and manage system activity logs",children:[d&&e.jsxs(r,{container:!0,spacing:3,sx:{mb:3},children:[e.jsx(r,{item:!0,xs:12,sm:6,md:3,children:e.jsx(p,{children:e.jsx(f,{children:e.jsxs(n,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(ke,{size:32,color:"#1976d2"}),e.jsxs(n,{children:[e.jsx(t,{variant:"h4",fontWeight:"bold",children:d.total_activities.toLocaleString()}),e.jsx(t,{variant:"body2",color:"text.secondary",children:"Total Activities (30 days)"})]})]})})})}),e.jsx(r,{item:!0,xs:12,sm:6,md:3,children:e.jsx(p,{children:e.jsx(f,{children:e.jsxs(n,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(Le,{size:32,color:"#388e3c"}),e.jsxs(n,{children:[e.jsx(t,{variant:"h4",fontWeight:"bold",children:d.unique_users}),e.jsx(t,{variant:"body2",color:"text.secondary",children:"Active Users"})]})]})})})}),e.jsx(r,{item:!0,xs:12,sm:6,md:3,children:e.jsx(p,{children:e.jsx(f,{children:e.jsxs(n,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(Fe,{size:32,color:"#f57c00"}),e.jsxs(n,{children:[e.jsx(t,{variant:"h4",fontWeight:"bold",children:d.active_days}),e.jsx(t,{variant:"body2",color:"text.secondary",children:"Active Days"})]})]})})})}),e.jsx(r,{item:!0,xs:12,sm:6,md:3,children:e.jsx(p,{children:e.jsx(f,{children:e.jsxs(n,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(oe,{size:32,color:"#7b1fa2"}),e.jsxs(n,{children:[e.jsx(t,{variant:"h4",fontWeight:"bold",children:d.unique_actions}),e.jsx(t,{variant:"body2",color:"text.secondary",children:"Action Types"})]})]})})})})]}),b.length>0&&e.jsx(p,{sx:{mb:3},children:e.jsxs(f,{children:[e.jsx(t,{variant:"h6",gutterBottom:!0,children:"Top Actions (Last 7 Days)"}),e.jsx($,{direction:"row",spacing:1,flexWrap:"wrap",gap:1,children:b.slice(0,10).map(s=>e.jsx(w,{label:`${E(s.action)} (${s.count})`,color:M(s.action),variant:"outlined",size:"small"},s.action))})]})}),e.jsxs(Te,{title:"Activity Logs & Audit Trail",children:[e.jsxs(Pe,{sx:{mb:2},children:[e.jsx(Ue,{expandIcon:e.jsx(ze,{}),children:e.jsxs(t,{variant:"h6",children:[e.jsx(oe,{size:20,style:{marginRight:8}}),"Filters & Search"]})}),e.jsx(We,{children:e.jsxs(r,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(r,{item:!0,xs:12,md:4,children:e.jsx(D,{fullWidth:!0,label:"Search",placeholder:"Search in actions, users, or changes...",value:h,onChange:s=>N(s.target.value),InputProps:{startAdornment:e.jsx(ce,{size:20,style:{marginRight:8}})}})}),e.jsx(r,{item:!0,xs:12,md:2,children:e.jsxs(Ce,{fullWidth:!0,children:[e.jsx(Ae,{children:"Action Filter"}),e.jsxs(Ie,{value:k,label:"Action Filter",onChange:s=>G(s.target.value),children:[e.jsx(x,{value:"",children:"All Actions"}),e.jsx(x,{value:"login",children:"Login"}),e.jsx(x,{value:"logout",children:"Logout"}),e.jsx(x,{value:"terminate_session",children:"Terminate Session"}),e.jsx(x,{value:"create_user",children:"Create User"}),e.jsx(x,{value:"update_user",children:"Update User"}),e.jsx(x,{value:"lockout_user",children:"Lockout User"})]})]})}),e.jsx(r,{item:!0,xs:12,md:2,children:e.jsx(D,{fullWidth:!0,label:"From Date",type:"date",value:L,onChange:s=>J(s.target.value),InputLabelProps:{shrink:!0}})}),e.jsx(r,{item:!0,xs:12,md:2,children:e.jsx(D,{fullWidth:!0,label:"To Date",type:"date",value:F,onChange:s=>K(s.target.value),InputLabelProps:{shrink:!0}})}),e.jsx(r,{item:!0,xs:12,md:2,children:e.jsxs($,{direction:"row",spacing:1,children:[e.jsx(u,{variant:"contained",onClick:pe,startIcon:e.jsx(ce,{}),children:"Search"}),e.jsx(u,{variant:"outlined",onClick:fe,children:"Clear"})]})})]})})]}),e.jsxs(n,{sx:{mb:2,display:"flex",gap:1,justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(t,{variant:"h6",children:["Activity Log Entries (",g.length," of ",W*R,")"]}),e.jsxs($,{direction:"row",spacing:1,children:[e.jsx(u,{variant:"outlined",startIcon:e.jsx(Se,{}),onClick:S,disabled:m,children:"Refresh"}),y(["super_admin"])&&e.jsx(u,{variant:"outlined",color:"warning",startIcon:e.jsx(Re,{}),onClick:()=>C(!0),children:"Cleanup Old Logs"})]})]}),m?e.jsx(n,{display:"flex",justifyContent:"center",p:4,children:e.jsx(_e,{})}):e.jsxs(e.Fragment,{children:[e.jsx(Be,{component:se,children:e.jsxs(Ee,{children:[e.jsx(Me,{sx:{backgroundColor:"#f5f5f5"},children:e.jsxs(H,{children:[e.jsx(l,{children:e.jsx("strong",{children:"Timestamp"})}),e.jsx(l,{children:e.jsx("strong",{children:"User"})}),e.jsx(l,{children:e.jsx("strong",{children:"Action"})}),e.jsx(l,{children:e.jsx("strong",{children:"Details"})}),e.jsx(l,{children:e.jsx("strong",{children:"IP Address"})}),e.jsx(l,{children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(Oe,{children:g.length===0?e.jsx(H,{children:e.jsx(l,{colSpan:6,align:"center",children:e.jsx(t,{variant:"body1",color:"text.secondary",py:4,children:"No activity logs found"})})}):g.map(s=>e.jsxs(H,{hover:!0,children:[e.jsx(l,{children:e.jsx(n,{children:e.jsx(t,{variant:"body2",children:X(s.created_at)})})}),e.jsx(l,{children:e.jsxs(n,{children:[e.jsx(t,{variant:"body2",fontWeight:"medium",children:ee(s)}),e.jsx(t,{variant:"caption",color:"text.secondary",children:s.user_email}),s.user_role&&e.jsx(w,{label:s.user_role,size:"small",color:s.user_role==="super_admin"?"error":"primary",variant:"outlined",sx:{ml:1}})]})}),e.jsx(l,{children:e.jsx(w,{label:E(s.action),color:M(s.action),variant:"outlined",size:"small"})}),e.jsx(l,{children:e.jsx(t,{variant:"body2",sx:{maxWidth:200},children:s.changes&&typeof s.changes=="object"&&Object.keys(s.changes).length>0?`${Object.keys(s.changes).length} changes`:"No details"})}),e.jsx(l,{children:e.jsxs(n,{display:"flex",alignItems:"center",gap:1,children:[e.jsx($e,{size:16}),e.jsx(t,{variant:"body2",children:s.ip_address||"Unknown"})]})}),e.jsx(l,{children:e.jsx(we,{title:"View Details",children:e.jsx(De,{size:"small",onClick:()=>ye(s),children:e.jsx(Ve,{})})})})]},s.id))})]})}),W>1&&e.jsx(n,{display:"flex",justifyContent:"center",mt:3,children:e.jsx(He,{count:W,page:P,onChange:(s,a)=>U(a),color:"primary"})})]})]}),e.jsxs(te,{open:ue,onClose:()=>z(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(re,{children:"Activity Log Details"}),e.jsx(ie,{children:o&&e.jsxs(n,{children:[e.jsxs(r,{container:!0,spacing:2,children:[e.jsxs(r,{item:!0,xs:6,children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Timestamp"}),e.jsx(t,{variant:"body1",children:X(o.created_at)})]}),e.jsxs(r,{item:!0,xs:6,children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Action"}),e.jsx(w,{label:E(o.action),color:M(o.action),variant:"outlined"})]}),e.jsxs(r,{item:!0,xs:6,children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"User"}),e.jsxs(t,{variant:"body1",children:[ee(o)," (",o.user_email,")"]})]}),e.jsxs(r,{item:!0,xs:6,children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Role"}),e.jsx(t,{variant:"body1",children:o.user_role||"Unknown"})]}),e.jsxs(r,{item:!0,xs:6,children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"IP Address"}),e.jsx(t,{variant:"body1",children:o.ip_address||"Unknown"})]}),e.jsxs(r,{item:!0,xs:6,children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"User Agent"}),e.jsx(t,{variant:"body2",sx:{wordBreak:"break-word"},children:o.user_agent||"Unknown"})]})]}),o.changes&&e.jsxs(n,{mt:3,children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Changes/Details"}),e.jsx(se,{sx:{p:2,backgroundColor:"#f5f5f5"},children:e.jsx("pre",{style:{margin:0,fontSize:"0.875rem",whiteSpace:"pre-wrap"},children:JSON.stringify(o.changes,null,2)})})]})]})}),e.jsx(ne,{children:e.jsx(u,{onClick:()=>z(!1),children:"Close"})})]}),e.jsxs(te,{open:je,onClose:()=>C(!1),children:[e.jsx(re,{children:"Cleanup Old Activity Logs"}),e.jsxs(ie,{children:[e.jsx(t,{variant:"body1",gutterBottom:!0,children:"This will permanently delete activity log records older than the specified number of days."}),e.jsx(D,{fullWidth:!0,label:"Days to keep",type:"number",value:Y,onChange:s=>me(parseInt(s.target.value)||90),helperText:"Records older than this many days will be deleted",sx:{mt:2}})]}),e.jsxs(ne,{children:[e.jsx(u,{onClick:()=>C(!1),children:"Cancel"}),e.jsx(u,{onClick:ve,color:"warning",variant:"contained",children:"Delete Old Logs"})]})]}),e.jsx(ae,{open:!!Z,autoHideDuration:5e3,onClose:()=>A(""),children:e.jsx(O,{severity:"success",onClose:()=>A(""),children:Z})}),e.jsx(ae,{open:!!Q,autoHideDuration:5e3,onClose:()=>I(""),children:e.jsx(O,{severity:"error",onClose:()=>I(""),children:Q})})]})};export{js as default};
//# sourceMappingURL=ActivityLogs-CMFtQGzE.js.map
