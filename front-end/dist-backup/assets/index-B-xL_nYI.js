var ir=Object.defineProperty,cr=Object.defineProperties;var dr=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var fr=Object.prototype.hasOwnProperty,mr=Object.prototype.propertyIsEnumerable;var G=(o,s,a)=>s in o?ir(o,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):o[s]=a,E=(o,s)=>{for(var a in s||(s={}))fr.call(s,a)&&G(o,a,s[a]);if(T)for(var a of T(s))mr.call(s,a)&&G(o,a,s[a]);return o},W=(o,s)=>cr(o,dr(s));var w=(o,s,a)=>new Promise((A,x)=>{var U=i=>{try{c(a.next(i))}catch(u){x(u)}},C=i=>{try{c(a.throw(i))}catch(u){x(u)}},c=i=>i.done?A(i.value):Promise.resolve(i.value).then(U,C);c((a=a.apply(o,s)).next())});import{k as ur,j as gr}from"./index-Dgvcv9SG.js";import{r as n}from"./vendor-Dkfty7_r.js";import{u as N}from"./index-DD9AOJWo.js";import{g as _}from"./globalFetcher-PGxvMJiC.js";function F(o){if(!o||!(!!o.id||!!o.email||!!o.username))return!1;if(o.name){const a=o.name.trim();if(a&&a!=="Unknown User")return!0}return!!(o.email&&o.email.trim())}function pr(o){return{firstName:o.first_name||o.firstName||"",lastName:o.last_name||o.lastName||"",username:o.username||null,email:o.email||null,id:o.id||null}}const yr=n.createContext(void 0),h={posts:[],users:[],gallery:[],followers:[],search:"",loading:!0};function Er({children:o}){const[s,a]=n.useState(h.posts),[A,x]=n.useState(h.users),[U,C]=n.useState(h.gallery),[c,i]=n.useState(h.followers),[u,q]=n.useState(h.search),[B,H]=n.useState(null),[M,I]=n.useState(h.loading),{user:l}=ur(),v=(l==null?void 0:l.id)||1,j=()=>{if(l)return{name:l.first_name&&l.last_name?`${l.first_name} ${l.last_name}`.trim():l.username||l.email||"User",role:l.role||"User",avatar:"/orthodox/avatars/default.svg",coverImage:"/orthodox/banners/default.svg",postsCount:0,followersCount:0,followingCount:0};try{const r=localStorage.getItem("orthodoxmetrics_profile_data");if(r)return JSON.parse(r)}catch(r){console.error("Error loading profile from localStorage:",r)}return{name:"User",role:"User",avatar:"/orthodox/avatars/default.svg",coverImage:"/orthodox/banners/default.svg",postsCount:0,followersCount:0,followingCount:0}},g=j(),[J,P]=n.useState(g);n.useEffect(()=>{const r=j();P(r)},[l==null?void 0:l.id]);const Q=`/om/profile/${v}`,V=`/om/profile/${v}/posts?page=1&limit=50`,X=`/om/profile/${v}/gallery`,Y=`/om/profile/${v}/followers`,{data:p,isLoading:O,error:b}=N(Q,_),{data:d,isLoading:R,error:L,mutate:wr}=N(V,_),{data:f,isLoading:K,error:D}=N(X,_),{data:m,isLoading:z,error:$}=N(Y,_);n.useEffect(()=>{if(p&&d&&f&&m){if(p&&p.ok&&p.profile){const r=p.profile,e=pr(r),y={name:`${e.firstName||""} ${e.lastName||""}`.trim()||e.username||e.email||"Unknown User",role:r.role||"User",avatar:r.avatarUrl||r.avatar_url||g.avatar,coverImage:r.bannerUrl||r.banner_url||g.coverImage,postsCount:g.postsCount,followersCount:g.followersCount,followingCount:g.followingCount,id:e.id,email:e.email||void 0,username:e.username||void 0};if(P(y),F(y))try{localStorage.setItem("orthodoxmetrics_profile_data",JSON.stringify(y))}catch(k){console.error("Error saving profile to localStorage:",k)}else{console.warn("Skipping localStorage save: profile is not persistable (fallback detected)");try{const k=localStorage.getItem("orthodoxmetrics_profile_data");if(k){const nr=JSON.parse(k);F(nr)||(localStorage.removeItem("orthodoxmetrics_profile_data"),console.log("Removed invalid stored profile from localStorage"))}}catch(k){}}}d&&d.ok&&d.rows&&Array.isArray(d.rows)&&a(d.rows),f&&f.ok&&f.rows&&Array.isArray(f.rows)&&C(f.rows),m&&m.ok&&m.rows&&Array.isArray(m.rows)&&i(m.rows),I(!1)}else b||L||D||$?(H(b||L||D||$),I(!1)):I(O||R||K||z)},[p,d,f,m,O,R,K,z,b,L,D,$]);const Z=r=>{C(e=>!e||!Array.isArray(e)?[r]:[...e,r])},rr=r=>{i(e=>!e||!Array.isArray(e)?[]:e.map(t=>t&&t.id===r?W(E({},t),{isFollowed:!t.isFollowed}):t))},or=()=>c&&Array.isArray(c)?c.filter(r=>r.name&&r.name.toLowerCase().includes(u.toLowerCase())):c||[],er=(r,e)=>w(this,null,function*(){try{console.log("Adding comment:",{postId:r,comment:e})}catch(t){console.error("Error adding comment:",t)}}),tr=(r,e,t)=>w(this,null,function*(){try{console.log("Adding reply:",{postId:r,commentId:e,reply:t})}catch(S){console.error("Error adding reply:",S)}}),ar=r=>w(this,null,function*(){try{console.log("Liking post:",{postId:r})}catch(e){console.error("Error liking post:",e)}}),sr=(r,e)=>w(this,null,function*(){try{console.log("Liking reply:",{postId:r,commentId:e})}catch(t){console.error("Error liking reply:",t)}}),lr=r=>w(this,null,function*(){const e=E(E({},J),r);if(P(e),F(e))try{localStorage.setItem("orthodoxmetrics_profile_data",JSON.stringify(e))}catch(t){console.error("Error saving profile to localStorage:",t)}else console.warn("Skipping localStorage save: updated profile is not persistable (fallback detected)");try{const t=yield fetch(`/api/om/profile/${v}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(r)});if(!t.ok){const y=yield t.json();throw console.error("Failed to save profile to backend:",y),new Error(y.error||"Failed to save profile")}const S=yield t.json();return console.log("Profile saved to backend:",S),S}catch(t){throw console.error("Error saving profile to backend:",t),t}});return gr.jsx(yr.Provider,{value:{posts:s,users:A,error:B,gallery:U,loading:M,profileData:J,addGalleryItem:Z,addReply:tr,likePost:ar,addComment:er,likeReply:sr,followers:or(),toggleFollow:rr,setSearch:q,search:u,updateProfileData:lr},children:o})}export{yr as U,Er as a};
//# sourceMappingURL=index-B-xL_nYI.js.map
