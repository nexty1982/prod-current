var $t=Object.defineProperty,Wt=Object.defineProperties;var Lt=Object.getOwnPropertyDescriptors;var Pe=Object.getOwnPropertySymbols;var nt=Object.prototype.hasOwnProperty,ot=Object.prototype.propertyIsEnumerable;var st=(t,r,s)=>r in t?$t(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s,j=(t,r)=>{for(var s in r||(r={}))nt.call(r,s)&&st(t,s,r[s]);if(Pe)for(var s of Pe(r))ot.call(r,s)&&st(t,s,r[s]);return t},E=(t,r)=>Wt(t,Lt(r));var at=t=>typeof t=="symbol"?t:t+"",it=(t,r)=>{var s={};for(var o in t)nt.call(t,o)&&r.indexOf(o)<0&&(s[o]=t[o]);if(t!=null&&Pe)for(var o of Pe(t))r.indexOf(o)<0&&ot.call(t,o)&&(s[o]=t[o]);return s};var te=(t,r,s)=>new Promise((o,h)=>{var a=u=>{try{l(s.next(u))}catch(p){h(p)}},c=u=>{try{l(s.throw(u))}catch(p){h(p)}},l=u=>u.done?o(u.value):Promise.resolve(u.value).then(a,c);l((s=s.apply(t,r)).next())});import{c as Ne,m as fe,j as e,B as S,cD as Ft,d as k,U as de,S as Q,h as oe,T as pe,I as ye,cm as ft,aH as Nt,H as xt,aR as re,P as Jt,s as Ee,t as Re,f as se,e as we,aI as lt,C as Oe,a4 as mt,a0 as Je,l as Bt,b4 as gt,i as Ut,k as Vt,z as Ve,q as ct,D as $e,$ as Ye,F as ge,Y as Yt,r as ke}from"./index-Dgvcv9SG.js";import{r as n}from"./vendor-Dkfty7_r.js";import{a as ue}from"./axiosInstance-ybWCckox.js";import{I as Xt}from"./IconInfoCircle-CInPNjNe.js";import{S as Zt}from"./Slider-C0NlYhsa.js";import{I as Gt}from"./IconZoomIn-Bbqb6z8B.js";import{I as Ht}from"./InputAdornment-fA5QdII4.js";import{I as qe}from"./IconTrash-C3ez3ykA.js";import{I as yt}from"./IconDownload-CXb9O49-.js";import{T as qt,a as Qt,b as Kt,c as We,d as er}from"./TableRow-GBYhOGTG.js";import{T as he}from"./TableCell-jHKItVVU.js";import{I as Le}from"./IconChevronUp-qiJ9Hl7v.js";import{I as Fe}from"./IconChevronDown-f9fpkikX.js";import{L as et}from"./LinearProgress-BAk3tkXf.js";import{I as tr}from"./IconWand-Cg5ckpx2.js";import{R as rr,a as Xe}from"./RadioGroup-BV2fzvZ4.js";import{I as sr}from"./IconDatabase-CBOQAi9V.js";import{I as Qe}from"./IconPhoto-BEkfSi5J.js";import{I as nr}from"./IconUpload-BYElQIAd.js";import{I as or}from"./IconPlayerPlay-BIkaw8WG.js";import{I as ar}from"./IconAlertCircle-Bc3zVEZG.js";import{I as ir}from"./IconCheck-WLZZX55y.js";import{I as lr}from"./IconClock-Tbzc27Lr.js";import"./api.config-C9UNSeTF.js";/**
 * @license @tabler/icons-react v3.36.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const cr=[["path",{d:"M4 8v-2a2 2 0 0 1 2 -2h2",key:"svg-0"}],["path",{d:"M4 16v2a2 2 0 0 0 2 2h2",key:"svg-1"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v2",key:"svg-2"}],["path",{d:"M16 20h2a2 2 0 0 0 2 -2v-2",key:"svg-3"}]],dr=Ne("outline","maximize","Maximize",cr);/**
 * @license @tabler/icons-react v3.36.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const ur=[["path",{d:"M6 6a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1l0 -12",key:"svg-0"}],["path",{d:"M14 6a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1l0 -12",key:"svg-1"}]],hr=Ne("outline","player-pause","PlayerPause",ur);/**
 * @license @tabler/icons-react v3.36.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const pr=[["path",{d:"M4.05 11a8 8 0 1 1 .5 4m-.5 5v-5h5",key:"svg-0"}]],fr=Ne("outline","rotate-clockwise","RotateClockwise",pr);/**
 * @license @tabler/icons-react v3.36.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const xr=[["path",{d:"M3 10a7 7 0 1 0 14 0a7 7 0 1 0 -14 0",key:"svg-0"}],["path",{d:"M7 10l6 0",key:"svg-1"}],["path",{d:"M21 21l-6 -6",key:"svg-2"}]],mr=Ne("outline","zoom-out","ZoomOut",xr),Ze=({title:t,imageSrc:r,maxWidth:s=600,children:o})=>{const h=fe(),[a,c]=n.useState(null),l=n.useRef(null),u=!!a,p=I=>{l.current&&(clearTimeout(l.current),l.current=null),c(I.currentTarget)},m=()=>{l.current=setTimeout(()=>{c(null)},100)},y=()=>{l.current&&(clearTimeout(l.current),l.current=null)},R=()=>{m()},x=I=>{I.key==="Escape"&&c(null)};return e.jsxs(e.Fragment,{children:[e.jsx(S,{component:"span",onMouseEnter:p,onMouseLeave:m,onFocus:p,onBlur:m,onKeyDown:x,sx:{display:"inline-flex",alignItems:"center",cursor:"pointer",color:"primary.main","&:hover":{color:"primary.dark"}},"aria-label":`Show schema info for ${t}`,tabIndex:0,children:o||e.jsx(Xt,{size:18})}),e.jsx(Ft,{open:u,anchorEl:a,onClose:()=>c(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},onMouseEnter:y,onMouseLeave:R,sx:{pointerEvents:"auto","& .MuiPopover-paper":{maxWidth:`${s}px`,bgcolor:h.palette.background.paper,border:`1px solid ${h.palette.divider}`,boxShadow:h.shadows[8],borderRadius:2,overflow:"hidden"}},disableRestoreFocus:!0,children:e.jsxs(S,{sx:{p:2},children:[e.jsxs(k,{variant:"h6",fontWeight:600,sx:{mb:2},children:["Default Columns: ",t]}),e.jsx(S,{component:"img",src:r,alt:`Schema preview for ${t}`,sx:{width:"100%",height:"auto",display:"block",borderRadius:1,border:`1px solid ${h.palette.divider}`},onError:I=>{const M=I.target;M.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5TY2hlbWEgUHJldmlldyBQbGFjZWhvbGRlcjwvdGV4dD48L3N2Zz4="}})]})})]})};function bt({churchId:t,limit:r=200,pollInterval:s=3e3}){const[o,h]=n.useState([]),[a,c]=n.useState(!1),[l,u]=n.useState(null),p=n.useRef(new Map),m=n.useRef(null),y=n.useRef(null),R=n.useCallback(()=>te(this,null,function*(){var i,g,D,v,O,_,b,T,A;if(!t){console.log("[useOcrJobs] No churchId, skipping fetch"),h([]);return}m.current&&m.current.abort(),m.current=new AbortController;try{console.log(`[useOcrJobs] Checking OCR availability for church ${t}...`);let L;try{L=yield ue.get(`/api/ocr/jobs?churchId=${t}&limit=${r}`)}catch(H){if(((i=H.response)==null?void 0:i.status)===404){console.log(`[useOcrJobs] OCR endpoint not available for church ${t}, skipping fetch`),h([]),u(null);return}throw H}const G=L,B=(g=G==null?void 0:G.data)!=null?g:G,le=Array.isArray(B)?B:(A=(T=(O=(v=B==null?void 0:B.jobs)!=null?v:(D=B==null?void 0:B.data)==null?void 0:D.jobs)!=null?O:Array.isArray(B==null?void 0:B.data)?B.data:null)!=null?T:(b=(_=B==null?void 0:B.data)==null?void 0:_.data)==null?void 0:b.jobs)!=null?A:[];console.log("[useOcrJobs] Response keys:",Object.keys(G||{})),console.log("[useOcrJobs] Data keys:",Object.keys(B||{})),console.log(`[useOcrJobs] Received ${le.length} jobs`);const K=le.map(H=>({id:Number(H.id),church_id:Number(H.church_id||t),original_filename:H.original_filename||H.filename||"",filename:H.filename||"",status:H.status||"queued",record_type:H.record_type||"baptism",confidence_score:H.confidence_score!=null?Number(H.confidence_score):null,language:H.language||"en",created_at:H.created_at,updated_at:H.updated_at,ocr_text_preview:H.ocr_text_preview||null,has_ocr_text:!!H.ocr_text_preview||!!H.has_ocr_text,error_message:H.error_message||H.error||null}));h(K),u(null)}catch(L){L.name!=="AbortError"&&(console.error("[useOcrJobs] Fetch error:",L),u(L.message||"Failed to fetch jobs"))}}),[t,r]),x=n.useCallback(()=>te(this,null,function*(){c(!0),yield R(),c(!1)}),[R]),I=n.useCallback(i=>te(this,null,function*(){var g,D,v;if(!t)return null;if(p.current.has(i))return p.current.get(i);try{let O;try{O=yield ue.get(`/api/ocr/jobs/${i}?churchId=${t}`)}catch(A){throw((g=A.response)==null?void 0:g.status)===404?(console.warn("[useOcrJobs] OCR endpoint not available, cannot fetch job details"),new Error("OCR endpoint not available")):A}const _=(D=O==null?void 0:O.data)!=null?D:O,b=(v=_==null?void 0:_.data)!=null?v:_;if(!b||!b.id)return console.error("[useOcrJobs] Invalid job detail response:",O),null;const T={id:parseInt(b.id),church_id:parseInt(b.church_id||t),original_filename:b.original_filename||b.filename,filename:b.filename,status:b.status,record_type:b.record_type||"baptism",confidence_score:b.confidence_score,language:b.language,created_at:b.created_at,updated_at:b.updated_at,ocr_text:b.ocr_text||null,ocr_result:b.ocr_result||null,file_path:b.file_path,mapping:b.mapping,has_ocr_text:!!b.ocr_text};return p.current.set(i,T),T}catch(O){return console.error("[useOcrJobs] Detail fetch error:",O),null}}),[t]),M=n.useCallback((i,g)=>te(this,null,function*(){var D;if(!t)return!1;h(v=>v.map(O=>O.id===i?E(j({},O),{record_type:g}):O));try{try{yield ue.patch(`/api/ocr/jobs/${i}`,{record_type:g,churchId:t})}catch(v){if(((D=v.response)==null?void 0:D.status)===404)yield ue.patch(`/api/church/${t}/ocr/jobs/${i}`,{record_type:g});else throw v}return p.current.delete(i),!0}catch(v){return console.error("[useOcrJobs] Update record type error:",v),yield R(),!1}}),[t,R]),V=n.useCallback(i=>te(this,null,function*(){var D,v,O,_;if(!t)return!1;const g=o.find(b=>b.id===i);if(!g)return console.warn(`[useOcrJobs] Job ${i} not found in current jobs list`),!1;if(g.status!=="failed")return console.warn(`[useOcrJobs] Cannot retry job ${i}: status is '${g.status}', only 'failed' jobs can be retried`),!1;try{try{yield ue.post(`/api/ocr/jobs/${i}/retry`,{churchId:t})}catch(b){if(((D=b.response)==null?void 0:D.status)===404)return console.warn(`[useOcrJobs] OCR endpoint not available for church ${t}`),!1;throw b}return h(b=>b.map(T=>T.id===i?E(j({},T),{status:"processing",error_message:null}):T)),p.current.delete(i),!0}catch(b){const T=(v=b==null?void 0:b.response)==null?void 0:v.status,A=((_=(O=b==null?void 0:b.response)==null?void 0:O.data)==null?void 0:_.error)||(b==null?void 0:b.message)||"Unknown error";return T===400?console.warn(`[useOcrJobs] Retry failed (400): ${A}`):console.error("[useOcrJobs] Retry error:",b),!1}}),[t,o]),Y=n.useCallback(i=>te(this,null,function*(){if(!t||i.length===0)return!1;try{return yield ue.delete(`/api/church/${t}/ocr/jobs`,{data:{jobIds:i}}),h(g=>g.filter(D=>!i.includes(D.id))),i.forEach(g=>p.current.delete(g)),!0}catch(g){return console.error("[useOcrJobs] Delete error:",g),!1}}),[t]),P=n.useCallback(i=>te(this,null,function*(){if(!t||i.length===0)return!1;const g=i.filter(D=>{const v=o.find(O=>O.id===D);return v&&v.status==="failed"});if(g.length===0)return console.warn("[useOcrJobs] No failed jobs to retry - reprocessJobs only works for failed jobs"),!1;g.length<i.length&&console.warn(`[useOcrJobs] Filtered ${i.length-g.length} non-failed jobs from reprocess list`);try{const D=yield Promise.allSettled(g.map(_=>te(this,null,function*(){var b;try{yield ue.post(`/api/ocr/jobs/${_}/retry`,{churchId:t})}catch(T){if(((b=T.response)==null?void 0:b.status)===404)yield ue.post(`/api/church/${t}/ocr/jobs/${_}/retry`);else throw T}}))),v=D.filter(_=>_.status==="rejected");v.length>0&&(console.warn(`[useOcrJobs] ${v.length} of ${g.length} retry requests failed`),v.forEach((_,b)=>{var G,B,le;const T=_.reason,A=(G=T==null?void 0:T.response)==null?void 0:G.status,L=((le=(B=T==null?void 0:T.response)==null?void 0:B.data)==null?void 0:le.error)||(T==null?void 0:T.message)||"Unknown error";A===400?console.warn(`[useOcrJobs] Retry failed (400) for job ${g[b]}: ${L}`):console.error(`[useOcrJobs] Retry error for job ${g[b]}:`,T)}));const O=g.filter((_,b)=>D[b].status==="fulfilled");return O.length>0&&(h(_=>_.map(b=>O.includes(b.id)?E(j({},b),{status:"processing",error_message:null}):b)),O.forEach(_=>p.current.delete(_))),O.length>0}catch(D){return console.error("[useOcrJobs] Reprocess error:",D),!1}}),[t,o]);n.useEffect(()=>t?(o.some(g=>["queued","uploading","processing"].includes(g.status))&&(y.current=setTimeout(()=>{R()},s)),()=>{y.current&&clearTimeout(y.current)}):void 0,[o,t,s,R]),n.useEffect(()=>(x(),p.current.clear(),()=>{m.current&&m.current.abort(),y.current&&clearTimeout(y.current)}),[t]);const f=o.filter(i=>i.status==="completed").length,J=o.filter(i=>i.status==="failed").length,C=o.filter(i=>["queued","uploading","processing"].includes(i.status)).length;return{jobs:o,loading:a,error:l,refresh:x,fetchJobDetail:I,updateRecordType:M,retryJob:V,deleteJobs:Y,reprocessJobs:P,completedCount:f,failedCount:J,processingCount:C,detailCache:p.current}}const wt={activeJobId:null,jobMetadata:null,ocrText:null,ocrResult:null,imageUrl:null,normalizedText:null,entries:[],entryAreas:[],selectedEntryIndex:null,bboxEditMode:!1,detectedLabels:[],labelCandidates:[],fieldValues:{},fieldExtractions:{},drafts:[],stepStatus:{detectEntries:{complete:!1},anchorLabels:{complete:!1},mapFields:{complete:!1},reviewCommit:{complete:!1}},activeStep:0,isProcessing:!1,error:null};function gr(t,r){switch(r.type){case"SET_JOB":return E(j({},t),{activeJobId:r.payload.jobId,jobMetadata:r.payload.metadata,ocrText:r.payload.ocrText,ocrResult:r.payload.ocrResult,imageUrl:r.payload.imageUrl,normalizedText:null,entries:[],entryAreas:[],selectedEntryIndex:null,detectedLabels:[],labelCandidates:[],fieldValues:{},fieldExtractions:{},drafts:[],activeStep:0});case"SET_NORMALIZED_TEXT":return E(j({},t),{normalizedText:r.payload});case"SET_ENTRIES":return E(j({},t),{entries:r.payload});case"SET_ENTRY_AREAS":return E(j({},t),{entryAreas:r.payload});case"UPDATE_ENTRY_AREA":return E(j({},t),{entryAreas:t.entryAreas.map(s=>s.entryId===r.payload.entryId?E(j({},s),{bbox:r.payload.bbox}):s)});case"SET_SELECTED_ENTRY":return E(j({},t),{selectedEntryIndex:r.payload});case"SET_BBOX_EDIT_MODE":return E(j({},t),{bboxEditMode:r.payload});case"SET_DETECTED_LABELS":return E(j({},t),{detectedLabels:r.payload});case"SET_LABEL_CANDIDATES":return E(j({},t),{labelCandidates:r.payload});case"SET_FIELD_VALUE":return E(j({},t),{fieldValues:E(j({},t.fieldValues),{[r.payload.key]:{value:r.payload.value,confidence:r.payload.confidence,source:r.payload.source}})});case"SET_FIELD_VALUES":return E(j({},t),{fieldValues:r.payload});case"SET_FIELD_EXTRACTIONS":return E(j({},t),{fieldExtractions:r.payload});case"SET_DRAFTS":return E(j({},t),{drafts:r.payload});case"ADD_DRAFT":return E(j({},t),{drafts:[...t.drafts,r.payload]});case"UPDATE_DRAFT":return E(j({},t),{drafts:t.drafts.map((s,o)=>o===r.payload.index?j(j({},s),r.payload.draft):s)});case"SET_STEP_STATUS":return E(j({},t),{stepStatus:E(j({},t.stepStatus),{[r.payload.step]:j(j({},t.stepStatus[r.payload.step]),r.payload.status)})});case"SET_ACTIVE_STEP":return E(j({},t),{activeStep:r.payload});case"SET_PROCESSING":return E(j({},t),{isProcessing:r.payload});case"SET_ERROR":return E(j({},t),{error:r.payload});case"RESET":return wt;default:return t}}const jt=n.createContext(null),yr=({children:t})=>{const[r,s]=n.useReducer(gr,wt),o=n.useCallback((x,I,M,V,Y)=>{s({type:"SET_JOB",payload:{jobId:x,metadata:I,ocrText:M,ocrResult:V,imageUrl:Y}})},[]),h=n.useCallback(x=>{s({type:"SET_ENTRIES",payload:x})},[]),a=n.useCallback((x,I)=>{s({type:"UPDATE_ENTRY_AREA",payload:{entryId:x,bbox:I}})},[]),c=n.useCallback(x=>{s({type:"SET_SELECTED_ENTRY",payload:x})},[]),l=n.useCallback((x,I,M,V)=>{s({type:"SET_FIELD_VALUE",payload:{key:x,value:I,confidence:M,source:V}})},[]),u=n.useCallback(x=>{s({type:"SET_FIELD_VALUES",payload:x})},[]),p=n.useCallback(x=>{s({type:"SET_DRAFTS",payload:x})},[]),m=n.useCallback(x=>{s({type:"SET_ACTIVE_STEP",payload:x})},[]),y=n.useCallback(()=>{s({type:"RESET"})},[]),R=n.useMemo(()=>({state:r,dispatch:s,setJob:o,setEntries:h,updateEntryArea:a,setSelectedEntry:c,setFieldValue:l,setFieldValues:u,setDrafts:p,setActiveStep:m,reset:y}),[r,o,h,a,c,l,u,p,m,y]);return e.jsx(jt.Provider,{value:R,children:t})};function vt(){const t=n.useContext(jt);if(!t)throw new Error("useWorkbench must be used within WorkbenchProvider");return t}function br(t){return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim()}function wr(t){if(!t)return{type:null,confidence:0};const r=br(t),s=["marriage","marriages","брак","бракосочетание","бракосочетавшихся","groom","bride","wedding","жених","невеста","marry","married","wed","wedded","метрической книги","часть вторая"],o=["baptism","baptisms","крещение","крещений","child","infant","baby","ребенок","младенец","godparent","godparents","sponsor","sponsors","крестный","крестная","born","birth","рождение","родился","метрической книги","часть первая"],h=["funeral","funerals","похороны","погребение","death","died","deceased","death","смерть","умер","покойный","burial","buried","cemetery","погребение","кладбище","метрической книги","часть третья"];let a=0,c=0,l=0;for(const R of s){const x=new RegExp(`\\b${R}\\b`,"gi"),I=r.match(x);I&&(a+=I.length)}for(const R of o){const x=new RegExp(`\\b${R}\\b`,"gi"),I=r.match(x);I&&(c+=I.length)}for(const R of h){const x=new RegExp(`\\b${R}\\b`,"gi"),I=r.match(x);I&&(l+=I.length)}const u=a+c+l,p=Math.max(a,c,l);if(u===0)return{type:null,confidence:0};let m=null;a>c&&a>l?m="marriage":c>l?m="baptism":l>0&&(m="funeral");const y=u>0?Math.min(1,p/Math.max(1,u*.5)):0;return{type:m,confidence:y}}function St(t){if(!t)return null;const r=[/(?:year|год)[\s:]*(\d{2,4})/gi,/\b(19\d{2}|20\d{2})\b/,/\b(\d{2})\b(?=\s|$)/];for(const s of r){const o=t.match(s);if(o&&o.length>0){const h=o[0].match(/\d{2,4}/);if(h){let a=parseInt(h[0],10);if(a<100&&(a=a>50?1900+a:2e3+a),a>=1800&&a<=2100)return a}}}return null}function jr(t){const r=wr(t),s=St(t);return{recordType:r.type,year:s,confidence:r.confidence}}const vr=({job:t,onClose:r})=>{fe();const s=(t==null?void 0:t.original_filename)||(t==null?void 0:t.originalFilename)||(t==null?void 0:t.filename)||"Unknown",o=(t==null?void 0:t.status)||"",h=(t==null?void 0:t.record_type)||(t==null?void 0:t.recordType)||"baptism",a=(t==null?void 0:t.confidence_score)||(t==null?void 0:t.confidenceScore)||0,c=(t==null?void 0:t.ocr_text)||(t==null?void 0:t.ocrText)||null,l=n.useMemo(()=>{if(!c)return null;try{return St(c)}catch(m){return console.warn("[WorkbenchHeader] Failed to extract year:",m),null}},[c]),u=m=>{switch(m.toLowerCase()){case"completed":case"complete":return"success";case"processing":return"info";case"failed":case"error":return"error";default:return"default"}},p=m=>m>=.8?"success":m>=.5?"warning":"error";return e.jsx(de,{elevation:0,sx:{p:2,borderBottom:"1px solid",borderColor:"divider",bgcolor:"background.paper"},children:e.jsxs(Q,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(Q,{direction:"row",spacing:2,alignItems:"center",sx:{flex:1,minWidth:0},children:[e.jsx(k,{variant:"h6",fontWeight:600,noWrap:!0,sx:{flex:1,minWidth:0},children:s}),e.jsx(oe,{size:"small",label:h,color:"primary",sx:{textTransform:"capitalize"}}),l&&e.jsx(oe,{size:"small",label:`Year ${l}`,color:"info",variant:"outlined"}),e.jsx(oe,{size:"small",label:o,color:u(o),sx:{textTransform:"capitalize"}}),a>0&&e.jsx(oe,{size:"small",label:`${Math.round(a*100)}% confidence`,color:p(a)})]}),e.jsxs(Q,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(pe,{title:"Copy OCR Text",children:e.jsx(ye,{size:"small",children:e.jsx(ft,{size:18})})}),e.jsx(pe,{title:"Refresh",children:e.jsx(ye,{size:"small",children:e.jsx(Nt,{size:18})})}),e.jsx(pe,{title:"Close Workbench",children:e.jsx(ye,{size:"small",onClick:r,children:e.jsx(xt,{size:18})})})]})]})})};function Ct(t){if(!t)return null;const r=t.getBoundingClientRect(),s=t.naturalWidth||0,o=t.naturalHeight||0,h=r.width,a=r.height,c=s>0?h/s:1,l=o>0?a/o:1;return{left:r.left,top:r.top,width:h,height:a,naturalWidth:s,naturalHeight:o,scaleX:c,scaleY:l,clientRect:r}}function Sr(t,r,s){return{x:(t-s.left)/s.scaleX,y:(r-s.top)/s.scaleY}}function _t(t,r,s,o){let h=t;if(s&&o&&r.naturalWidth&&r.naturalHeight){const a=r.naturalWidth/s,c=r.naturalHeight/o;(Math.abs(a-1)>.01||Math.abs(c-1)>.01)&&(h={x:t.x*a,y:t.y*c,w:t.w*a,h:t.h*c})}return{x:r.left+h.x*r.scaleX,y:r.top+h.y*r.scaleY,w:h.w*r.scaleX,h:h.h*r.scaleY}}function dt(t,r){switch(t){case"nw":return{x:r.x,y:r.y};case"ne":return{x:r.x+r.w,y:r.y};case"sw":return{x:r.x,y:r.y+r.h};case"se":return{x:r.x+r.w,y:r.y+r.h};case"n":return{x:r.x+r.w/2,y:r.y};case"s":return{x:r.x+r.w/2,y:r.y+r.h};case"e":return{x:r.x+r.w,y:r.y+r.h/2};case"w":return{x:r.x,y:r.y+r.h/2};default:return{x:0,y:0}}}function ut(t){switch(t){case"nw":case"se":return"nwse-resize";case"ne":case"sw":return"nesw-resize";case"n":case"s":return"ns-resize";case"e":case"w":return"ew-resize";default:return"grab"}}function Cr({bbox:t,onBboxChange:r,onBboxChangeEnd:s,imageElement:o,visionWidth:h,visionHeight:a,minWidth:c=20,minHeight:l=20,disabled:u=!1,color:p="#4CAF50",label:m}){const y=fe(),R=n.useRef(null),[x,I]=n.useState(!1),[M,V]=n.useState(!1),[Y,P]=n.useState(null),[f,J]=n.useState(null),[C,i]=n.useState(null),[g,D]=n.useState(!1),[v,O]=n.useState(null),[_,b]=n.useState(null),T=10;n.useEffect(()=>{if(!o){b(null);return}const z=()=>{const W=Ct(o);b(W)};z(),o.addEventListener("load",z);const F=new ResizeObserver(()=>{z()}),$=o.parentElement;$&&F.observe($),F.observe(o);const N=new MutationObserver(()=>{z()});return N.observe(o,{attributes:!0,attributeFilter:["style"]}),()=>{o.removeEventListener("load",z),F.disconnect(),N.disconnect()}},[o]);const A=n.useMemo(()=>{var $,N;if(!_)return{x:0,y:0,w:0,h:0};const z=_t(t,_),F=(N=($=R.current)==null?void 0:$.parentElement)==null?void 0:N.getBoundingClientRect();return F?{x:z.x-(_.left-F.left),y:z.y-(_.top-F.top),w:z.w,h:z.h}:z},[t,_]),L=n.useCallback(z=>{const F=h,$=a;let N=Math.max(0,Math.min(z.x,F-c)),W=Math.max(0,Math.min(z.y,$-l)),be=Math.max(c,Math.min(z.w,F-N)),Se=Math.max(l,Math.min(z.h,$-W));return{x:N,y:W,w:be,h:Se}},[h,a,c,l]),G=n.useCallback((z,F)=>_?Sr(z,F,_):null,[_]),B=n.useCallback(z=>{var je,Te;if(u||!_)return;z.preventDefault(),z.stopPropagation(),z.currentTarget.setPointerCapture(z.pointerId);const $=(Te=(je=R.current)==null?void 0:je.parentElement)==null?void 0:Te.getBoundingClientRect();if(!$)return;const N=z.clientX-$.left,W=z.clientY-$.top,be=N-(_.left-$.left),Se=W-(_.top-$.top),Be=["nw","ne","sw","se","n","s","e","w"];for(const ae of Be){const xe=dt(ae,A);if(Math.sqrt(Math.pow(be-xe.x,2)+Math.pow(Se-xe.y,2))<T){P(ae),V(!0),i(t);const Ce=G(z.clientX,z.clientY);Ce&&J(Ce);return}}I(!0),i(t);const De=G(z.clientX,z.clientY);De&&J(De)},[u,A,t,G,T,_]),le=n.useCallback(z=>{if(!(u||!_)){if(g&&v){const F=G(z.clientX,z.clientY);if(!F)return;const $={x:Math.min(v.x,F.x),y:Math.min(v.y,F.y),w:Math.abs(F.x-v.x),h:Math.abs(F.y-v.y)};r(L($))}else if(x&&f&&C){const F=G(z.clientX,z.clientY);if(!F)return;const $=F.x-f.x,N=F.y-f.y,W=L({x:C.x+$,y:C.y+N,w:C.w,h:C.h});r(W)}else if(M&&Y&&f&&C){const F=G(z.clientX,z.clientY);if(!F)return;const $=F.x-f.x,N=F.y-f.y;let W=j({},C);switch(Y){case"nw":W.x=C.x+$,W.y=C.y+N,W.w=C.w-$,W.h=C.h-N;break;case"ne":W.y=C.y+N,W.w=C.w+$,W.h=C.h-N;break;case"sw":W.x=C.x+$,W.w=C.w-$,W.h=C.h+N;break;case"se":W.w=C.w+$,W.h=C.h+N;break;case"n":W.y=C.y+N,W.h=C.h-N;break;case"s":W.h=C.h+N;break;case"e":W.w=C.w+$;break;case"w":W.x=C.x+$,W.w=C.w-$;break}W.w<c&&(Y!=null&&Y.includes("w")&&(W.x=C.x+C.w-c),W.w=c),W.h<l&&(Y!=null&&Y.includes("n")&&(W.y=C.y+C.h-l),W.h=l),r(L(W))}}},[u,x,M,g,f,v,C,Y,r,L,c,l,_,G]),K=n.useCallback(z=>{z.currentTarget.releasePointerCapture(z.pointerId),(x||M||g)&&s&&t&&s(t),I(!1),V(!1),D(!1),P(null),J(null),O(null),i(null)},[x,M,g,t,s]);n.useCallback(z=>{if(u||!_)return;z.preventDefault(),z.stopPropagation(),z.currentTarget.setPointerCapture(z.pointerId);const $=G(z.clientX,z.clientY);$&&(D(!0),O($))},[u,_,G]);const H=x?"grabbing":M?ut(Y):u?"default":"grab";return e.jsxs(S,{ref:R,onPointerDown:B,onPointerMove:le,onPointerUp:K,sx:{position:"absolute",left:A.x,top:A.y,width:A.w,height:A.h,border:`2px solid ${p}`,bgcolor:u?"transparent":`${p}20`,cursor:H,pointerEvents:u?"none":"auto",zIndex:x||M?100:10,"&:hover":{borderColor:u?p:y.palette.primary.main}},children:[m&&e.jsx(S,{sx:{position:"absolute",top:-24,left:0,bgcolor:p,color:"white",px:.5,py:.25,fontSize:10,fontWeight:600,whiteSpace:"nowrap",pointerEvents:"none"},children:m}),!u&&e.jsx(e.Fragment,{children:["nw","ne","sw","se","n","s","e","w"].map(z=>{const F=dt(z,A);return e.jsx(S,{onPointerDown:$=>{$.preventDefault(),$.stopPropagation(),$.currentTarget.setPointerCapture($.pointerId),P(z),V(!0),i(t);const W=G($.clientX,$.clientY);W&&J(W)},sx:{position:"absolute",left:F.x-T/2,top:F.y-T/2,width:T,height:T,bgcolor:p,border:"1px solid white",borderRadius:"50%",cursor:ut(z),zIndex:101,pointerEvents:"all","&:hover":{bgcolor:y.palette.primary.main,transform:"scale(1.2)"}}},z)})})]})}const _r=({boxes:t=[],imageElement:r,visionWidth:s=0,visionHeight:o=0,showLabels:h=!0,hideCompleted:a=!1,onTokenClick:c,onTokenDoubleClick:l,ocrTokens:u=[],editMode:p=!1})=>{const m=fe(),y=n.useRef(null),R=n.useRef({x:0,y:0}),[x,I]=n.useState(null);n.useEffect(()=>{y.current},[p]);const M=n.useMemo(()=>!t||!Array.isArray(t)?[]:t,[t]),V=n.useMemo(()=>!u||!Array.isArray(u)?[]:u,[u]);n.useEffect(()=>{if(!r){I(null);return}const f=()=>{const g=Ct(r);I(g)};f(),r.addEventListener("load",f);const J=new ResizeObserver(()=>{f()}),C=r.parentElement;C&&J.observe(C),J.observe(r);const i=new MutationObserver(()=>{f()});return i.observe(r,{attributes:!0,attributeFilter:["style"]}),()=>{r.removeEventListener("load",f),J.disconnect(),i.disconnect()}},[r]);const Y=n.useCallback(f=>x?_t(f,x,s,o):{x:0,y:0,w:0,h:0},[x,s,o]);n.useLayoutEffect(()=>{var C;if(!x||!y.current){const i={x:0,y:0};R.current=i;return}const f=(C=y.current.parentElement)==null?void 0:C.getBoundingClientRect();if(!f){const i={x:0,y:0};R.current=i;return}const J={x:x.left-f.left,y:x.top-f.top};(R.current.x!==J.x||R.current.y!==J.y)&&(R.current=J)},[x]);const P=n.useMemo(()=>{var g,D,v,O,_,b;if(!x)return{position:"absolute",top:0,left:0,width:0,height:0};const f=(D=(g=R.current)==null?void 0:g.x)!=null?D:0,J=(O=(v=R.current)==null?void 0:v.y)!=null?O:0,C=(_=x.width)!=null?_:0,i=(b=x.height)!=null?b:0;return{position:"absolute",left:f,top:J,width:C,height:i}},[x]);return!x||M.length===0||x.width===0||x.height===0?e.jsx(S,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:5,pointerEvents:"none"},children:e.jsx(k,{variant:"caption",sx:{color:"text.secondary",fontSize:"0.75rem",opacity:.6},children:"No entries detected"})}):e.jsxs(S,{ref:y,sx:E(j({},P),{pointerEvents:"none",zIndex:5}),children:[M.map((f,J)=>{var G,B,le,K,H,z,F;if(!f||!f.bbox)return console.warn(`[FusionOverlay] Invalid box at index ${J}:`,f),null;const C=Y(f.bbox),i=(G=f.completed)!=null?G:!1,g=((B=f.selected)!=null?B:!1)||((le=f.emphasized)!=null?le:!1),D=g?3:2,v=f.color||m.palette.primary.main,O=i?m.palette.success.main:g?m.palette.primary.main:v,_=i?a?.85:.45:g?.15:.1,b=i?`rgba(0,0,0,${_})`:re(v,_);if(f.editable&&f.onBboxChange&&x)return e.jsx(Cr,{bbox:f.bbox,onBboxChange:f.onBboxChange,onBboxChangeEnd:f.onBboxChangeEnd,imageElement:r,visionWidth:s,visionHeight:o,color:O,label:f.label,disabled:!p},J);const T=(H=(K=R.current)==null?void 0:K.x)!=null?H:0,A=(F=(z=R.current)==null?void 0:z.y)!=null?F:0,L={x:C.x-T,y:C.y-A,w:C.w,h:C.h};return e.jsxs(S,{onClick:f.onClick,onDoubleClick:$=>{$.stopPropagation(),f.onClick&&f.onClick()},sx:{position:"absolute",left:L.x,top:L.y,width:L.w,height:L.h,border:`${D}px solid ${O}`,bgcolor:b,borderRadius:.5,transition:"background-color 300ms ease, border-color 300ms ease, opacity 300ms ease",pointerEvents:p&&f.onClick?"auto":"none",cursor:p&&f.onClick?"pointer":"default",boxShadow:g?`0 0 12px ${re(O,.5)}`:"none","&:hover":p&&f.onClick?{borderColor:m.palette.primary.light}:{}},children:[i&&e.jsx(S,{sx:{position:"absolute",top:4,left:4,bgcolor:m.palette.success.main,color:"white",px:.75,py:.25,borderRadius:.5,fontSize:10,fontWeight:700,display:"flex",alignItems:"center",gap:.5,boxShadow:m.shadows[2]},children:"✓ Completed"}),h&&f.label&&e.jsx(k,{variant:"caption",sx:{position:"absolute",top:i?28:-20,left:0,bgcolor:O,color:"white",px:.5,py:.25,borderRadius:.5,fontSize:10,fontWeight:600,whiteSpace:"nowrap",lineHeight:1.2,boxShadow:m.shadows[2]},children:f.label})]},J)}),V.map(f=>{var D,v,O,_;if(!f||!f.bbox)return null;const J=Y(f.bbox),C=(v=(D=R.current)==null?void 0:D.x)!=null?v:0,i=(_=(O=R.current)==null?void 0:O.y)!=null?_:0,g={x:J.x-C,y:J.y-i,w:J.w,h:J.h};return e.jsx(S,{onClick:b=>{b.stopPropagation(),c&&c(f.id,f.bbox,f.text)},onDoubleClick:b=>{b.stopPropagation(),l&&l(f.id,f.bbox,f.text)},sx:{position:"absolute",left:g.x,top:g.y,width:Math.max(g.w,10),height:Math.max(g.h,10),bgcolor:re(m.palette.info.main,.2),border:`1px solid ${re(m.palette.info.main,.5)}`,borderRadius:.5,pointerEvents:p||c||l?"auto":"none",cursor:p||c||l?"pointer":"default",zIndex:3,"&:hover":p||c||l?{bgcolor:re(m.palette.info.main,.4),borderColor:m.palette.info.main,borderWidth:2}:{}},title:`${f.text}${f.confidence?` (${Math.round(f.confidence*100)}%)`:""}`},f.id)})]})};function kt(t){if(!t||t.length<4)return{x:0,y:0,w:0,h:0};const r=t.map(l=>l.x||0),s=t.map(l=>l.y||0),o=Math.min(...r),h=Math.max(...r),a=Math.min(...s),c=Math.max(...s);return{x:o,y:a,w:h-o,h:c-a}}function kr(t){if(t.length===0)return{x:0,y:0,w:0,h:0};const r=Math.min(...t.map(a=>a.x)),s=Math.min(...t.map(a=>a.y)),o=Math.max(...t.map(a=>a.x+a.w)),h=Math.max(...t.map(a=>a.y+a.h));return{x:r,y:s,w:o-r,h:h-s}}function Er(t){var s;if(!t.symbols)return"";let r="";for(const o of t.symbols)if(r+=o.text||"",(s=o.property)!=null&&s.detectedBreak){const h=o.property.detectedBreak.type;(h==="SPACE"||h==="SURE_SPACE")&&(r+=" ")}return r}function Et(t,r,s,o,h=0){const a=Math.round(s.x),c=Math.round(s.y),l=Math.round(s.w),u=Math.round(s.h),p=r.trim().toLowerCase().replace(/\s+/g," ");return`${t}_p${h}_${a}_${c}_${l}_${u}_${p.slice(0,20)}_${o}`}function Rr(t,r,s=0){var a;const o=Er(t).trim(),h=kt((a=t.boundingBox)==null?void 0:a.vertices);return{id:Et("token",o,h,r,s),text:o,bbox:h,confidence:t.confidence}}function Tr(t,r,s=0){var l;const o=(t.words||[]).map((u,p)=>Rr(u,p,s)),h=o.map(u=>u.text).join(" "),a=o.filter(u=>u.bbox.w>0).map(u=>u.bbox),c=a.length>0?kr(a):kt((l=t.boundingBox)==null?void 0:l.vertices);return{id:Et("line",h,c,r,s),text:h,bbox:c,confidence:t.confidence,tokens:o}}function zr(t,r,s=0){return t.paragraphs?t.paragraphs.map((o,h)=>Tr(o,h,s)):[]}function Ir(t){var s;if(!((s=t==null?void 0:t.fullTextAnnotation)!=null&&s.pages))return[];const r=[];return t.fullTextAnnotation.pages.forEach((o,h)=>{(o.blocks||[]).forEach((a,c)=>{r.push(...zr(a,c,h))})}),r}function Mr(t){var s,o;if(!((o=(s=t==null?void 0:t.fullTextAnnotation)==null?void 0:s.pages)!=null&&o[0]))return{width:0,height:0};const r=t.fullTextAnnotation.pages[0];return{width:r.width||0,height:r.height||0}}const Or=({onTokenClick:t,onTokenDoubleClick:r})=>{var Y;fe();const s=vt(),o=n.useRef(null),[h,a]=n.useState(100),[c,l]=n.useState({width:0,height:0,naturalWidth:0,naturalHeight:0}),u=s.state.ocrResult,p=s.state.imageUrl,m=s.state.bboxEditMode,y=n.useMemo(()=>u?Mr(u):{width:0,height:0},[u]),R=n.useMemo(()=>{if(!u)return[];try{const P=Ir(u),f=[],J=1e4;for(const C of P){if(f.length>=J){console.warn("[WorkbenchViewer] Token limit reached, truncating overlay");break}if(C.tokens)for(const i of C.tokens){if(f.length>=J)break;i.id&&i.bbox&&i.bbox.w>0&&i.bbox.h>0&&f.push({id:i.id,text:i.text,bbox:i.bbox,confidence:i.confidence})}}return f}catch(P){return console.error("[WorkbenchViewer] Error parsing OCR tokens:",P),[]}},[u]),x=n.useCallback(()=>{a(P=>Math.min(P+25,300))},[]),I=n.useCallback(()=>{a(P=>Math.max(P-25,25))},[]),M=n.useCallback(()=>{a(100)},[]),V=n.useCallback((P,f)=>{a(f)},[]);return e.jsxs(S,{sx:{height:"100%",display:"flex",flexDirection:"column",position:"relative"},children:[e.jsxs(S,{sx:{position:"absolute",top:8,right:8,zIndex:10,display:"flex",alignItems:"center",gap:1,bgcolor:"background.paper",borderRadius:1,boxShadow:2,p:1},children:[e.jsx(pe,{title:"Zoom Out",children:e.jsx(ye,{size:"small",onClick:I,children:e.jsx(mr,{size:18})})}),e.jsx(Zt,{value:h,onChange:V,min:25,max:300,step:5,sx:{width:100},size:"small"}),e.jsx(pe,{title:"Zoom In",children:e.jsx(ye,{size:"small",onClick:x,children:e.jsx(Gt,{size:18})})}),e.jsx(pe,{title:"Fit to View",children:e.jsx(ye,{size:"small",onClick:M,children:e.jsx(dr,{size:18})})}),e.jsx(Jt,{size:"small",value:h,onChange:P=>{const f=parseInt(P.target.value,10);!isNaN(f)&&f>=25&&f<=300&&a(f)},InputProps:{endAdornment:e.jsx(Ht,{position:"end",children:"%"})},sx:{width:70}})]}),e.jsx(S,{sx:j({flex:1,overflow:"auto",display:"flex",alignItems:"flex-start",justifyContent:"center",p:2},m&&{overflow:"hidden",touchAction:"none",userSelect:"none"}),children:p&&e.jsxs(S,{sx:{position:"relative",display:"inline-block",overflow:"hidden"},children:[e.jsx("img",{ref:o,src:p||"",alt:((Y=s.state.jobMetadata)==null?void 0:Y.filename)||"OCR Image",style:{maxWidth:"100%",width:"auto",height:"auto",objectFit:"contain",display:"block",transform:`scale(${h/100})`,transformOrigin:"top left",pointerEvents:"auto"},onLoad:P=>{const f=P.currentTarget;l({width:f.clientWidth,height:f.clientHeight,naturalWidth:f.naturalWidth,naturalHeight:f.naturalHeight})},onError:P=>{console.error("[WorkbenchViewer] Failed to load image:",p),console.error("[WorkbenchViewer] Image error:",P)}}),o.current&&e.jsx(_r,{boxes:s.state.entryAreas.map((P,f)=>{const C=s.state.entries.findIndex(i=>i.id===P.entryId)===s.state.selectedEntryIndex;return{bbox:P.bbox,label:P.label||`Entry ${f+1}`,color:`hsl(${f*60%360}, 70%, 50%)`,selected:C,editable:m&&C,onBboxChange:m&&C?i=>s.updateEntryArea(P.entryId,i):void 0,onBboxChangeEnd:m&&C?()=>{console.log("[WorkbenchViewer] Bbox change ended for",P.entryId)}:void 0}}),imageElement:o.current,visionWidth:y.width||c.naturalWidth||0,visionHeight:y.height||c.naturalHeight||0,showLabels:!0,ocrTokens:R,onTokenClick:t,onTokenDoubleClick:r,editMode:m})]})})]})},Dr=({jobs:t,loading:r,error:s,onJobSelect:o,onRefresh:h,onDeleteJobs:a,churchId:c})=>{fe();const[l,u]=n.useState(new Set),[p,m]=n.useState(20),[y,R]=n.useState("added"),[x,I]=n.useState("desc"),M=n.useMemo(()=>[...t].sort((g,D)=>{let v=0;if(y==="added"){const O=g.created_at?new Date(g.created_at).getTime():0,_=D.created_at?new Date(D.created_at).getTime():0;v=O-_}else if(y==="filename"){const O=(g.original_filename||"").toLowerCase(),_=(D.original_filename||"").toLowerCase();v=O.localeCompare(_)}return x==="asc"?v:-v}).slice(0,p),[t,y,x,p]),V=n.useCallback(i=>{if(!i)return 6;const g=new Date(i),v=Math.floor((new Date().getTime()-g.getTime())/(1e3*60*60*24));return Math.max(0,6-v)},[]),Y=n.useCallback(i=>{if(!i)return"-";const g=new Date(i),v=new Date().getTime()-g.getTime(),O=Math.floor(v/(1e3*60)),_=Math.floor(v/(1e3*60*60)),b=Math.floor(v/(1e3*60*60*24));return O<60?`${O} minute${O!==1?"s":""} ago`:_<24?`${_} hour${_!==1?"s":""} ago`:`${b} day${b!==1?"s":""} ago`},[]),P=n.useCallback(i=>{u(g=>{const D=new Set(g);return D.has(i)?D.delete(i):D.add(i),D})},[]),f=n.useCallback(()=>{l.size===M.length?u(new Set):u(new Set(M.map(i=>i.id)))},[M,l.size]),J=i=>{switch(i==null?void 0:i.toLowerCase()){case"completed":case"complete":return"success";case"processing":return"info";case"failed":case"error":return"error";case"queued":return"default";default:return"default"}},C=n.useCallback(i=>{y===i?I(x==="asc"?"desc":"asc"):(R(i),I("desc"))},[y,x]);return e.jsxs(de,{variant:"outlined",sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs(S,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(Ee,{size:"small",sx:{minWidth:120},children:e.jsxs(Re,{value:p,onChange:i=>m(Number(i.target.value)),sx:{"& .MuiSelect-select":{py:1,display:"flex",alignItems:"center"}},children:[e.jsx(se,{value:10,children:"10 per page"}),e.jsx(se,{value:20,children:"20 per page"}),e.jsx(se,{value:50,children:"50 per page"}),e.jsx(se,{value:100,children:"100 per page"})]})}),e.jsxs(Q,{direction:"row",spacing:1,children:[e.jsx(pe,{title:"Delete Selected",children:e.jsx("span",{children:e.jsx(ye,{size:"small",disabled:l.size===0,onClick:()=>{a&&l.size>0&&(a(Array.from(l)),u(new Set))},sx:{opacity:l.size===0?.5:1,color:l.size===0?"text.disabled":"text.secondary"},children:e.jsx(qe,{size:18})})})}),e.jsx(pe,{title:"Download Selected",children:e.jsx("span",{children:e.jsx(we,{size:"small",variant:"outlined",startIcon:e.jsx(yt,{size:16}),disabled:l.size===0,sx:{opacity:l.size===0?.5:1},children:"Download"})})})]})]}),e.jsx(qt,{sx:{flex:1,overflow:"auto"},children:e.jsxs(Qt,{stickyHeader:!0,children:[e.jsx(Kt,{children:e.jsxs(We,{children:[e.jsx(he,{padding:"checkbox",sx:{width:50},children:e.jsx(lt,{checked:M.length>0&&l.size===M.length,indeterminate:l.size>0&&l.size<M.length,onChange:f})}),e.jsx(he,{sx:{cursor:"pointer",userSelect:"none",textDecoration:y==="filename"?"underline":"none",textDecorationStyle:"dotted"},onClick:()=>C("filename"),children:e.jsxs(Q,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx("span",{children:"File name"}),y==="filename"&&(x==="asc"?e.jsx(Le,{size:16}):e.jsx(Fe,{size:16}))]})}),e.jsx(he,{children:"Pages"}),e.jsx(he,{sx:{cursor:"pointer",userSelect:"none",textDecoration:y==="added"?"underline":"none",textDecorationStyle:"dotted"},onClick:()=>C("added"),children:e.jsxs(Q,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx("span",{children:"Added"}),y==="added"&&(x==="asc"?e.jsx(Le,{size:16}):e.jsx(Fe,{size:16}))]})}),e.jsx(he,{children:"Status"})]})}),e.jsx(er,{children:r?e.jsx(We,{children:e.jsx(he,{colSpan:5,align:"center",sx:{py:4},children:e.jsx(et,{})})}):M.length===0?e.jsx(We,{children:e.jsx(he,{colSpan:5,align:"center",sx:{py:4},children:e.jsx(k,{variant:"body2",color:"text.secondary",children:t.length===0?"No processed images yet":"No jobs to display"})})}):M.map(i=>{const g=V(i.created_at),D=i.status==="completed"||i.status==="complete";return e.jsxs(We,{hover:!0,sx:{cursor:"pointer"},onClick:()=>D&&o(i.id),children:[e.jsx(he,{padding:"checkbox",onClick:v=>v.stopPropagation(),children:e.jsx(lt,{checked:l.has(i.id),onChange:()=>P(i.id)})}),e.jsx(he,{children:e.jsx(k,{variant:"body2",noWrap:!0,sx:{maxWidth:400},children:i.original_filename||"Unknown"})}),e.jsx(he,{children:e.jsx(k,{variant:"body2",color:"text.secondary",children:i.pages||1})}),e.jsx(he,{children:e.jsx(k,{variant:"body2",color:"text.secondary",children:Y(i.created_at)})}),e.jsx(he,{children:e.jsxs(Q,{direction:"row",spacing:1,alignItems:"center",children:[D&&e.jsxs(e.Fragment,{children:[e.jsx(oe,{size:"small",label:"Processed",color:"success",sx:{height:24,fontSize:"0.75rem"}}),e.jsxs(Q,{direction:"row",spacing:.5,alignItems:"center",sx:{color:"text.secondary"},children:[e.jsx(qe,{size:14}),e.jsxs(k,{variant:"caption",children:[g," day",g!==1?"s":""]})]}),e.jsx(we,{size:"small",variant:"outlined",onClick:v=>{v.stopPropagation(),o(i.id)},sx:{ml:1,minWidth:60,height:28,fontSize:"0.75rem",textTransform:"none"},children:"Open"})]}),!D&&e.jsx(oe,{size:"small",label:i.status||"Processing",color:J(i.status||""),sx:{height:24,fontSize:"0.75rem",textTransform:"capitalize"}})]})})]},i.id)})})]})})]})};function Me(t){return t?t.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\n{3,}/g,`

`).split(`
`).map(r=>r.trim()).join(`
`).trim():""}function Ar(t){var o;if(!((o=t==null?void 0:t.fullTextAnnotation)!=null&&o.pages))return"";const r=[],s=t.fullTextAnnotation.pages||[];return s.forEach((h,a)=>{const c=h.blocks||[];c.forEach((l,u)=>{(l.paragraphs||[]).forEach((m,y)=>{const x=(m.words||[]).map(I=>(I.symbols||[]).map(V=>{var f;const Y=V.text||"",P=(f=V.property)==null?void 0:f.detectedBreak;return Y+((P==null?void 0:P.type)==="LINE_BREAK"||(P==null?void 0:P.type)==="EOL_SURE_SPACE"?`
`:"")}).join("")).filter(I=>I.trim().length>0).join(" ").trim();if(x){const I=x.split(`
`).map(M=>M.trim()).filter(M=>M.length>0);r.push(...I)}}),u<c.length-1&&r.length>0&&r[r.length-1]&&r.push("")}),a<s.length-1&&r.length>0&&r[r.length-1]&&r.push("")}),r.join(`
`)}function Ge(t){var r,s;if(!t)return"";if((r=t.fullTextAnnotation)!=null&&r.pages){const o=Ar(t);if(o.trim().length>0)return Me(o)}if((s=t.fullTextAnnotation)!=null&&s.text)return Me(t.fullTextAnnotation.text);if(t.textAnnotations&&t.textAnnotations.length>0){const o=t.textAnnotations[0].description||"";return Me(o)}return""}function ht(t){return t.length<3||t.length>50?!1:/^[A-ZА-ЯЁ][a-zа-яё\s\-']+$/.test(t.trim())}function pt(t){return[/\d{1,2}\s+(Января|Февраля|Марта|Апреля|Мая|Июня|Июля|Августа|Сентября|Октября|Ноября|Декабря|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i,/(род|крещ|родился|baptized|born|date).*\d{4}/i,/\d{1,2}[,\s]+\d{4}/,/[A-Z]{3}\.\s+\d{1,2},\s+\d{4}/].some(s=>s.test(t))}function Pr(t){const r=["notification of marriage","baptism","marriage","funeral","крещение","брак","погребение"],s=t.toLowerCase();return r.some(o=>s.includes(o))||/^[A-ZА-ЯЁ\s]+$/.test(t)&&t.length<40}function Rt(t){if(!t)return"";const r=t.split(`
`).map(c=>c.trim()).filter(c=>c.length>0);if(r.length===0)return"";const s=[];for(let c=0;c<r.length;c++){const l=r[c],u=c>0?r[c-1]:null,p=c<r.length-1?r[c+1]:null,m=ht(l),y=pt(l),R=Pr(l),x=l.length<25;if(l.length>70,R&&u&&u.length>10&&s.length>0&&s[s.length-1]&&s.push(""),m&&u&&(pt(u)||u.length>60)&&s.length>0&&s[s.length-1]&&s.push(""),y&&p&&ht(p)){s.push(l),p&&s.push("");continue}if(x&&!m&&!y&&p&&p.length>40){s.push(l),s.push("");continue}s.push(l)}let o=s.join(`
`);o=o.replace(/\n{3,}/g,`

`),o=o.replace(/^\n+/,"").replace(/\n+$/,"");const h=o.split(`
`),a=[];for(let c=0;c<h.length;c++){const l=h[c],u=c>0?h[c-1]:"";if(l.trim().length===0){a.length>0&&a[a.length-1]&&a.push("");continue}/^[A-ZА-ЯЁ]/.test(l)&&l.length<50&&u&&u.trim().length>0&&!u.match(/^[A-ZА-ЯЁ]/)&&a.length>0&&a[a.length-1]&&a.push(""),a.push(l)}return a.join(`
`).trim()}function Ke(){if(typeof window!="undefined"){const t=localStorage.getItem("OCR_NORMALIZE_SERVER");if(t!==null)return t==="1"||t==="true"}return!1}function $r(o,h){return te(this,arguments,function*(t,r,s={}){var a;try{const c=yield ue.post(`/api/church/${t}/ocr/jobs/${r}/normalize`,{settings:s});return((a=c==null?void 0:c.data)!=null?a:c).transcription||null}catch(c){return console.warn("[useServerNormalization] Server normalization failed:",c),null}})}function He(t){if(!t)return"";try{const r=Me(t);return Rt(r)}catch(r){return console.error("[useServerNormalization] Client normalization failed:",r),t||""}}function Wr(){const[t,r]=n.useState(!1),[s,o]=n.useState(null),[h,a]=n.useState(null);return{normalize:n.useCallback((y,R,x,...I)=>te(this,[y,R,x,...I],function*(l,u,p,m={}){if(!Ke())return He(p);if(!p)return"";r(!0),a(null);try{const M=yield $r(l,u,m);if(M&&M.text)return o(M.text),M.text;{console.warn("[useServerNormalization] Server returned empty result, using client fallback");const V=He(p);return o(null),V}}catch(M){console.error("[useServerNormalization] Normalization error:",M),a(M.message||"Normalization failed");const V=He(p);return o(null),V}finally{r(!1)}}),[]),normalizing:t,serverNormalized:s,error:h,isEnabled:Ke()}}const Lr=({ocrText:t,serverNormalizedText:r,loading:s=!1,normalizing:o=!1,onCopy:h,onDownload:a,onNormalize:c})=>{const l=Ke(),u=n.useMemo(()=>{if(l&&r)return r;if(!t)return"";try{const y=Me(t);return Rt(y)}catch(y){return console.error("[TranscriptionPanel] Error normalizing text:",y),t}},[t,r,l]),p=()=>{u&&(navigator.clipboard.writeText(u),h&&h())},m=()=>{if(u){const y=new Blob([u],{type:"text/plain"}),R=URL.createObjectURL(y),x=document.createElement("a");x.href=R,x.download="transcription.txt",document.body.appendChild(x),x.click(),document.body.removeChild(x),URL.revokeObjectURL(R),a&&a()}};return e.jsxs(de,{elevation:0,sx:{height:"100%",display:"flex",flexDirection:"column",border:"1px solid",borderColor:"divider",borderRadius:2,overflow:"hidden"},children:[e.jsxs(S,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(k,{variant:"h6",fontWeight:600,children:"Transcription"}),e.jsxs(Q,{direction:"row",spacing:.5,alignItems:"center",children:[l&&c&&e.jsx(pe,{title:"Normalize transcription (server-side)",children:e.jsx(we,{size:"small",variant:"outlined",startIcon:o?e.jsx(Oe,{size:14}):e.jsx(tr,{size:16}),onClick:c,disabled:!t||s||o,sx:{mr:1},children:o?"Normalizing...":"Normalize"})}),e.jsx(pe,{title:"Copy transcription",children:e.jsx(ye,{size:"small",onClick:p,disabled:!u||s,children:e.jsx(ft,{size:18})})}),e.jsx(pe,{title:"Download transcription",children:e.jsx(ye,{size:"small",onClick:m,disabled:!u||s,children:e.jsx(yt,{size:18})})})]})]}),e.jsx(S,{sx:{flex:1,overflow:"auto",p:3,bgcolor:"background.default"},children:s?e.jsx(k,{variant:"body2",color:"text.secondary",children:"Processing..."}):u?e.jsx(k,{variant:"body1",component:"pre",sx:{fontFamily:"inherit",whiteSpace:"pre-wrap",wordBreak:"break-word",lineHeight:1.6,color:"text.primary",margin:0},children:u}):e.jsx(k,{variant:"body2",color:"text.secondary",children:"No transcription available. Process a document to see OCR text."})})]})},Fr=({churchId:t,initialJobId:r})=>{var v,O,_,b;fe();const s=vt(),{normalize:o,normalizing:h}=Wr(),[a,c]=n.useState(null),l=n.useMemo(()=>{if(typeof window=="undefined")return!1;const T=localStorage.getItem("OCR_NORMALIZE_SERVER");return T==="1"||T==="true"},[a]),[u,p]=n.useState({open:!1,message:"",severity:"info"}),m=n.useCallback((T,A="info")=>{p({open:!0,message:T,severity:A})},[]),[y,R]=n.useState(r||null),{jobs:x,loading:I,error:M,refresh:V,fetchJobDetail:Y,deleteJobs:P}=bt({churchId:t});n.useEffect(()=>{if(!t)return;V();const T=setInterval(()=>{V()},5e3);return()=>clearInterval(T)},[t,V]);const f=n.useMemo(()=>y&&x.find(T=>T.id===y)||null,[x,y]);n.useEffect(()=>{if(!y||!t){y||s.reset();return}te(void 0,null,function*(){try{const A=yield Y(y);if(!A){s.dispatch({type:"SET_ERROR",payload:"Job not found"});return}let L=null;try{A.ocr_result_json?L=typeof A.ocr_result_json=="string"?JSON.parse(A.ocr_result_json):A.ocr_result_json:A.ocrResultJson&&(L=typeof A.ocrResultJson=="string"?JSON.parse(A.ocrResultJson):A.ocrResultJson)}catch(K){console.warn("[OcrWorkbench] Failed to parse OCR result:",K)}const G=t&&y?`/api/church/${t}/ocr/jobs/${y}/image`:null;let B=A.ocr_text||A.ocrText||null;!B&&L&&(B=Ge(L));let le=A.record_type||A.recordType||"baptism";if(B)try{const K=jr(B);K&&K.recordType&&K.confidence>.5&&(le=K.recordType,console.log("[OcrWorkbench] Auto-detected record type:",K.recordType,"confidence:",K.confidence),K.year&&console.log("[OcrWorkbench] Auto-detected year:",K.year))}catch(K){console.warn("[OcrWorkbench] Failed to auto-detect record type:",K)}s.setJob(y,{filename:A.original_filename||A.originalFilename||"Unknown",recordType:le,status:A.status||"unknown",confidence:A.confidence_score||A.confidenceScore||0,churchId:t},B,L,G)}catch(A){console.error("[OcrWorkbench] Failed to load job data:",A),s.dispatch({type:"SET_ERROR",payload:"Failed to load job data"})}})},[y,t]);const J=n.useCallback(T=>{R(T),s.dispatch({type:"SET_ACTIVE_STEP",payload:0}),s.dispatch({type:"SET_ERROR",payload:null})},[s]),C=n.useCallback(T=>te(void 0,null,function*(){if(!confirm(`Delete ${T.length} job(s)? This cannot be undone.`))return;(yield P(T))&&(y&&T.includes(y)&&(R(null),s.reset()),yield V())}),[P,V,y,s]),i=n.useCallback(()=>{R(null),s.reset(),c(null)},[s]);n.useEffect(()=>(a?window.__workbenchState={normalizedText:a}:delete window.__workbenchState,()=>{delete window.__workbenchState}),[a]);const g=n.useCallback(()=>te(void 0,null,function*(){if(!y||!t)return;const T=s.state.ocrText||(s.state.ocrResult?Ge(s.state.ocrResult):null);if(!T){m("No OCR text available to normalize","warning");return}let A={transcriptionMode:"exact",textExtractionScope:"all",formattingMode:"improve-formatting",confidenceThreshold:.35};try{const L=sessionStorage.getItem("om.ocr.docSettings");if(L){const G=JSON.parse(L);A=j(j({},A),G)}}catch(L){console.warn("[OcrWorkbench] Failed to load doc settings:",L)}try{const L=yield o(t,y,T,A);c(L),s.dispatch({type:"SET_NORMALIZED_TEXT",payload:L}),m("Transcription normalized successfully","success")}catch(L){console.error("[OcrWorkbench] Normalization failed:",L),m("Normalization failed, using client-side formatting","warning"),c(null),s.dispatch({type:"SET_NORMALIZED_TEXT",payload:null})}}),[y,t,s,o,m]),D=y&&s.state.jobMetadata;return e.jsx(S,{sx:{height:"100%",display:"flex",flexDirection:"column",overflow:"hidden"},children:D?e.jsxs(S,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[e.jsx(vr,{job:E(j({},f||{id:y,original_filename:((v=s.state.jobMetadata)==null?void 0:v.filename)||"Unknown",record_type:((O=s.state.jobMetadata)==null?void 0:O.recordType)||"baptism",status:((_=s.state.jobMetadata)==null?void 0:_.status)||"unknown",confidence_score:((b=s.state.jobMetadata)==null?void 0:b.confidence)||0}),{ocr_text:s.state.ocrText||null}),onClose:i}),e.jsxs(S,{sx:{flex:1,display:"flex",overflow:"hidden"},children:[e.jsx(S,{sx:{width:"50%",borderRight:"1px solid",borderColor:"divider",overflow:"hidden"},children:e.jsx(Or,{})}),e.jsx(S,{sx:{width:"50%",overflow:"hidden",p:2},children:e.jsx(Lr,{ocrText:s.state.ocrText||(s.state.ocrResult?Ge(s.state.ocrResult):null),serverNormalizedText:a,loading:!s.state.ocrResult&&!s.state.ocrText,normalizing:h,onCopy:()=>m("Copied to clipboard","success"),onDownload:()=>m("Transcription downloaded","success"),onNormalize:l?g:void 0})})]}),e.jsx(mt,{open:u.open,autoHideDuration:3500,onClose:()=>p(E(j({},u),{open:!1})),anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(Je,{onClose:()=>p(E(j({},u),{open:!1})),severity:u.severity,variant:"filled",sx:{width:"100%"},children:u.message})})]}):e.jsxs(S,{sx:{height:"100%",display:"flex",flexDirection:"column",p:2},children:[e.jsx(k,{variant:"h5",fontWeight:600,gutterBottom:!0,children:"OCR Jobs"}),e.jsx(Dr,{jobs:x,loading:I,error:M,onJobSelect:J,onRefresh:V,onDeleteJobs:C,churchId:t})]})})},Nr={selections:{}};function Jr(t,r){var s;switch(r.type){case"SET_SELECTION":return E(j({},t),{selections:E(j({},t.selections),{[r.jobId]:r.items})});case"ADD_SELECTION":{const h=t.selections[r.jobId]||[];return h.some(a=>a.id===r.item.id)?t:E(j({},t),{selections:E(j({},t.selections),{[r.jobId]:[...h,r.item]})})}case"REMOVE_SELECTION":{const h=t.selections[r.jobId]||[];return E(j({},t),{selections:E(j({},t.selections),{[r.jobId]:h.filter(a=>a.id!==r.itemId)})})}case"CLEAR_SELECTION":{const o=t.selections,{[s=r.jobId]:h}=o,a=it(o,[at(s)]);return E(j({},t),{selections:a})}case"CLEAR_ALL":return E(j({},t),{selections:{}});default:return t}}const Br=n.createContext(null);function Ur({children:t}){const[r,s]=n.useReducer(Jr,Nr),o=n.useCallback(p=>r.selections[p]||[],[r]),h=n.useCallback((p,m)=>{s({type:"SET_SELECTION",jobId:p,items:m})},[]),a=n.useCallback((p,m)=>{s({type:"ADD_SELECTION",jobId:p,item:m})},[]),c=n.useCallback((p,m)=>{s({type:"REMOVE_SELECTION",jobId:p,itemId:m})},[]),l=n.useCallback(p=>{s({type:"CLEAR_SELECTION",jobId:p})},[]),u=n.useCallback(()=>{s({type:"CLEAR_ALL"})},[]);return e.jsx(Br.Provider,{value:{getSelection:o,setSelection:h,addSelection:a,removeSelection:c,clearSelection:l,clearAll:u},children:t})}function Vr({children:t}){const r=Bt(),[s]=gt(),o=parseInt(s.get("church_id")||"46"),[h,a]=n.useState(null),[c,l]=n.useState(!0),[u,p]=n.useState(0);n.useEffect(()=>{m()},[o]);const m=()=>te(this,null,function*(){try{const y=yield fetch(`/api/church/${o}/ocr/setup-state`);if(y.ok){const R=yield y.json();a(R.isComplete),p(R.percentComplete||0)}else a(!1)}catch(y){console.error("Failed to check setup status:",y),a(!1)}finally{l(!1)}});return c?e.jsxs(S,{sx:{display:"flex",flexDirection:"column",alignItems:"center",p:4},children:[e.jsx(Oe,{}),e.jsx(k,{variant:"body2",sx:{mt:2},children:"Checking setup status..."})]}):h?e.jsx(e.Fragment,{children:t}):e.jsxs(S,{sx:{p:3,maxWidth:600,mx:"auto"},children:[e.jsxs(Je,{severity:"warning",sx:{mb:2},children:[e.jsx(k,{variant:"h6",gutterBottom:!0,children:"OCR Setup Required"}),e.jsx(k,{variant:"body2",gutterBottom:!0,children:"Enhanced OCR Uploader requires completing the setup wizard first."}),u>0&&e.jsxs(k,{variant:"body2",color:"text.secondary",sx:{mt:1},children:["Setup Progress: ",u,"%"]})]}),e.jsx(we,{variant:"contained",startIcon:e.jsx(Ut,{}),onClick:()=>r(`/devel/ocr-setup-wizard?church_id=${o}`),size:"large",children:"Complete OCR Setup"})]})}const Yr=t=>t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(1)} KB`:`${(t/(1024*1024)).toFixed(2)} MB`,Xr=()=>Math.random().toString(36).substring(2,11),Zr=({status:t})=>{const r=fe(),s={queued:{label:"Queued",color:r.palette.grey[500],icon:e.jsx(lr,{size:14})},uploading:{label:"Uploading",color:r.palette.info.main,icon:e.jsx(Oe,{size:14,sx:{color:"inherit"}})},processing:{label:"Processing",color:r.palette.warning.main,icon:e.jsx(Oe,{size:14,sx:{color:"inherit"}})},complete:{label:"Complete",color:r.palette.success.main,icon:e.jsx(ir,{size:14})},error:{label:"Error",color:r.palette.error.main,icon:e.jsx(ar,{size:14})}},{label:o,color:h,icon:a}=s[t];return e.jsx(oe,{size:"small",label:o,icon:e.jsx(S,{sx:{display:"flex",color:"inherit"},children:a}),sx:{bgcolor:re(h,.1),color:h,borderColor:re(h,.3),border:"1px solid",fontWeight:500,fontSize:"0.75rem","& .MuiChip-icon":{color:"inherit"}}})},Gr=({type:t})=>{const r=fe(),s={baptism:r.palette.primary.main,marriage:"#9c27b0",funeral:r.palette.grey[700]};return e.jsx(oe,{size:"small",label:t.charAt(0).toUpperCase()+t.slice(1),sx:{bgcolor:re(s[t],.1),color:s[t],fontWeight:600,fontSize:"0.7rem",textTransform:"capitalize"}})},Hr=({file:t,isSelected:r,onRecordTypeChange:s,onRemove:o,onRetry:h,onSelect:a})=>{const c=fe(),l=t.status==="complete"&&a;return e.jsx(de,{elevation:0,onClick:()=>l&&a(t.id),sx:{p:2,mb:1.5,border:"2px solid",borderColor:r?"primary.main":t.status==="error"?"error.light":"divider",borderRadius:2,bgcolor:r?re(c.palette.primary.main,.05):t.status==="error"?re(c.palette.error.main,.02):"background.paper",transition:"all 0.2s ease",cursor:l?"pointer":"default","&:hover":{boxShadow:c.shadows[2],borderColor:r?"primary.dark":t.status==="error"?"error.main":"primary.light"}},children:e.jsxs(S,{sx:{display:"flex",alignItems:"flex-start",gap:2},children:[e.jsx(S,{sx:{width:64,height:64,borderRadius:1.5,bgcolor:"action.hover",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",flexShrink:0,border:"1px solid",borderColor:"divider"},children:t.thumbnail?e.jsx("img",{src:t.thumbnail,alt:t.name,style:{width:"100%",height:"100%",objectFit:"cover"}}):e.jsx(Qe,{size:24,color:c.palette.grey[400]})}),e.jsxs(S,{sx:{flex:1,minWidth:0},children:[e.jsx(k,{variant:"body2",fontWeight:600,noWrap:!0,title:t.name,children:t.name}),e.jsx(k,{variant:"caption",color:"text.secondary",children:Yr(t.size)}),e.jsxs(Q,{direction:"row",spacing:1,sx:{mt:1},alignItems:"center",flexWrap:"wrap",children:[e.jsx(Gr,{type:t.recordType}),t.isSimulation&&e.jsx(oe,{label:"SIMULATION",size:"small",color:"info",sx:{fontSize:"0.7rem",height:20,fontWeight:600}}),e.jsx(Ee,{size:"small",sx:{minWidth:100},children:e.jsxs(Re,{value:t.recordType,onChange:u=>s(t.id,u.target.value),disabled:t.status!=="queued",sx:{height:28,fontSize:"0.75rem","& .MuiSelect-select":{py:.5}},children:[e.jsx(se,{value:"baptism",children:"Baptism"}),e.jsx(se,{value:"marriage",children:"Marriage"}),e.jsx(se,{value:"funeral",children:"Funeral"})]})})]}),(t.status==="uploading"||t.status==="processing")&&e.jsxs(S,{sx:{mt:1.5},children:[e.jsx(et,{variant:"determinate",value:t.progress,sx:{height:6,borderRadius:3,bgcolor:re(c.palette.primary.main,.1),"& .MuiLinearProgress-bar":{borderRadius:3,transition:"transform 0.3s ease"}}}),e.jsxs(k,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:[t.progress,"%"]})]}),t.status==="error"&&t.error&&e.jsx(Je,{severity:"error",sx:{mt:1,py:0,"& .MuiAlert-message":{fontSize:"0.75rem"}},action:e.jsx(we,{size:"small",onClick:()=>h(t.id),startIcon:e.jsx(fr,{size:14}),children:"Retry"}),children:t.error})]}),e.jsxs(S,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Zr,{status:t.status}),e.jsx(ye,{size:"small",onClick:()=>o(t.id),disabled:t.status==="uploading"||t.status==="processing",sx:{color:"text.secondary"},children:e.jsx(xt,{size:18})})]})]})})},qr=({total:t,completed:r,processing:s})=>{const o=fe(),h=t>0?Math.round(r/t*100):0;return e.jsxs(de,{elevation:3,sx:{p:2,bgcolor:"background.paper",borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsxs(Q,{direction:"row",alignItems:"center",spacing:2,children:[s&&e.jsx(Oe,{size:20,sx:{color:"primary.main"}}),e.jsx(k,{variant:"subtitle2",fontWeight:600,children:"Batch Progress"}),e.jsxs(k,{variant:"body2",color:"text.secondary",sx:{ml:"auto"},children:[r," of ",t]})]}),e.jsx(et,{variant:"determinate",value:h,sx:{mt:1.5,height:10,borderRadius:5,bgcolor:re(o.palette.primary.main,.1),"& .MuiLinearProgress-bar":{borderRadius:5,background:`linear-gradient(90deg, ${o.palette.primary.main} 0%, ${o.palette.secondary.main} 100%)`}}}),e.jsxs(Q,{direction:"row",justifyContent:"space-between",sx:{mt:1},children:[e.jsxs(k,{variant:"caption",color:"text.secondary",children:[r," images processed"]}),e.jsxs(k,{variant:"caption",color:"primary.main",fontWeight:600,children:[h,"%"]})]})]})},Ss=()=>{const t=fe(),{user:r,isSuperAdmin:s}=Vt(),[o,h]=gt(),a=n.useRef(null),c=d=>{if(d==null||d==="")return null;const w=typeof d=="string"?parseInt(d,10):Number(d);return!isNaN(w)&&w>0?w:null},l=c(o.get("church_id")),u=o.get("ocr_mode"),[p,m]=n.useState([]),[y,R]=n.useState([]),[x,I]=n.useState(l),[M,V]=n.useState(!1),[Y,P]=n.useState(!1),[f,J]=n.useState(!1),[C,i]=n.useState(!1),[g,D]=n.useState(u==="simulate"),v=x===46,[O,_]=n.useState(!1),[b,T]=n.useState(null),[A,L]=n.useState(null),[G,B]=n.useState(!1),[le,K]=n.useState(!1),[H,z]=n.useState(void 0),{refresh:F,fetchJobDetail:$}=bt({churchId:x}),[N,W]=n.useState({engine:"Google Vision",dpi:300,confidenceThreshold:85,autoDetectLanguage:!0,forceGrayscale:!1,deskewImages:!0,language:"en"}),[be,Se]=n.useState(()=>{try{const d=sessionStorage.getItem("om.ocr.docSettings");if(d)return JSON.parse(d)}catch(d){console.warn("Failed to load doc settings from sessionStorage:",d)}return{transcriptionMode:"fix-spelling",textExtractionScope:"all",formattingMode:"improve-formatting"}}),[Be,De]=n.useState("full-text"),[je,Te]=n.useState({open:!1,message:"",severity:"info"});n.useEffect(()=>{try{sessionStorage.setItem("om.ocr.docSettings",JSON.stringify(be))}catch(d){console.warn("Failed to save doc settings to sessionStorage:",d)}},[be]);const ae=n.useCallback((d,w="info")=>{Te({open:!0,message:d,severity:w})},[]),[xe,Ae]=n.useState(()=>{try{const d=localStorage.getItem("om.enhancedOcrUploader.stickyDefaults.v1");if(d){const w=JSON.parse(d);return{baptism:w.baptism_records||!1,marriage:w.marriage_records||!1,funeral:w.funeral_records||!1}}}catch(d){console.warn("Failed to load sticky defaults from localStorage:",d)}return{baptism:!1,marriage:!1,funeral:!1}});n.useEffect(()=>{if(v){const d=new URLSearchParams(o);g?d.set("ocr_mode","simulate"):d.delete("ocr_mode"),h(d,{replace:!0})}},[g,v,o,h]),n.useEffect(()=>{try{localStorage.setItem("om.enhancedOcrUploader.stickyDefaults.v1",JSON.stringify({baptism_records:xe.baptism,marriage_records:xe.marriage,funeral_records:xe.funeral}))}catch(d){console.warn("Failed to save sticky defaults to localStorage:",d)}},[xe]);const Ce=p.filter(d=>d.status==="complete").length,Tt=p.filter(d=>d.status==="error").length,zt=x?`/var/www/orthodoxmetrics/prod/uploads/om_church_${x}/uploaded/`:"/var/www/orthodoxmetrics/prod/uploads/";n.useEffect(()=>{te(void 0,null,function*(){var w,Z;try{let U=[],ne=!1;try{const q=(yield ue.get("/api/my/churches")).data;if(U=(q==null?void 0:q.churches)||q||[],ne=!0,U.length>0){console.log(`✅ Loaded ${U.length} churches from /api/my/churches`),R(U),l?I(l):r!=null&&r.church_id?I(c(r.church_id)||U[0].id):U.length>0&&I(U[0].id);return}}catch(ee){const q=(w=ee.response)==null?void 0:w.status;q===404||q===400?console.log(`⚠️ /api/my/churches returned ${q}, trying fallback`):console.warn("⚠️ /api/my/churches error:",q||ee.message)}if((!ne||U.length===0)&&((r==null?void 0:r.role)==="admin"||(r==null?void 0:r.role)==="manager"||(r==null?void 0:r.role)==="super_admin"||s))try{const ie=(yield ue.get("/api/churches")).data;if(U=(ie==null?void 0:ie.churches)||ie||[],U.length>0){console.log(`✅ Loaded ${U.length} churches from /api/churches (admin fallback)`),R(U),l?I(l):r!=null&&r.church_id?I(c(r.church_id)||U[0].id):U.length>0&&I(U[0].id);return}}catch(q){if(((Z=q.response)==null?void 0:Z.status)===403){console.warn("⚠️ /api/churches returned 403, using user church_id");const ie=l||c(r==null?void 0:r.church_id);if(ie){R([{id:ie,name:`Church ${ie}`,database_name:`om_church_${ie}`}]),I(ie);return}}throw q}const X=l||c(r==null?void 0:r.church_id);if(U.length===0&&X){console.log(`⚠️ No churches loaded, using church_id: ${X}`),R([{id:X,name:`Church ${X}`,database_name:`om_church_${X}`}]),I(X);return}U.length===0&&(console.error("❌ No churches available for user"),R([]))}catch(U){console.error("❌ Failed to load churches:",U);const ne=l||c(r==null?void 0:r.church_id);ne?(console.log(`⚠️ Using church_id as fallback: ${ne}`),R([{id:ne,name:`Church ${ne}`,database_name:`om_church_${ne}`}]),I(ne)):R([])}})},[r,s,l]),n.useCallback(d=>te(void 0,null,function*(){if(!x||d.status!=="completed")return;T(String(d.id)),_(!0),B(!0),K(!1),L(null);const w=yield $(d.id);w&&L({id:String(w.id),original_filename:w.original_filename,filename:w.filename,file_path:w.file_path,status:w.status,record_type:w.record_type,language:w.language,confidence_score:w.confidence_score,created_at:w.created_at,updated_at:w.updated_at,ocr_text:w.ocr_text,ocr_result:w.ocr_result,mapping:w.mapping}),B(!1)}),[x,$]);const ze=n.useCallback(d=>{if(!d)return;const w=["image/jpeg","image/png","image/tiff"],Z=10*1024*1024,U=50,ne=[];Array.from(d).slice(0,U-p.length).forEach(X=>{if(!w.includes(X.type)){console.warn(`Invalid file type: ${X.name}`);return}if(X.size>Z){console.warn(`File too large: ${X.name}`);return}const ee=new FileReader,q={id:Xr(),file:X,name:X.name,size:X.size,recordType:"baptism",status:"queued",progress:0};ee.onload=ie=>{m(me=>me.map(ve=>{var Ie;return ve.id===q.id?E(j({},ve),{thumbnail:(Ie=ie.target)==null?void 0:Ie.result}):ve}))},ee.readAsDataURL(X),ne.push(q)}),m(X=>[...X,...ne])},[p.length]),It=n.useCallback(()=>te(void 0,null,function*(){const d=["IMG_2025_03_05_10_44_50S.jpg","IMG_2024_10_25_12_32_04S.jpg","IMG_2025_03_05_11_04_55S.jpg","IMG_2024_10_22_11_27_57S.jpg","IMG_2024_10_22_11_29_28S.jpg","IMG_2024_10_25_12_28_25S.jpg","IMG_2024_10_22_11_39_09S.jpg","IMG_2025_03_12_12_48_44S.jpg"];try{const w=[];for(const Z of d)try{const U=yield fetch(`/images/misc/demo/${Z}`);if(!U.ok){console.warn(`Failed to load demo image: ${Z}`);continue}const ne=yield U.blob(),X=new File([ne],Z,{type:ne.type||"image/jpeg"});w.push(X)}catch(U){console.error(`Error loading demo image ${Z}:`,U)}if(w.length>0){const Z=new DataTransfer;w.forEach(U=>Z.items.add(U)),ze(Z.files),ae(`Loaded ${w.length} demo images`,"success")}else ae("Failed to load demo images","error")}catch(w){console.error("Error loading demo images:",w),ae("Error loading demo images","error")}}),[ze,ae]),Ue=n.useCallback(d=>{d.preventDefault(),d.stopPropagation(),d.type==="dragenter"||d.type==="dragover"?i(!0):d.type==="dragleave"&&i(!1)},[]),Mt=n.useCallback(d=>{d.preventDefault(),d.stopPropagation(),i(!1),ze(d.dataTransfer.files)},[ze]),tt=n.useCallback(()=>te(void 0,null,function*(){var w,Z,U,ne;if(!x||p.length===0)return;V(!0),P(!1);const d=p.filter(X=>X.status==="queued"||X.status==="error");d.length>0&&ae("Extracting text...","info");for(const X of d){if(Y)break;m(ee=>ee.map(q=>q.id===X.id?E(j({},q),{status:"uploading",progress:0}):q));try{const ee=new FormData;ee.append("files",X.file),ee.append("churchId",x.toString()),ee.append("recordType",X.recordType),ee.append("language",N.language),ee.append("settings",JSON.stringify({autoDetectLanguage:N.autoDetectLanguage,forceGrayscale:N.forceGrayscale,deskewImages:N.deskewImages,dpi:N.dpi})),g&&v&&ee.append("ocr_mode","simulate");const q=setInterval(()=>{m(_e=>_e.map(ce=>ce.id===X.id&&ce.progress<90?E(j({},ce),{progress:ce.progress+10}):ce))},200),ie=g&&v?`/api/church/${x}/ocr/enhanced/process?ocr_mode=simulate`:"/api/ocr/jobs/upload",me=yield ue.post(ie,ee);clearInterval(q);const ve=((w=me.data)==null?void 0:w.jobs)||me.jobs||[],Ie=ve.length>0?ve[0].id:void 0,rt=((Z=me.data)==null?void 0:Z.source)==="simulation"||((U=ve[0])==null?void 0:U.source)==="simulation";g&&v&&!rt&&ve.length===0&&ae("No simulation data for this file","warning"),m(_e=>_e.map(ce=>ce.id===X.id?E(j({},ce),{status:"processing",progress:95,jobId:Ie}):ce)),yield new Promise(_e=>setTimeout(_e,500)),m(_e=>_e.map(ce=>ce.id===X.id?E(j({},ce),{status:"complete",progress:100,jobId:Ie,isSimulation:rt||!1}):ce)),F(),g&&v&&((ne=me.data)==null?void 0:ne.source)==="simulation"?ae("Loaded verified demo OCR results","success"):ae("OCR completed","success")}catch(ee){m(ie=>ie.map(me=>me.id===X.id?E(j({},me),{status:"error",progress:0,error:ee.message||"Upload failed"}):me));const q=ee.message||"Unknown error";ae(`OCR processing failed: ${q}`,"error")}}V(!1),F()}),[p,x,N,Y,F]),Ot=n.useCallback((d,w)=>{m(Z=>Z.map(U=>U.id===d?E(j({},U),{recordType:w}):U))},[]),Dt=n.useCallback(d=>{m(w=>w.filter(Z=>Z.id!==d))},[]),At=n.useCallback(d=>{m(w=>w.map(Z=>Z.id===d?E(j({},Z),{status:"queued",progress:0,error:void 0}):Z))},[]),Pt=n.useCallback(()=>{m([]),T(null),L(null),_(!1)},[]);return n.useCallback(d=>te(void 0,null,function*(){const w=p.find(Z=>Z.id===d);if(!(!w||w.status!=="complete"||!w.jobId||!x)){T(d),_(!0),B(!0);try{const Z=yield ue.get(`/api/ocr/jobs/${w.jobId}?churchId=${x}`);L(Z.data)}catch(Z){console.error("Failed to fetch job detail:",Z),L(null)}finally{B(!1)}}}),[p,x]),y.find(d=>d.id===x),e.jsx(Vr,{children:e.jsx(Ur,{children:e.jsxs(S,{sx:{minHeight:"100vh",bgcolor:"background.default",pb:4},children:[e.jsx(de,{elevation:0,sx:{borderBottom:"1px solid",borderColor:"divider",bgcolor:"background.paper",mb:3},children:e.jsx(S,{sx:{maxWidth:1200,mx:"auto",px:3,py:3},children:e.jsxs(Q,{direction:"row",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:2,children:[e.jsxs(S,{children:[e.jsx(k,{variant:"h4",fontWeight:700,color:"text.primary",children:"OCR Record Uploader"}),e.jsx(k,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:"Upload, organize, and process church record images with OCR."})]}),e.jsxs(Q,{direction:"row",spacing:1,children:[e.jsx(oe,{icon:e.jsx(Ve,{size:14}),label:N.engine,variant:"outlined",size:"small",sx:{fontWeight:500}}),e.jsx(oe,{label:`${N.dpi} DPI`,variant:"outlined",size:"small",sx:{fontWeight:500}}),e.jsx(oe,{label:`${N.confidenceThreshold}% Confidence`,variant:"outlined",size:"small",sx:{fontWeight:500}})]})]})})}),e.jsxs(S,{sx:{maxWidth:1200,mx:"auto",px:3},children:[e.jsxs(de,{elevation:0,sx:{mb:3,borderRadius:2,border:"1px solid",borderColor:"divider",overflow:"hidden"},children:[e.jsxs(S,{sx:{p:2,display:"flex",alignItems:"center",cursor:"pointer","&:hover":{bgcolor:"action.hover"}},onClick:()=>J(!f),children:[e.jsx(Ve,{size:20,style:{marginRight:12}}),e.jsx(k,{variant:"subtitle1",fontWeight:600,children:"Settings"}),e.jsx(S,{sx:{ml:"auto"},children:f?e.jsx(Le,{size:20}):e.jsx(Fe,{size:20})})]}),e.jsxs(ct,{in:f,children:[e.jsx($e,{}),e.jsxs(S,{sx:{p:3},children:[e.jsxs(S,{sx:{mb:3},children:[e.jsxs(Q,{direction:"row",spacing:1,alignItems:"center",sx:{mb:2},children:[e.jsx(k,{variant:"subtitle2",fontWeight:600,children:"Document processing"}),e.jsx(oe,{label:"Customize AI",size:"small",color:"primary",variant:"outlined"}),e.jsx(oe,{label:"Experimental",size:"small",color:"warning",variant:"outlined"})]}),e.jsxs(Q,{spacing:2.5,children:[e.jsxs(Ee,{fullWidth:!0,children:[e.jsx(Ye,{sx:{mb:1,fontWeight:500},children:"Transcription mode"}),e.jsxs(Re,{value:be.transcriptionMode,onChange:d=>{Se(w=>E(j({},w),{transcriptionMode:d.target.value})),ae("Settings saved","success")},size:"small",children:[e.jsx(se,{value:"exact",children:"Transcribe exactly as written"}),e.jsx(se,{value:"fix-spelling",children:"Fix spelling mistakes"})]})]}),e.jsxs(Ee,{fullWidth:!0,children:[e.jsx(Ye,{sx:{mb:1,fontWeight:500},children:"Text extraction scope"}),e.jsxs(Re,{value:be.textExtractionScope,onChange:d=>{Se(w=>E(j({},w),{textExtractionScope:d.target.value})),d.target.value==="handwritten-only"?ae("Handwritten-only not supported for this engine yet.","warning"):ae("Settings saved","success")},size:"small",children:[e.jsx(se,{value:"all",children:"Extract all text"}),e.jsx(se,{value:"handwritten-only",children:"Extract handwritten text only"})]})]}),e.jsxs(Ee,{fullWidth:!0,children:[e.jsx(Ye,{sx:{mb:1,fontWeight:500},children:"Formatting mode"}),e.jsx(Re,{value:be.formattingMode,onChange:d=>{Se(w=>E(j({},w),{formattingMode:d.target.value})),ae("Settings saved","success")},size:"small",children:e.jsx(se,{value:"improve-formatting",children:"Improving formatting for better readability"})})]})]})]}),e.jsx($e,{sx:{my:3}}),e.jsxs(S,{children:[e.jsx(k,{variant:"subtitle2",fontWeight:600,sx:{mb:2},children:"Choose an action"}),e.jsxs(rr,{value:Be,onChange:d=>De(d.target.value),children:[e.jsx(ge,{value:"full-text",control:e.jsx(Xe,{}),label:e.jsxs(S,{children:[e.jsx(k,{variant:"body2",fontWeight:500,children:"Extract Full Text"}),e.jsx(k,{variant:"caption",color:"text.secondary",children:"Extract all text from the document"})]})}),e.jsx(ge,{value:"tables",control:e.jsx(Xe,{disabled:!0}),label:e.jsxs(S,{children:[e.jsx(k,{variant:"body2",fontWeight:500,color:"text.disabled",children:"Extract Tables"}),e.jsx(k,{variant:"caption",color:"text.secondary",children:"Coming soon"})]})}),e.jsx(ge,{value:"custom-data",control:e.jsx(Xe,{disabled:!0}),label:e.jsxs(S,{children:[e.jsx(k,{variant:"body2",fontWeight:500,color:"text.disabled",children:"Extract Custom Data"}),e.jsx(k,{variant:"caption",color:"text.secondary",children:"Coming soon"})]})})]})]})]})]})]}),s()&&e.jsx(de,{elevation:0,sx:{p:3,mb:3,borderRadius:2,bgcolor:re(t.palette.warning.main,.03),border:"2px dashed",borderColor:re(t.palette.warning.main,.3)},children:e.jsxs(Q,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(S,{sx:{p:1.5,borderRadius:2,bgcolor:re(t.palette.warning.main,.1),color:"warning.main"},children:e.jsx(sr,{size:28})}),e.jsxs(S,{sx:{flex:1},children:[e.jsxs(Q,{direction:"row",alignItems:"center",spacing:1,children:[e.jsx(k,{variant:"subtitle1",fontWeight:600,children:"Target Church Database"}),e.jsx(pe,{title:"Changes affect live production data",arrow:!0,children:e.jsx(Yt,{size:18,color:t.palette.warning.main})})]}),e.jsx(k,{variant:"caption",color:"text.secondary",children:"Select the church database where OCR results will be stored."})]}),e.jsx(Ee,{sx:{minWidth:300},children:e.jsx(Re,{value:x||"",onChange:d=>I(Number(d.target.value)),displayEmpty:!0,sx:{bgcolor:"background.paper","& .MuiSelect-select":{py:1.5}},children:y.map(d=>e.jsxs(se,{value:d.id,children:[d.name," - Church ",d.id]},d.id))})})]})}),e.jsxs(de,{elevation:0,sx:{p:4,mb:3,borderRadius:3,border:"2px dashed",borderColor:C?"primary.main":re(t.palette.primary.main,.3),bgcolor:C?re(t.palette.primary.main,.05):re(t.palette.primary.main,.02),textAlign:"center",cursor:"pointer",transition:"all 0.3s ease","&:hover":{borderColor:"primary.main",bgcolor:re(t.palette.primary.main,.05)}},onDragEnter:Ue,onDragLeave:Ue,onDragOver:Ue,onDrop:Mt,onClick:()=>{var d;return(d=a.current)==null?void 0:d.click()},children:[e.jsx("input",{ref:a,type:"file",multiple:!0,accept:".jpg,.jpeg,.png,.tiff",onChange:d=>ze(d.target.files),style:{display:"none"}}),e.jsx(S,{sx:{width:80,height:80,mx:"auto",mb:2,borderRadius:"50%",bgcolor:re(t.palette.primary.main,.1),display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(Qe,{size:40,color:t.palette.primary.main})}),e.jsx(k,{variant:"h6",fontWeight:600,color:"text.primary",children:"Drag & drop record images here"}),e.jsx(k,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:"or click to browse files"}),e.jsxs(Q,{direction:"row",spacing:2,justifyContent:"center",sx:{mt:2},children:[e.jsx(oe,{label:"• JPG",size:"small",variant:"outlined"}),e.jsx(oe,{label:"• PNG",size:"small",variant:"outlined"}),e.jsx(oe,{label:"• TIFF",size:"small",variant:"outlined"})]}),e.jsx(k,{variant:"caption",color:"text.secondary",sx:{mt:1,display:"block"},children:"Max 50 files per batch • 10MB per file"}),v&&e.jsxs(S,{sx:{mt:2,display:"flex",gap:2,justifyContent:"center",flexWrap:"wrap"},children:[e.jsx(we,{variant:"outlined",color:"primary",startIcon:e.jsx(Qe,{}),onClick:It,disabled:M,sx:{mt:1},children:"Load Demo Images"}),e.jsx(ge,{control:e.jsx(ke,{checked:g,onChange:d=>D(d.target.checked),disabled:M}),label:e.jsxs(S,{children:[e.jsx(k,{variant:"body2",fontWeight:500,children:"Simulation Mode"}),e.jsx(k,{variant:"caption",color:"text.secondary",children:"Use pre-validated demo OCR results"})]}),sx:{mt:1}})]})]}),e.jsxs(de,{elevation:0,sx:{mb:3,borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsxs(S,{sx:{p:2,display:"flex",alignItems:"center",cursor:"pointer","&:hover":{bgcolor:"action.hover"}},onClick:()=>J(!f),children:[e.jsx(Ve,{size:20,style:{marginRight:12}}),e.jsx(k,{variant:"subtitle1",fontWeight:600,children:"Advanced Options"}),e.jsx(S,{sx:{ml:"auto"},children:f?e.jsx(Le,{size:20}):e.jsx(Fe,{size:20})})]}),e.jsxs(ct,{in:f,children:[e.jsx($e,{}),e.jsx(S,{sx:{p:3},children:e.jsxs(Q,{spacing:3,children:[e.jsx(ge,{control:e.jsx(ke,{checked:N.autoDetectLanguage,onChange:d=>W(w=>E(j({},w),{autoDetectLanguage:d.target.checked}))}),label:e.jsxs(S,{children:[e.jsx(k,{variant:"body2",fontWeight:500,children:"Auto-detect Language"}),e.jsx(k,{variant:"caption",color:"text.secondary",children:"Automatically detect the language in record images"})]})}),e.jsx(ge,{control:e.jsx(ke,{checked:N.forceGrayscale,onChange:d=>W(w=>E(j({},w),{forceGrayscale:d.target.checked}))}),label:e.jsxs(S,{children:[e.jsx(k,{variant:"body2",fontWeight:500,children:"Force Grayscale Preprocessing"}),e.jsx(k,{variant:"caption",color:"text.secondary",children:"Convert images to grayscale before OCR processing"})]})}),e.jsx(ge,{control:e.jsx(ke,{checked:N.deskewImages,onChange:d=>W(w=>E(j({},w),{deskewImages:d.target.checked}))}),label:e.jsxs(S,{children:[e.jsx(k,{variant:"body2",fontWeight:500,children:"Deskew Images Before OCR"}),e.jsx(k,{variant:"caption",color:"text.secondary",children:"Automatically correct skewed or rotated images"})]})}),e.jsxs(S,{children:[e.jsx(k,{variant:"body2",fontWeight:500,sx:{mb:1},children:"OCR Language"}),e.jsx(Ee,{sx:{minWidth:200},children:e.jsxs(Re,{value:N.language,onChange:d=>W(w=>E(j({},w),{language:d.target.value})),size:"small",children:[e.jsx(se,{value:"en",children:"English"}),e.jsx(se,{value:"el",children:"Greek"}),e.jsx(se,{value:"ru",children:"Russian"}),e.jsx(se,{value:"ro",children:"Romanian"}),e.jsx(se,{value:"sr",children:"Serbian"}),e.jsx(se,{value:"bg",children:"Bulgarian"})]})}),e.jsx(k,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:"Default language from church settings"})]}),e.jsxs(S,{children:[e.jsx(k,{variant:"body2",fontWeight:500,sx:{mb:1},children:"Upload Directory"}),e.jsx(de,{variant:"outlined",sx:{p:1.5,bgcolor:"background.paper",fontFamily:"monospace",fontSize:"0.875rem"},children:zt}),e.jsx(k,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:"Server path where images will be stored"})]}),e.jsx($e,{sx:{my:2}}),e.jsxs(S,{children:[e.jsx(k,{variant:"body2",fontWeight:600,sx:{mb:2},children:"Sticky Default Fields"}),e.jsx(k,{variant:"caption",color:"text.secondary",sx:{mb:2,display:"block"},children:"Restrict field mapping to default database columns for each record type"}),e.jsxs(Q,{spacing:2,children:[e.jsxs(S,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(Ze,{title:"baptism_records",imageSrc:"/images/schema-previews/baptism_records.png"}),e.jsx(k,{variant:"body2",sx:{flex:1},children:"baptism_records"}),e.jsx(ge,{control:e.jsx(ke,{checked:xe.baptism,onChange:d=>Ae(w=>E(j({},w),{baptism:d.target.checked})),size:"small"}),label:"Sticky Defaults",labelPlacement:"end"})]}),e.jsxs(S,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(Ze,{title:"marriage_records",imageSrc:"/images/schema-previews/marriage_records.png"}),e.jsx(k,{variant:"body2",sx:{flex:1},children:"marriage_records"}),e.jsx(ge,{control:e.jsx(ke,{checked:xe.marriage,onChange:d=>Ae(w=>E(j({},w),{marriage:d.target.checked})),size:"small"}),label:"Sticky Defaults",labelPlacement:"end"})]}),e.jsxs(S,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(Ze,{title:"funeral_records",imageSrc:"/images/schema-previews/funeral_records.png"}),e.jsx(k,{variant:"body2",sx:{flex:1},children:"funeral_records"}),e.jsx(ge,{control:e.jsx(ke,{checked:xe.funeral,onChange:d=>Ae(w=>E(j({},w),{funeral:d.target.checked})),size:"small"}),label:"Sticky Defaults",labelPlacement:"end"})]})]})]})]})})]})]}),p.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(de,{elevation:0,sx:{p:2,mb:3,borderRadius:2,border:"1px solid",borderColor:"divider",bgcolor:"background.paper"},children:e.jsxs(Q,{direction:"row",spacing:2,alignItems:"center",flexWrap:"wrap",children:[g&&v&&e.jsx(oe,{label:"SIMULATION (Verified Demo)",color:"info",size:"small",sx:{fontWeight:600}}),e.jsx(we,{variant:"contained",startIcon:M?e.jsx(hr,{}):e.jsx(nr,{}),onClick:M?()=>P(!0):tt,disabled:!x||p.filter(d=>d.status==="queued").length===0,sx:{px:3,background:"linear-gradient(135deg, #5e35b1 0%, #3949ab 100%)","&:hover":{background:"linear-gradient(135deg, #4527a0 0%, #303f9f 100%)"}},children:M?"Pause":"Start Upload"}),Y&&e.jsx(we,{variant:"outlined",startIcon:e.jsx(or,{}),onClick:()=>{P(!1),tt()},children:"Resume"}),e.jsx(we,{variant:"outlined",color:"error",startIcon:e.jsx(qe,{}),onClick:Pt,disabled:M,children:"Clear All"}),e.jsxs(S,{sx:{ml:"auto",display:"flex",alignItems:"center",gap:2},children:[e.jsx(qr,{total:p.length,completed:Ce,processing:M}),e.jsx(k,{variant:"body2",color:"text.secondary",sx:{minWidth:120},children:M?"Processing...":Ce>0?`Completed: ${Ce}`:"Ready to upload"})]})]})}),e.jsxs(de,{elevation:0,sx:{borderRadius:2,border:"1px solid",borderColor:"divider",overflow:"hidden"},children:[e.jsxs(S,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider",bgcolor:"background.paper",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(k,{variant:"subtitle1",fontWeight:600,children:["Upload Queue (",p.length," files)"]}),e.jsxs(Q,{direction:"row",spacing:2,children:[e.jsxs(k,{variant:"body2",color:"success.main",children:["Completed: ",Ce]}),e.jsxs(k,{variant:"body2",color:"error.main",children:["Failed: ",Tt]})]})]}),e.jsx(S,{sx:{p:2,maxHeight:400,overflow:"auto"},children:p.map(d=>e.jsx(Hr,{file:d,isSelected:!1,onRecordTypeChange:Ot,onRemove:Dt,onRetry:At,onSelect:()=>{}},d.id))})]})]}),x&&e.jsx(S,{sx:{mt:3,height:"calc(100vh - 400px)",minHeight:600},children:e.jsx(yr,{children:e.jsx(Fr,{churchId:x})})})]}),e.jsx(mt,{open:je.open,autoHideDuration:12e3,onClose:()=>Te(E(j({},je),{open:!1})),anchorOrigin:{vertical:"center",horizontal:"center"},sx:{position:"fixed",top:"50% !important",left:"50% !important",transform:"translate(-50%, -50%) !important",zIndex:1e4,"& .MuiSnackbar-root":{position:"fixed",top:"50% !important",left:"50% !important",transform:"translate(-50%, -50%) !important"}},children:e.jsx(Je,{onClose:()=>Te(E(j({},je),{open:!1})),severity:je.severity,variant:"filled",sx:{minWidth:"400px",maxWidth:"600px",fontSize:"1.1rem",padding:"16px 20px","& .MuiAlert-message":{fontSize:"1.1rem",fontWeight:500},"& .MuiAlert-icon":{fontSize:"28px"}},children:je.message})})]})})})};export{Ss as EnhancedOCRUploader,Ss as default};
//# sourceMappingURL=EnhancedOCRUploader-BrLj_mgR.js.map
