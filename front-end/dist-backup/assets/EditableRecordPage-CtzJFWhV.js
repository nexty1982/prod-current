var se=Object.defineProperty,ae=Object.defineProperties;var re=Object.getOwnPropertyDescriptors;var N=Object.getOwnPropertySymbols;var te=Object.prototype.hasOwnProperty,oe=Object.prototype.propertyIsEnumerable;var U=(c,t,o)=>t in c?se(c,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):c[t]=o,h=(c,t)=>{for(var o in t||(t={}))te.call(t,o)&&U(c,o,t[o]);if(N)for(var o of N(t))oe.call(t,o)&&U(c,o,t[o]);return c},m=(c,t)=>ae(c,re(t));var B=(c,t,o)=>new Promise((f,y)=>{var F=u=>{try{j(o.next(u))}catch(n){y(n)}},v=u=>{try{j(o.throw(u))}catch(n){y(n)}},j=u=>u.done?f(u.value):Promise.resolve(u.value).then(F,v);j((o=o.apply(c,t)).next())});import{a as ne,j as a,l as ie,aJ as le,k as ce,B as g,I as V,a_ as de,d as A,T as Y,aG as ue,e as xe,a$ as he,a0 as k,V as me,R as ge,D as ve}from"./index-Dgvcv9SG.js";import{r as l}from"./vendor-Dkfty7_r.js";import{C as pe}from"./Container-BLaKfmEJ.js";import{T as fe}from"./Toolbar-DfqyUE-7.js";import{U as ye}from"./Palette-BW4bxUzv.js";import{F as je}from"./Fab-CFrL7wE8.js";const _=ne(a.jsx("path",{d:"M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.89-2-2-2m0 16H5V7h14zm-5.5-6c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5.67-1.5 1.5-1.5 1.5.67 1.5 1.5M12 9c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5"})),Pe=({recordType:c,recordId:t,onSave:o,onCancel:f,readonly:y=!1,showPreview:F=!0})=>{const v=ie(),j=le(),{user:u}=ce(),n=c||j.recordType||"baptism",P=u&&["super_admin","admin","manager"].includes(u.role),[d,R]=l.useState(()=>createRecordWithFields(n)),[be,$]=l.useState(!1),[L,I]=l.useState(!1),[M,D]=l.useState(null),[W,E]=l.useState(null),[b,O]=l.useState({}),[C,q]=l.useState(F),[G,S]=l.useState(!1);l.useEffect(()=>{t&&z()},[t,n]);const z=()=>B(void 0,null,function*(){if(t){$(!0),D(null);try{const s=yield recordService.fetchRecordById(n,t);R(s),devLogStateChange("record",null,s,"EditableRecordPage")}catch(s){const e=s instanceof Error?s.message:"Failed to load record";D(e),devLogStateChange("loadError",null,e,"EditableRecordPage")}finally{$(!1)}}}),p=l.useMemo(()=>getRecordSchema(n),[n]),J=l.useMemo(()=>{const s={};return p.sections.forEach(e=>{s[e.id]=d.fields.filter(r=>e.fields.includes(r.key))}),s},[d.fields,p.sections]),Q=l.useCallback((s,e)=>{R(r=>{const i=m(h({},r),{fields:r.fields.map(x=>x.key===s?m(h({},x),{value:e}):x),metadata:m(h({},r.metadata),{updatedAt:new Date,version:r.metadata.version+1})});return devLogStateChange("Field Value Changed",r,i,"EditableRecordPage"),i}),S(!0),b[s]&&O(r=>{const i=h({},r);return delete i[s],i})},[b]),X=l.useCallback((s,e)=>{R(r=>{const i=m(h({},r),{colorOverrides:m(h({},r.colorOverrides),{[s]:e}),metadata:m(h({},r.metadata),{updatedAt:new Date,version:r.metadata.version+1})});return devLogStateChange("Field Color Changed",r.colorOverrides,i.colorOverrides,"EditableRecordPage"),i}),S(!0)},[]),H=l.useCallback(()=>{const s={};return p.requiredFields.forEach(e=>{const r=d.fields.find(i=>i.key===e);(!r||!r.value||typeof r.value=="string"&&r.value.trim()==="")&&(s[e]=`${(r==null?void 0:r.label)||e} is required`)}),d.fields.forEach(e=>{if(e.value&&e.validation){const{min:r,max:i,pattern:x,message:T}=e.validation;if(e.type==="email"&&e.value&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.value)||(s[e.key]="Please enter a valid email address")),e.type==="number"&&e.value){const w=Number(e.value);r!==void 0&&w<r&&(s[e.key]=T||`Value must be at least ${r}`),i!==void 0&&w>i&&(s[e.key]=T||`Value must be no more than ${i}`)}x&&e.value&&(new RegExp(x).test(e.value)||(s[e.key]=T||"Invalid format"))}}),O(s),Object.keys(s).length===0},[d.fields,p.requiredFields]),Z=l.useCallback(()=>B(void 0,null,function*(){if(H()){if(!P){E("You do not have permission to edit records");return}I(!0),E(null);try{const s=m(h({},d),{metadata:m(h({},d.metadata),{status:"active",updatedAt:new Date})});if(devLogStateChange("Record Saved",d,s,"EditableRecordPage"),o)yield o(s);else if(t){const e=yield recordService.updateRecord(n,t,s);console.log("Record updated:",e)}else{const e=yield recordService.createRecord(n,s);console.log("Record created:",e),e.id&&v(`/demos/editable-record/${n}/${e.id}`)}S(!1)}catch(s){const e=s instanceof Error?s.message:"Failed to save record";E(e),console.error("Error saving record:",s)}finally{I(!1)}}}),[d,H,o,P,n,t,v]),K=l.useCallback(()=>{f?f():v(-1)},[v,f]),ee=l.useCallback(()=>{const s=createRecordWithFields(n);t&&(s.id=t),R(s),O({}),S(!1),devLogStateChange("Form Reset",d,s,"EditableRecordPage")},[n,t,d]);return a.jsx("div",{children:a.jsxs(pe,{maxWidth:"xl",sx:{py:3},children:[a.jsxs(g,{mb:3,children:[a.jsxs(fe,{disableGutters:!0,children:[a.jsx(V,{onClick:K,sx:{mr:1},children:a.jsx(de,{})}),a.jsxs(g,{sx:{flexGrow:1},children:[a.jsxs(A,{variant:"h4",component:"h1",children:[t?"Edit":"New"," ",n.charAt(0).toUpperCase()+n.slice(1)," Record"]}),a.jsx(A,{variant:"body2",color:"text.secondary",children:p.description})]}),a.jsxs(g,{sx:{display:"flex",gap:1},children:[a.jsx(Y,{title:"Toggle Preview",children:a.jsx(V,{onClick:()=>q(!C),color:C?"primary":"default",children:a.jsx(_,{})})}),a.jsx(Y,{title:"Reset Form",children:a.jsx(V,{onClick:ee,disabled:!G,children:a.jsx(ue,{})})}),a.jsx(xe,{variant:"contained",startIcon:a.jsx(he,{}),onClick:Z,disabled:y||L,loading:L,children:L?"Saving...":"Save Record"})]})]}),G&&a.jsx(k,{severity:"info",sx:{mt:2},children:"You have unsaved changes. Don't forget to save your work!"}),!P&&a.jsx(k,{severity:"warning",sx:{mt:2},children:"You have read-only access. Only priests, deacons, and administrators can edit church records."}),M&&a.jsxs(k,{severity:"error",sx:{mt:2},onClose:()=>D(null),children:["Failed to load record: ",M]}),W&&a.jsxs(k,{severity:"error",sx:{mt:2},onClose:()=>E(null),children:["Failed to save record: ",W]}),Object.keys(b).length>0&&a.jsxs(k,{severity:"error",sx:{mt:2},children:["Please fix the following errors before saving:",a.jsx("ul",{style:{margin:"8px 0",paddingLeft:"20px"},children:Object.entries(b).map(([s,e])=>a.jsx("li",{children:e},s))})]})]}),a.jsxs(g,{sx:{display:"flex",gap:3},children:[a.jsx(g,{sx:{flex:C?"1 1 60%":"1 1 100%",minWidth:0,transition:"flex 0.3s ease"},children:p.sections.map(s=>{var e;return a.jsx(me,{sx:{mb:3},children:a.jsxs(ge,{children:[a.jsxs(A,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:[a.jsx(ye,{color:"primary"}),s.title]}),a.jsx(ve,{sx:{mb:3}}),a.jsx(g,{sx:{display:"flex",flexDirection:"column",gap:3},children:(e=J[s.id])==null?void 0:e.map(r=>{var i;return a.jsx(FieldRenderer,{field:r,value:r.value,color:((i=d.colorOverrides)==null?void 0:i[r.key])||r.color,error:b[r.key],readonly:y,onValueChange:x=>Q(r.key,x),onColorChange:x=>X(r.key,x)},r.key)})})]})},s.id)})}),C&&a.jsx(g,{sx:{flex:"1 1 40%",minWidth:"300px",position:"sticky",top:"80px",height:"fit-content",maxHeight:"calc(100vh - 100px)",overflow:"auto"},children:a.jsx(RecordPreviewPane,{record:d})})]}),!C&&a.jsx(je,{color:"primary",sx:{position:"fixed",bottom:16,right:16,display:{xs:"flex",md:"none"}},onClick:()=>q(!0),children:a.jsx(_,{})})]})})};export{Pe as default};
//# sourceMappingURL=EditableRecordPage-CtzJFWhV.js.map
