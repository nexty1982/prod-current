var u=(c,p,d)=>new Promise((v,g)=>{var I=x=>{try{h(d.next(x))}catch(w){g(w)}},G=x=>{try{h(d.throw(x))}catch(w){g(w)}},h=x=>x.done?v(x.value):Promise.resolve(x.value).then(I,G);h((d=d.apply(c,p)).next())});import{c as ye,m as Ue,k as ze,j as e,B as _,C as se,a0 as ne,d as n,S as Pe,V as B,R as O,P as pe,s as Ee,a1 as Re,t as qe,f as ie,e as o,aH as Ne,H as We,Y as $e,U as Ke,h as re,T as H,I as X,K as C,Z as b,O as k,a2 as A}from"./index-Dgvcv9SG.js";import{r as t}from"./vendor-Dkfty7_r.js";import{a as m}from"./admin.api-KTUJsu5j.js";import{P as te}from"./PageContainer-CE1CdJ_Q.js";import{D as Be}from"./DashboardCard-Dv-ZmD1u.js";import{I as ge}from"./IconUsers-CIqrEFml.js";import{I as Oe}from"./IconClock-Tbzc27Lr.js";import{I as He}from"./IconSearch-Yybor66O.js";import{T as Xe,a as Ye,b as Ge,c as Y,d as Ve}from"./TableRow-GBYhOGTG.js";import{T as r}from"./TableCell-jHKItVVU.js";import{I as Ze}from"./IconShieldX-CUwHgDBH.js";import{I as fe}from"./IconMessage-rT5DJxuK.js";import{I as Je}from"./IconLock-CyWSl9Lh.js";import{P as Qe}from"./Pagination-DMJsNFIO.js";import"./api.config-C9UNSeTF.js";import"./Helmet-B7mFktpd.js";import"./index-Ch3W3BYh.js";import"./LastPage-BXUC_f7y.js";/**
 * @license @tabler/icons-react v3.36.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const es=[["path",{d:"M13 9a1 1 0 0 1 1 -1h6a1 1 0 0 1 1 1v10a1 1 0 0 1 -1 1h-6a1 1 0 0 1 -1 -1v-10",key:"svg-0"}],["path",{d:"M18 8v-3a1 1 0 0 0 -1 -1h-13a1 1 0 0 0 -1 1v12a1 1 0 0 0 1 1h9",key:"svg-1"}],["path",{d:"M16 9h2",key:"svg-2"}]],ss=ye("outline","devices","Devices",es);/**
 * @license @tabler/icons-react v3.36.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const ns=[["path",{d:"M17.67 17.667a12 12 0 0 1 -5.67 3.333a12 12 0 0 1 -8.5 -15c.794 .036 1.583 -.006 2.357 -.124m3.128 -.926a11.997 11.997 0 0 0 3.015 -1.95a12 12 0 0 0 8.5 3a12 12 0 0 1 -1.116 9.376",key:"svg-0"}],["path",{d:"M3 3l18 18",key:"svg-1"}]],is=ye("outline","shield-off","ShieldOff",ns),Cs=()=>{var xe,he,ue,me;const c=Ue(),{user:p,authenticated:d,loading:v,hasRole:g}=ze(),[I,G]=t.useState([]),[h,x]=t.useState(null),[w,M]=t.useState(!0),[V,ve]=t.useState(""),[L,Se]=t.useState("all"),[Z,_e]=t.useState(1),[oe,Ce]=t.useState(1),[D,F]=t.useState({open:!1,session:null}),[U,z]=t.useState({open:!1,session:null}),[P,E]=t.useState({open:!1,session:null}),[be,R]=t.useState(!1),[ke,q]=t.useState(!1),[T,N]=t.useState({open:!1,session:null}),[W,$]=t.useState(""),[K,ae]=t.useState(!1),[le,J]=t.useState(""),[ce,Q]=t.useState(""),ee=20,S=s=>{J(s),setTimeout(()=>J(""),5e3)},j=s=>{Q(s),setTimeout(()=>Q(""),5e3)};if(v)return e.jsx(te,{title:"Session Management",description:"Manage user sessions",children:e.jsx(_,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px"},children:e.jsx(se,{})})});if(!d||!p||!g(["super_admin","admin"]))return e.jsx(te,{title:"Session Management",description:"Manage user sessions",children:e.jsxs(ne,{severity:"error",sx:{mt:2},children:[e.jsx(n,{variant:"h6",children:"Access Denied"}),e.jsx(n,{children:"You don't have permission to access session management."})]})});const f=()=>u(void 0,null,function*(){if(!d||!p||!g(["super_admin","admin"])){M(!1);return}try{M(!0);const s={search:V||void 0,status:L==="all"?void 0:L,limit:ee,offset:(Z-1)*ee},i=yield m.sessions.getAll(s),je=(i.sessions||[]).map(a=>{const l=a.user||{};return{session_id:a.session_id,user_id:l.id||l.user_id||0,email:l.email||"Unknown",first_name:l.first_name||l.firstName||"",last_name:l.last_name||l.lastName||"",role:l.role||"unknown",church_name:l.church_name||l.churchName||l.church_name||"",ip_address:a.ip_address||"N/A",user_agent:a.user_agent||"Unknown",login_time:a.login_time||a.created_at||new Date().toISOString(),expires:a.expires||a.expires_readable,is_active:a.is_active===1||a.is_active===!0,minutes_until_expiry:a.minutes_until_expiry||0}});G(je),Ce(Math.ceil((i.total||je.length)/ee))}catch(s){console.error("Failed to fetch sessions:",s),j("Failed to load sessions")}finally{M(!1)}}),y=()=>u(void 0,null,function*(){if(!(!d||!p||!g(["super_admin","admin"])))try{const s=yield m.sessions.getStats(),i=s.stats||s.statistics||s;x(i?{total_sessions:i.total_sessions||0,active_sessions:i.active_sessions||0,expired_sessions:i.expired_sessions||0,unique_users:i.unique_users||0,unique_ips:i.unique_ips||0,latest_login:i.newest_session||i.latest_login||"",earliest_login:i.oldest_session||i.earliest_login||""}:null)}catch(s){console.error("Failed to fetch session stats:",s)}}),Ae=s=>u(void 0,null,function*(){try{yield m.sessions.terminate(s.session_id),S(`Session terminated for ${s.email}`),F({open:!1,session:null}),f(),y()}catch(i){console.error("Failed to terminate session:",i),j("Failed to terminate session")}}),we=s=>u(void 0,null,function*(){try{s.is_active&&(yield m.sessions.terminate(s.session_id)),yield m.users.toggleStatus(s.user_id),S(`User ${s.email} has been deactivated and all sessions terminated`),z({open:!1,session:null}),f(),y()}catch(i){console.error("Failed to lockout user:",i),j("Failed to lockout user")}}),Te=s=>u(void 0,null,function*(){try{yield m.sessions.terminateAllForUser(s.user_id),S(`All sessions terminated for ${s.email}`),E({open:!1,session:null}),f(),y()}catch(i){console.error("Failed to terminate all user sessions:",i),j("Failed to terminate all user sessions")}}),Ie=()=>u(void 0,null,function*(){try{const s=yield m.sessions.cleanup(7);S("Cleanup completed successfully"),R(!1),f(),y()}catch(s){console.error("Failed to cleanup sessions:",s),j("Failed to cleanup sessions")}}),Me=()=>u(void 0,null,function*(){try{const s=yield m.sessions.terminateAll();S("All active sessions terminated successfully"),q(!1),f(),y()}catch(s){console.error("Failed to terminate all sessions:",s),j("Failed to terminate all sessions")}}),Le=()=>u(void 0,null,function*(){if(!T.session||!W.trim()){j("Please enter a message");return}try{ae(!0),yield m.messages.sendToSession(T.session.session_id,W),S(`Message sent to ${T.session.email}`),N({open:!1,session:null}),$("")}catch(s){console.error("Failed to send message:",s),j("Failed to send message")}finally{ae(!1)}}),de=s=>new Date(s).toLocaleString(),De=s=>s.is_active?e.jsx(re,{label:"Active",color:"success",size:"small"}):e.jsx(re,{label:"Expired",color:"default",size:"small"}),Fe=s=>{switch(s){case"super_admin":return"error";case"admin":return"warning";case"manager":return"info";case"user":return"primary";default:return"default"}};return t.useEffect(()=>{!v&&d&&p&&g(["super_admin","admin"])?(f(),y()):v||M(!1)},[V,L,Z,d,p,v]),e.jsx(te,{title:"Session Management",description:"Monitor and manage user sessions",children:e.jsxs(_,{children:[le&&e.jsx(ne,{severity:"success",sx:{mb:2},onClose:()=>J(""),children:le}),ce&&e.jsx(ne,{severity:"error",sx:{mb:2},onClose:()=>Q(""),children:ce}),h&&e.jsxs(Pe,{direction:"row",spacing:2,sx:{mb:3},children:[e.jsx(B,{sx:{flex:1},children:e.jsxs(O,{sx:{textAlign:"center"},children:[e.jsx(ge,{size:40,color:"#1976d2"}),e.jsx(n,{variant:"h4",children:h.active_sessions}),e.jsx(n,{color:"textSecondary",children:"Active Sessions"})]})}),e.jsx(B,{sx:{flex:1},children:e.jsxs(O,{sx:{textAlign:"center"},children:[e.jsx(Oe,{size:40,color:"#ed6c02"}),e.jsx(n,{variant:"h4",children:h.expired_sessions}),e.jsx(n,{color:"textSecondary",children:"Expired Sessions"})]})}),e.jsx(B,{sx:{flex:1},children:e.jsxs(O,{sx:{textAlign:"center"},children:[e.jsx(ge,{size:40,color:"#2e7d32"}),e.jsx(n,{variant:"h4",children:h.unique_users}),e.jsx(n,{color:"textSecondary",children:"Unique Users"})]})}),e.jsx(B,{sx:{flex:1},children:e.jsxs(O,{sx:{textAlign:"center"},children:[e.jsx(ss,{size:40,color:"#9c27b0"}),e.jsx(n,{variant:"h4",children:h.unique_ips}),e.jsx(n,{color:"textSecondary",children:"Unique IPs"})]})})]}),e.jsxs(Be,{title:"Active Sessions & Session Logs",children:[e.jsxs(_,{sx:{display:"flex",gap:2,mb:3,flexWrap:"wrap",alignItems:"center"},children:[e.jsx(pe,{label:"Search by email, name, or IP",variant:"outlined",size:"small",value:V,onChange:s=>ve(s.target.value),InputProps:{startAdornment:e.jsx(He,{size:20})},sx:{minWidth:250}}),e.jsxs(Ee,{size:"small",sx:{minWidth:120},children:[e.jsx(Re,{children:"Status"}),e.jsxs(qe,{value:L,label:"Status",onChange:s=>Se(s.target.value),children:[e.jsx(ie,{value:"all",children:"All"}),e.jsx(ie,{value:"active",children:"Active"}),e.jsx(ie,{value:"expired",children:"Expired"})]})]}),e.jsx(o,{variant:"outlined",startIcon:e.jsx(Ne,{}),onClick:()=>{f(),y()},children:"Refresh"}),e.jsx(o,{variant:"outlined",color:"warning",startIcon:e.jsx(We,{}),onClick:()=>R(!0),children:"Cleanup Expired"}),e.jsx(o,{variant:"contained",color:"error",startIcon:e.jsx($e,{}),onClick:()=>q(!0),children:"Kill All Sessions"})]}),e.jsx(Xe,{component:Ke,children:e.jsxs(Ye,{children:[e.jsx(Ge,{sx:{backgroundColor:c.palette.mode==="dark"?c.palette.grey[800]:"#f5f5f5"},children:e.jsxs(Y,{children:[e.jsx(r,{children:e.jsx("strong",{children:"User"})}),e.jsx(r,{children:e.jsx("strong",{children:"Email"})}),e.jsx(r,{children:e.jsx("strong",{children:"Role"})}),e.jsx(r,{children:e.jsx("strong",{children:"Church"})}),e.jsx(r,{children:e.jsx("strong",{children:"IP Address"})}),e.jsx(r,{children:e.jsx("strong",{children:"Login Time"})}),e.jsx(r,{children:e.jsx("strong",{children:"Expires"})}),e.jsx(r,{children:e.jsx("strong",{children:"User Agent"})}),e.jsx(r,{children:e.jsx("strong",{children:"Status"})}),e.jsx(r,{children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(Ve,{children:w?e.jsx(Y,{children:e.jsxs(r,{colSpan:10,sx:{textAlign:"center",py:4},children:[e.jsx(se,{}),e.jsx(n,{sx:{mt:2},children:"Loading sessions..."})]})}):I.length===0?e.jsx(Y,{children:e.jsx(r,{colSpan:10,sx:{textAlign:"center",py:4},children:e.jsx(n,{color:"textSecondary",children:"No sessions found"})})}):I.map((s,i)=>e.jsxs(Y,{sx:{backgroundColor:i%2===0?c.palette.mode==="dark"?c.palette.grey[900]:"#ffffff":c.palette.mode==="dark"?c.palette.grey[800]:"#f9f9f9","&:hover":{backgroundColor:c.palette.mode==="dark"?c.palette.grey[700]:"#f0f0f0"}},children:[e.jsx(r,{children:s.first_name&&s.last_name?`${s.first_name} ${s.last_name}`:"N/A"}),e.jsx(r,{children:s.email}),e.jsx(r,{children:e.jsx(re,{label:s.role,color:Fe(s.role),size:"small"})}),e.jsx(r,{children:e.jsx(n,{variant:"body2",children:s.church_name||"-"})}),e.jsx(r,{children:e.jsx(n,{variant:"body2",fontFamily:"monospace",children:s.ip_address||"-"})}),e.jsx(r,{children:de(s.login_time)}),e.jsx(r,{children:e.jsxs(_,{children:[s.expires?de(s.expires):"No active session",s.is_active&&s.minutes_until_expiry>0&&e.jsxs(n,{variant:"caption",color:"textSecondary",sx:{display:"block"},children:["Expires in ",s.minutes_until_expiry," min"]})]})}),e.jsx(r,{children:e.jsx(n,{variant:"body2",sx:{maxWidth:"200px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},title:s.user_agent||"Unknown",children:s.user_agent||"Unknown"})}),e.jsx(r,{children:De(s)}),e.jsx(r,{children:e.jsxs(_,{sx:{display:"flex",gap:1},children:[s.is_active&&e.jsx(H,{title:"Terminate Session",children:e.jsx(X,{color:"error",size:"small",onClick:()=>F({open:!0,session:s}),children:e.jsx(Ze,{size:18})})}),e.jsx(H,{title:"Terminate All User Sessions",children:e.jsx(X,{color:"error",size:"small",onClick:()=>E({open:!0,session:s}),children:e.jsx(is,{size:18})})}),s.is_active&&e.jsx(H,{title:"Send Message",children:e.jsx(X,{color:"primary",size:"small",onClick:()=>N({open:!0,session:s}),children:e.jsx(fe,{size:18})})}),e.jsx(H,{title:"Lockout User",children:e.jsx(X,{color:"warning",size:"small",onClick:()=>z({open:!0,session:s}),children:e.jsx(Je,{size:18})})})]})})]},s.session_id))})]})}),oe>1&&e.jsx(_,{sx:{display:"flex",justifyContent:"center",mt:3},children:e.jsx(Qe,{count:oe,page:Z,onChange:(s,i)=>_e(i),color:"primary"})})]}),e.jsxs(C,{open:D.open,onClose:()=>F({open:!1,session:null}),children:[e.jsx(b,{children:"Terminate Session"}),e.jsxs(k,{children:[e.jsxs(n,{children:["Are you sure you want to terminate the session for"," ",e.jsx("strong",{children:(xe=D.session)==null?void 0:xe.email}),"?"]}),e.jsx(n,{variant:"body2",color:"textSecondary",sx:{mt:1},children:"This will immediately log out the user and they will need to log in again."})]}),e.jsxs(A,{children:[e.jsx(o,{onClick:()=>F({open:!1,session:null}),color:"inherit",children:"Cancel"}),e.jsx(o,{onClick:()=>D.session&&Ae(D.session),color:"error",variant:"contained",children:"Terminate Session"})]})]}),e.jsxs(C,{open:U.open,onClose:()=>z({open:!1,session:null}),children:[e.jsx(b,{children:"Lockout User Account"}),e.jsxs(k,{children:[e.jsxs(n,{children:["Are you sure you want to lockout the account for"," ",e.jsx("strong",{children:(he=U.session)==null?void 0:he.email}),"?"]}),e.jsx(n,{variant:"body2",color:"error",sx:{mt:1},children:"⚠️ This will:"}),e.jsxs(n,{variant:"body2",color:"textSecondary",component:"div",sx:{mt:1,ml:2},children:["• Immediately terminate all active sessions",e.jsx("br",{}),"• Prevent the user from logging in",e.jsx("br",{}),"• Require admin intervention to unlock the account"]})]}),e.jsxs(A,{children:[e.jsx(o,{onClick:()=>z({open:!1,session:null}),color:"inherit",children:"Cancel"}),e.jsx(o,{onClick:()=>U.session&&we(U.session),color:"error",variant:"contained",children:"Lockout User"})]})]}),e.jsxs(C,{open:P.open,onClose:()=>E({open:!1,session:null}),children:[e.jsx(b,{children:"Terminate All User Sessions"}),e.jsxs(k,{children:[e.jsxs(n,{children:["Are you sure you want to terminate ALL sessions for"," ",e.jsx("strong",{children:(ue=P.session)==null?void 0:ue.email}),"?"]}),e.jsx(n,{variant:"body2",color:"warning.main",sx:{mt:1},children:"⚠️ This will:"}),e.jsxs(n,{variant:"body2",color:"textSecondary",component:"div",sx:{mt:1,ml:2},children:["• Immediately terminate all active sessions for this user",e.jsx("br",{}),"• Log out the user from all devices",e.jsx("br",{}),"• The user can log back in immediately after termination"]})]}),e.jsxs(A,{children:[e.jsx(o,{onClick:()=>E({open:!1,session:null}),color:"inherit",children:"Cancel"}),e.jsx(o,{onClick:()=>P.session&&Te(P.session),color:"warning",variant:"contained",children:"Terminate All Sessions"})]})]}),e.jsxs(C,{open:be,onClose:()=>R(!1),children:[e.jsx(b,{children:"Cleanup Expired Sessions"}),e.jsxs(k,{children:[e.jsx(n,{children:"This will permanently delete all expired sessions older than 7 days from the database."}),e.jsx(n,{variant:"body2",color:"textSecondary",sx:{mt:1},children:"This action cannot be undone."})]}),e.jsxs(A,{children:[e.jsx(o,{onClick:()=>R(!1),color:"inherit",children:"Cancel"}),e.jsx(o,{onClick:Ie,color:"warning",variant:"contained",children:"Cleanup Sessions"})]})]}),e.jsxs(C,{open:T.open,onClose:()=>{N({open:!1,session:null}),$("")},maxWidth:"sm",fullWidth:!0,children:[e.jsx(b,{children:"Send Message to User"}),e.jsxs(k,{children:[e.jsxs(n,{variant:"body2",color:"textSecondary",sx:{mb:2},children:["Send an instant message to ",e.jsx("strong",{children:(me=T.session)==null?void 0:me.email})]}),e.jsx(pe,{autoFocus:!0,fullWidth:!0,multiline:!0,rows:4,label:"Message",value:W,onChange:s=>$(s.target.value),placeholder:"Enter your message here...",sx:{mt:1}}),e.jsx(n,{variant:"caption",color:"textSecondary",sx:{mt:1,display:"block"},children:"The message will appear instantly if the user is online, or be saved for when they log in."})]}),e.jsxs(A,{children:[e.jsx(o,{onClick:()=>{N({open:!1,session:null}),$("")},color:"inherit",disabled:K,children:"Cancel"}),e.jsx(o,{onClick:Le,color:"primary",variant:"contained",disabled:!W.trim()||K,startIcon:K?e.jsx(se,{size:16}):e.jsx(fe,{size:18}),children:K?"Sending...":"Send Message"})]})]}),e.jsxs(C,{open:ke,onClose:()=>q(!1),children:[e.jsx(b,{children:"Kill All Active Sessions"}),e.jsxs(k,{children:[e.jsx(n,{children:"Are you sure you want to terminate ALL active sessions for ALL users?"}),e.jsx(n,{variant:"body2",color:"error",sx:{mt:1},children:"⚠️ This will:"}),e.jsxs(n,{variant:"body2",color:"textSecondary",component:"div",sx:{mt:1,ml:2},children:["• Immediately log out ALL users from ALL devices",e.jsx("br",{}),"• Terminate ALL admin sessions (including your own)",e.jsx("br",{}),"• Force everyone to log in again",e.jsx("br",{}),"• This action affects the entire system"]}),e.jsx(n,{variant:"body2",color:"error",sx:{mt:2,fontWeight:"bold"},children:"Use this only in emergency situations!"})]}),e.jsxs(A,{children:[e.jsx(o,{onClick:()=>q(!1),color:"inherit",children:"Cancel"}),e.jsx(o,{onClick:Me,color:"error",variant:"contained",children:"Kill All Sessions"})]})]})]})})};export{Cs as default};
//# sourceMappingURL=SessionManagement-BWBnUWRX.js.map
