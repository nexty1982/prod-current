# ============================================================================
# NGINX Configuration: Admin-Only "Latest" Environment
# ============================================================================
# 
# This configuration creates a separate /latest environment accessible only
# to super_admin users. It should be included in the main nginx server block.
#
# Location: /etc/nginx/sites-enabled/orthodoxmetrics.com
# Add this inside the server { } block.
#
# Prerequisites:
#   1. Create the /latest build directory:
#      mkdir -p /var/www/orthodoxmetrics/latest/front-end/dist
#   2. Deploy "latest" builds to that directory
#   3. Backend must set X-Environment header based on user role
#
# ============================================================================

# ============================================================================
# OPTION 1: Cookie-based authentication (Session Cookie Check)
# ============================================================================
# This checks for the presence of the session cookie and relies on the
# backend to validate the user's role.

# Map to check for super_admin session cookie
# Note: This is a basic presence check - actual role validation happens at backend
map $cookie_orthodoxmetrics_sid $has_session {
    ""      0;
    default 1;
}

# /latest location block - serves the "latest" build for authenticated users
# The backend X-Environment header determines if user has access
location /latest {
    # Require session cookie to be present
    if ($has_session = 0) {
        return 302 /auth/login2?redirect=/latest;
    }

    alias /var/www/orthodoxmetrics/latest/front-end/dist;
    try_files $uri $uri/ /latest/index.html;

    # Add security headers
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
    
    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# ============================================================================
# OPTION 2: Lua-based role validation (Requires ngx_http_lua_module)
# ============================================================================
# This provides server-side role validation but requires OpenResty or
# nginx compiled with Lua support.
#
# Uncomment if you have Lua support:
#
# location /latest {
#     access_by_lua_block {
#         local cookie = ngx.var.cookie_orthodoxmetrics_sid
#         if not cookie then
#             return ngx.redirect("/auth/login2?redirect=/latest")
#         end
#         
#         -- Call backend to validate session and check role
#         local res = ngx.location.capture("/api/auth/validate-session", {
#             method = ngx.HTTP_GET,
#             args = { check_super_admin = "true" }
#         })
#         
#         if res.status ~= 200 then
#             return ngx.redirect("/auth/unauthorized")
#         end
#         
#         local cjson = require "cjson"
#         local data = cjson.decode(res.body)
#         
#         if data.role ~= "super_admin" then
#             return ngx.redirect("/auth/unauthorized")
#         end
#     }
#     
#     alias /var/www/orthodoxmetrics/latest/front-end/dist;
#     try_files $uri $uri/ /latest/index.html;
# }

# ============================================================================
# API Proxy for /latest environment
# ============================================================================
# The /latest frontend still uses the same backend API

location /latest/api {
    rewrite ^/latest/api(.*)$ /api$1 break;
    proxy_pass http://localhost:3001;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    
    # Pass the environment context
    proxy_set_header X-Environment "latest";
}

# ============================================================================
# Deployment Notes
# ============================================================================
#
# To deploy "latest" builds:
#
# 1. Build with environment flag:
#    cd /var/www/orthodoxmetrics/prod/front-end
#    VITE_ENVIRONMENT=latest npm run build
#    cp -r dist/* /var/www/orthodoxmetrics/latest/front-end/dist/
#
# 2. Or use a deployment script:
#    npm run build:latest
#
# 3. Test nginx config:
#    sudo nginx -t
#
# 4. Reload nginx:
#    sudo systemctl reload nginx
#
# ============================================================================
