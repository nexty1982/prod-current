# nginx-external-221.conf
# External proxy server (.221) - handles SSL, cookie-based routing, proxies to internal (.239)
#
# To deploy: Copy to .221 server and reload nginx

# 1. IP bypass for maintenance - set your IP to bypass 503 errors
# Uncomment and replace YOUR_IP with your actual IP address
geo $maintenance_bypass {
    default         0;
    73.160.15.116/32  1;  # Your IP to bypass maintenance
    192.168.1.0/24 1;  # Example: allow local subnet
}

# 2. Map the cookie to a build type variable
map $cookie_user_role $om_build_type {
    default       stable;
    "super_admin" latest;
    "developer"   latest;
}

server {
    listen 80;
    server_name orthodoxmetrics.com www.orthodoxmetrics.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name orthodoxmetrics.com www.orthodoxmetrics.com;

    ssl_certificate     /etc/ssl/certs/orthodoxmetrics-full-cert.pem;
    ssl_certificate_key /etc/ssl/private/orthodoxmetrics.key;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    access_log /var/log/nginx/orthodoxmetrics.access.log;
    error_log  /var/log/nginx/orthodoxmetrics.error.log;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Error interception ONLY for backend errors (502, 503, 504)
    # DO NOT intercept 404 - let the SPA handle routing!
    proxy_intercept_errors on;
    error_page 502 503 504 /updating.html;

    location = /updating.html {
        root /var/www/html;
        internal;
    }

    # GITHUB WEBHOOKS
    location /webhooks/github {
        proxy_pass         http://192.168.1.239:3001/webhooks/github;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Content-Type $content_type;
        proxy_pass_request_body on;
    }

    # FRONTEND - Pass X-Build-Type header for routing
    location / {
        proxy_pass         http://192.168.1.239:80;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   X-Build-Type $om_build_type;
        proxy_set_header   X-Maintenance-Bypass $maintenance_bypass;
        proxy_buffering    off;

        proxy_set_header   Cookie $http_cookie;
        proxy_pass_header  Set-Cookie;
        proxy_cookie_path  / /;

        # Debug header to verify routing
        add_header X-Served-Build $om_build_type always;
    }

    # BACKEND /api
    location /api/ {
        proxy_pass         http://192.168.1.239:3001/api/;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   X-Build-Type $om_build_type;
        proxy_set_header   X-Maintenance-Bypass $maintenance_bypass;
        proxy_buffering    off;

        client_max_body_size 50M;

        proxy_set_header   Cookie $http_cookie;
        proxy_pass_header  Set-Cookie;
        proxy_cookie_path  / /;

        proxy_connect_timeout 300s;
        proxy_send_timeout    300s;
        proxy_read_timeout    300s;
        send_timeout          300s;
    }

    # WebSocket: OMAI Logger
    location /ws/omai-logger {
        proxy_pass         http://192.168.1.239:3001/ws/omai-logger;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_connect_timeout 7d;
        proxy_send_timeout    7d;
        proxy_read_timeout    7d;
    }

    # Socket.IO
    location /socket.io/ {
        proxy_pass         http://192.168.1.239:3001/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Cookie $http_cookie;
        proxy_pass_header  Set-Cookie;
        proxy_cookie_path  / /;
        proxy_connect_timeout 7d;
        proxy_send_timeout    7d;
        proxy_read_timeout    7d;
    }

    # Uploads
    location /uploads/ {
        proxy_pass         http://192.168.1.239:80/uploads/;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
    }

    # Public
    location /public/ {
        proxy_pass         http://192.168.1.239:80/public/;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
    }

    # Berry UI
    location ^~ /berry {
        proxy_pass         http://192.168.1.239:80/berry;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Library API
    location /api/library {
        proxy_pass         http://192.168.1.239:3001;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
    }

    client_max_body_size 50M;
}
