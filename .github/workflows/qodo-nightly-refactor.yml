name: Qodo Nightly Refactor
on:
  schedule:
    - cron: '0 7 * * *' # Runs at 2:00 AM EST (7:00 AM UTC)
  workflow_dispatch: # Allows you to trigger it manually for a "dry run"

jobs:
  qodo-refactor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Qodo needs full history for context

      - name: Qodo AI Refactor Agent
        uses: qodo-ai/qodo-refactor-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # The "Canonical Truth" Instruction Set
          instructions: >
            1. Fix CORS: Add 'http://192.168.1.239:5174' to the allowed origins in the server's CORS middleware. 
               Ensure it handles unauthorized origins gracefully (callback(null, false)) to prevent 500 errors.
            2. Canonical Health: Consolidate 'server/src/routes/systemRoutes.js'. 
               It must return Node version 'v20.19.3' and use 'SELECT 1' to verify MariaDB for the 3rd status dot.
            3. Header Sync: Ensure only 'front-end/src/layouts/full/vertical/header/Header.tsx' is updated with the 3-dot polling logic.
            4. Cleanup: Identify and flag duplicate 'Header.tsx' files in 'refactor-src' for deletion.
