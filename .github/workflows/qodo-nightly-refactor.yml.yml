name: Qodo Nightly Refactor
on:
  schedule:
    - cron: '0 7 * * *' # Runs daily at 07:00 UTC (GitHub Actions schedules use UTC; local time may shift with DST)
  workflow_dispatch: # Allows you to trigger it manually for a "dry run"

jobs:
  qodo-refactor:
    runs-on: ubuntu-latest
    permissions:
      contents: read        # Read repository code
      pull-requests: write  # Create and update pull requests
      issues: write         # Comment on issues if needed
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Qodo needs full history for context

      - name: Qodo AI Refactor Agent
        # TODO: Pin to commit SHA once repository is publicly accessible
        # Current: @v1 (not immutable, supply-chain risk)
        # Recommended: @<commit-sha> for immutable reference
        uses: qodo-ai/qodo-refactor-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # The "Canonical Truth" Instruction Set
          instructions: >
            1. Fix CORS: Ensure development origins are configured via environment or config (not hard-coded IPs) and added to the server's CORS middleware.
               Ensure it handles unauthorized origins gracefully (callback(null, false)) to prevent 500 errors.
            2. Canonical Health: Consolidate 'server/src/routes/systemRoutes.js'. 
               It must return the Node version reported by process.version (Node 20.x expected) and use 'SELECT 1' to verify MariaDB for the 3rd status dot.
            3. Header Sync: Ensure only 'front-end/src/layouts/full/vertical/header/Header.tsx' is updated with the 3-dot polling logic.
            4. Cleanup: Identify and flag duplicate 'Header.tsx' files in 'refactor-src' for deletion.
